<!DOCTYPE html>
<html><head><meta charset="utf-8" content="text/html" http-equiv="Content-Type" /><meta content="Pallet Crates" name="description" /><script type="text/javascript">/*!
 * jQuery JavaScript Library v1.4.4
 * http://jquery.com/
 *
 * Copyright 2010, John Resig
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * Includes Sizzle.js
 * http://sizzlejs.com/
 * Copyright 2010, The Dojo Foundation
 * Released under the MIT, BSD, and GPL Licenses.
 *
 * Date: Thu Nov 11 19:04:53 2010 -0500
 */
(function(E,B){function ka(a,b,d){if(d===B&&a.nodeType===1){d=a.getAttribute("data-"+b);if(typeof d==="string"){try{d=d==="true"?true:d==="false"?false:d==="null"?null:!c.isNaN(d)?parseFloat(d):Ja.test(d)?c.parseJSON(d):d}catch(e){}c.data(a,b,d)}else d=B}return d}function U(){return false}function ca(){return true}function la(a,b,d){d[0].type=a;return c.event.handle.apply(b,d)}function Ka(a){var b,d,e,f,h,l,k,o,x,r,A,C=[];f=[];h=c.data(this,this.nodeType?"events":"__events__");if(typeof h==="function")h=
h.events;if(!(a.liveFired===this||!h||!h.live||a.button&&a.type==="click")){if(a.namespace)A=RegExp("(^|\\.)"+a.namespace.split(".").join("\\.(?:.*\\.)?")+"(\\.|$)");a.liveFired=this;var J=h.live.slice(0);for(k=0;k<J.length;k++){h=J[k];h.origType.replace(X,"")===a.type?f.push(h.selector):J.splice(k--,1)}f=c(a.target).closest(f,a.currentTarget);o=0;for(x=f.length;o<x;o++){r=f[o];for(k=0;k<J.length;k++){h=J[k];if(r.selector===h.selector&&(!A||A.test(h.namespace))){l=r.elem;e=null;if(h.preType==="mouseenter"||
h.preType==="mouseleave"){a.type=h.preType;e=c(a.relatedTarget).closest(h.selector)[0]}if(!e||e!==l)C.push({elem:l,handleObj:h,level:r.level})}}}o=0;for(x=C.length;o<x;o++){f=C[o];if(d&&f.level>d)break;a.currentTarget=f.elem;a.data=f.handleObj.data;a.handleObj=f.handleObj;A=f.handleObj.origHandler.apply(f.elem,arguments);if(A===false||a.isPropagationStopped()){d=f.level;if(A===false)b=false;if(a.isImmediatePropagationStopped())break}}return b}}function Y(a,b){return(a&&a!=="*"?a+".":"")+b.replace(La,
"`").replace(Ma,"&")}function ma(a,b,d){if(c.isFunction(b))return c.grep(a,function(f,h){return!!b.call(f,h,f)===d});else if(b.nodeType)return c.grep(a,function(f){return f===b===d});else if(typeof b==="string"){var e=c.grep(a,function(f){return f.nodeType===1});if(Na.test(b))return c.filter(b,e,!d);else b=c.filter(b,e)}return c.grep(a,function(f){return c.inArray(f,b)>=0===d})}function na(a,b){var d=0;b.each(function(){if(this.nodeName===(a[d]&&a[d].nodeName)){var e=c.data(a[d++]),f=c.data(this,
e);if(e=e&&e.events){delete f.handle;f.events={};for(var h in e)for(var l in e[h])c.event.add(this,h,e[h][l],e[h][l].data)}}})}function Oa(a,b){b.src?c.ajax({url:b.src,async:false,dataType:"script"}):c.globalEval(b.text||b.textContent||b.innerHTML||"");b.parentNode&&b.parentNode.removeChild(b)}function oa(a,b,d){var e=b==="width"?a.offsetWidth:a.offsetHeight;if(d==="border")return e;c.each(b==="width"?Pa:Qa,function(){d||(e-=parseFloat(c.css(a,"padding"+this))||0);if(d==="margin")e+=parseFloat(c.css(a,
"margin"+this))||0;else e-=parseFloat(c.css(a,"border"+this+"Width"))||0});return e}function da(a,b,d,e){if(c.isArray(b)&&b.length)c.each(b,function(f,h){d||Ra.test(a)?e(a,h):da(a+"["+(typeof h==="object"||c.isArray(h)?f:"")+"]",h,d,e)});else if(!d&&b!=null&&typeof b==="object")c.isEmptyObject(b)?e(a,""):c.each(b,function(f,h){da(a+"["+f+"]",h,d,e)});else e(a,b)}function S(a,b){var d={};c.each(pa.concat.apply([],pa.slice(0,b)),function(){d[this]=a});return d}function qa(a){if(!ea[a]){var b=c("<"+
a+">").appendTo("body"),d=b.css("display");b.remove();if(d==="none"||d==="")d="block";ea[a]=d}return ea[a]}function fa(a){return c.isWindow(a)?a:a.nodeType===9?a.defaultView||a.parentWindow:false}var t=E.document,c=function(){function a(){if(!b.isReady){try{t.documentElement.doScroll("left")}catch(j){setTimeout(a,1);return}b.ready()}}var b=function(j,s){return new b.fn.init(j,s)},d=E.jQuery,e=E.$,f,h=/^(?:[^<]*(<[\w\W]+>)[^>]*$|#([\w\-]+)$)/,l=/\S/,k=/^\s+/,o=/\s+$/,x=/\W/,r=/\d/,A=/^<(\w+)\s*\/?>(?:<\/\1>)?$/,
C=/^[\],:{}\s]*$/,J=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,w=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,I=/(?:^|:|,)(?:\s*\[)+/g,L=/(webkit)[ \/]([\w.]+)/,g=/(opera)(?:.*version)?[ \/]([\w.]+)/,i=/(msie) ([\w.]+)/,n=/(mozilla)(?:.*? rv:([\w.]+))?/,m=navigator.userAgent,p=false,q=[],u,y=Object.prototype.toString,F=Object.prototype.hasOwnProperty,M=Array.prototype.push,N=Array.prototype.slice,O=String.prototype.trim,D=Array.prototype.indexOf,R={};b.fn=b.prototype={init:function(j,
s){var v,z,H;if(!j)return this;if(j.nodeType){this.context=this[0]=j;this.length=1;return this}if(j==="body"&&!s&&t.body){this.context=t;this[0]=t.body;this.selector="body";this.length=1;return this}if(typeof j==="string")if((v=h.exec(j))&&(v[1]||!s))if(v[1]){H=s?s.ownerDocument||s:t;if(z=A.exec(j))if(b.isPlainObject(s)){j=[t.createElement(z[1])];b.fn.attr.call(j,s,true)}else j=[H.createElement(z[1])];else{z=b.buildFragment([v[1]],[H]);j=(z.cacheable?z.fragment.cloneNode(true):z.fragment).childNodes}return b.merge(this,
j)}else{if((z=t.getElementById(v[2]))&&z.parentNode){if(z.id!==v[2])return f.find(j);this.length=1;this[0]=z}this.context=t;this.selector=j;return this}else if(!s&&!x.test(j)){this.selector=j;this.context=t;j=t.getElementsByTagName(j);return b.merge(this,j)}else return!s||s.jquery?(s||f).find(j):b(s).find(j);else if(b.isFunction(j))return f.ready(j);if(j.selector!==B){this.selector=j.selector;this.context=j.context}return b.makeArray(j,this)},selector:"",jquery:"1.4.4",length:0,size:function(){return this.length},
toArray:function(){return N.call(this,0)},get:function(j){return j==null?this.toArray():j<0?this.slice(j)[0]:this[j]},pushStack:function(j,s,v){var z=b();b.isArray(j)?M.apply(z,j):b.merge(z,j);z.prevObject=this;z.context=this.context;if(s==="find")z.selector=this.selector+(this.selector?" ":"")+v;else if(s)z.selector=this.selector+"."+s+"("+v+")";return z},each:function(j,s){return b.each(this,j,s)},ready:function(j){b.bindReady();if(b.isReady)j.call(t,b);else q&&q.push(j);return this},eq:function(j){return j===
-1?this.slice(j):this.slice(j,+j+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(N.apply(this,arguments),"slice",N.call(arguments).join(","))},map:function(j){return this.pushStack(b.map(this,function(s,v){return j.call(s,v,s)}))},end:function(){return this.prevObject||b(null)},push:M,sort:[].sort,splice:[].splice};b.fn.init.prototype=b.fn;b.extend=b.fn.extend=function(){var j,s,v,z,H,G=arguments[0]||{},K=1,Q=arguments.length,ga=false;
if(typeof G==="boolean"){ga=G;G=arguments[1]||{};K=2}if(typeof G!=="object"&&!b.isFunction(G))G={};if(Q===K){G=this;--K}for(;K<Q;K++)if((j=arguments[K])!=null)for(s in j){v=G[s];z=j[s];if(G!==z)if(ga&&z&&(b.isPlainObject(z)||(H=b.isArray(z)))){if(H){H=false;v=v&&b.isArray(v)?v:[]}else v=v&&b.isPlainObject(v)?v:{};G[s]=b.extend(ga,v,z)}else if(z!==B)G[s]=z}return G};b.extend({noConflict:function(j){E.$=e;if(j)E.jQuery=d;return b},isReady:false,readyWait:1,ready:function(j){j===true&&b.readyWait--;
if(!b.readyWait||j!==true&&!b.isReady){if(!t.body)return setTimeout(b.ready,1);b.isReady=true;if(!(j!==true&&--b.readyWait>0))if(q){var s=0,v=q;for(q=null;j=v[s++];)j.call(t,b);b.fn.trigger&&b(t).trigger("ready").unbind("ready")}}},bindReady:function(){if(!p){p=true;if(t.readyState==="complete")return setTimeout(b.ready,1);if(t.addEventListener){t.addEventListener("DOMContentLoaded",u,false);E.addEventListener("load",b.ready,false)}else if(t.attachEvent){t.attachEvent("onreadystatechange",u);E.attachEvent("onload",
b.ready);var j=false;try{j=E.frameElement==null}catch(s){}t.documentElement.doScroll&&j&&a()}}},isFunction:function(j){return b.type(j)==="function"},isArray:Array.isArray||function(j){return b.type(j)==="array"},isWindow:function(j){return j&&typeof j==="object"&&"setInterval"in j},isNaN:function(j){return j==null||!r.test(j)||isNaN(j)},type:function(j){return j==null?String(j):R[y.call(j)]||"object"},isPlainObject:function(j){if(!j||b.type(j)!=="object"||j.nodeType||b.isWindow(j))return false;if(j.constructor&&
!F.call(j,"constructor")&&!F.call(j.constructor.prototype,"isPrototypeOf"))return false;for(var s in j);return s===B||F.call(j,s)},isEmptyObject:function(j){for(var s in j)return false;return true},error:function(j){throw j;},parseJSON:function(j){if(typeof j!=="string"||!j)return null;j=b.trim(j);if(C.test(j.replace(J,"@").replace(w,"]").replace(I,"")))return E.JSON&&E.JSON.parse?E.JSON.parse(j):(new Function("return "+j))();else b.error("Invalid JSON: "+j)},noop:function(){},globalEval:function(j){if(j&&
l.test(j)){var s=t.getElementsByTagName("head")[0]||t.documentElement,v=t.createElement("script");v.type="text/javascript";if(b.support.scriptEval)v.appendChild(t.createTextNode(j));else v.text=j;s.insertBefore(v,s.firstChild);s.removeChild(v)}},nodeName:function(j,s){return j.nodeName&&j.nodeName.toUpperCase()===s.toUpperCase()},each:function(j,s,v){var z,H=0,G=j.length,K=G===B||b.isFunction(j);if(v)if(K)for(z in j){if(s.apply(j[z],v)===false)break}else for(;H<G;){if(s.apply(j[H++],v)===false)break}else if(K)for(z in j){if(s.call(j[z],
z,j[z])===false)break}else for(v=j[0];H<G&&s.call(v,H,v)!==false;v=j[++H]);return j},trim:O?function(j){return j==null?"":O.call(j)}:function(j){return j==null?"":j.toString().replace(k,"").replace(o,"")},makeArray:function(j,s){var v=s||[];if(j!=null){var z=b.type(j);j.length==null||z==="string"||z==="function"||z==="regexp"||b.isWindow(j)?M.call(v,j):b.merge(v,j)}return v},inArray:function(j,s){if(s.indexOf)return s.indexOf(j);for(var v=0,z=s.length;v<z;v++)if(s[v]===j)return v;return-1},merge:function(j,
s){var v=j.length,z=0;if(typeof s.length==="number")for(var H=s.length;z<H;z++)j[v++]=s[z];else for(;s[z]!==B;)j[v++]=s[z++];j.length=v;return j},grep:function(j,s,v){var z=[],H;v=!!v;for(var G=0,K=j.length;G<K;G++){H=!!s(j[G],G);v!==H&&z.push(j[G])}return z},map:function(j,s,v){for(var z=[],H,G=0,K=j.length;G<K;G++){H=s(j[G],G,v);if(H!=null)z[z.length]=H}return z.concat.apply([],z)},guid:1,proxy:function(j,s,v){if(arguments.length===2)if(typeof s==="string"){v=j;j=v[s];s=B}else if(s&&!b.isFunction(s)){v=
s;s=B}if(!s&&j)s=function(){return j.apply(v||this,arguments)};if(j)s.guid=j.guid=j.guid||s.guid||b.guid++;return s},access:function(j,s,v,z,H,G){var K=j.length;if(typeof s==="object"){for(var Q in s)b.access(j,Q,s[Q],z,H,v);return j}if(v!==B){z=!G&&z&&b.isFunction(v);for(Q=0;Q<K;Q++)H(j[Q],s,z?v.call(j[Q],Q,H(j[Q],s)):v,G);return j}return K?H(j[0],s):B},now:function(){return(new Date).getTime()},uaMatch:function(j){j=j.toLowerCase();j=L.exec(j)||g.exec(j)||i.exec(j)||j.indexOf("compatible")<0&&n.exec(j)||
[];return{browser:j[1]||"",version:j[2]||"0"}},browser:{}});b.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(j,s){R["[object "+s+"]"]=s.toLowerCase()});m=b.uaMatch(m);if(m.browser){b.browser[m.browser]=true;b.browser.version=m.version}if(b.browser.webkit)b.browser.safari=true;if(D)b.inArray=function(j,s){return D.call(s,j)};if(!/\s/.test("\u00a0")){k=/^[\s\xA0]+/;o=/[\s\xA0]+$/}f=b(t);if(t.addEventListener)u=function(){t.removeEventListener("DOMContentLoaded",u,
false);b.ready()};else if(t.attachEvent)u=function(){if(t.readyState==="complete"){t.detachEvent("onreadystatechange",u);b.ready()}};return E.jQuery=E.$=b}();(function(){c.support={};var a=t.documentElement,b=t.createElement("script"),d=t.createElement("div"),e="script"+c.now();d.style.display="none";d.innerHTML="   <link/><table></table><a href='/a' style='color:red;float:left;opacity:.55;'>a</a><input type='checkbox'/>";var f=d.getElementsByTagName("*"),h=d.getElementsByTagName("a")[0],l=t.createElement("select"),
k=l.appendChild(t.createElement("option"));if(!(!f||!f.length||!h)){c.support={leadingWhitespace:d.firstChild.nodeType===3,tbody:!d.getElementsByTagName("tbody").length,htmlSerialize:!!d.getElementsByTagName("link").length,style:/red/.test(h.getAttribute("style")),hrefNormalized:h.getAttribute("href")==="/a",opacity:/^0.55$/.test(h.style.opacity),cssFloat:!!h.style.cssFloat,checkOn:d.getElementsByTagName("input")[0].value==="on",optSelected:k.selected,deleteExpando:true,optDisabled:false,checkClone:false,
scriptEval:false,noCloneEvent:true,boxModel:null,inlineBlockNeedsLayout:false,shrinkWrapBlocks:false,reliableHiddenOffsets:true};l.disabled=true;c.support.optDisabled=!k.disabled;b.type="text/javascript";try{b.appendChild(t.createTextNode("window."+e+"=1;"))}catch(o){}a.insertBefore(b,a.firstChild);if(E[e]){c.support.scriptEval=true;delete E[e]}try{delete b.test}catch(x){c.support.deleteExpando=false}a.removeChild(b);if(d.attachEvent&&d.fireEvent){d.attachEvent("onclick",function r(){c.support.noCloneEvent=
false;d.detachEvent("onclick",r)});d.cloneNode(true).fireEvent("onclick")}d=t.createElement("div");d.innerHTML="<input type='radio' name='radiotest' checked='checked'/>";a=t.createDocumentFragment();a.appendChild(d.firstChild);c.support.checkClone=a.cloneNode(true).cloneNode(true).lastChild.checked;c(function(){var r=t.createElement("div");r.style.width=r.style.paddingLeft="1px";t.body.appendChild(r);c.boxModel=c.support.boxModel=r.offsetWidth===2;if("zoom"in r.style){r.style.display="inline";r.style.zoom=
1;c.support.inlineBlockNeedsLayout=r.offsetWidth===2;r.style.display="";r.innerHTML="<div style='width:4px;'></div>";c.support.shrinkWrapBlocks=r.offsetWidth!==2}r.innerHTML="<table><tr><td style='padding:0;display:none'></td><td>t</td></tr></table>";var A=r.getElementsByTagName("td");c.support.reliableHiddenOffsets=A[0].offsetHeight===0;A[0].style.display="";A[1].style.display="none";c.support.reliableHiddenOffsets=c.support.reliableHiddenOffsets&&A[0].offsetHeight===0;r.innerHTML="";t.body.removeChild(r).style.display=
"none"});a=function(r){var A=t.createElement("div");r="on"+r;var C=r in A;if(!C){A.setAttribute(r,"return;");C=typeof A[r]==="function"}return C};c.support.submitBubbles=a("submit");c.support.changeBubbles=a("change");a=b=d=f=h=null}})();var ra={},Ja=/^(?:\{.*\}|\[.*\])$/;c.extend({cache:{},uuid:0,expando:"jQuery"+c.now(),noData:{embed:true,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:true},data:function(a,b,d){if(c.acceptData(a)){a=a==E?ra:a;var e=a.nodeType,f=e?a[c.expando]:null,h=
c.cache;if(!(e&&!f&&typeof b==="string"&&d===B)){if(e)f||(a[c.expando]=f=++c.uuid);else h=a;if(typeof b==="object")if(e)h[f]=c.extend(h[f],b);else c.extend(h,b);else if(e&&!h[f])h[f]={};a=e?h[f]:h;if(d!==B)a[b]=d;return typeof b==="string"?a[b]:a}}},removeData:function(a,b){if(c.acceptData(a)){a=a==E?ra:a;var d=a.nodeType,e=d?a[c.expando]:a,f=c.cache,h=d?f[e]:e;if(b){if(h){delete h[b];d&&c.isEmptyObject(h)&&c.removeData(a)}}else if(d&&c.support.deleteExpando)delete a[c.expando];else if(a.removeAttribute)a.removeAttribute(c.expando);
else if(d)delete f[e];else for(var l in a)delete a[l]}},acceptData:function(a){if(a.nodeName){var b=c.noData[a.nodeName.toLowerCase()];if(b)return!(b===true||a.getAttribute("classid")!==b)}return true}});c.fn.extend({data:function(a,b){var d=null;if(typeof a==="undefined"){if(this.length){var e=this[0].attributes,f;d=c.data(this[0]);for(var h=0,l=e.length;h<l;h++){f=e[h].name;if(f.indexOf("data-")===0){f=f.substr(5);ka(this[0],f,d[f])}}}return d}else if(typeof a==="object")return this.each(function(){c.data(this,
a)});var k=a.split(".");k[1]=k[1]?"."+k[1]:"";if(b===B){d=this.triggerHandler("getData"+k[1]+"!",[k[0]]);if(d===B&&this.length){d=c.data(this[0],a);d=ka(this[0],a,d)}return d===B&&k[1]?this.data(k[0]):d}else return this.each(function(){var o=c(this),x=[k[0],b];o.triggerHandler("setData"+k[1]+"!",x);c.data(this,a,b);o.triggerHandler("changeData"+k[1]+"!",x)})},removeData:function(a){return this.each(function(){c.removeData(this,a)})}});c.extend({queue:function(a,b,d){if(a){b=(b||"fx")+"queue";var e=
c.data(a,b);if(!d)return e||[];if(!e||c.isArray(d))e=c.data(a,b,c.makeArray(d));else e.push(d);return e}},dequeue:function(a,b){b=b||"fx";var d=c.queue(a,b),e=d.shift();if(e==="inprogress")e=d.shift();if(e){b==="fx"&&d.unshift("inprogress");e.call(a,function(){c.dequeue(a,b)})}}});c.fn.extend({queue:function(a,b){if(typeof a!=="string"){b=a;a="fx"}if(b===B)return c.queue(this[0],a);return this.each(function(){var d=c.queue(this,a,b);a==="fx"&&d[0]!=="inprogress"&&c.dequeue(this,a)})},dequeue:function(a){return this.each(function(){c.dequeue(this,
a)})},delay:function(a,b){a=c.fx?c.fx.speeds[a]||a:a;b=b||"fx";return this.queue(b,function(){var d=this;setTimeout(function(){c.dequeue(d,b)},a)})},clearQueue:function(a){return this.queue(a||"fx",[])}});var sa=/[\n\t]/g,ha=/\s+/,Sa=/\r/g,Ta=/^(?:href|src|style)$/,Ua=/^(?:button|input)$/i,Va=/^(?:button|input|object|select|textarea)$/i,Wa=/^a(?:rea)?$/i,ta=/^(?:radio|checkbox)$/i;c.props={"for":"htmlFor","class":"className",readonly:"readOnly",maxlength:"maxLength",cellspacing:"cellSpacing",rowspan:"rowSpan",
colspan:"colSpan",tabindex:"tabIndex",usemap:"useMap",frameborder:"frameBorder"};c.fn.extend({attr:function(a,b){return c.access(this,a,b,true,c.attr)},removeAttr:function(a){return this.each(function(){c.attr(this,a,"");this.nodeType===1&&this.removeAttribute(a)})},addClass:function(a){if(c.isFunction(a))return this.each(function(x){var r=c(this);r.addClass(a.call(this,x,r.attr("class")))});if(a&&typeof a==="string")for(var b=(a||"").split(ha),d=0,e=this.length;d<e;d++){var f=this[d];if(f.nodeType===
1)if(f.className){for(var h=" "+f.className+" ",l=f.className,k=0,o=b.length;k<o;k++)if(h.indexOf(" "+b[k]+" ")<0)l+=" "+b[k];f.className=c.trim(l)}else f.className=a}return this},removeClass:function(a){if(c.isFunction(a))return this.each(function(o){var x=c(this);x.removeClass(a.call(this,o,x.attr("class")))});if(a&&typeof a==="string"||a===B)for(var b=(a||"").split(ha),d=0,e=this.length;d<e;d++){var f=this[d];if(f.nodeType===1&&f.className)if(a){for(var h=(" "+f.className+" ").replace(sa," "),
l=0,k=b.length;l<k;l++)h=h.replace(" "+b[l]+" "," ");f.className=c.trim(h)}else f.className=""}return this},toggleClass:function(a,b){var d=typeof a,e=typeof b==="boolean";if(c.isFunction(a))return this.each(function(f){var h=c(this);h.toggleClass(a.call(this,f,h.attr("class"),b),b)});return this.each(function(){if(d==="string")for(var f,h=0,l=c(this),k=b,o=a.split(ha);f=o[h++];){k=e?k:!l.hasClass(f);l[k?"addClass":"removeClass"](f)}else if(d==="undefined"||d==="boolean"){this.className&&c.data(this,
"__className__",this.className);this.className=this.className||a===false?"":c.data(this,"__className__")||""}})},hasClass:function(a){a=" "+a+" ";for(var b=0,d=this.length;b<d;b++)if((" "+this[b].className+" ").replace(sa," ").indexOf(a)>-1)return true;return false},val:function(a){if(!arguments.length){var b=this[0];if(b){if(c.nodeName(b,"option")){var d=b.attributes.value;return!d||d.specified?b.value:b.text}if(c.nodeName(b,"select")){var e=b.selectedIndex;d=[];var f=b.options;b=b.type==="select-one";
if(e<0)return null;var h=b?e:0;for(e=b?e+1:f.length;h<e;h++){var l=f[h];if(l.selected&&(c.support.optDisabled?!l.disabled:l.getAttribute("disabled")===null)&&(!l.parentNode.disabled||!c.nodeName(l.parentNode,"optgroup"))){a=c(l).val();if(b)return a;d.push(a)}}return d}if(ta.test(b.type)&&!c.support.checkOn)return b.getAttribute("value")===null?"on":b.value;return(b.value||"").replace(Sa,"")}return B}var k=c.isFunction(a);return this.each(function(o){var x=c(this),r=a;if(this.nodeType===1){if(k)r=
a.call(this,o,x.val());if(r==null)r="";else if(typeof r==="number")r+="";else if(c.isArray(r))r=c.map(r,function(C){return C==null?"":C+""});if(c.isArray(r)&&ta.test(this.type))this.checked=c.inArray(x.val(),r)>=0;else if(c.nodeName(this,"select")){var A=c.makeArray(r);c("option",this).each(function(){this.selected=c.inArray(c(this).val(),A)>=0});if(!A.length)this.selectedIndex=-1}else this.value=r}})}});c.extend({attrFn:{val:true,css:true,html:true,text:true,data:true,width:true,height:true,offset:true},
attr:function(a,b,d,e){if(!a||a.nodeType===3||a.nodeType===8)return B;if(e&&b in c.attrFn)return c(a)[b](d);e=a.nodeType!==1||!c.isXMLDoc(a);var f=d!==B;b=e&&c.props[b]||b;var h=Ta.test(b);if((b in a||a[b]!==B)&&e&&!h){if(f){b==="type"&&Ua.test(a.nodeName)&&a.parentNode&&c.error("type property can't be changed");if(d===null)a.nodeType===1&&a.removeAttribute(b);else a[b]=d}if(c.nodeName(a,"form")&&a.getAttributeNode(b))return a.getAttributeNode(b).nodeValue;if(b==="tabIndex")return(b=a.getAttributeNode("tabIndex"))&&
b.specified?b.value:Va.test(a.nodeName)||Wa.test(a.nodeName)&&a.href?0:B;return a[b]}if(!c.support.style&&e&&b==="style"){if(f)a.style.cssText=""+d;return a.style.cssText}f&&a.setAttribute(b,""+d);if(!a.attributes[b]&&a.hasAttribute&&!a.hasAttribute(b))return B;a=!c.support.hrefNormalized&&e&&h?a.getAttribute(b,2):a.getAttribute(b);return a===null?B:a}});var X=/\.(.*)$/,ia=/^(?:textarea|input|select)$/i,La=/\./g,Ma=/ /g,Xa=/[^\w\s.|`]/g,Ya=function(a){return a.replace(Xa,"\\$&")},ua={focusin:0,focusout:0};
c.event={add:function(a,b,d,e){if(!(a.nodeType===3||a.nodeType===8)){if(c.isWindow(a)&&a!==E&&!a.frameElement)a=E;if(d===false)d=U;else if(!d)return;var f,h;if(d.handler){f=d;d=f.handler}if(!d.guid)d.guid=c.guid++;if(h=c.data(a)){var l=a.nodeType?"events":"__events__",k=h[l],o=h.handle;if(typeof k==="function"){o=k.handle;k=k.events}else if(!k){a.nodeType||(h[l]=h=function(){});h.events=k={}}if(!o)h.handle=o=function(){return typeof c!=="undefined"&&!c.event.triggered?c.event.handle.apply(o.elem,
arguments):B};o.elem=a;b=b.split(" ");for(var x=0,r;l=b[x++];){h=f?c.extend({},f):{handler:d,data:e};if(l.indexOf(".")>-1){r=l.split(".");l=r.shift();h.namespace=r.slice(0).sort().join(".")}else{r=[];h.namespace=""}h.type=l;if(!h.guid)h.guid=d.guid;var A=k[l],C=c.event.special[l]||{};if(!A){A=k[l]=[];if(!C.setup||C.setup.call(a,e,r,o)===false)if(a.addEventListener)a.addEventListener(l,o,false);else a.attachEvent&&a.attachEvent("on"+l,o)}if(C.add){C.add.call(a,h);if(!h.handler.guid)h.handler.guid=
d.guid}A.push(h);c.event.global[l]=true}a=null}}},global:{},remove:function(a,b,d,e){if(!(a.nodeType===3||a.nodeType===8)){if(d===false)d=U;var f,h,l=0,k,o,x,r,A,C,J=a.nodeType?"events":"__events__",w=c.data(a),I=w&&w[J];if(w&&I){if(typeof I==="function"){w=I;I=I.events}if(b&&b.type){d=b.handler;b=b.type}if(!b||typeof b==="string"&&b.charAt(0)==="."){b=b||"";for(f in I)c.event.remove(a,f+b)}else{for(b=b.split(" ");f=b[l++];){r=f;k=f.indexOf(".")<0;o=[];if(!k){o=f.split(".");f=o.shift();x=RegExp("(^|\\.)"+
c.map(o.slice(0).sort(),Ya).join("\\.(?:.*\\.)?")+"(\\.|$)")}if(A=I[f])if(d){r=c.event.special[f]||{};for(h=e||0;h<A.length;h++){C=A[h];if(d.guid===C.guid){if(k||x.test(C.namespace)){e==null&&A.splice(h--,1);r.remove&&r.remove.call(a,C)}if(e!=null)break}}if(A.length===0||e!=null&&A.length===1){if(!r.teardown||r.teardown.call(a,o)===false)c.removeEvent(a,f,w.handle);delete I[f]}}else for(h=0;h<A.length;h++){C=A[h];if(k||x.test(C.namespace)){c.event.remove(a,r,C.handler,h);A.splice(h--,1)}}}if(c.isEmptyObject(I)){if(b=
w.handle)b.elem=null;delete w.events;delete w.handle;if(typeof w==="function")c.removeData(a,J);else c.isEmptyObject(w)&&c.removeData(a)}}}}},trigger:function(a,b,d,e){var f=a.type||a;if(!e){a=typeof a==="object"?a[c.expando]?a:c.extend(c.Event(f),a):c.Event(f);if(f.indexOf("!")>=0){a.type=f=f.slice(0,-1);a.exclusive=true}if(!d){a.stopPropagation();c.event.global[f]&&c.each(c.cache,function(){this.events&&this.events[f]&&c.event.trigger(a,b,this.handle.elem)})}if(!d||d.nodeType===3||d.nodeType===
8)return B;a.result=B;a.target=d;b=c.makeArray(b);b.unshift(a)}a.currentTarget=d;(e=d.nodeType?c.data(d,"handle"):(c.data(d,"__events__")||{}).handle)&&e.apply(d,b);e=d.parentNode||d.ownerDocument;try{if(!(d&&d.nodeName&&c.noData[d.nodeName.toLowerCase()]))if(d["on"+f]&&d["on"+f].apply(d,b)===false){a.result=false;a.preventDefault()}}catch(h){}if(!a.isPropagationStopped()&&e)c.event.trigger(a,b,e,true);else if(!a.isDefaultPrevented()){var l;e=a.target;var k=f.replace(X,""),o=c.nodeName(e,"a")&&k===
"click",x=c.event.special[k]||{};if((!x._default||x._default.call(d,a)===false)&&!o&&!(e&&e.nodeName&&c.noData[e.nodeName.toLowerCase()])){try{if(e[k]){if(l=e["on"+k])e["on"+k]=null;c.event.triggered=true;e[k]()}}catch(r){}if(l)e["on"+k]=l;c.event.triggered=false}}},handle:function(a){var b,d,e,f;d=[];var h=c.makeArray(arguments);a=h[0]=c.event.fix(a||E.event);a.currentTarget=this;b=a.type.indexOf(".")<0&&!a.exclusive;if(!b){e=a.type.split(".");a.type=e.shift();d=e.slice(0).sort();e=RegExp("(^|\\.)"+
d.join("\\.(?:.*\\.)?")+"(\\.|$)")}a.namespace=a.namespace||d.join(".");f=c.data(this,this.nodeType?"events":"__events__");if(typeof f==="function")f=f.events;d=(f||{})[a.type];if(f&&d){d=d.slice(0);f=0;for(var l=d.length;f<l;f++){var k=d[f];if(b||e.test(k.namespace)){a.handler=k.handler;a.data=k.data;a.handleObj=k;k=k.handler.apply(this,h);if(k!==B){a.result=k;if(k===false){a.preventDefault();a.stopPropagation()}}if(a.isImmediatePropagationStopped())break}}}return a.result},props:"altKey attrChange attrName bubbles button cancelable charCode clientX clientY ctrlKey currentTarget data detail eventPhase fromElement handler keyCode layerX layerY metaKey newValue offsetX offsetY pageX pageY prevValue relatedNode relatedTarget screenX screenY shiftKey srcElement target toElement view wheelDelta which".split(" "),
fix:function(a){if(a[c.expando])return a;var b=a;a=c.Event(b);for(var d=this.props.length,e;d;){e=this.props[--d];a[e]=b[e]}if(!a.target)a.target=a.srcElement||t;if(a.target.nodeType===3)a.target=a.target.parentNode;if(!a.relatedTarget&&a.fromElement)a.relatedTarget=a.fromElement===a.target?a.toElement:a.fromElement;if(a.pageX==null&&a.clientX!=null){b=t.documentElement;d=t.body;a.pageX=a.clientX+(b&&b.scrollLeft||d&&d.scrollLeft||0)-(b&&b.clientLeft||d&&d.clientLeft||0);a.pageY=a.clientY+(b&&b.scrollTop||
d&&d.scrollTop||0)-(b&&b.clientTop||d&&d.clientTop||0)}if(a.which==null&&(a.charCode!=null||a.keyCode!=null))a.which=a.charCode!=null?a.charCode:a.keyCode;if(!a.metaKey&&a.ctrlKey)a.metaKey=a.ctrlKey;if(!a.which&&a.button!==B)a.which=a.button&1?1:a.button&2?3:a.button&4?2:0;return a},guid:1E8,proxy:c.proxy,special:{ready:{setup:c.bindReady,teardown:c.noop},live:{add:function(a){c.event.add(this,Y(a.origType,a.selector),c.extend({},a,{handler:Ka,guid:a.handler.guid}))},remove:function(a){c.event.remove(this,
Y(a.origType,a.selector),a)}},beforeunload:{setup:function(a,b,d){if(c.isWindow(this))this.onbeforeunload=d},teardown:function(a,b){if(this.onbeforeunload===b)this.onbeforeunload=null}}}};c.removeEvent=t.removeEventListener?function(a,b,d){a.removeEventListener&&a.removeEventListener(b,d,false)}:function(a,b,d){a.detachEvent&&a.detachEvent("on"+b,d)};c.Event=function(a){if(!this.preventDefault)return new c.Event(a);if(a&&a.type){this.originalEvent=a;this.type=a.type}else this.type=a;this.timeStamp=
c.now();this[c.expando]=true};c.Event.prototype={preventDefault:function(){this.isDefaultPrevented=ca;var a=this.originalEvent;if(a)if(a.preventDefault)a.preventDefault();else a.returnValue=false},stopPropagation:function(){this.isPropagationStopped=ca;var a=this.originalEvent;if(a){a.stopPropagation&&a.stopPropagation();a.cancelBubble=true}},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=ca;this.stopPropagation()},isDefaultPrevented:U,isPropagationStopped:U,isImmediatePropagationStopped:U};
var va=function(a){var b=a.relatedTarget;try{for(;b&&b!==this;)b=b.parentNode;if(b!==this){a.type=a.data;c.event.handle.apply(this,arguments)}}catch(d){}},wa=function(a){a.type=a.data;c.event.handle.apply(this,arguments)};c.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){c.event.special[a]={setup:function(d){c.event.add(this,b,d&&d.selector?wa:va,a)},teardown:function(d){c.event.remove(this,b,d&&d.selector?wa:va)}}});if(!c.support.submitBubbles)c.event.special.submit={setup:function(){if(this.nodeName.toLowerCase()!==
"form"){c.event.add(this,"click.specialSubmit",function(a){var b=a.target,d=b.type;if((d==="submit"||d==="image")&&c(b).closest("form").length){a.liveFired=B;return la("submit",this,arguments)}});c.event.add(this,"keypress.specialSubmit",function(a){var b=a.target,d=b.type;if((d==="text"||d==="password")&&c(b).closest("form").length&&a.keyCode===13){a.liveFired=B;return la("submit",this,arguments)}})}else return false},teardown:function(){c.event.remove(this,".specialSubmit")}};if(!c.support.changeBubbles){var V,
xa=function(a){var b=a.type,d=a.value;if(b==="radio"||b==="checkbox")d=a.checked;else if(b==="select-multiple")d=a.selectedIndex>-1?c.map(a.options,function(e){return e.selected}).join("-"):"";else if(a.nodeName.toLowerCase()==="select")d=a.selectedIndex;return d},Z=function(a,b){var d=a.target,e,f;if(!(!ia.test(d.nodeName)||d.readOnly)){e=c.data(d,"_change_data");f=xa(d);if(a.type!=="focusout"||d.type!=="radio")c.data(d,"_change_data",f);if(!(e===B||f===e))if(e!=null||f){a.type="change";a.liveFired=
B;return c.event.trigger(a,b,d)}}};c.event.special.change={filters:{focusout:Z,beforedeactivate:Z,click:function(a){var b=a.target,d=b.type;if(d==="radio"||d==="checkbox"||b.nodeName.toLowerCase()==="select")return Z.call(this,a)},keydown:function(a){var b=a.target,d=b.type;if(a.keyCode===13&&b.nodeName.toLowerCase()!=="textarea"||a.keyCode===32&&(d==="checkbox"||d==="radio")||d==="select-multiple")return Z.call(this,a)},beforeactivate:function(a){a=a.target;c.data(a,"_change_data",xa(a))}},setup:function(){if(this.type===
"file")return false;for(var a in V)c.event.add(this,a+".specialChange",V[a]);return ia.test(this.nodeName)},teardown:function(){c.event.remove(this,".specialChange");return ia.test(this.nodeName)}};V=c.event.special.change.filters;V.focus=V.beforeactivate}t.addEventListener&&c.each({focus:"focusin",blur:"focusout"},function(a,b){function d(e){e=c.event.fix(e);e.type=b;return c.event.trigger(e,null,e.target)}c.event.special[b]={setup:function(){ua[b]++===0&&t.addEventListener(a,d,true)},teardown:function(){--ua[b]===
0&&t.removeEventListener(a,d,true)}}});c.each(["bind","one"],function(a,b){c.fn[b]=function(d,e,f){if(typeof d==="object"){for(var h in d)this[b](h,e,d[h],f);return this}if(c.isFunction(e)||e===false){f=e;e=B}var l=b==="one"?c.proxy(f,function(o){c(this).unbind(o,l);return f.apply(this,arguments)}):f;if(d==="unload"&&b!=="one")this.one(d,e,f);else{h=0;for(var k=this.length;h<k;h++)c.event.add(this[h],d,l,e)}return this}});c.fn.extend({unbind:function(a,b){if(typeof a==="object"&&!a.preventDefault)for(var d in a)this.unbind(d,
a[d]);else{d=0;for(var e=this.length;d<e;d++)c.event.remove(this[d],a,b)}return this},delegate:function(a,b,d,e){return this.live(b,d,e,a)},undelegate:function(a,b,d){return arguments.length===0?this.unbind("live"):this.die(b,null,d,a)},trigger:function(a,b){return this.each(function(){c.event.trigger(a,b,this)})},triggerHandler:function(a,b){if(this[0]){var d=c.Event(a);d.preventDefault();d.stopPropagation();c.event.trigger(d,b,this[0]);return d.result}},toggle:function(a){for(var b=arguments,d=
1;d<b.length;)c.proxy(a,b[d++]);return this.click(c.proxy(a,function(e){var f=(c.data(this,"lastToggle"+a.guid)||0)%d;c.data(this,"lastToggle"+a.guid,f+1);e.preventDefault();return b[f].apply(this,arguments)||false}))},hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}});var ya={focus:"focusin",blur:"focusout",mouseenter:"mouseover",mouseleave:"mouseout"};c.each(["live","die"],function(a,b){c.fn[b]=function(d,e,f,h){var l,k=0,o,x,r=h||this.selector;h=h?this:c(this.context);if(typeof d===
"object"&&!d.preventDefault){for(l in d)h[b](l,e,d[l],r);return this}if(c.isFunction(e)){f=e;e=B}for(d=(d||"").split(" ");(l=d[k++])!=null;){o=X.exec(l);x="";if(o){x=o[0];l=l.replace(X,"")}if(l==="hover")d.push("mouseenter"+x,"mouseleave"+x);else{o=l;if(l==="focus"||l==="blur"){d.push(ya[l]+x);l+=x}else l=(ya[l]||l)+x;if(b==="live"){x=0;for(var A=h.length;x<A;x++)c.event.add(h[x],"live."+Y(l,r),{data:e,selector:r,handler:f,origType:l,origHandler:f,preType:o})}else h.unbind("live."+Y(l,r),f)}}return this}});
c.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error".split(" "),function(a,b){c.fn[b]=function(d,e){if(e==null){e=d;d=null}return arguments.length>0?this.bind(b,d,e):this.trigger(b)};if(c.attrFn)c.attrFn[b]=true});E.attachEvent&&!E.addEventListener&&c(E).bind("unload",function(){for(var a in c.cache)if(c.cache[a].handle)try{c.event.remove(c.cache[a].handle.elem)}catch(b){}});
(function(){function a(g,i,n,m,p,q){p=0;for(var u=m.length;p<u;p++){var y=m[p];if(y){var F=false;for(y=y[g];y;){if(y.sizcache===n){F=m[y.sizset];break}if(y.nodeType===1&&!q){y.sizcache=n;y.sizset=p}if(y.nodeName.toLowerCase()===i){F=y;break}y=y[g]}m[p]=F}}}function b(g,i,n,m,p,q){p=0;for(var u=m.length;p<u;p++){var y=m[p];if(y){var F=false;for(y=y[g];y;){if(y.sizcache===n){F=m[y.sizset];break}if(y.nodeType===1){if(!q){y.sizcache=n;y.sizset=p}if(typeof i!=="string"){if(y===i){F=true;break}}else if(k.filter(i,
[y]).length>0){F=y;break}}y=y[g]}m[p]=F}}}var d=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,e=0,f=Object.prototype.toString,h=false,l=true;[0,0].sort(function(){l=false;return 0});var k=function(g,i,n,m){n=n||[];var p=i=i||t;if(i.nodeType!==1&&i.nodeType!==9)return[];if(!g||typeof g!=="string")return n;var q,u,y,F,M,N=true,O=k.isXML(i),D=[],R=g;do{d.exec("");if(q=d.exec(R)){R=q[3];D.push(q[1]);if(q[2]){F=q[3];
break}}}while(q);if(D.length>1&&x.exec(g))if(D.length===2&&o.relative[D[0]])u=L(D[0]+D[1],i);else for(u=o.relative[D[0]]?[i]:k(D.shift(),i);D.length;){g=D.shift();if(o.relative[g])g+=D.shift();u=L(g,u)}else{if(!m&&D.length>1&&i.nodeType===9&&!O&&o.match.ID.test(D[0])&&!o.match.ID.test(D[D.length-1])){q=k.find(D.shift(),i,O);i=q.expr?k.filter(q.expr,q.set)[0]:q.set[0]}if(i){q=m?{expr:D.pop(),set:C(m)}:k.find(D.pop(),D.length===1&&(D[0]==="~"||D[0]==="+")&&i.parentNode?i.parentNode:i,O);u=q.expr?k.filter(q.expr,
q.set):q.set;if(D.length>0)y=C(u);else N=false;for(;D.length;){q=M=D.pop();if(o.relative[M])q=D.pop();else M="";if(q==null)q=i;o.relative[M](y,q,O)}}else y=[]}y||(y=u);y||k.error(M||g);if(f.call(y)==="[object Array]")if(N)if(i&&i.nodeType===1)for(g=0;y[g]!=null;g++){if(y[g]&&(y[g]===true||y[g].nodeType===1&&k.contains(i,y[g])))n.push(u[g])}else for(g=0;y[g]!=null;g++)y[g]&&y[g].nodeType===1&&n.push(u[g]);else n.push.apply(n,y);else C(y,n);if(F){k(F,p,n,m);k.uniqueSort(n)}return n};k.uniqueSort=function(g){if(w){h=
l;g.sort(w);if(h)for(var i=1;i<g.length;i++)g[i]===g[i-1]&&g.splice(i--,1)}return g};k.matches=function(g,i){return k(g,null,null,i)};k.matchesSelector=function(g,i){return k(i,null,null,[g]).length>0};k.find=function(g,i,n){var m;if(!g)return[];for(var p=0,q=o.order.length;p<q;p++){var u,y=o.order[p];if(u=o.leftMatch[y].exec(g)){var F=u[1];u.splice(1,1);if(F.substr(F.length-1)!=="\\"){u[1]=(u[1]||"").replace(/\\/g,"");m=o.find[y](u,i,n);if(m!=null){g=g.replace(o.match[y],"");break}}}}m||(m=i.getElementsByTagName("*"));
return{set:m,expr:g}};k.filter=function(g,i,n,m){for(var p,q,u=g,y=[],F=i,M=i&&i[0]&&k.isXML(i[0]);g&&i.length;){for(var N in o.filter)if((p=o.leftMatch[N].exec(g))!=null&&p[2]){var O,D,R=o.filter[N];D=p[1];q=false;p.splice(1,1);if(D.substr(D.length-1)!=="\\"){if(F===y)y=[];if(o.preFilter[N])if(p=o.preFilter[N](p,F,n,y,m,M)){if(p===true)continue}else q=O=true;if(p)for(var j=0;(D=F[j])!=null;j++)if(D){O=R(D,p,j,F);var s=m^!!O;if(n&&O!=null)if(s)q=true;else F[j]=false;else if(s){y.push(D);q=true}}if(O!==
B){n||(F=y);g=g.replace(o.match[N],"");if(!q)return[];break}}}if(g===u)if(q==null)k.error(g);else break;u=g}return F};k.error=function(g){throw"Syntax error, unrecognized expression: "+g;};var o=k.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(['"]*)(.*?)\3|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\((even|odd|[\dn+\-]*)\))?/,
POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(g){return g.getAttribute("href")}},relative:{"+":function(g,i){var n=typeof i==="string",m=n&&!/\W/.test(i);n=n&&!m;if(m)i=i.toLowerCase();m=0;for(var p=g.length,q;m<p;m++)if(q=g[m]){for(;(q=q.previousSibling)&&q.nodeType!==1;);g[m]=n||q&&q.nodeName.toLowerCase()===
i?q||false:q===i}n&&k.filter(i,g,true)},">":function(g,i){var n,m=typeof i==="string",p=0,q=g.length;if(m&&!/\W/.test(i))for(i=i.toLowerCase();p<q;p++){if(n=g[p]){n=n.parentNode;g[p]=n.nodeName.toLowerCase()===i?n:false}}else{for(;p<q;p++)if(n=g[p])g[p]=m?n.parentNode:n.parentNode===i;m&&k.filter(i,g,true)}},"":function(g,i,n){var m,p=e++,q=b;if(typeof i==="string"&&!/\W/.test(i)){m=i=i.toLowerCase();q=a}q("parentNode",i,p,g,m,n)},"~":function(g,i,n){var m,p=e++,q=b;if(typeof i==="string"&&!/\W/.test(i)){m=
i=i.toLowerCase();q=a}q("previousSibling",i,p,g,m,n)}},find:{ID:function(g,i,n){if(typeof i.getElementById!=="undefined"&&!n)return(g=i.getElementById(g[1]))&&g.parentNode?[g]:[]},NAME:function(g,i){if(typeof i.getElementsByName!=="undefined"){for(var n=[],m=i.getElementsByName(g[1]),p=0,q=m.length;p<q;p++)m[p].getAttribute("name")===g[1]&&n.push(m[p]);return n.length===0?null:n}},TAG:function(g,i){return i.getElementsByTagName(g[1])}},preFilter:{CLASS:function(g,i,n,m,p,q){g=" "+g[1].replace(/\\/g,
"")+" ";if(q)return g;q=0;for(var u;(u=i[q])!=null;q++)if(u)if(p^(u.className&&(" "+u.className+" ").replace(/[\t\n]/g," ").indexOf(g)>=0))n||m.push(u);else if(n)i[q]=false;return false},ID:function(g){return g[1].replace(/\\/g,"")},TAG:function(g){return g[1].toLowerCase()},CHILD:function(g){if(g[1]==="nth"){var i=/(-?)(\d*)n((?:\+|-)?\d*)/.exec(g[2]==="even"&&"2n"||g[2]==="odd"&&"2n+1"||!/\D/.test(g[2])&&"0n+"+g[2]||g[2]);g[2]=i[1]+(i[2]||1)-0;g[3]=i[3]-0}g[0]=e++;return g},ATTR:function(g,i,n,
m,p,q){i=g[1].replace(/\\/g,"");if(!q&&o.attrMap[i])g[1]=o.attrMap[i];if(g[2]==="~=")g[4]=" "+g[4]+" ";return g},PSEUDO:function(g,i,n,m,p){if(g[1]==="not")if((d.exec(g[3])||"").length>1||/^\w/.test(g[3]))g[3]=k(g[3],null,null,i);else{g=k.filter(g[3],i,n,true^p);n||m.push.apply(m,g);return false}else if(o.match.POS.test(g[0])||o.match.CHILD.test(g[0]))return true;return g},POS:function(g){g.unshift(true);return g}},filters:{enabled:function(g){return g.disabled===false&&g.type!=="hidden"},disabled:function(g){return g.disabled===
true},checked:function(g){return g.checked===true},selected:function(g){return g.selected===true},parent:function(g){return!!g.firstChild},empty:function(g){return!g.firstChild},has:function(g,i,n){return!!k(n[3],g).length},header:function(g){return/h\d/i.test(g.nodeName)},text:function(g){return"text"===g.type},radio:function(g){return"radio"===g.type},checkbox:function(g){return"checkbox"===g.type},file:function(g){return"file"===g.type},password:function(g){return"password"===g.type},submit:function(g){return"submit"===
g.type},image:function(g){return"image"===g.type},reset:function(g){return"reset"===g.type},button:function(g){return"button"===g.type||g.nodeName.toLowerCase()==="button"},input:function(g){return/input|select|textarea|button/i.test(g.nodeName)}},setFilters:{first:function(g,i){return i===0},last:function(g,i,n,m){return i===m.length-1},even:function(g,i){return i%2===0},odd:function(g,i){return i%2===1},lt:function(g,i,n){return i<n[3]-0},gt:function(g,i,n){return i>n[3]-0},nth:function(g,i,n){return n[3]-
0===i},eq:function(g,i,n){return n[3]-0===i}},filter:{PSEUDO:function(g,i,n,m){var p=i[1],q=o.filters[p];if(q)return q(g,n,i,m);else if(p==="contains")return(g.textContent||g.innerText||k.getText([g])||"").indexOf(i[3])>=0;else if(p==="not"){i=i[3];n=0;for(m=i.length;n<m;n++)if(i[n]===g)return false;return true}else k.error("Syntax error, unrecognized expression: "+p)},CHILD:function(g,i){var n=i[1],m=g;switch(n){case "only":case "first":for(;m=m.previousSibling;)if(m.nodeType===1)return false;if(n===
"first")return true;m=g;case "last":for(;m=m.nextSibling;)if(m.nodeType===1)return false;return true;case "nth":n=i[2];var p=i[3];if(n===1&&p===0)return true;var q=i[0],u=g.parentNode;if(u&&(u.sizcache!==q||!g.nodeIndex)){var y=0;for(m=u.firstChild;m;m=m.nextSibling)if(m.nodeType===1)m.nodeIndex=++y;u.sizcache=q}m=g.nodeIndex-p;return n===0?m===0:m%n===0&&m/n>=0}},ID:function(g,i){return g.nodeType===1&&g.getAttribute("id")===i},TAG:function(g,i){return i==="*"&&g.nodeType===1||g.nodeName.toLowerCase()===
i},CLASS:function(g,i){return(" "+(g.className||g.getAttribute("class"))+" ").indexOf(i)>-1},ATTR:function(g,i){var n=i[1];n=o.attrHandle[n]?o.attrHandle[n](g):g[n]!=null?g[n]:g.getAttribute(n);var m=n+"",p=i[2],q=i[4];return n==null?p==="!=":p==="="?m===q:p==="*="?m.indexOf(q)>=0:p==="~="?(" "+m+" ").indexOf(q)>=0:!q?m&&n!==false:p==="!="?m!==q:p==="^="?m.indexOf(q)===0:p==="$="?m.substr(m.length-q.length)===q:p==="|="?m===q||m.substr(0,q.length+1)===q+"-":false},POS:function(g,i,n,m){var p=o.setFilters[i[2]];
if(p)return p(g,n,i,m)}}},x=o.match.POS,r=function(g,i){return"\\"+(i-0+1)},A;for(A in o.match){o.match[A]=RegExp(o.match[A].source+/(?![^\[]*\])(?![^\(]*\))/.source);o.leftMatch[A]=RegExp(/(^(?:.|\r|\n)*?)/.source+o.match[A].source.replace(/\\(\d+)/g,r))}var C=function(g,i){g=Array.prototype.slice.call(g,0);if(i){i.push.apply(i,g);return i}return g};try{Array.prototype.slice.call(t.documentElement.childNodes,0)}catch(J){C=function(g,i){var n=0,m=i||[];if(f.call(g)==="[object Array]")Array.prototype.push.apply(m,
g);else if(typeof g.length==="number")for(var p=g.length;n<p;n++)m.push(g[n]);else for(;g[n];n++)m.push(g[n]);return m}}var w,I;if(t.documentElement.compareDocumentPosition)w=function(g,i){if(g===i){h=true;return 0}if(!g.compareDocumentPosition||!i.compareDocumentPosition)return g.compareDocumentPosition?-1:1;return g.compareDocumentPosition(i)&4?-1:1};else{w=function(g,i){var n,m,p=[],q=[];n=g.parentNode;m=i.parentNode;var u=n;if(g===i){h=true;return 0}else if(n===m)return I(g,i);else if(n){if(!m)return 1}else return-1;
for(;u;){p.unshift(u);u=u.parentNode}for(u=m;u;){q.unshift(u);u=u.parentNode}n=p.length;m=q.length;for(u=0;u<n&&u<m;u++)if(p[u]!==q[u])return I(p[u],q[u]);return u===n?I(g,q[u],-1):I(p[u],i,1)};I=function(g,i,n){if(g===i)return n;for(g=g.nextSibling;g;){if(g===i)return-1;g=g.nextSibling}return 1}}k.getText=function(g){for(var i="",n,m=0;g[m];m++){n=g[m];if(n.nodeType===3||n.nodeType===4)i+=n.nodeValue;else if(n.nodeType!==8)i+=k.getText(n.childNodes)}return i};(function(){var g=t.createElement("div"),
i="script"+(new Date).getTime(),n=t.documentElement;g.innerHTML="<a name='"+i+"'/>";n.insertBefore(g,n.firstChild);if(t.getElementById(i)){o.find.ID=function(m,p,q){if(typeof p.getElementById!=="undefined"&&!q)return(p=p.getElementById(m[1]))?p.id===m[1]||typeof p.getAttributeNode!=="undefined"&&p.getAttributeNode("id").nodeValue===m[1]?[p]:B:[]};o.filter.ID=function(m,p){var q=typeof m.getAttributeNode!=="undefined"&&m.getAttributeNode("id");return m.nodeType===1&&q&&q.nodeValue===p}}n.removeChild(g);
n=g=null})();(function(){var g=t.createElement("div");g.appendChild(t.createComment(""));if(g.getElementsByTagName("*").length>0)o.find.TAG=function(i,n){var m=n.getElementsByTagName(i[1]);if(i[1]==="*"){for(var p=[],q=0;m[q];q++)m[q].nodeType===1&&p.push(m[q]);m=p}return m};g.innerHTML="<a href='#'></a>";if(g.firstChild&&typeof g.firstChild.getAttribute!=="undefined"&&g.firstChild.getAttribute("href")!=="#")o.attrHandle.href=function(i){return i.getAttribute("href",2)};g=null})();t.querySelectorAll&&
function(){var g=k,i=t.createElement("div");i.innerHTML="<p class='TEST'></p>";if(!(i.querySelectorAll&&i.querySelectorAll(".TEST").length===0)){k=function(m,p,q,u){p=p||t;m=m.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!u&&!k.isXML(p))if(p.nodeType===9)try{return C(p.querySelectorAll(m),q)}catch(y){}else if(p.nodeType===1&&p.nodeName.toLowerCase()!=="object"){var F=p.getAttribute("id"),M=F||"__sizzle__";F||p.setAttribute("id",M);try{return C(p.querySelectorAll("#"+M+" "+m),q)}catch(N){}finally{F||
p.removeAttribute("id")}}return g(m,p,q,u)};for(var n in g)k[n]=g[n];i=null}}();(function(){var g=t.documentElement,i=g.matchesSelector||g.mozMatchesSelector||g.webkitMatchesSelector||g.msMatchesSelector,n=false;try{i.call(t.documentElement,"[test!='']:sizzle")}catch(m){n=true}if(i)k.matchesSelector=function(p,q){q=q.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!k.isXML(p))try{if(n||!o.match.PSEUDO.test(q)&&!/!=/.test(q))return i.call(p,q)}catch(u){}return k(q,null,null,[p]).length>0}})();(function(){var g=
t.createElement("div");g.innerHTML="<div class='test e'></div><div class='test'></div>";if(!(!g.getElementsByClassName||g.getElementsByClassName("e").length===0)){g.lastChild.className="e";if(g.getElementsByClassName("e").length!==1){o.order.splice(1,0,"CLASS");o.find.CLASS=function(i,n,m){if(typeof n.getElementsByClassName!=="undefined"&&!m)return n.getElementsByClassName(i[1])};g=null}}})();k.contains=t.documentElement.contains?function(g,i){return g!==i&&(g.contains?g.contains(i):true)}:t.documentElement.compareDocumentPosition?
function(g,i){return!!(g.compareDocumentPosition(i)&16)}:function(){return false};k.isXML=function(g){return(g=(g?g.ownerDocument||g:0).documentElement)?g.nodeName!=="HTML":false};var L=function(g,i){for(var n,m=[],p="",q=i.nodeType?[i]:i;n=o.match.PSEUDO.exec(g);){p+=n[0];g=g.replace(o.match.PSEUDO,"")}g=o.relative[g]?g+"*":g;n=0;for(var u=q.length;n<u;n++)k(g,q[n],m);return k.filter(p,m)};c.find=k;c.expr=k.selectors;c.expr[":"]=c.expr.filters;c.unique=k.uniqueSort;c.text=k.getText;c.isXMLDoc=k.isXML;
c.contains=k.contains})();var Za=/Until$/,$a=/^(?:parents|prevUntil|prevAll)/,ab=/,/,Na=/^.[^:#\[\.,]*$/,bb=Array.prototype.slice,cb=c.expr.match.POS;c.fn.extend({find:function(a){for(var b=this.pushStack("","find",a),d=0,e=0,f=this.length;e<f;e++){d=b.length;c.find(a,this[e],b);if(e>0)for(var h=d;h<b.length;h++)for(var l=0;l<d;l++)if(b[l]===b[h]){b.splice(h--,1);break}}return b},has:function(a){var b=c(a);return this.filter(function(){for(var d=0,e=b.length;d<e;d++)if(c.contains(this,b[d]))return true})},
not:function(a){return this.pushStack(ma(this,a,false),"not",a)},filter:function(a){return this.pushStack(ma(this,a,true),"filter",a)},is:function(a){return!!a&&c.filter(a,this).length>0},closest:function(a,b){var d=[],e,f,h=this[0];if(c.isArray(a)){var l,k={},o=1;if(h&&a.length){e=0;for(f=a.length;e<f;e++){l=a[e];k[l]||(k[l]=c.expr.match.POS.test(l)?c(l,b||this.context):l)}for(;h&&h.ownerDocument&&h!==b;){for(l in k){e=k[l];if(e.jquery?e.index(h)>-1:c(h).is(e))d.push({selector:l,elem:h,level:o})}h=
h.parentNode;o++}}return d}l=cb.test(a)?c(a,b||this.context):null;e=0;for(f=this.length;e<f;e++)for(h=this[e];h;)if(l?l.index(h)>-1:c.find.matchesSelector(h,a)){d.push(h);break}else{h=h.parentNode;if(!h||!h.ownerDocument||h===b)break}d=d.length>1?c.unique(d):d;return this.pushStack(d,"closest",a)},index:function(a){if(!a||typeof a==="string")return c.inArray(this[0],a?c(a):this.parent().children());return c.inArray(a.jquery?a[0]:a,this)},add:function(a,b){var d=typeof a==="string"?c(a,b||this.context):
c.makeArray(a),e=c.merge(this.get(),d);return this.pushStack(!d[0]||!d[0].parentNode||d[0].parentNode.nodeType===11||!e[0]||!e[0].parentNode||e[0].parentNode.nodeType===11?e:c.unique(e))},andSelf:function(){return this.add(this.prevObject)}});c.each({parent:function(a){return(a=a.parentNode)&&a.nodeType!==11?a:null},parents:function(a){return c.dir(a,"parentNode")},parentsUntil:function(a,b,d){return c.dir(a,"parentNode",d)},next:function(a){return c.nth(a,2,"nextSibling")},prev:function(a){return c.nth(a,
2,"previousSibling")},nextAll:function(a){return c.dir(a,"nextSibling")},prevAll:function(a){return c.dir(a,"previousSibling")},nextUntil:function(a,b,d){return c.dir(a,"nextSibling",d)},prevUntil:function(a,b,d){return c.dir(a,"previousSibling",d)},siblings:function(a){return c.sibling(a.parentNode.firstChild,a)},children:function(a){return c.sibling(a.firstChild)},contents:function(a){return c.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:c.makeArray(a.childNodes)}},function(a,
b){c.fn[a]=function(d,e){var f=c.map(this,b,d);Za.test(a)||(e=d);if(e&&typeof e==="string")f=c.filter(e,f);f=this.length>1?c.unique(f):f;if((this.length>1||ab.test(e))&&$a.test(a))f=f.reverse();return this.pushStack(f,a,bb.call(arguments).join(","))}});c.extend({filter:function(a,b,d){if(d)a=":not("+a+")";return b.length===1?c.find.matchesSelector(b[0],a)?[b[0]]:[]:c.find.matches(a,b)},dir:function(a,b,d){var e=[];for(a=a[b];a&&a.nodeType!==9&&(d===B||a.nodeType!==1||!c(a).is(d));){a.nodeType===1&&
e.push(a);a=a[b]}return e},nth:function(a,b,d){b=b||1;for(var e=0;a;a=a[d])if(a.nodeType===1&&++e===b)break;return a},sibling:function(a,b){for(var d=[];a;a=a.nextSibling)a.nodeType===1&&a!==b&&d.push(a);return d}});var za=/ jQuery\d+="(?:\d+|null)"/g,$=/^\s+/,Aa=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,Ba=/<([\w:]+)/,db=/<tbody/i,eb=/<|&#?\w+;/,Ca=/<(?:script|object|embed|option|style)/i,Da=/checked\s*(?:[^=]|=\s*.checked.)/i,fb=/\=([^="'>\s]+\/)>/g,P={option:[1,
"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]};P.optgroup=P.option;P.tbody=P.tfoot=P.colgroup=P.caption=P.thead;P.th=P.td;if(!c.support.htmlSerialize)P._default=[1,"div<div>","</div>"];c.fn.extend({text:function(a){if(c.isFunction(a))return this.each(function(b){var d=
c(this);d.text(a.call(this,b,d.text()))});if(typeof a!=="object"&&a!==B)return this.empty().append((this[0]&&this[0].ownerDocument||t).createTextNode(a));return c.text(this)},wrapAll:function(a){if(c.isFunction(a))return this.each(function(d){c(this).wrapAll(a.call(this,d))});if(this[0]){var b=c(a,this[0].ownerDocument).eq(0).clone(true);this[0].parentNode&&b.insertBefore(this[0]);b.map(function(){for(var d=this;d.firstChild&&d.firstChild.nodeType===1;)d=d.firstChild;return d}).append(this)}return this},
wrapInner:function(a){if(c.isFunction(a))return this.each(function(b){c(this).wrapInner(a.call(this,b))});return this.each(function(){var b=c(this),d=b.contents();d.length?d.wrapAll(a):b.append(a)})},wrap:function(a){return this.each(function(){c(this).wrapAll(a)})},unwrap:function(){return this.parent().each(function(){c.nodeName(this,"body")||c(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,true,function(a){this.nodeType===1&&this.appendChild(a)})},
prepend:function(){return this.domManip(arguments,true,function(a){this.nodeType===1&&this.insertBefore(a,this.firstChild)})},before:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,false,function(b){this.parentNode.insertBefore(b,this)});else if(arguments.length){var a=c(arguments[0]);a.push.apply(a,this.toArray());return this.pushStack(a,"before",arguments)}},after:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,false,function(b){this.parentNode.insertBefore(b,
this.nextSibling)});else if(arguments.length){var a=this.pushStack(this,"after",arguments);a.push.apply(a,c(arguments[0]).toArray());return a}},remove:function(a,b){for(var d=0,e;(e=this[d])!=null;d++)if(!a||c.filter(a,[e]).length){if(!b&&e.nodeType===1){c.cleanData(e.getElementsByTagName("*"));c.cleanData([e])}e.parentNode&&e.parentNode.removeChild(e)}return this},empty:function(){for(var a=0,b;(b=this[a])!=null;a++)for(b.nodeType===1&&c.cleanData(b.getElementsByTagName("*"));b.firstChild;)b.removeChild(b.firstChild);
return this},clone:function(a){var b=this.map(function(){if(!c.support.noCloneEvent&&!c.isXMLDoc(this)){var d=this.outerHTML,e=this.ownerDocument;if(!d){d=e.createElement("div");d.appendChild(this.cloneNode(true));d=d.innerHTML}return c.clean([d.replace(za,"").replace(fb,'="$1">').replace($,"")],e)[0]}else return this.cloneNode(true)});if(a===true){na(this,b);na(this.find("*"),b.find("*"))}return b},html:function(a){if(a===B)return this[0]&&this[0].nodeType===1?this[0].innerHTML.replace(za,""):null;
else if(typeof a==="string"&&!Ca.test(a)&&(c.support.leadingWhitespace||!$.test(a))&&!P[(Ba.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(Aa,"<$1></$2>");try{for(var b=0,d=this.length;b<d;b++)if(this[b].nodeType===1){c.cleanData(this[b].getElementsByTagName("*"));this[b].innerHTML=a}}catch(e){this.empty().append(a)}}else c.isFunction(a)?this.each(function(f){var h=c(this);h.html(a.call(this,f,h.html()))}):this.empty().append(a);return this},replaceWith:function(a){if(this[0]&&this[0].parentNode){if(c.isFunction(a))return this.each(function(b){var d=
c(this),e=d.html();d.replaceWith(a.call(this,b,e))});if(typeof a!=="string")a=c(a).detach();return this.each(function(){var b=this.nextSibling,d=this.parentNode;c(this).remove();b?c(b).before(a):c(d).append(a)})}else return this.pushStack(c(c.isFunction(a)?a():a),"replaceWith",a)},detach:function(a){return this.remove(a,true)},domManip:function(a,b,d){var e,f,h,l=a[0],k=[];if(!c.support.checkClone&&arguments.length===3&&typeof l==="string"&&Da.test(l))return this.each(function(){c(this).domManip(a,
b,d,true)});if(c.isFunction(l))return this.each(function(x){var r=c(this);a[0]=l.call(this,x,b?r.html():B);r.domManip(a,b,d)});if(this[0]){e=l&&l.parentNode;e=c.support.parentNode&&e&&e.nodeType===11&&e.childNodes.length===this.length?{fragment:e}:c.buildFragment(a,this,k);h=e.fragment;if(f=h.childNodes.length===1?h=h.firstChild:h.firstChild){b=b&&c.nodeName(f,"tr");f=0;for(var o=this.length;f<o;f++)d.call(b?c.nodeName(this[f],"table")?this[f].getElementsByTagName("tbody")[0]||this[f].appendChild(this[f].ownerDocument.createElement("tbody")):
this[f]:this[f],f>0||e.cacheable||this.length>1?h.cloneNode(true):h)}k.length&&c.each(k,Oa)}return this}});c.buildFragment=function(a,b,d){var e,f,h;b=b&&b[0]?b[0].ownerDocument||b[0]:t;if(a.length===1&&typeof a[0]==="string"&&a[0].length<512&&b===t&&!Ca.test(a[0])&&(c.support.checkClone||!Da.test(a[0]))){f=true;if(h=c.fragments[a[0]])if(h!==1)e=h}if(!e){e=b.createDocumentFragment();c.clean(a,b,e,d)}if(f)c.fragments[a[0]]=h?e:1;return{fragment:e,cacheable:f}};c.fragments={};c.each({appendTo:"append",
prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){c.fn[a]=function(d){var e=[];d=c(d);var f=this.length===1&&this[0].parentNode;if(f&&f.nodeType===11&&f.childNodes.length===1&&d.length===1){d[b](this[0]);return this}else{f=0;for(var h=d.length;f<h;f++){var l=(f>0?this.clone(true):this).get();c(d[f])[b](l);e=e.concat(l)}return this.pushStack(e,a,d.selector)}}});c.extend({clean:function(a,b,d,e){b=b||t;if(typeof b.createElement==="undefined")b=b.ownerDocument||
b[0]&&b[0].ownerDocument||t;for(var f=[],h=0,l;(l=a[h])!=null;h++){if(typeof l==="number")l+="";if(l){if(typeof l==="string"&&!eb.test(l))l=b.createTextNode(l);else if(typeof l==="string"){l=l.replace(Aa,"<$1></$2>");var k=(Ba.exec(l)||["",""])[1].toLowerCase(),o=P[k]||P._default,x=o[0],r=b.createElement("div");for(r.innerHTML=o[1]+l+o[2];x--;)r=r.lastChild;if(!c.support.tbody){x=db.test(l);k=k==="table"&&!x?r.firstChild&&r.firstChild.childNodes:o[1]==="<table>"&&!x?r.childNodes:[];for(o=k.length-
1;o>=0;--o)c.nodeName(k[o],"tbody")&&!k[o].childNodes.length&&k[o].parentNode.removeChild(k[o])}!c.support.leadingWhitespace&&$.test(l)&&r.insertBefore(b.createTextNode($.exec(l)[0]),r.firstChild);l=r.childNodes}if(l.nodeType)f.push(l);else f=c.merge(f,l)}}if(d)for(h=0;f[h];h++)if(e&&c.nodeName(f[h],"script")&&(!f[h].type||f[h].type.toLowerCase()==="text/javascript"))e.push(f[h].parentNode?f[h].parentNode.removeChild(f[h]):f[h]);else{f[h].nodeType===1&&f.splice.apply(f,[h+1,0].concat(c.makeArray(f[h].getElementsByTagName("script"))));
d.appendChild(f[h])}return f},cleanData:function(a){for(var b,d,e=c.cache,f=c.event.special,h=c.support.deleteExpando,l=0,k;(k=a[l])!=null;l++)if(!(k.nodeName&&c.noData[k.nodeName.toLowerCase()]))if(d=k[c.expando]){if((b=e[d])&&b.events)for(var o in b.events)f[o]?c.event.remove(k,o):c.removeEvent(k,o,b.handle);if(h)delete k[c.expando];else k.removeAttribute&&k.removeAttribute(c.expando);delete e[d]}}});var Ea=/alpha\([^)]*\)/i,gb=/opacity=([^)]*)/,hb=/-([a-z])/ig,ib=/([A-Z])/g,Fa=/^-?\d+(?:px)?$/i,
jb=/^-?\d/,kb={position:"absolute",visibility:"hidden",display:"block"},Pa=["Left","Right"],Qa=["Top","Bottom"],W,Ga,aa,lb=function(a,b){return b.toUpperCase()};c.fn.css=function(a,b){if(arguments.length===2&&b===B)return this;return c.access(this,a,b,true,function(d,e,f){return f!==B?c.style(d,e,f):c.css(d,e)})};c.extend({cssHooks:{opacity:{get:function(a,b){if(b){var d=W(a,"opacity","opacity");return d===""?"1":d}else return a.style.opacity}}},cssNumber:{zIndex:true,fontWeight:true,opacity:true,
zoom:true,lineHeight:true},cssProps:{"float":c.support.cssFloat?"cssFloat":"styleFloat"},style:function(a,b,d,e){if(!(!a||a.nodeType===3||a.nodeType===8||!a.style)){var f,h=c.camelCase(b),l=a.style,k=c.cssHooks[h];b=c.cssProps[h]||h;if(d!==B){if(!(typeof d==="number"&&isNaN(d)||d==null)){if(typeof d==="number"&&!c.cssNumber[h])d+="px";if(!k||!("set"in k)||(d=k.set(a,d))!==B)try{l[b]=d}catch(o){}}}else{if(k&&"get"in k&&(f=k.get(a,false,e))!==B)return f;return l[b]}}},css:function(a,b,d){var e,f=c.camelCase(b),
h=c.cssHooks[f];b=c.cssProps[f]||f;if(h&&"get"in h&&(e=h.get(a,true,d))!==B)return e;else if(W)return W(a,b,f)},swap:function(a,b,d){var e={},f;for(f in b){e[f]=a.style[f];a.style[f]=b[f]}d.call(a);for(f in b)a.style[f]=e[f]},camelCase:function(a){return a.replace(hb,lb)}});c.curCSS=c.css;c.each(["height","width"],function(a,b){c.cssHooks[b]={get:function(d,e,f){var h;if(e){if(d.offsetWidth!==0)h=oa(d,b,f);else c.swap(d,kb,function(){h=oa(d,b,f)});if(h<=0){h=W(d,b,b);if(h==="0px"&&aa)h=aa(d,b,b);
if(h!=null)return h===""||h==="auto"?"0px":h}if(h<0||h==null){h=d.style[b];return h===""||h==="auto"?"0px":h}return typeof h==="string"?h:h+"px"}},set:function(d,e){if(Fa.test(e)){e=parseFloat(e);if(e>=0)return e+"px"}else return e}}});if(!c.support.opacity)c.cssHooks.opacity={get:function(a,b){return gb.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?parseFloat(RegExp.$1)/100+"":b?"1":""},set:function(a,b){var d=a.style;d.zoom=1;var e=c.isNaN(b)?"":"alpha(opacity="+b*100+")",f=
d.filter||"";d.filter=Ea.test(f)?f.replace(Ea,e):d.filter+" "+e}};if(t.defaultView&&t.defaultView.getComputedStyle)Ga=function(a,b,d){var e;d=d.replace(ib,"-$1").toLowerCase();if(!(b=a.ownerDocument.defaultView))return B;if(b=b.getComputedStyle(a,null)){e=b.getPropertyValue(d);if(e===""&&!c.contains(a.ownerDocument.documentElement,a))e=c.style(a,d)}return e};if(t.documentElement.currentStyle)aa=function(a,b){var d,e,f=a.currentStyle&&a.currentStyle[b],h=a.style;if(!Fa.test(f)&&jb.test(f)){d=h.left;
e=a.runtimeStyle.left;a.runtimeStyle.left=a.currentStyle.left;h.left=b==="fontSize"?"1em":f||0;f=h.pixelLeft+"px";h.left=d;a.runtimeStyle.left=e}return f===""?"auto":f};W=Ga||aa;if(c.expr&&c.expr.filters){c.expr.filters.hidden=function(a){var b=a.offsetHeight;return a.offsetWidth===0&&b===0||!c.support.reliableHiddenOffsets&&(a.style.display||c.css(a,"display"))==="none"};c.expr.filters.visible=function(a){return!c.expr.filters.hidden(a)}}var mb=c.now(),nb=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
ob=/^(?:select|textarea)/i,pb=/^(?:color|date|datetime|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,qb=/^(?:GET|HEAD)$/,Ra=/\[\]$/,T=/\=\?(&|$)/,ja=/\?/,rb=/([?&])_=[^&]*/,sb=/^(\w+:)?\/\/([^\/?#]+)/,tb=/%20/g,ub=/#.*$/,Ha=c.fn.load;c.fn.extend({load:function(a,b,d){if(typeof a!=="string"&&Ha)return Ha.apply(this,arguments);else if(!this.length)return this;var e=a.indexOf(" ");if(e>=0){var f=a.slice(e,a.length);a=a.slice(0,e)}e="GET";if(b)if(c.isFunction(b)){d=b;b=null}else if(typeof b===
"object"){b=c.param(b,c.ajaxSettings.traditional);e="POST"}var h=this;c.ajax({url:a,type:e,dataType:"html",data:b,complete:function(l,k){if(k==="success"||k==="notmodified")h.html(f?c("<div>").append(l.responseText.replace(nb,"")).find(f):l.responseText);d&&h.each(d,[l.responseText,k,l])}});return this},serialize:function(){return c.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?c.makeArray(this.elements):this}).filter(function(){return this.name&&
!this.disabled&&(this.checked||ob.test(this.nodeName)||pb.test(this.type))}).map(function(a,b){var d=c(this).val();return d==null?null:c.isArray(d)?c.map(d,function(e){return{name:b.name,value:e}}):{name:b.name,value:d}}).get()}});c.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(a,b){c.fn[b]=function(d){return this.bind(b,d)}});c.extend({get:function(a,b,d,e){if(c.isFunction(b)){e=e||d;d=b;b=null}return c.ajax({type:"GET",url:a,data:b,success:d,dataType:e})},
getScript:function(a,b){return c.get(a,null,b,"script")},getJSON:function(a,b,d){return c.get(a,b,d,"json")},post:function(a,b,d,e){if(c.isFunction(b)){e=e||d;d=b;b={}}return c.ajax({type:"POST",url:a,data:b,success:d,dataType:e})},ajaxSetup:function(a){c.extend(c.ajaxSettings,a)},ajaxSettings:{url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new E.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",
script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},ajax:function(a){var b=c.extend(true,{},c.ajaxSettings,a),d,e,f,h=b.type.toUpperCase(),l=qb.test(h);b.url=b.url.replace(ub,"");b.context=a&&a.context!=null?a.context:b;if(b.data&&b.processData&&typeof b.data!=="string")b.data=c.param(b.data,b.traditional);if(b.dataType==="jsonp"){if(h==="GET")T.test(b.url)||(b.url+=(ja.test(b.url)?"&":"?")+(b.jsonp||"callback")+"=?");else if(!b.data||
!T.test(b.data))b.data=(b.data?b.data+"&":"")+(b.jsonp||"callback")+"=?";b.dataType="json"}if(b.dataType==="json"&&(b.data&&T.test(b.data)||T.test(b.url))){d=b.jsonpCallback||"jsonp"+mb++;if(b.data)b.data=(b.data+"").replace(T,"="+d+"$1");b.url=b.url.replace(T,"="+d+"$1");b.dataType="script";var k=E[d];E[d]=function(m){if(c.isFunction(k))k(m);else{E[d]=B;try{delete E[d]}catch(p){}}f=m;c.handleSuccess(b,w,e,f);c.handleComplete(b,w,e,f);r&&r.removeChild(A)}}if(b.dataType==="script"&&b.cache===null)b.cache=
false;if(b.cache===false&&l){var o=c.now(),x=b.url.replace(rb,"$1_="+o);b.url=x+(x===b.url?(ja.test(b.url)?"&":"?")+"_="+o:"")}if(b.data&&l)b.url+=(ja.test(b.url)?"&":"?")+b.data;b.global&&c.active++===0&&c.event.trigger("ajaxStart");o=(o=sb.exec(b.url))&&(o[1]&&o[1].toLowerCase()!==location.protocol||o[2].toLowerCase()!==location.host);if(b.dataType==="script"&&h==="GET"&&o){var r=t.getElementsByTagName("head")[0]||t.documentElement,A=t.createElement("script");if(b.scriptCharset)A.charset=b.scriptCharset;
A.src=b.url;if(!d){var C=false;A.onload=A.onreadystatechange=function(){if(!C&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){C=true;c.handleSuccess(b,w,e,f);c.handleComplete(b,w,e,f);A.onload=A.onreadystatechange=null;r&&A.parentNode&&r.removeChild(A)}}}r.insertBefore(A,r.firstChild);return B}var J=false,w=b.xhr();if(w){b.username?w.open(h,b.url,b.async,b.username,b.password):w.open(h,b.url,b.async);try{if(b.data!=null&&!l||a&&a.contentType)w.setRequestHeader("Content-Type",
b.contentType);if(b.ifModified){c.lastModified[b.url]&&w.setRequestHeader("If-Modified-Since",c.lastModified[b.url]);c.etag[b.url]&&w.setRequestHeader("If-None-Match",c.etag[b.url])}o||w.setRequestHeader("X-Requested-With","XMLHttpRequest");w.setRequestHeader("Accept",b.dataType&&b.accepts[b.dataType]?b.accepts[b.dataType]+", */*; q=0.01":b.accepts._default)}catch(I){}if(b.beforeSend&&b.beforeSend.call(b.context,w,b)===false){b.global&&c.active--===1&&c.event.trigger("ajaxStop");w.abort();return false}b.global&&
c.triggerGlobal(b,"ajaxSend",[w,b]);var L=w.onreadystatechange=function(m){if(!w||w.readyState===0||m==="abort"){J||c.handleComplete(b,w,e,f);J=true;if(w)w.onreadystatechange=c.noop}else if(!J&&w&&(w.readyState===4||m==="timeout")){J=true;w.onreadystatechange=c.noop;e=m==="timeout"?"timeout":!c.httpSuccess(w)?"error":b.ifModified&&c.httpNotModified(w,b.url)?"notmodified":"success";var p;if(e==="success")try{f=c.httpData(w,b.dataType,b)}catch(q){e="parsererror";p=q}if(e==="success"||e==="notmodified")d||
c.handleSuccess(b,w,e,f);else c.handleError(b,w,e,p);d||c.handleComplete(b,w,e,f);m==="timeout"&&w.abort();if(b.async)w=null}};try{var g=w.abort;w.abort=function(){w&&Function.prototype.call.call(g,w);L("abort")}}catch(i){}b.async&&b.timeout>0&&setTimeout(function(){w&&!J&&L("timeout")},b.timeout);try{w.send(l||b.data==null?null:b.data)}catch(n){c.handleError(b,w,null,n);c.handleComplete(b,w,e,f)}b.async||L();return w}},param:function(a,b){var d=[],e=function(h,l){l=c.isFunction(l)?l():l;d[d.length]=
encodeURIComponent(h)+"="+encodeURIComponent(l)};if(b===B)b=c.ajaxSettings.traditional;if(c.isArray(a)||a.jquery)c.each(a,function(){e(this.name,this.value)});else for(var f in a)da(f,a[f],b,e);return d.join("&").replace(tb,"+")}});c.extend({active:0,lastModified:{},etag:{},handleError:function(a,b,d,e){a.error&&a.error.call(a.context,b,d,e);a.global&&c.triggerGlobal(a,"ajaxError",[b,a,e])},handleSuccess:function(a,b,d,e){a.success&&a.success.call(a.context,e,d,b);a.global&&c.triggerGlobal(a,"ajaxSuccess",
[b,a])},handleComplete:function(a,b,d){a.complete&&a.complete.call(a.context,b,d);a.global&&c.triggerGlobal(a,"ajaxComplete",[b,a]);a.global&&c.active--===1&&c.event.trigger("ajaxStop")},triggerGlobal:function(a,b,d){(a.context&&a.context.url==null?c(a.context):c.event).trigger(b,d)},httpSuccess:function(a){try{return!a.status&&location.protocol==="file:"||a.status>=200&&a.status<300||a.status===304||a.status===1223}catch(b){}return false},httpNotModified:function(a,b){var d=a.getResponseHeader("Last-Modified"),
e=a.getResponseHeader("Etag");if(d)c.lastModified[b]=d;if(e)c.etag[b]=e;return a.status===304},httpData:function(a,b,d){var e=a.getResponseHeader("content-type")||"",f=b==="xml"||!b&&e.indexOf("xml")>=0;a=f?a.responseXML:a.responseText;f&&a.documentElement.nodeName==="parsererror"&&c.error("parsererror");if(d&&d.dataFilter)a=d.dataFilter(a,b);if(typeof a==="string")if(b==="json"||!b&&e.indexOf("json")>=0)a=c.parseJSON(a);else if(b==="script"||!b&&e.indexOf("javascript")>=0)c.globalEval(a);return a}});
if(E.ActiveXObject)c.ajaxSettings.xhr=function(){if(E.location.protocol!=="file:")try{return new E.XMLHttpRequest}catch(a){}try{return new E.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}};c.support.ajax=!!c.ajaxSettings.xhr();var ea={},vb=/^(?:toggle|show|hide)$/,wb=/^([+\-]=)?([\d+.\-]+)(.*)$/,ba,pa=[["height","marginTop","marginBottom","paddingTop","paddingBottom"],["width","marginLeft","marginRight","paddingLeft","paddingRight"],["opacity"]];c.fn.extend({show:function(a,b,d){if(a||a===0)return this.animate(S("show",
3),a,b,d);else{d=0;for(var e=this.length;d<e;d++){a=this[d];b=a.style.display;if(!c.data(a,"olddisplay")&&b==="none")b=a.style.display="";b===""&&c.css(a,"display")==="none"&&c.data(a,"olddisplay",qa(a.nodeName))}for(d=0;d<e;d++){a=this[d];b=a.style.display;if(b===""||b==="none")a.style.display=c.data(a,"olddisplay")||""}return this}},hide:function(a,b,d){if(a||a===0)return this.animate(S("hide",3),a,b,d);else{a=0;for(b=this.length;a<b;a++){d=c.css(this[a],"display");d!=="none"&&c.data(this[a],"olddisplay",
d)}for(a=0;a<b;a++)this[a].style.display="none";return this}},_toggle:c.fn.toggle,toggle:function(a,b,d){var e=typeof a==="boolean";if(c.isFunction(a)&&c.isFunction(b))this._toggle.apply(this,arguments);else a==null||e?this.each(function(){var f=e?a:c(this).is(":hidden");c(this)[f?"show":"hide"]()}):this.animate(S("toggle",3),a,b,d);return this},fadeTo:function(a,b,d,e){return this.filter(":hidden").css("opacity",0).show().end().animate({opacity:b},a,d,e)},animate:function(a,b,d,e){var f=c.speed(b,
d,e);if(c.isEmptyObject(a))return this.each(f.complete);return this[f.queue===false?"each":"queue"](function(){var h=c.extend({},f),l,k=this.nodeType===1,o=k&&c(this).is(":hidden"),x=this;for(l in a){var r=c.camelCase(l);if(l!==r){a[r]=a[l];delete a[l];l=r}if(a[l]==="hide"&&o||a[l]==="show"&&!o)return h.complete.call(this);if(k&&(l==="height"||l==="width")){h.overflow=[this.style.overflow,this.style.overflowX,this.style.overflowY];if(c.css(this,"display")==="inline"&&c.css(this,"float")==="none")if(c.support.inlineBlockNeedsLayout)if(qa(this.nodeName)===
"inline")this.style.display="inline-block";else{this.style.display="inline";this.style.zoom=1}else this.style.display="inline-block"}if(c.isArray(a[l])){(h.specialEasing=h.specialEasing||{})[l]=a[l][1];a[l]=a[l][0]}}if(h.overflow!=null)this.style.overflow="hidden";h.curAnim=c.extend({},a);c.each(a,function(A,C){var J=new c.fx(x,h,A);if(vb.test(C))J[C==="toggle"?o?"show":"hide":C](a);else{var w=wb.exec(C),I=J.cur()||0;if(w){var L=parseFloat(w[2]),g=w[3]||"px";if(g!=="px"){c.style(x,A,(L||1)+g);I=(L||
1)/J.cur()*I;c.style(x,A,I+g)}if(w[1])L=(w[1]==="-="?-1:1)*L+I;J.custom(I,L,g)}else J.custom(I,C,"")}});return true})},stop:function(a,b){var d=c.timers;a&&this.queue([]);this.each(function(){for(var e=d.length-1;e>=0;e--)if(d[e].elem===this){b&&d[e](true);d.splice(e,1)}});b||this.dequeue();return this}});c.each({slideDown:S("show",1),slideUp:S("hide",1),slideToggle:S("toggle",1),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){c.fn[a]=function(d,e,f){return this.animate(b,
d,e,f)}});c.extend({speed:function(a,b,d){var e=a&&typeof a==="object"?c.extend({},a):{complete:d||!d&&b||c.isFunction(a)&&a,duration:a,easing:d&&b||b&&!c.isFunction(b)&&b};e.duration=c.fx.off?0:typeof e.duration==="number"?e.duration:e.duration in c.fx.speeds?c.fx.speeds[e.duration]:c.fx.speeds._default;e.old=e.complete;e.complete=function(){e.queue!==false&&c(this).dequeue();c.isFunction(e.old)&&e.old.call(this)};return e},easing:{linear:function(a,b,d,e){return d+e*a},swing:function(a,b,d,e){return(-Math.cos(a*
Math.PI)/2+0.5)*e+d}},timers:[],fx:function(a,b,d){this.options=b;this.elem=a;this.prop=d;if(!b.orig)b.orig={}}});c.fx.prototype={update:function(){this.options.step&&this.options.step.call(this.elem,this.now,this);(c.fx.step[this.prop]||c.fx.step._default)(this)},cur:function(){if(this.elem[this.prop]!=null&&(!this.elem.style||this.elem.style[this.prop]==null))return this.elem[this.prop];var a=parseFloat(c.css(this.elem,this.prop));return a&&a>-1E4?a:0},custom:function(a,b,d){function e(l){return f.step(l)}
var f=this,h=c.fx;this.startTime=c.now();this.start=a;this.end=b;this.unit=d||this.unit||"px";this.now=this.start;this.pos=this.state=0;e.elem=this.elem;if(e()&&c.timers.push(e)&&!ba)ba=setInterval(h.tick,h.interval)},show:function(){this.options.orig[this.prop]=c.style(this.elem,this.prop);this.options.show=true;this.custom(this.prop==="width"||this.prop==="height"?1:0,this.cur());c(this.elem).show()},hide:function(){this.options.orig[this.prop]=c.style(this.elem,this.prop);this.options.hide=true;
this.custom(this.cur(),0)},step:function(a){var b=c.now(),d=true;if(a||b>=this.options.duration+this.startTime){this.now=this.end;this.pos=this.state=1;this.update();this.options.curAnim[this.prop]=true;for(var e in this.options.curAnim)if(this.options.curAnim[e]!==true)d=false;if(d){if(this.options.overflow!=null&&!c.support.shrinkWrapBlocks){var f=this.elem,h=this.options;c.each(["","X","Y"],function(k,o){f.style["overflow"+o]=h.overflow[k]})}this.options.hide&&c(this.elem).hide();if(this.options.hide||
this.options.show)for(var l in this.options.curAnim)c.style(this.elem,l,this.options.orig[l]);this.options.complete.call(this.elem)}return false}else{a=b-this.startTime;this.state=a/this.options.duration;b=this.options.easing||(c.easing.swing?"swing":"linear");this.pos=c.easing[this.options.specialEasing&&this.options.specialEasing[this.prop]||b](this.state,a,0,1,this.options.duration);this.now=this.start+(this.end-this.start)*this.pos;this.update()}return true}};c.extend(c.fx,{tick:function(){for(var a=
c.timers,b=0;b<a.length;b++)a[b]()||a.splice(b--,1);a.length||c.fx.stop()},interval:13,stop:function(){clearInterval(ba);ba=null},speeds:{slow:600,fast:200,_default:400},step:{opacity:function(a){c.style(a.elem,"opacity",a.now)},_default:function(a){if(a.elem.style&&a.elem.style[a.prop]!=null)a.elem.style[a.prop]=(a.prop==="width"||a.prop==="height"?Math.max(0,a.now):a.now)+a.unit;else a.elem[a.prop]=a.now}}});if(c.expr&&c.expr.filters)c.expr.filters.animated=function(a){return c.grep(c.timers,function(b){return a===
b.elem}).length};var xb=/^t(?:able|d|h)$/i,Ia=/^(?:body|html)$/i;c.fn.offset="getBoundingClientRect"in t.documentElement?function(a){var b=this[0],d;if(a)return this.each(function(l){c.offset.setOffset(this,a,l)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return c.offset.bodyOffset(b);try{d=b.getBoundingClientRect()}catch(e){}var f=b.ownerDocument,h=f.documentElement;if(!d||!c.contains(h,b))return d||{top:0,left:0};b=f.body;f=fa(f);return{top:d.top+(f.pageYOffset||c.support.boxModel&&
h.scrollTop||b.scrollTop)-(h.clientTop||b.clientTop||0),left:d.left+(f.pageXOffset||c.support.boxModel&&h.scrollLeft||b.scrollLeft)-(h.clientLeft||b.clientLeft||0)}}:function(a){var b=this[0];if(a)return this.each(function(x){c.offset.setOffset(this,a,x)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return c.offset.bodyOffset(b);c.offset.initialize();var d,e=b.offsetParent,f=b.ownerDocument,h=f.documentElement,l=f.body;d=(f=f.defaultView)?f.getComputedStyle(b,null):b.currentStyle;
for(var k=b.offsetTop,o=b.offsetLeft;(b=b.parentNode)&&b!==l&&b!==h;){if(c.offset.supportsFixedPosition&&d.position==="fixed")break;d=f?f.getComputedStyle(b,null):b.currentStyle;k-=b.scrollTop;o-=b.scrollLeft;if(b===e){k+=b.offsetTop;o+=b.offsetLeft;if(c.offset.doesNotAddBorder&&!(c.offset.doesAddBorderForTableAndCells&&xb.test(b.nodeName))){k+=parseFloat(d.borderTopWidth)||0;o+=parseFloat(d.borderLeftWidth)||0}e=b.offsetParent}if(c.offset.subtractsBorderForOverflowNotVisible&&d.overflow!=="visible"){k+=
parseFloat(d.borderTopWidth)||0;o+=parseFloat(d.borderLeftWidth)||0}d=d}if(d.position==="relative"||d.position==="static"){k+=l.offsetTop;o+=l.offsetLeft}if(c.offset.supportsFixedPosition&&d.position==="fixed"){k+=Math.max(h.scrollTop,l.scrollTop);o+=Math.max(h.scrollLeft,l.scrollLeft)}return{top:k,left:o}};c.offset={initialize:function(){var a=t.body,b=t.createElement("div"),d,e,f,h=parseFloat(c.css(a,"marginTop"))||0;c.extend(b.style,{position:"absolute",top:0,left:0,margin:0,border:0,width:"1px",
height:"1px",visibility:"hidden"});b.innerHTML="<div style='position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;'><div></div></div><table style='position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;' cellpadding='0' cellspacing='0'><tr><td></td></tr></table>";a.insertBefore(b,a.firstChild);d=b.firstChild;e=d.firstChild;f=d.nextSibling.firstChild.firstChild;this.doesNotAddBorder=e.offsetTop!==5;this.doesAddBorderForTableAndCells=
f.offsetTop===5;e.style.position="fixed";e.style.top="20px";this.supportsFixedPosition=e.offsetTop===20||e.offsetTop===15;e.style.position=e.style.top="";d.style.overflow="hidden";d.style.position="relative";this.subtractsBorderForOverflowNotVisible=e.offsetTop===-5;this.doesNotIncludeMarginInBodyOffset=a.offsetTop!==h;a.removeChild(b);c.offset.initialize=c.noop},bodyOffset:function(a){var b=a.offsetTop,d=a.offsetLeft;c.offset.initialize();if(c.offset.doesNotIncludeMarginInBodyOffset){b+=parseFloat(c.css(a,
"marginTop"))||0;d+=parseFloat(c.css(a,"marginLeft"))||0}return{top:b,left:d}},setOffset:function(a,b,d){var e=c.css(a,"position");if(e==="static")a.style.position="relative";var f=c(a),h=f.offset(),l=c.css(a,"top"),k=c.css(a,"left"),o=e==="absolute"&&c.inArray("auto",[l,k])>-1;e={};var x={};if(o)x=f.position();l=o?x.top:parseInt(l,10)||0;k=o?x.left:parseInt(k,10)||0;if(c.isFunction(b))b=b.call(a,d,h);if(b.top!=null)e.top=b.top-h.top+l;if(b.left!=null)e.left=b.left-h.left+k;"using"in b?b.using.call(a,
e):f.css(e)}};c.fn.extend({position:function(){if(!this[0])return null;var a=this[0],b=this.offsetParent(),d=this.offset(),e=Ia.test(b[0].nodeName)?{top:0,left:0}:b.offset();d.top-=parseFloat(c.css(a,"marginTop"))||0;d.left-=parseFloat(c.css(a,"marginLeft"))||0;e.top+=parseFloat(c.css(b[0],"borderTopWidth"))||0;e.left+=parseFloat(c.css(b[0],"borderLeftWidth"))||0;return{top:d.top-e.top,left:d.left-e.left}},offsetParent:function(){return this.map(function(){for(var a=this.offsetParent||t.body;a&&!Ia.test(a.nodeName)&&
c.css(a,"position")==="static";)a=a.offsetParent;return a})}});c.each(["Left","Top"],function(a,b){var d="scroll"+b;c.fn[d]=function(e){var f=this[0],h;if(!f)return null;if(e!==B)return this.each(function(){if(h=fa(this))h.scrollTo(!a?e:c(h).scrollLeft(),a?e:c(h).scrollTop());else this[d]=e});else return(h=fa(f))?"pageXOffset"in h?h[a?"pageYOffset":"pageXOffset"]:c.support.boxModel&&h.document.documentElement[d]||h.document.body[d]:f[d]}});c.each(["Height","Width"],function(a,b){var d=b.toLowerCase();
c.fn["inner"+b]=function(){return this[0]?parseFloat(c.css(this[0],d,"padding")):null};c.fn["outer"+b]=function(e){return this[0]?parseFloat(c.css(this[0],d,e?"margin":"border")):null};c.fn[d]=function(e){var f=this[0];if(!f)return e==null?null:this;if(c.isFunction(e))return this.each(function(l){var k=c(this);k[d](e.call(this,l,k[d]()))});if(c.isWindow(f))return f.document.compatMode==="CSS1Compat"&&f.document.documentElement["client"+b]||f.document.body["client"+b];else if(f.nodeType===9)return Math.max(f.documentElement["client"+
b],f.body["scroll"+b],f.documentElement["scroll"+b],f.body["offset"+b],f.documentElement["offset"+b]);else if(e===B){f=c.css(f,d);var h=parseFloat(f);return c.isNaN(h)?f:h}else return this.css(d,typeof e==="string"?e:e+"px")}})})(window);
</script><script type="text/javascript">//XRegExp 1.5.0 <xregexp.com> MIT License
var XRegExp;if(XRegExp){throw Error("can't load XRegExp twice in the same frame")}(function(){XRegExp=function(w,r){var q=[],u=XRegExp.OUTSIDE_CLASS,x=0,p,s,v,t,y;if(XRegExp.isRegExp(w)){if(r!==undefined){throw TypeError("can't supply flags when constructing one RegExp from another")}return j(w)}if(g){throw Error("can't call the XRegExp constructor within token definition functions")}r=r||"";p={hasNamedCapture:false,captureNames:[],hasFlag:function(z){return r.indexOf(z)>-1},setFlag:function(z){r+=z}};while(x<w.length){s=o(w,x,u,p);if(s){q.push(s.output);x+=(s.match[0].length||1)}else{if(v=m.exec.call(i[u],w.slice(x))){q.push(v[0]);x+=v[0].length}else{t=w.charAt(x);if(t==="["){u=XRegExp.INSIDE_CLASS}else{if(t==="]"){u=XRegExp.OUTSIDE_CLASS}}q.push(t);x++}}}y=RegExp(q.join(""),m.replace.call(r,h,""));y._xregexp={source:w,captureNames:p.hasNamedCapture?p.captureNames:null};return y};XRegExp.version="1.5.0";XRegExp.INSIDE_CLASS=1;XRegExp.OUTSIDE_CLASS=2;var c=/\$(?:(\d\d?|[$&`'])|{([$\w]+)})/g,h=/[^gimy]+|([\s\S])(?=[\s\S]*\1)/g,n=/^(?:[?*+]|{\d+(?:,\d*)?})\??/,g=false,k=[],m={exec:RegExp.prototype.exec,test:RegExp.prototype.test,match:String.prototype.match,replace:String.prototype.replace,split:String.prototype.split},a=m.exec.call(/()??/,"")[1]===undefined,e=function(){var p=/^/g;m.test.call(p,"");return !p.lastIndex}(),f=function(){var p=/x/g;m.replace.call("x",p,"");return !p.lastIndex}(),b=RegExp.prototype.sticky!==undefined,i={};i[XRegExp.INSIDE_CLASS]=/^(?:\\(?:[0-3][0-7]{0,2}|[4-7][0-7]?|x[\dA-Fa-f]{2}|u[\dA-Fa-f]{4}|c[A-Za-z]|[\s\S]))/;i[XRegExp.OUTSIDE_CLASS]=/^(?:\\(?:0(?:[0-3][0-7]{0,2}|[4-7][0-7]?)?|[1-9]\d*|x[\dA-Fa-f]{2}|u[\dA-Fa-f]{4}|c[A-Za-z]|[\s\S])|\(\?[:=!]|[?*+]\?|{\d+(?:,\d*)?}\??)/;XRegExp.addToken=function(s,r,q,p){k.push({pattern:j(s,"g"+(b?"y":"")),handler:r,scope:q||XRegExp.OUTSIDE_CLASS,trigger:p||null})};XRegExp.cache=function(r,p){var q=r+"/"+(p||"");return XRegExp.cache[q]||(XRegExp.cache[q]=XRegExp(r,p))};XRegExp.copyAsGlobal=function(p){return j(p,"g")};XRegExp.escape=function(p){return p.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")};XRegExp.execAt=function(s,r,t,q){r=j(r,"g"+((q&&b)?"y":""));r.lastIndex=t=t||0;var p=r.exec(s);if(q){return(p&&p.index===t)?p:null}else{return p}};XRegExp.freezeTokens=function(){XRegExp.addToken=function(){throw Error("can't run addToken after freezeTokens")}};XRegExp.isRegExp=function(p){return Object.prototype.toString.call(p)==="[object RegExp]"};XRegExp.iterate=function(u,p,v,s){var t=j(p,"g"),r=-1,q;while(q=t.exec(u)){v.call(s,q,++r,u,t);if(t.lastIndex===q.index){t.lastIndex++}}if(p.global){p.lastIndex=0}};XRegExp.matchChain=function(q,p){return function r(s,x){var v=p[x].regex?p[x]:{regex:p[x]},u=j(v.regex,"g"),w=[],t;for(t=0;t<s.length;t++){XRegExp.iterate(s[t],u,function(y){w.push(v.backref?(y[v.backref]||""):y[0])})}return((x===p.length-1)||!w.length)?w:r(w,x+1)}([q],0)};RegExp.prototype.apply=function(q,p){return this.exec(p[0])};RegExp.prototype.call=function(p,q){return this.exec(q)};RegExp.prototype.exec=function(t){var r=m.exec.apply(this,arguments),q,p;if(r){if(!a&&r.length>1&&l(r,"")>-1){p=RegExp(this.source,m.replace.call(d(this),"g",""));m.replace.call(t.slice(r.index),p,function(){for(var u=1;u<arguments.length-2;u++){if(arguments[u]===undefined){r[u]=undefined}}})}if(this._xregexp&&this._xregexp.captureNames){for(var s=1;s<r.length;s++){q=this._xregexp.captureNames[s-1];if(q){r[q]=r[s]}}}if(!e&&this.global&&!r[0].length&&(this.lastIndex>r.index)){this.lastIndex--}}return r};if(!e){RegExp.prototype.test=function(q){var p=m.exec.call(this,q);if(p&&this.global&&!p[0].length&&(this.lastIndex>p.index)){this.lastIndex--}return !!p}}String.prototype.match=function(q){if(!XRegExp.isRegExp(q)){q=RegExp(q)}if(q.global){var p=m.match.apply(this,arguments);q.lastIndex=0;return p}return q.exec(this)};String.prototype.replace=function(r,s){var t=XRegExp.isRegExp(r),q,p,u;if(t&&typeof s.valueOf()==="string"&&s.indexOf("${")===-1&&f){return m.replace.apply(this,arguments)}if(!t){r=r+""}else{if(r._xregexp){q=r._xregexp.captureNames}}if(typeof s==="function"){p=m.replace.call(this,r,function(){if(q){arguments[0]=new String(arguments[0]);for(var v=0;v<q.length;v++){if(q[v]){arguments[0][q[v]]=arguments[v+1]}}}if(t&&r.global){r.lastIndex=arguments[arguments.length-2]+arguments[0].length}return s.apply(null,arguments)})}else{u=this+"";p=m.replace.call(u,r,function(){var v=arguments;return m.replace.call(s,c,function(x,w,A){if(w){switch(w){case"$":return"$";case"&":return v[0];case"`":return v[v.length-1].slice(0,v[v.length-2]);case"'":return v[v.length-1].slice(v[v.length-2]+v[0].length);default:var y="";w=+w;if(!w){return x}while(w>v.length-3){y=String.prototype.slice.call(w,-1)+y;w=Math.floor(w/10)}return(w?v[w]||"":"$")+y}}else{var z=+A;if(z<=v.length-3){return v[z]}z=q?l(q,A):-1;return z>-1?v[z+1]:x}})})}if(t&&r.global){r.lastIndex=0}return p};String.prototype.split=function(u,p){if(!XRegExp.isRegExp(u)){return m.split.apply(this,arguments)}var w=this+"",r=[],v=0,t,q;if(p===undefined||+p<0){p=Infinity}else{p=Math.floor(+p);if(!p){return[]}}u=XRegExp.copyAsGlobal(u);while(t=u.exec(w)){if(u.lastIndex>v){r.push(w.slice(v,t.index));if(t.length>1&&t.index<w.length){Array.prototype.push.apply(r,t.slice(1))}q=t[0].length;v=u.lastIndex;if(r.length>=p){break}}if(u.lastIndex===t.index){u.lastIndex++}}if(v===w.length){if(!m.test.call(u,"")||q){r.push("")}}else{r.push(w.slice(v))}return r.length>p?r.slice(0,p):r};function j(r,q){if(!XRegExp.isRegExp(r)){throw TypeError("type RegExp expected")}var p=r._xregexp;r=XRegExp(r.source,d(r)+(q||""));if(p){r._xregexp={source:p.source,captureNames:p.captureNames?p.captureNames.slice(0):null}}return r}function d(p){return(p.global?"g":"")+(p.ignoreCase?"i":"")+(p.multiline?"m":"")+(p.extended?"x":"")+(p.sticky?"y":"")}function o(v,u,w,p){var r=k.length,y,s,x;g=true;try{while(r--){x=k[r];if((w&x.scope)&&(!x.trigger||x.trigger.call(p))){x.pattern.lastIndex=u;s=x.pattern.exec(v);if(s&&s.index===u){y={output:x.handler.call(p,s,w),match:s};break}}}}catch(q){throw q}finally{g=false}return y}function l(s,q,r){if(Array.prototype.indexOf){return s.indexOf(q,r)}for(var p=r||0;p<s.length;p++){if(s[p]===q){return p}}return -1}XRegExp.addToken(/\(\?#[^)]*\)/,function(p){return m.test.call(n,p.input.slice(p.index+p[0].length))?"":"(?:)"});XRegExp.addToken(/\((?!\?)/,function(){this.captureNames.push(null);return"("});XRegExp.addToken(/\(\?<([$\w]+)>/,function(p){this.captureNames.push(p[1]);this.hasNamedCapture=true;return"("});XRegExp.addToken(/\\k<([\w$]+)>/,function(q){var p=l(this.captureNames,q[1]);return p>-1?"\\"+(p+1)+(isNaN(q.input.charAt(q.index+q[0].length))?"":"(?:)"):q[0]});XRegExp.addToken(/\[\^?]/,function(p){return p[0]==="[]"?"\\b\\B":"[\\s\\S]"});XRegExp.addToken(/^\(\?([imsx]+)\)/,function(p){this.setFlag(p[1]);return""});XRegExp.addToken(/(?:\s+|#.*)+/,function(p){return m.test.call(n,p.input.slice(p.index+p[0].length))?"":"(?:)"},XRegExp.OUTSIDE_CLASS,function(){return this.hasFlag("x")});XRegExp.addToken(/\./,function(){return"[\\s\\S]"},XRegExp.OUTSIDE_CLASS,function(){return this.hasFlag("s")})})();
</script><script type="text/javascript">/**
 * SyntaxHighlighter
 * http://alexgorbatchev.com/SyntaxHighlighter
 *
 * SyntaxHighlighter is donationware. If you are using it, please donate.
 * http://alexgorbatchev.com/SyntaxHighlighter/donate.html
 *
 * @version
 * 3.0.83 (July 02 2010)
 * 
 * @copyright
 * Copyright (C) 2004-2010 Alex Gorbatchev.
 *
 * @license
 * Dual licensed under the MIT and GPL licenses.
 */
//
// Begin anonymous function. This is used to contain local scope variables without polutting global scope.
//
var SyntaxHighlighter = function() { 

// CommonJS
if (typeof(require) != 'undefined' && typeof(XRegExp) == 'undefined')
{
	XRegExp = require('XRegExp').XRegExp;
}

// Shortcut object which will be assigned to the SyntaxHighlighter variable.
// This is a shorthand for local reference in order to avoid long namespace 
// references to SyntaxHighlighter.whatever...
var sh = {
	defaults : {
		/** Additional CSS class names to be added to highlighter elements. */
		'class-name' : '',
		
		/** First line number. */
		'first-line' : 1,
		
		/**
		 * Pads line numbers. Possible values are:
		 *
		 *   false - don't pad line numbers.
		 *   true  - automaticaly pad numbers with minimum required number of leading zeroes.
		 *   [int] - length up to which pad line numbers.
		 */
		'pad-line-numbers' : false,
		
		/** Lines to highlight. */
		'highlight' : null,
		
		/** Title to be displayed above the code block. */
		'title' : null,
		
		/** Enables or disables smart tabs. */
		'smart-tabs' : true,
		
		/** Gets or sets tab size. */
		'tab-size' : 4,
		
		/** Enables or disables gutter. */
		'gutter' : true,
		
		/** Enables or disables toolbar. */
		'toolbar' : true,
		
		/** Enables quick code copy and paste from double click. */
		'quick-code' : true,
		
		/** Forces code view to be collapsed. */
		'collapse' : false,
		
		/** Enables or disables automatic links. */
		'auto-links' : true,
		
		/** Gets or sets light mode. Equavalent to turning off gutter and toolbar. */
		'light' : false,
		
		'html-script' : false
	},
	
	config : {
		space : '&nbsp;',
		
		/** Enables use of <SCRIPT type="syntaxhighlighter" /> tags. */
		useScriptTags : true,
		
		/** Blogger mode flag. */
		bloggerMode : false,
		
		stripBrs : false,
		
		/** Name of the tag that SyntaxHighlighter will automatically look for. */
		tagName : 'pre',
		
		strings : {
			expandSource : 'expand source',
			help : '?',
			alert: 'SyntaxHighlighter\n\n',
			noBrush : 'Can\'t find brush for: ',
			brushNotHtmlScript : 'Brush wasn\'t configured for html-script option: ',
			
			// this is populated by the build script
			aboutDialog : '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>About SyntaxHighlighter</title></head><body style="font-family:Geneva,Arial,Helvetica,sans-serif;background-color:#fff;color:#000;font-size:1em;text-align:center;"><div style="text-align:center;margin-top:1.5em;"><div style="font-size:xx-large;">SyntaxHighlighter</div><div style="font-size:.75em;margin-bottom:3em;"><div>version 3.0.83 (July 02 2010)</div><div><a href="http://alexgorbatchev.com/SyntaxHighlighter" target="_blank" style="color:#005896">http://alexgorbatchev.com/SyntaxHighlighter</a></div><div>JavaScript code syntax highlighter.</div><div>Copyright 2004-2010 Alex Gorbatchev.</div></div><div>If you like this script, please <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=2930402" style="color:#005896">donate</a> to <br/>keep development active!</div></div></body></html>'
		}
	},
	
	/** Internal 'global' variables. */
	vars : {
		discoveredBrushes : null,
		highlighters : {}
	},
	
	/** This object is populated by user included external brush files. */
	brushes : {},

	/** Common regular expressions. */
	regexLib : {
		multiLineCComments			: /\/\*[\s\S]*?\*\//gm,
		singleLineCComments			: /\/\/.*$/gm,
		singleLinePerlComments		: /#.*$/gm,
		doubleQuotedString			: /"([^\\"\n]|\\.)*"/g,
		singleQuotedString			: /'([^\\'\n]|\\.)*'/g,
		multiLineDoubleQuotedString	: new XRegExp('"([^\\\\"]|\\\\.)*"', 'gs'),
		multiLineSingleQuotedString	: new XRegExp("'([^\\\\']|\\\\.)*'", 'gs'),
		xmlComments					: /(&lt;|<)!--[\s\S]*?--(&gt;|>)/gm,
		url							: /\w+:\/\/[\w-.\/?%&=:@;]*/g,
		
		/** <?= ?> tags. */
		phpScriptTags 				: { left: /(&lt;|<)\?=?/g, right: /\?(&gt;|>)/g },
		
		/** <%= %> tags. */
		aspScriptTags				: { left: /(&lt;|<)%=?/g, right: /%(&gt;|>)/g },
		
		scriptScriptTags			: { left: /(&lt;|<)\s*script.*?(&gt;|>)/gi, right: /(&lt;|<)\/\s*script\s*(&gt;|>)/gi }
	},

	toolbar: {
		/**
		 * Generates HTML markup for the toolbar.
		 * @param {Highlighter} highlighter Highlighter instance.
		 * @return {String} Returns HTML markup.
		 */
		getHtml: function(highlighter)
		{
			var html = '<div class="toolbar">',
				items = sh.toolbar.items,
				list = items.list
				;
			
			function defaultGetHtml(highlighter, name)
			{
				return sh.toolbar.getButtonHtml(highlighter, name, sh.config.strings[name]);
			};
			
			for (var i = 0; i < list.length; i++)
				html += (items[list[i]].getHtml || defaultGetHtml)(highlighter, list[i]);
			
			html += '</div>';
			
			return html;
		},
		
		/**
		 * Generates HTML markup for a regular button in the toolbar.
		 * @param {Highlighter} highlighter Highlighter instance.
		 * @param {String} commandName		Command name that would be executed.
		 * @param {String} label			Label text to display.
		 * @return {String}					Returns HTML markup.
		 */
		getButtonHtml: function(highlighter, commandName, label)
		{
			return '<span><a href="#" class="toolbar_item'
				+ ' command_' + commandName
				+ ' ' + commandName
				+ '">' + label + '</a></span>'
				;
		},
		
		/**
		 * Event handler for a toolbar anchor.
		 */
		handler: function(e)
		{
			var target = e.target,
				className = target.className || ''
				;

			function getValue(name)
			{
				var r = new RegExp(name + '_(\\w+)'),
					match = r.exec(className)
					;

				return match ? match[1] : null;
			};
			
			var highlighter = getHighlighterById(findParentElement(target, '.syntaxhighlighter').id),
				commandName = getValue('command')
				;
			
			// execute the toolbar command
			if (highlighter && commandName)
				sh.toolbar.items[commandName].execute(highlighter);

			// disable default A click behaviour
			e.preventDefault();
		},
		
		/** Collection of toolbar items. */
		items : {
			// Ordered lis of items in the toolbar. Can't expect `for (var n in items)` to be consistent.
			list: ['expandSource', 'help'],

			expandSource: {
				getHtml: function(highlighter)
				{
					if (highlighter.getParam('collapse') != true)
						return '';
						
					var title = highlighter.getParam('title');
					return sh.toolbar.getButtonHtml(highlighter, 'expandSource', title ? title : sh.config.strings.expandSource);
				},
			
				execute: function(highlighter)
				{
					var div = getHighlighterDivById(highlighter.id);
					removeClass(div, 'collapsed');
				}
			},

			/** Command to display the about dialog window. */
			help: {
				execute: function(highlighter)
				{	
					var wnd = popup('', '_blank', 500, 250, 'scrollbars=0'),
						doc = wnd.document
						;
					
					doc.write(sh.config.strings.aboutDialog);
					doc.close();
					wnd.focus();
				}
			}
		}
	},

	/**
	 * Finds all elements on the page which should be processes by SyntaxHighlighter.
	 *
	 * @param {Object} globalParams		Optional parameters which override element's 
	 * 									parameters. Only used if element is specified.
	 * 
	 * @param {Object} element	Optional element to highlight. If none is
	 * 							provided, all elements in the current document 
	 * 							are returned which qualify.
	 *
	 * @return {Array}	Returns list of <code>{ target: DOMElement, params: Object }</code> objects.
	 */
	findElements: function(globalParams, element)
	{
		var elements = element ? [element] : toArray(document.getElementsByTagName(sh.config.tagName)), 
			conf = sh.config,
			result = []
			;

		// support for <SCRIPT TYPE="syntaxhighlighter" /> feature
		if (conf.useScriptTags)
			elements = elements.concat(getSyntaxHighlighterScriptTags());

		if (elements.length === 0) 
			return result;
	
		for (var i = 0; i < elements.length; i++) 
		{
			var item = {
				target: elements[i], 
				// local params take precedence over globals
				params: merge(globalParams, parseParams(elements[i].className))
			};

			if (item.params['brush'] == null)
				continue;
				
			result.push(item);
		}
		
		return result;
	},

	/**
	 * Shorthand to highlight all elements on the page that are marked as 
	 * SyntaxHighlighter source code.
	 * 
	 * @param {Object} globalParams		Optional parameters which override element's 
	 * 									parameters. Only used if element is specified.
	 * 
	 * @param {Object} element	Optional element to highlight. If none is
	 * 							provided, all elements in the current document 
	 * 							are highlighted.
	 */ 
	highlight: function(globalParams, element)
	{
		var elements = this.findElements(globalParams, element),
			propertyName = 'innerHTML', 
			highlighter = null,
			conf = sh.config
			;

		if (elements.length === 0) 
			return;
	
		for (var i = 0; i < elements.length; i++) 
		{
			var element = elements[i],
				target = element.target,
				params = element.params,
				brushName = params.brush,
				code
				;

			if (brushName == null)
				continue;

			// Instantiate a brush
			if (params['html-script'] == 'true' || sh.defaults['html-script'] == true) 
			{
				highlighter = new sh.HtmlScript(brushName);
				brushName = 'htmlscript';
			}
			else
			{
				var brush = findBrush(brushName);
				
				if (brush)
					highlighter = new brush();
				else
					continue;
			}
			
			code = target[propertyName];
			
			// remove CDATA from <SCRIPT/> tags if it's present
			if (conf.useScriptTags)
				code = stripCData(code);
				
			// Inject title if the attribute is present
			if ((target.title || '') != '')
				params.title = target.title;
				
			params['brush'] = brushName;
			highlighter.init(params);
			element = highlighter.getDiv(code);
			
			// carry over ID
			if ((target.id || '') != '')
				element.id = target.id;
			
			target.parentNode.replaceChild(element, target);
		}
	},

	/**
	 * Main entry point for the SyntaxHighlighter.
	 * @param {Object} params Optional params to apply to all highlighted elements.
	 */
	all: function(params)
	{
		attachEvent(
			window,
			'load',
			function() { sh.highlight(params); }
		);
	}
}; // end of sh

sh['all']			= sh.all;
sh['highlight']		= sh.highlight;

/**
 * Checks if target DOM elements has specified CSS class.
 * @param {DOMElement} target Target DOM element to check.
 * @param {String} className Name of the CSS class to check for.
 * @return {Boolean} Returns true if class name is present, false otherwise.
 */
function hasClass(target, className)
{
	return target.className.indexOf(className) != -1;
};

/**
 * Adds CSS class name to the target DOM element.
 * @param {DOMElement} target Target DOM element.
 * @param {String} className New CSS class to add.
 */
function addClass(target, className)
{
	if (!hasClass(target, className))
		target.className += ' ' + className;
};

/**
 * Removes CSS class name from the target DOM element.
 * @param {DOMElement} target Target DOM element.
 * @param {String} className CSS class to remove.
 */
function removeClass(target, className)
{
	target.className = target.className.replace(className, '');
};

/**
 * Converts the source to array object. Mostly used for function arguments and 
 * lists returned by getElementsByTagName() which aren't Array objects.
 * @param {List} source Source list.
 * @return {Array} Returns array.
 */
function toArray(source)
{
	var result = [];
	
	for (var i = 0; i < source.length; i++) 
		result.push(source[i]);
		
	return result;
};

/**
 * Splits block of text into lines.
 * @param {String} block Block of text.
 * @return {Array} Returns array of lines.
 */
function splitLines(block)
{
	return block.split('\n');
}

/**
 * Generates HTML ID for the highlighter.
 * @param {String} highlighterId Highlighter ID.
 * @return {String} Returns HTML ID.
 */
function getHighlighterId(id)
{
	var prefix = 'highlighter_';
	return id.indexOf(prefix) == 0 ? id : prefix + id;
};

/**
 * Finds Highlighter instance by ID.
 * @param {String} highlighterId Highlighter ID.
 * @return {Highlighter} Returns instance of the highlighter.
 */
function getHighlighterById(id)
{
	return sh.vars.highlighters[getHighlighterId(id)];
};

/**
 * Finds highlighter's DIV container.
 * @param {String} highlighterId Highlighter ID.
 * @return {Element} Returns highlighter's DIV element.
 */
function getHighlighterDivById(id)
{
	return document.getElementById(getHighlighterId(id));
};

/**
 * Stores highlighter so that getHighlighterById() can do its thing. Each
 * highlighter must call this method to preserve itself.
 * @param {Highilghter} highlighter Highlighter instance.
 */
function storeHighlighter(highlighter)
{
	sh.vars.highlighters[getHighlighterId(highlighter.id)] = highlighter;
};

/**
 * Looks for a child or parent node which has specified classname.
 * Equivalent to jQuery's $(container).find(".className")
 * @param {Element} target Target element.
 * @param {String} search Class name or node name to look for.
 * @param {Boolean} reverse If set to true, will go up the node tree instead of down.
 * @return {Element} Returns found child or parent element on null.
 */
function findElement(target, search, reverse /* optional */)
{
	if (target == null)
		return null;
		
	var nodes			= reverse != true ? target.childNodes : [ target.parentNode ],
		propertyToFind	= { '#' : 'id', '.' : 'className' }[search.substr(0, 1)] || 'nodeName',
		expectedValue,
		found
		;

	expectedValue = propertyToFind != 'nodeName'
		? search.substr(1)
		: search.toUpperCase()
		;
		
	// main return of the found node
	if ((target[propertyToFind] || '').indexOf(expectedValue) != -1)
		return target;
	
	for (var i = 0; nodes && i < nodes.length && found == null; i++)
		found = findElement(nodes[i], search, reverse);
	
	return found;
};

/**
 * Looks for a parent node which has specified classname.
 * This is an alias to <code>findElement(container, className, true)</code>.
 * @param {Element} target Target element.
 * @param {String} className Class name to look for.
 * @return {Element} Returns found parent element on null.
 */
function findParentElement(target, className)
{
	return findElement(target, className, true);
};

/**
 * Finds an index of element in the array.
 * @ignore
 * @param {Object} searchElement
 * @param {Number} fromIndex
 * @return {Number} Returns index of element if found; -1 otherwise.
 */
function indexOf(array, searchElement, fromIndex)
{
	fromIndex = Math.max(fromIndex || 0, 0);

	for (var i = fromIndex; i < array.length; i++)
		if(array[i] == searchElement)
			return i;
	
	return -1;
};

/**
 * Generates a unique element ID.
 */
function guid(prefix)
{
	return (prefix || '') + Math.round(Math.random() * 1000000).toString();
};

/**
 * Merges two objects. Values from obj2 override values in obj1.
 * Function is NOT recursive and works only for one dimensional objects.
 * @param {Object} obj1 First object.
 * @param {Object} obj2 Second object.
 * @return {Object} Returns combination of both objects.
 */
function merge(obj1, obj2)
{
	var result = {}, name;

	for (name in obj1) 
		result[name] = obj1[name];
	
	for (name in obj2) 
		result[name] = obj2[name];
		
	return result;
};

/**
 * Attempts to convert string to boolean.
 * @param {String} value Input string.
 * @return {Boolean} Returns true if input was "true", false if input was "false" and value otherwise.
 */
function toBoolean(value)
{
	var result = { "true" : true, "false" : false }[value];
	return result == null ? value : result;
};

/**
 * Opens up a centered popup window.
 * @param {String} url		URL to open in the window.
 * @param {String} name		Popup name.
 * @param {int} width		Popup width.
 * @param {int} height		Popup height.
 * @param {String} options	window.open() options.
 * @return {Window}			Returns window instance.
 */
function popup(url, name, width, height, options)
{
	var x = (screen.width - width) / 2,
		y = (screen.height - height) / 2
		;
		
	options +=	', left=' + x + 
				', top=' + y +
				', width=' + width +
				', height=' + height
		;
	options = options.replace(/^,/, '');

	var win = window.open(url, name, options);
	win.focus();
	return win;
};

/**
 * Adds event handler to the target object.
 * @param {Object} obj		Target object.
 * @param {String} type		Name of the event.
 * @param {Function} func	Handling function.
 */
function attachEvent(obj, type, func, scope)
{
	function handler(e)
	{
		e = e || window.event;
		
		if (!e.target)
		{
			e.target = e.srcElement;
			e.preventDefault = function()
			{
				this.returnValue = false;
			};
		}
			
		func.call(scope || window, e);
	};
	
	if (obj.attachEvent) 
	{
		obj.attachEvent('on' + type, handler);
	}
	else 
	{
		obj.addEventListener(type, handler, false);
	}
};

/**
 * Displays an alert.
 * @param {String} str String to display.
 */
function alert(str)
{
	window.alert(sh.config.strings.alert + str);
};

/**
 * Finds a brush by its alias.
 *
 * @param {String} alias		Brush alias.
 * @param {Boolean} showAlert	Suppresses the alert if false.
 * @return {Brush}				Returns bursh constructor if found, null otherwise.
 */
function findBrush(alias, showAlert)
{
	var brushes = sh.vars.discoveredBrushes,
		result = null
		;
	
	if (brushes == null) 
	{
		brushes = {};
		
		// Find all brushes
		for (var brush in sh.brushes) 
		{
			var info = sh.brushes[brush],
				aliases = info.aliases
				;
			
			if (aliases == null) 
				continue;
			
			// keep the brush name
			info.brushName = brush.toLowerCase();
			
			for (var i = 0; i < aliases.length; i++) 
				brushes[aliases[i]] = brush;
		}
		
		sh.vars.discoveredBrushes = brushes;
	}
	
	result = sh.brushes[brushes[alias]];

	if (result == null && showAlert != false)
		alert(sh.config.strings.noBrush + alias);
	
	return result;
};

/**
 * Executes a callback on each line and replaces each line with result from the callback.
 * @param {Object} str			Input string.
 * @param {Object} callback		Callback function taking one string argument and returning a string.
 */
function eachLine(str, callback)
{
	var lines = splitLines(str);
	
	for (var i = 0; i < lines.length; i++)
		lines[i] = callback(lines[i], i);
		
	return lines.join('\n');
};

/**
 * This is a special trim which only removes first and last empty lines
 * and doesn't affect valid leading space on the first line.
 * 
 * @param {String} str   Input string
 * @return {String}      Returns string without empty first and last lines.
 */
function trimFirstAndLastLines(str)
{
	return str.replace(/^[ ]*[\n]+|[\n]*[ ]*$/g, '');
};

/**
 * Parses key/value pairs into hash object.
 * 
 * Understands the following formats:
 * - name: word;
 * - name: [word, word];
 * - name: "string";
 * - name: 'string';
 * 
 * For example:
 *   name1: value; name2: [value, value]; name3: 'value'
 *   
 * @param {String} str    Input string.
 * @return {Object}       Returns deserialized object.
 */
function parseParams(str)
{
	var match, 
		result = {},
		arrayRegex = new XRegExp("^\\[(?<values>(.*?))\\]$"),
		regex = new XRegExp(
			"(?<name>[\\w-]+)" +
			"\\s*:\\s*" +
			"(?<value>" +
				"[\\w-%#]+|" +		// word
				"\\[.*?\\]|" +		// [] array
				'".*?"|' +			// "" string
				"'.*?'" +			// '' string
			")\\s*;?",
			"g"
		)
		;

	while ((match = regex.exec(str)) != null) 
	{
		var value = match.value
			.replace(/^['"]|['"]$/g, '') // strip quotes from end of strings
			;
		
		// try to parse array value
		if (value != null && arrayRegex.test(value))
		{
			var m = arrayRegex.exec(value);
			value = m.values.length > 0 ? m.values.split(/\s*,\s*/) : [];
		}
		
		result[match.name] = value;
	}
	
	return result;
};

/**
 * Wraps each line of the string into <code/> tag with given style applied to it.
 * 
 * @param {String} str   Input string.
 * @param {String} css   Style name to apply to the string.
 * @return {String}      Returns input string with each line surrounded by <span/> tag.
 */
function wrapLinesWithCode(str, css)
{
	if (str == null || str.length == 0 || str == '\n') 
		return str;

	str = str.replace(/</g, '&lt;');

	// Replace two or more sequential spaces with &nbsp; leaving last space untouched.
	str = str.replace(/ {2,}/g, function(m)
	{
		var spaces = '';
		
		for (var i = 0; i < m.length - 1; i++)
			spaces += sh.config.space;
		
		return spaces + ' ';
	});

	// Split each line and apply <span class="...">...</span> to them so that
	// leading spaces aren't included.
	if (css != null) 
		str = eachLine(str, function(line)
		{
			if (line.length == 0) 
				return '';
			
			var spaces = '';
			
			line = line.replace(/^(&nbsp;| )+/, function(s)
			{
				spaces = s;
				return '';
			});
			
			if (line.length == 0) 
				return spaces;
			
			return spaces + '<code class="' + css + '">' + line + '</code>';
		});

	return str;
};

/**
 * Pads number with zeros until it's length is the same as given length.
 * 
 * @param {Number} number	Number to pad.
 * @param {Number} length	Max string length with.
 * @return {String}			Returns a string padded with proper amount of '0'.
 */
function padNumber(number, length)
{
	var result = number.toString();
	
	while (result.length < length)
		result = '0' + result;
	
	return result;
};

/**
 * Replaces tabs with spaces.
 * 
 * @param {String} code		Source code.
 * @param {Number} tabSize	Size of the tab.
 * @return {String}			Returns code with all tabs replaces by spaces.
 */
function processTabs(code, tabSize)
{
	var tab = '';
	
	for (var i = 0; i < tabSize; i++)
		tab += ' ';

	return code.replace(/\t/g, tab);
};

/**
 * Replaces tabs with smart spaces.
 * 
 * @param {String} code    Code to fix the tabs in.
 * @param {Number} tabSize Number of spaces in a column.
 * @return {String}        Returns code with all tabs replaces with roper amount of spaces.
 */
function processSmartTabs(code, tabSize)
{
	var lines = splitLines(code),
		tab = '\t',
		spaces = ''
		;
	
	// Create a string with 1000 spaces to copy spaces from... 
	// It's assumed that there would be no indentation longer than that.
	for (var i = 0; i < 50; i++) 
		spaces += '                    '; // 20 spaces * 50
			
	// This function inserts specified amount of spaces in the string
	// where a tab is while removing that given tab.
	function insertSpaces(line, pos, count)
	{
		return line.substr(0, pos)
			+ spaces.substr(0, count)
			+ line.substr(pos + 1, line.length) // pos + 1 will get rid of the tab
			;
	};

	// Go through all the lines and do the 'smart tabs' magic.
	code = eachLine(code, function(line)
	{
		if (line.indexOf(tab) == -1) 
			return line;
		
		var pos = 0;
		
		while ((pos = line.indexOf(tab)) != -1) 
		{
			// This is pretty much all there is to the 'smart tabs' logic.
			// Based on the position within the line and size of a tab,
			// calculate the amount of spaces we need to insert.
			var spaces = tabSize - pos % tabSize;
			line = insertSpaces(line, pos, spaces);
		}
		
		return line;
	});
	
	return code;
};

/**
 * Performs various string fixes based on configuration.
 */
function fixInputString(str)
{
	var br = /<br\s*\/?>|&lt;br\s*\/?&gt;/gi;
	
	if (sh.config.bloggerMode == true)
		str = str.replace(br, '\n');

	if (sh.config.stripBrs == true)
		str = str.replace(br, '');
		
	return str;
};

/**
 * Removes all white space at the begining and end of a string.
 * 
 * @param {String} str   String to trim.
 * @return {String}      Returns string without leading and following white space characters.
 */
function trim(str)
{
	return str.replace(/^\s+|\s+$/g, '');
};

/**
 * Unindents a block of text by the lowest common indent amount.
 * @param {String} str   Text to unindent.
 * @return {String}      Returns unindented text block.
 */
function unindent(str)
{
	var lines = splitLines(fixInputString(str)),
		indents = new Array(),
		regex = /^\s*/,
		min = 1000
		;
	
	// go through every line and check for common number of indents
	for (var i = 0; i < lines.length && min > 0; i++) 
	{
		var line = lines[i];
		
		if (trim(line).length == 0) 
			continue;
		
		var matches = regex.exec(line);
		
		// In the event that just one line doesn't have leading white space
		// we can't unindent anything, so bail completely.
		if (matches == null) 
			return str;
			
		min = Math.min(matches[0].length, min);
	}
	
	// trim minimum common number of white space from the begining of every line
	if (min > 0) 
		for (var i = 0; i < lines.length; i++) 
			lines[i] = lines[i].substr(min);
	
	return lines.join('\n');
};

/**
 * Callback method for Array.sort() which sorts matches by
 * index position and then by length.
 * 
 * @param {Match} m1	Left object.
 * @param {Match} m2    Right object.
 * @return {Number}     Returns -1, 0 or -1 as a comparison result.
 */
function matchesSortCallback(m1, m2)
{
	// sort matches by index first
	if(m1.index < m2.index)
		return -1;
	else if(m1.index > m2.index)
		return 1;
	else
	{
		// if index is the same, sort by length
		if(m1.length < m2.length)
			return -1;
		else if(m1.length > m2.length)
			return 1;
	}
	
	return 0;
};

/**
 * Executes given regular expression on provided code and returns all
 * matches that are found.
 * 
 * @param {String} code    Code to execute regular expression on.
 * @param {Object} regex   Regular expression item info from <code>regexList</code> collection.
 * @return {Array}         Returns a list of Match objects.
 */ 
function getMatches(code, regexInfo)
{
	function defaultAdd(match, regexInfo)
	{
		return match[0];
	};
	
	var index = 0,
		match = null,
		matches = [],
		func = regexInfo.func ? regexInfo.func : defaultAdd
		;
	
	while((match = regexInfo.regex.exec(code)) != null)
	{
		var resultMatch = func(match, regexInfo);
		
		if (typeof(resultMatch) == 'string')
			resultMatch = [new sh.Match(resultMatch, match.index, regexInfo.css)];

		matches = matches.concat(resultMatch);
	}
	
	return matches;
};

/**
 * Turns all URLs in the code into <a/> tags.
 * @param {String} code Input code.
 * @return {String} Returns code with </a> tags.
 */
function processUrls(code)
{
	var gt = /(.*)((&gt;|&lt;).*)/;
	
	return code.replace(sh.regexLib.url, function(m)
	{
		var suffix = '',
			match = null
			;
		
		// We include &lt; and &gt; in the URL for the common cases like <http://google.com>
		// The problem is that they get transformed into &lt;http://google.com&gt;
		// Where as &gt; easily looks like part of the URL string.
	
		if (match = gt.exec(m))
		{
			m = match[1];
			suffix = match[2];
		}
		
		return '<a href="' + m + '">' + m + '</a>' + suffix;
	});
};

/**
 * Finds all <SCRIPT TYPE="syntaxhighlighter" /> elementss.
 * @return {Array} Returns array of all found SyntaxHighlighter tags.
 */
function getSyntaxHighlighterScriptTags()
{
	var tags = document.getElementsByTagName('script'),
		result = []
		;
	
	for (var i = 0; i < tags.length; i++)
		if (tags[i].type == 'syntaxhighlighter')
			result.push(tags[i]);
			
	return result;
};

/**
 * Strips <![CDATA[]]> from <SCRIPT /> content because it should be used
 * there in most cases for XHTML compliance.
 * @param {String} original	Input code.
 * @return {String} Returns code without leading <![CDATA[]]> tags.
 */
function stripCData(original)
{
	var left = '<![CDATA[',
		right = ']]>',
		// for some reason IE inserts some leading blanks here
		copy = trim(original),
		changed = false,
		leftLength = left.length,
		rightLength = right.length
		;
	
	if (copy.indexOf(left) == 0)
	{
		copy = copy.substring(leftLength);
		changed = true;
	}
	
	var copyLength = copy.length;
	
	if (copy.indexOf(right) == copyLength - rightLength)
	{
		copy = copy.substring(0, copyLength - rightLength);
		changed = true;
	}
	
	return changed ? copy : original;
};


/**
 * Quick code mouse double click handler.
 */
function quickCodeHandler(e)
{
	var target = e.target,
		highlighterDiv = findParentElement(target, '.syntaxhighlighter'),
		container = findParentElement(target, '.container'),
		textarea = document.createElement('textarea'),
		highlighter
		;

	if (!container || !highlighterDiv || findElement(container, 'textarea'))
		return;

	highlighter = getHighlighterById(highlighterDiv.id);
	
	// add source class name
	addClass(highlighterDiv, 'source');

	// Have to go over each line and grab it's text, can't just do it on the
	// container because Firefox loses all \n where as Webkit doesn't.
	var lines = container.childNodes,
		code = []
		;
	
	for (var i = 0; i < lines.length; i++)
		code.push(lines[i].innerText || lines[i].textContent);
	
	// using \r instead of \r or \r\n makes this work equally well on IE, FF and Webkit
	code = code.join('\r');
	
	// inject <textarea/> tag
	textarea.appendChild(document.createTextNode(code));
	container.appendChild(textarea);
	
	// preselect all text
	textarea.focus();
	textarea.select();
	
	// set up handler for lost focus
	attachEvent(textarea, 'blur', function(e)
	{
		textarea.parentNode.removeChild(textarea);
		removeClass(highlighterDiv, 'source');
	});
};

/**
 * Match object.
 */
sh.Match = function(value, index, css)
{
	this.value = value;
	this.index = index;
	this.length = value.length;
	this.css = css;
	this.brushName = null;
};

sh.Match.prototype.toString = function()
{
	return this.value;
};

/**
 * Simulates HTML code with a scripting language embedded.
 * 
 * @param {String} scriptBrushName Brush name of the scripting language.
 */
sh.HtmlScript = function(scriptBrushName)
{
	var brushClass = findBrush(scriptBrushName),
		scriptBrush,
		xmlBrush = new sh.brushes.Xml(),
		bracketsRegex = null,
		ref = this,
		methodsToExpose = 'getDiv getHtml init'.split(' ')
		;

	if (brushClass == null)
		return;
	
	scriptBrush = new brushClass();
	
	for(var i = 0; i < methodsToExpose.length; i++)
		// make a closure so we don't lose the name after i changes
		(function() {
			var name = methodsToExpose[i];
			
			ref[name] = function()
			{
				return xmlBrush[name].apply(xmlBrush, arguments);
			};
		})();
	
	if (scriptBrush.htmlScript == null)
	{
		alert(sh.config.strings.brushNotHtmlScript + scriptBrushName);
		return;
	}
	
	xmlBrush.regexList.push(
		{ regex: scriptBrush.htmlScript.code, func: process }
	);
	
	function offsetMatches(matches, offset)
	{
		for (var j = 0; j < matches.length; j++) 
			matches[j].index += offset;
	}
	
	function process(match, info)
	{
		var code = match.code,
			matches = [],
			regexList = scriptBrush.regexList,
			offset = match.index + match.left.length,
			htmlScript = scriptBrush.htmlScript,
			result
			;

		// add all matches from the code
		for (var i = 0; i < regexList.length; i++)
		{
			result = getMatches(code, regexList[i]);
			offsetMatches(result, offset);
			matches = matches.concat(result);
		}
		
		// add left script bracket
		if (htmlScript.left != null && match.left != null)
		{
			result = getMatches(match.left, htmlScript.left);
			offsetMatches(result, match.index);
			matches = matches.concat(result);
		}
		
		// add right script bracket
		if (htmlScript.right != null && match.right != null)
		{
			result = getMatches(match.right, htmlScript.right);
			offsetMatches(result, match.index + match[0].lastIndexOf(match.right));
			matches = matches.concat(result);
		}
		
		for (var j = 0; j < matches.length; j++)
			matches[j].brushName = brushClass.brushName;
			
		return matches;
	}
};

/**
 * Main Highlither class.
 * @constructor
 */
sh.Highlighter = function()
{
	// not putting any code in here because of the prototype inheritance
};

sh.Highlighter.prototype = {
	/**
	 * Returns value of the parameter passed to the highlighter.
	 * @param {String} name				Name of the parameter.
	 * @param {Object} defaultValue		Default value.
	 * @return {Object}					Returns found value or default value otherwise.
	 */
	getParam: function(name, defaultValue)
	{
		var result = this.params[name];
		return toBoolean(result == null ? defaultValue : result);
	},
	
	/**
	 * Shortcut to document.createElement().
	 * @param {String} name		Name of the element to create (DIV, A, etc).
	 * @return {HTMLElement}	Returns new HTML element.
	 */
	create: function(name)
	{
		return document.createElement(name);
	},
	
	/**
	 * Applies all regular expression to the code and stores all found
	 * matches in the `this.matches` array.
	 * @param {Array} regexList		List of regular expressions.
	 * @param {String} code			Source code.
	 * @return {Array}				Returns list of matches.
	 */
	findMatches: function(regexList, code)
	{
		var result = [];
		
		if (regexList != null)
			for (var i = 0; i < regexList.length; i++) 
				// BUG: length returns len+1 for array if methods added to prototype chain (oising@gmail.com)
				if (typeof (regexList[i]) == "object")
					result = result.concat(getMatches(code, regexList[i]));
		
		// sort and remove nested the matches
		return this.removeNestedMatches(result.sort(matchesSortCallback));
	},
	
	/**
	 * Checks to see if any of the matches are inside of other matches. 
	 * This process would get rid of highligted strings inside comments, 
	 * keywords inside strings and so on.
	 */
	removeNestedMatches: function(matches)
	{
		// Optimized by Jose Prado (http://joseprado.com)
		for (var i = 0; i < matches.length; i++) 
		{ 
			if (matches[i] === null)
				continue;
			
			var itemI = matches[i],
				itemIEndPos = itemI.index + itemI.length
				;
			
			for (var j = i + 1; j < matches.length && matches[i] !== null; j++) 
			{
				var itemJ = matches[j];
				
				if (itemJ === null) 
					continue;
				else if (itemJ.index > itemIEndPos) 
					break;
				else if (itemJ.index == itemI.index && itemJ.length > itemI.length)
					matches[i] = null;
				else if (itemJ.index >= itemI.index && itemJ.index < itemIEndPos) 
					matches[j] = null;
			}
		}
		
		return matches;
	},
	
	/**
	 * Creates an array containing integer line numbers starting from the 'first-line' param.
	 * @return {Array} Returns array of integers.
	 */
	figureOutLineNumbers: function(code)
	{
		var lines = [],
			firstLine = parseInt(this.getParam('first-line'))
			;
		
		eachLine(code, function(line, index)
		{
			lines.push(index + firstLine);
		});
		
		return lines;
	},
	
	/**
	 * Determines if specified line number is in the highlighted list.
	 */
	isLineHighlighted: function(lineNumber)
	{
		var list = this.getParam('highlight', []);
		
		if (typeof(list) != 'object' && list.push == null) 
			list = [ list ];
		
		return indexOf(list, lineNumber.toString()) != -1;
	},
	
	/**
	 * Generates HTML markup for a single line of code while determining alternating line style.
	 * @param {Integer} lineNumber	Line number.
	 * @param {String} code Line	HTML markup.
	 * @return {String}				Returns HTML markup.
	 */
	getLineHtml: function(lineIndex, lineNumber, code)
	{
		var classes = [
			'line',
			'number' + lineNumber,
			'index' + lineIndex,
			'alt' + (lineNumber % 2 == 0 ? 1 : 2).toString()
		];
		
		if (this.isLineHighlighted(lineNumber))
		 	classes.push('highlighted');
		
		if (lineNumber == 0)
			classes.push('break');
			
		return '<div class="' + classes.join(' ') + '">' + code + '</div>';
	},
	
	/**
	 * Generates HTML markup for line number column.
	 * @param {String} code			Complete code HTML markup.
	 * @param {Array} lineNumbers	Calculated line numbers.
	 * @return {String}				Returns HTML markup.
	 */
	getLineNumbersHtml: function(code, lineNumbers)
	{
		var html = '',
			count = splitLines(code).length,
			firstLine = parseInt(this.getParam('first-line')),
			pad = this.getParam('pad-line-numbers')
			;
		
		if (pad == true)
			pad = (firstLine + count - 1).toString().length;
		else if (isNaN(pad) == true)
			pad = 0;
			
		for (var i = 0; i < count; i++)
		{
			var lineNumber = lineNumbers ? lineNumbers[i] : firstLine + i,
				code = lineNumber == 0 ? sh.config.space : padNumber(lineNumber, pad)
				;
				
			html += this.getLineHtml(i, lineNumber, code);
		}
		
		return html;
	},
	
	/**
	 * Splits block of text into individual DIV lines.
	 * @param {String} code			Code to highlight.
	 * @param {Array} lineNumbers	Calculated line numbers.
	 * @return {String}				Returns highlighted code in HTML form.
	 */
	getCodeLinesHtml: function(html, lineNumbers)
	{
		html = trim(html);
		
		var lines = splitLines(html),
			padLength = this.getParam('pad-line-numbers'),
			firstLine = parseInt(this.getParam('first-line')),
			html = '',
			brushName = this.getParam('brush')
			;

		for (var i = 0; i < lines.length; i++)
		{
			var line = lines[i],
				indent = /^(&nbsp;|\s)+/.exec(line),
				spaces = null,
				lineNumber = lineNumbers ? lineNumbers[i] : firstLine + i;
				;

			if (indent != null)
			{
				spaces = indent[0].toString();
				line = line.substr(spaces.length);
				spaces = spaces.replace(' ', sh.config.space);
			}

			line = trim(line);
			
			if (line.length == 0)
				line = sh.config.space;
			
			html += this.getLineHtml(
				i,
				lineNumber, 
				(spaces != null ? '<code class="' + brushName + ' spaces">' + spaces + '</code>' : '') + line
			);
		}
		
		return html;
	},
	
	/**
	 * Returns HTML for the table title or empty string if title is null.
	 */
	getTitleHtml: function(title)
	{
		return title ? '<caption>' + title + '</caption>' : '';
	},
	
	/**
	 * Finds all matches in the source code.
	 * @param {String} code		Source code to process matches in.
	 * @param {Array} matches	Discovered regex matches.
	 * @return {String} Returns formatted HTML with processed mathes.
	 */
	getMatchesHtml: function(code, matches)
	{
		var pos = 0, 
			result = '',
			brushName = this.getParam('brush', '')
			;
		
		function getBrushNameCss(match)
		{
			var result = match ? (match.brushName || brushName) : brushName;
			return result ? result + ' ' : '';
		};
		
		// Finally, go through the final list of matches and pull the all
		// together adding everything in between that isn't a match.
		for (var i = 0; i < matches.length; i++) 
		{
			var match = matches[i],
				matchBrushName
				;
			
			if (match === null || match.length === 0) 
				continue;
			
			matchBrushName = getBrushNameCss(match);
			
			result += wrapLinesWithCode(code.substr(pos, match.index - pos), matchBrushName + 'plain')
					+ wrapLinesWithCode(match.value, matchBrushName + match.css)
					;

			pos = match.index + match.length + (match.offset || 0);
		}

		// don't forget to add whatever's remaining in the string
		result += wrapLinesWithCode(code.substr(pos), getBrushNameCss() + 'plain');

		return result;
	},
	
	/**
	 * Generates HTML markup for the whole syntax highlighter.
	 * @param {String} code Source code.
	 * @return {String} Returns HTML markup.
	 */
	getHtml: function(code)
	{
		var html = '',
			classes = [ 'syntaxhighlighter' ],
			tabSize,
			matches,
			lineNumbers
			;
		
		// process light mode
		if (this.getParam('light') == true)
			this.params.toolbar = this.params.gutter = false;

		className = 'syntaxhighlighter';

		if (this.getParam('collapse') == true)
			classes.push('collapsed');
		
		if ((gutter = this.getParam('gutter')) == false)
			classes.push('nogutter');

		// add custom user style name
		classes.push(this.getParam('class-name'));

		// add brush alias to the class name for custom CSS
		classes.push(this.getParam('brush'));

		code = trimFirstAndLastLines(code)
			.replace(/\r/g, ' ') // IE lets these buggers through
			;

		tabSize = this.getParam('tab-size');

		// replace tabs with spaces
		code = this.getParam('smart-tabs') == true
			? processSmartTabs(code, tabSize)
			: processTabs(code, tabSize)
			;

		// unindent code by the common indentation
		code = unindent(code);

		if (gutter)
			lineNumbers = this.figureOutLineNumbers(code);
		
		// find matches in the code using brushes regex list
		matches = this.findMatches(this.regexList, code);
		// processes found matches into the html
		html = this.getMatchesHtml(code, matches);
		// finally, split all lines so that they wrap well
		html = this.getCodeLinesHtml(html, lineNumbers);

		// finally, process the links
		if (this.getParam('auto-links'))
			html = processUrls(html);
		
		if (typeof(navigator) != 'undefined' && navigator.userAgent && navigator.userAgent.match(/MSIE/))
			classes.push('ie');
		
		html = 
			'<div id="' + getHighlighterId(this.id) + '" class="' + classes.join(' ') + '">'
				+ (this.getParam('toolbar') ? sh.toolbar.getHtml(this) : '')
				+ '<table border="0" cellpadding="0" cellspacing="0">'
					+ this.getTitleHtml(this.getParam('title'))
					+ '<tbody>'
						+ '<tr>'
							+ (gutter ? '<td class="gutter">' + this.getLineNumbersHtml(code) + '</td>' : '')
							+ '<td class="code">'
								+ '<div class="container">'
									+ html
								+ '</div>'
							+ '</td>'
						+ '</tr>'
					+ '</tbody>'
				+ '</table>'
			+ '</div>'
			;
			
		return html;
	},
	
	/**
	 * Highlights the code and returns complete HTML.
	 * @param {String} code     Code to highlight.
	 * @return {Element}        Returns container DIV element with all markup.
	 */
	getDiv: function(code)
	{
		if (code === null) 
			code = '';
		
		this.code = code;

		var div = this.create('div');

		// create main HTML
		div.innerHTML = this.getHtml(code);
		
		// set up click handlers
		if (this.getParam('toolbar'))
			attachEvent(findElement(div, '.toolbar'), 'click', sh.toolbar.handler);
		
		if (this.getParam('quick-code'))
			attachEvent(findElement(div, '.code'), 'dblclick', quickCodeHandler);
		
		return div;
	},
	
	/**
	 * Initializes the highlighter/brush.
	 *
	 * Constructor isn't used for initialization so that nothing executes during necessary
	 * `new SyntaxHighlighter.Highlighter()` call when setting up brush inheritence.
	 *
	 * @param {Hash} params Highlighter parameters.
	 */
	init: function(params)
	{
		this.id = guid();
		
		// register this instance in the highlighters list
		storeHighlighter(this);
		
		// local params take precedence over defaults
		this.params = merge(sh.defaults, params || {})
		
		// process light mode
		if (this.getParam('light') == true)
			this.params.toolbar = this.params.gutter = false;
	},
	
	/**
	 * Converts space separated list of keywords into a regular expression string.
	 * @param {String} str    Space separated keywords.
	 * @return {String}       Returns regular expression string.
	 */
	getKeywords: function(str)
	{
		str = str
			.replace(/^\s+|\s+$/g, '')
			.replace(/\s+/g, '|')
			;
		
		return '\\b(?:' + str + ')\\b';
	},
	
	/**
	 * Makes a brush compatible with the `html-script` functionality.
	 * @param {Object} regexGroup Object containing `left` and `right` regular expressions.
	 */
	forHtmlScript: function(regexGroup)
	{
		this.htmlScript = {
			left : { regex: regexGroup.left, css: 'script' },
			right : { regex: regexGroup.right, css: 'script' },
			code : new XRegExp(
				"(?<left>" + regexGroup.left.source + ")" +
				"(?<code>.*?)" +
				"(?<right>" + regexGroup.right.source + ")",
				"sgi"
				)
		};
	}
}; // end of Highlighter

return sh;
}(); // end of anonymous function

// CommonJS
typeof(exports) != 'undefined' ? exports['SyntaxHighlighter'] = SyntaxHighlighter : null;
</script><script type="text/javascript">/*!
 * Copyright  2010 Sattvik Software & Technology Resources, Ltd. Co.
 * All rights reserved.
 *
 * sh-clojure may be used under the terms of either the GNU Lesser General Public
 * License (LGPL) or the Eclipse Public License (EPL).  As a recipient of
 * sh-clojure, you may choose which license to receive the code under.  See the
 * LICENSE file distributed with sh-clojure for details.
 *
 * Written by Daniel Solano Gmez
 *
 * Version 0.9.1 - 10 Apr 2010
 */

function ClojureRegExp(pattern) {
	pattern = pattern + '(?=[[\\]{}(),\\s])';
	this.regex = new RegExp(pattern, 'g');
	this.lookBehind = /[\[\]{}(),\s]$/;
}

ClojureRegExp.prototype.exec = function (str) {
	var match, leftContext;
	while (match=this.regex.exec(str)) {
		leftContext = str.substring(0, match.index);
		if (this.lookBehind.test(leftContext)) {
			return match;
		}
		else {
			this.regex.lastIndex = match.index + 1;
		}
	}
	return null;
};

SyntaxHighlighter.brushes.Clojure = function () {
	var special_forms =
			'. def do fn if let loop monitor-enter monitor-exit new quote recur set! ' +
			'throw try var',
	    clojure_core =
			'* *1 *2 *3 *agent* *allow-unresolved-vars* *assert* *clojure-version* ' +
			'*command-line-args* *compile-files* *compile-path* *e *err* *file* ' +
			'*flush-on-newline* *in* *macro-meta* *math-context* *ns* *out* ' +
			'*print-dup* *print-length* *print-level* *print-meta* *print-readably* ' +
			'*read-eval* *source-path* *use-context-classloader* ' +
			'*warn-on-reflection* + - -> -&gt; ->> -&gt;&gt; .. / < &lt; <= &lt;= = ' +
			'== > &gt; >= &gt;= accessor aclone ' +
			'add-classpath add-watch agent agent-errors aget alength alias all-ns ' +
			'alter alter-meta! alter-var-root amap ancestors and apply areduce ' +
			'array-map aset aset-boolean aset-byte aset-char aset-double aset-float ' +
			'aset-int aset-long aset-short assert assoc assoc! assoc-in associative? ' +
			'atom await await-for await1 bases bean bigdec bigint binding bit-and ' +
			'bit-and-not bit-clear bit-flip bit-not bit-or bit-set bit-shift-left ' +
			'bit-shift-right bit-test bit-xor boolean boolean-array booleans ' +
			'bound-fn bound-fn* butlast byte byte-array bytes cast char char-array ' +
			'char-escape-string char-name-string char? chars chunk chunk-append ' +
			'chunk-buffer chunk-cons chunk-first chunk-next chunk-rest chunked-seq? ' +
			'class class? clear-agent-errors clojure-version coll? comment commute ' +
			'comp comparator compare compare-and-set! compile complement concat cond ' +
			'condp conj conj! cons constantly construct-proxy contains? count ' +
			'counted? create-ns create-struct cycle dec decimal? declare definline ' +
			'defmacro defmethod defmulti defn defn- defonce defstruct delay delay? ' +
			'deliver deref derive descendants destructure disj disj! dissoc dissoc! ' +
			'distinct distinct? doall doc dorun doseq dosync dotimes doto double ' +
			'double-array doubles drop drop-last drop-while empty empty? ensure ' +
			'enumeration-seq eval even? every? false? ffirst file-seq filter find ' +
			'find-doc find-ns find-var first float float-array float? floats flush ' +
			'fn fn? fnext for force format future future-call future-cancel ' +
			'future-cancelled? future-done? future? gen-class gen-interface gensym ' +
			'get get-in get-method get-proxy-class get-thread-bindings get-validator ' +
			'hash hash-map hash-set identical? identity if-let if-not ifn? import ' +
			'in-ns inc init-proxy instance? int int-array integer? interleave intern ' +
			'interpose into into-array ints io! isa? iterate iterator-seq juxt key ' +
			'keys keyword keyword? last lazy-cat lazy-seq let letfn line-seq list ' +
			'list* list? load load-file load-reader load-string loaded-libs locking ' +
			'long long-array longs loop macroexpand macroexpand-1 make-array ' +
			'make-hierarchy map map? mapcat max max-key memfn memoize merge ' +
			'merge-with meta method-sig methods min min-key mod name namespace neg? ' +
			'newline next nfirst nil? nnext not not-any? not-empty not-every? not= ' +
			'	ns ns-aliases ns-imports ns-interns ns-map ns-name ns-publics ' +
			'ns-refers ns-resolve ns-unalias ns-unmap nth nthnext num number? odd? ' +
			'or parents partial partition pcalls peek persistent! pmap pop pop! ' +
			'pop-thread-bindings pos? pr pr-str prefer-method prefers ' +
			'primitives-classnames print print-ctor print-doc print-dup print-method ' +
			'print-namespace-doc print-simple print-special-doc print-str printf ' +
			'println println-str prn prn-str promise proxy proxy-call-with-super ' +
			'proxy-mappings proxy-name proxy-super push-thread-bindings pvalues quot ' +
			'rand rand-int range ratio? rational? rationalize re-find re-groups ' +
			're-matcher re-matches re-pattern re-seq read read-line read-string ' +
			'reduce ref ref-history-count ref-max-history ref-min-history ref-set ' +
			'refer refer-clojure release-pending-sends rem remove remove-method ' +
			'remove-ns remove-watch repeat repeatedly replace replicate require ' +
			'reset! reset-meta! resolve rest resultset-seq reverse reversible? rseq ' +
			'rsubseq second select-keys send send-off seq seq? seque sequence ' +
			'sequential? set set-validator! set? short short-array shorts ' +
			'shutdown-agents slurp some sort sort-by sorted-map sorted-map-by ' +
			'sorted-set sorted-set-by sorted? special-form-anchor special-symbol? ' +
			'split-at split-with str stream? string? struct struct-map subs subseq ' +
			'subvec supers swap! symbol symbol? sync syntax-symbol-anchor take ' +
			'take-last take-nth take-while test the-ns time to-array to-array-2d ' +
			'trampoline transient tree-seq true? type unchecked-add unchecked-dec ' +
			'unchecked-divide unchecked-inc unchecked-multiply unchecked-negate ' +
			'unchecked-remainder unchecked-subtract underive unquote ' +
			'unquote-splicing update-in update-proxy use val vals var-get var-set ' +
			'var? vary-meta vec vector vector? when when-first when-let when-not ' +
			'while with-bindings with-bindings* with-in-str with-loading-context ' +
			'with-local-vars with-meta with-open with-out-str with-precision xml-seq ' +
			'zero? zipmap ';

	this.getKeywords = function (keywordStr) {
		// quote special characters
		keywordStr = keywordStr.replace(/[\-\[\]{}()*+?.\\\^$|,#]/g, "\\$&");
		// trim whitespace and convert to alternatives
		keywordStr = keywordStr.replace(/^\s+|\s+$/g, '').replace(/\s+/g, '|');
		// create pattern
		return '(?:' + keywordStr + ')';
	};

	this.regexList = [
		// comments
		{ regex: new RegExp(';.*$', 'gm'),
			css: 'comments' },
		// strings
		{ regex: SyntaxHighlighter.regexLib.multiLineDoubleQuotedString,
			css: 'string' },
		// regular expressions
		{ regex: /#"(?:\.|(\\\")|[^\""\n])*"/g,
			css: 'string' },
		// vectors
		{ regex: /\[|\]/g,
			css: 'keyword' },
		// amperstands
		{ regex: /&(amp;)?/g,
			css: 'keyword' },
		// sets and maps
		{ regex: /#?\{|\}/g,
			css: 'keyword' },
		// metadata
		{ regex: /#\^\{/g,
			css: 'keyword' },
		// anonymous fn syntactic sugar
		{ regex: /#\(|%/g,
			css: 'keyword' },
		// deref reader macro
		{ regex: /@/g,
			css: 'keyword' },
		// (un)quoted sexprs
		{ regex: /(['`]|~@?)[\[({]/g,
			css: 'keyword' },
		// lists
		{ regex: /\(|\)/g,
			css: 'keyword' },
		// character literals
		{ regex: /\\.\b/g,
			css: 'value' },
		// hexadecimal literals
		{ regex: /[+\-]?\b0x[0-9A-F]+\b/gi,
			css: 'value' },
		// integer/octal/float/bigdecimal literals
		{ regex: new ClojureRegExp("[+-]?\\b\\d+(\\.\\d*)?([eE][+-]?\\d+|M)?\\b"),
			css: 'value' },
		{ regex: /^[+\-]?\b\d+(\.\d*)?([eE][+\-]?\d+|M)?\b/g,
			css: 'value' },
		// booleans+nil
		{ regex: /\b(true|false|nil)\b/g,
			css: 'value' },
		// (un)quoted symbols
		{ regex: /(`|#?'|~@?)[\w-.\/]+/g,
			css: 'color1' },
		// keywords
		{ regex: /:[A-Za-z0-9_\-]+/g,
			css: 'constants' },
		// special forms
		{ regex: new ClojureRegExp(this.getKeywords(special_forms)),
			css: 'preprocessor' },
		// type hints
		{ regex: /\#\^[A-Za-z]\w*/g,
			css: 'preprocessor' },
		// clojure.core
		{ regex: new ClojureRegExp(this.getKeywords(clojure_core)),
			css: 'functions' }
	];

	this.forHtmlScript(SyntaxHighlighter.regexLib.scriptScriptTags);
};

SyntaxHighlighter.brushes.Clojure.prototype = new SyntaxHighlighter.Highlighter();
SyntaxHighlighter.brushes.Clojure.aliases   = ['clojure', 'Clojure', 'clj'];

// vim: ts=2 sw=2 noet
</script><script type="text/javascript">
// hackity-hack

$(document).ready(function() {
    var ft = $("#floating-toc")
    var ul = ft.find('ul')
    var lis = ft.find('li')

    ul.css('maring', '0px')

    var liHeight = $(lis.get(0)).height()

    ft.css('height', (liHeight) + 'px')


    showNs = function(ns) {
        //this is killing performance, lookup table.
        //var el = $("[id='floating-toc_" + ns + "']")
        //var index = lis.index(el)

        var index = 0

        for(i in nsPositions.nss) {
            if(ns == nsPositions.nss[i]) index = i
        }

        console.log(index)

        if(index == lastNsIndex) return;

        lastNsIndex = index


        ul.animate({marginTop: (-1 * liHeight * index) + 'px'},
               300)
        //        ul.css('margin-top', (-1 * liHeight * index) + 'px')

    }

    var calcNsPositions = function() {
        var nss = []
        var anchors = []
        var positions = []
        $.each(lis, function(i, el) {
            var ns = $(el).attr('id').split('_')[1]
            nss.push(ns)
            var a = $("a[name='"+ns+"']")
            anchors.push(a)
            positions.push(a.offset().top)
            console.log(a.offset().top)
        });

        return {nss: nss, positions: positions}
    }

    var nsPositions = calcNsPositions()

    console.log(nsPositions)

    var lastNsIndex = -1

    var $window = $(window)

    var currentSection = function(nsp) {

        var ps = nsp.positions
        var nss = nsp.nss
        var scroll = $window.scrollTop() + 300
        var nsIndex = -1
        for(var i in ps) {
            var p = ps[i]
            if(p >= scroll) {
                nsIndex = i-1
                break;
            }
                
        }

        if(nsIndex == -1 && scroll >= ps[0]) {
            nsIndex = ps.length-1
        }

        if(nsIndex == -1) nsIndex = 0

        return nss[nsIndex]
    }

    $(window).scroll(function(e) {
        showNs(currentSection(nsPositions))
    })

    ul.css('margin-top', '0px')

})
</script><style type="text/css">/**
 * SyntaxHighlighter
 * http://alexgorbatchev.com/SyntaxHighlighter
 *
 * SyntaxHighlighter is donationware. If you are using it, please donate.
 * http://alexgorbatchev.com/SyntaxHighlighter/donate.html
 *
 * @version
 * 3.0.83 (July 02 2010)
 * 
 * @copyright
 * Copyright (C) 2004-2010 Alex Gorbatchev.
 *
 * @license
 * Dual licensed under the MIT and GPL licenses.
 */
.syntaxhighlighter a,
.syntaxhighlighter div,
.syntaxhighlighter code,
.syntaxhighlighter table,
.syntaxhighlighter table td,
.syntaxhighlighter table tr,
.syntaxhighlighter table tbody,
.syntaxhighlighter table thead,
.syntaxhighlighter table caption,
.syntaxhighlighter textarea {
  -moz-border-radius: 0 0 0 0 !important;
  -webkit-border-radius: 0 0 0 0 !important;
  background: none !important;
  border: 0 !important;
  bottom: auto !important;
  float: none !important;
  height: auto !important;
  left: auto !important;
  line-height: 1.1em !important;
  margin: 0 !important;
  outline: 0 !important;
  overflow: visible !important;
  padding: 0 !important;
  position: static !important;
  right: auto !important;
  text-align: left !important;
  top: auto !important;
  vertical-align: baseline !important;
  width: auto !important;
  box-sizing: content-box !important;
  font-family: "Consolas", "Bitstream Vera Sans Mono", "Courier New", Courier, monospace !important;
  font-weight: normal !important;
  font-style: normal !important;
  min-height: inherit !important;
  min-height: auto !important;
}

.syntaxhighlighter {
/*  width: 100% !important; */
  margin: 1em 0 1em 0 !important;
  position: relative !important;
  overflow: auto !important;
}
.syntaxhighlighter.source {
  overflow: hidden !important;
}
.syntaxhighlighter .bold {
  font-weight: bold !important;
}
.syntaxhighlighter .italic {
  font-style: italic !important;
}
.syntaxhighlighter .line {
  white-space: pre !important;
}
.syntaxhighlighter table {
/*    width: 100% !important;*/
}
.syntaxhighlighter table caption {
  text-align: left !important;
  padding: .5em 0 0.5em 1em !important;
}
.syntaxhighlighter table td.code {
  width: 100% !important;
}
.syntaxhighlighter table td.code .container {
  position: relative !important;
}
.syntaxhighlighter table td.code .container textarea {
  box-sizing: border-box !important;
  position: absolute !important;
  left: 0 !important;
  top: 0 !important;
  width: 100% !important;
  height: 100% !important;
  border: none !important;
  background: white !important;
  padding-left: 1em !important;
  overflow: hidden !important;
  white-space: pre !important;
}
.syntaxhighlighter table td.gutter .line {
  text-align: right !important;
  padding: 0 0.5em 0 1em !important;
}
.syntaxhighlighter table td.code .line {
  padding: 0 1em !important;
}
.syntaxhighlighter.nogutter td.code .container textarea, .syntaxhighlighter.nogutter td.code .line {
  padding-left: 0em !important;
}
.syntaxhighlighter.show {
  display: block !important;
}
.syntaxhighlighter.collapsed table {
  display: none !important;
}
.syntaxhighlighter.collapsed .toolbar {
    display: none;
/*  padding: 0.1em 0.8em 0em 0.8em !important;
  font-size: 1em !important;
  position: static !important;
  width: auto !important;
  height: auto !important;*/
}
.syntaxhighlighter.collapsed .toolbar span {
  display: inline !important;
  margin-right: 1em !important;
}
.syntaxhighlighter.collapsed .toolbar span a {
  padding: 0 !important;
  display: none !important;
}
.syntaxhighlighter.collapsed .toolbar span a.expandSource {
  display: inline !important;
}
.syntaxhighlighter .toolbar {
    display: none;
/*  position: absolute !important;
  right: 1px !important;
  top: 1px !important;
  width: 11px !important;
  height: 11px !important;
  font-size: 10px !important;
  z-index: 10 !important;*/
}
.syntaxhighlighter .toolbar span.title {
  display: inline !important;
}
.syntaxhighlighter .toolbar a {
  display: block !important;
  text-align: center !important;
  text-decoration: none !important;
  padding-top: 1px !important;
}
.syntaxhighlighter .toolbar a.expandSource {
  display: none !important;
}
.syntaxhighlighter.ie {
  font-size: .9em !important;
  padding: 1px 0 1px 0 !important;
}
.syntaxhighlighter.ie .toolbar {
  line-height: 8px !important;
}
.syntaxhighlighter.ie .toolbar a {
  padding-top: 0px !important;
}
.syntaxhighlighter.printing .line.alt1 .content,
.syntaxhighlighter.printing .line.alt2 .content,
.syntaxhighlighter.printing .line.highlighted .number,
.syntaxhighlighter.printing .line.highlighted.alt1 .content,
.syntaxhighlighter.printing .line.highlighted.alt2 .content {
  background: none !important;
}
.syntaxhighlighter.printing .line .number {
  color: #bbbbbb !important;
}
.syntaxhighlighter.printing .line .content {
  color: black !important;
}
.syntaxhighlighter.printing .toolbar {
  display: none !important;
}
.syntaxhighlighter.printing a {
  text-decoration: none !important;
}
.syntaxhighlighter.printing .plain, .syntaxhighlighter.printing .plain a {
  color: black !important;
}
.syntaxhighlighter.printing .comments, .syntaxhighlighter.printing .comments a {
  color: #008200 !important;
}
.syntaxhighlighter.printing .string, .syntaxhighlighter.printing .string a {
  color: blue !important;
}
.syntaxhighlighter.printing .keyword {
  color: #006699 !important;
  font-weight: bold !important;
}
.syntaxhighlighter.printing .preprocessor {
  color: gray !important;
}
.syntaxhighlighter.printing .variable {
  color: #aa7700 !important;
}
.syntaxhighlighter.printing .value {
  color: #009900 !important;
}
.syntaxhighlighter.printing .functions {
  color: #ff1493 !important;
}
.syntaxhighlighter.printing .constants {
  color: #0066cc !important;
}
.syntaxhighlighter.printing .script {
  font-weight: bold !important;
}
.syntaxhighlighter.printing .color1, .syntaxhighlighter.printing .color1 a {
  color: gray !important;
}
.syntaxhighlighter.printing .color2, .syntaxhighlighter.printing .color2 a {
  color: #ff1493 !important;
}
.syntaxhighlighter.printing .color3, .syntaxhighlighter.printing .color3 a {
  color: red !important;
}
.syntaxhighlighter.printing .break, .syntaxhighlighter.printing .break a {
  color: black !important;
}
</style><style type="text/css">.syntaxhighlighter{overflow:hidden !important;}</style><style type="text/css">/**
 * SyntaxHighlighter
 * http://alexgorbatchev.com/SyntaxHighlighter
 *
 * SyntaxHighlighter is donationware. If you are using it, please donate.
 * http://alexgorbatchev.com/SyntaxHighlighter/donate.html
 *
 * @version
 * 3.0.83 (July 02 2010)
 * 
 * @copyright
 * Copyright (C) 2004-2010 Alex Gorbatchev.
 *
 * @license
 * Dual licensed under the MIT and GPL licenses.
 */
.syntaxhighlighter {
  background-color: transparent !important;
}
.syntaxhighlighter .line.alt1 {
  background-color: transparent !important;
}
.syntaxhighlighter .line.alt2 {
  background-color: transparent !important;
}
.syntaxhighlighter .line.highlighted.alt1, .syntaxhighlighter .line.highlighted.alt2 {
  background-color: #c3defe !important;
}
.syntaxhighlighter .line.highlighted.number {
  color: white !important;
}
.syntaxhighlighter table caption {
  color: black !important;
}
.syntaxhighlighter .gutter {
  color: #787878 !important;
}
.syntaxhighlighter .gutter .line {
  border-right: 3px solid #d4d0c8 !important;
}
.syntaxhighlighter .gutter .line.highlighted {
  background-color: #d4d0c8 !important;
  color: white !important;
}
.syntaxhighlighter.printing .line .content {
  border: none !important;
}
.syntaxhighlighter.collapsed {
  overflow: visible !important;
}
.syntaxhighlighter.collapsed .toolbar {
  color: #3f5fbf !important;
  background: white !important;
  border: 1px solid #d4d0c8 !important;
}
.syntaxhighlighter.collapsed .toolbar a {
  color: #3f5fbf !important;
}
.syntaxhighlighter.collapsed .toolbar a:hover {
  color: #aa7700 !important;
}
.syntaxhighlighter .toolbar {
  color: #a0a0a0 !important;
  background: #d4d0c8 !important;
  border: none !important;
}
.syntaxhighlighter .toolbar a {
  color: #a0a0a0 !important;
}
.syntaxhighlighter .toolbar a:hover {
  color: red !important;
}
.syntaxhighlighter .plain, .syntaxhighlighter .plain a {
  color: black !important;
}
.syntaxhighlighter .comments, .syntaxhighlighter .comments a {
  color: #3f5fbf !important;
}
.syntaxhighlighter .string, .syntaxhighlighter .string a {
  color: #2a00ff !important;
}
.syntaxhighlighter .keyword {
  color: #7f0055 !important;
}
.syntaxhighlighter .preprocessor {
  color: #646464 !important;
}
.syntaxhighlighter .variable {
  color: #aa7700 !important;
}
.syntaxhighlighter .value {
  color: #009900 !important;
}
.syntaxhighlighter .functions {
  color: #ff1493 !important;
}
.syntaxhighlighter .constants {
  color: #0066cc !important;
}
.syntaxhighlighter .script {
  font-weight: bold !important;
  color: #7f0055 !important;
  background-color: none !important;
}
.syntaxhighlighter .color1, .syntaxhighlighter .color1 a {
  color: gray !important;
}
.syntaxhighlighter .color2, .syntaxhighlighter .color2 a {
  color: #ff1493 !important;
}
.syntaxhighlighter .color3, .syntaxhighlighter .color3 a {
  color: red !important;
}

.syntaxhighlighter .keyword {
  font-weight: bold !important;
}
.syntaxhighlighter .xml .keyword {
  color: #3f7f7f !important;
  font-weight: normal !important;
}
.syntaxhighlighter .xml .color1, .syntaxhighlighter .xml .color1 a {
  color: #7f007f !important;
}
.syntaxhighlighter .xml .string {
  font-style: italic !important;
  color: #2a00ff !important;
}
</style><style type="text/css">html{margin:0;padding:0;}h1{margin:0;padding:0;}h2{margin:0;padding:0;}h3{margin:0;padding:0;}h4{margin:0;padding:0;}a{color:#261A3B;}a:visited{color:#261A3B;}</style><style type="text/css">.header{margin-top:30px;}h1.project-name{font-size:34px;display:inline;}h2.project-version{font-size:18px;margin-top:0;display:inline;margin-left:10px;}.toc-link{font-size:12px;margin-left:10px;color:#252519;text-decoration:none;}.toc-link:hover{color:#5050A6;}.toc h1{font-size:34px;margin:0;}.docs-header{border-bottom:dotted #aaa 1px;padding-bottom:10px;margin-bottom:25px;}.toc h1{font-size:24px;}.toc{border-bottom:solid #bbb 1px;margin-bottom:40px;}.toc ul{margin-left:20px;padding-left:0px;padding-top:0;margin-top:0;}.toc li{list-style-type:none;padding-left:0;}.dependencies{}.dependencies table{font-size:16px;width:99.99%;border:none;margin-left:20px;}.dependencies td{padding-right:20px;;white-space:nowrap;}.dependencies .dotted{width:99%;}.dependencies .dotted hr{margin-bottom:-6px;noshade:noshade;border-top:none;color:transparent;border-left:none;border-bottom:dotted #bbb 1px;border-right:none;background-color:transparent;height:0;}.dependencies .dep-version{text-align:right;}.plugins ul{margin-left:20px;padding-left:0px;padding-top:0;margin-top:0;}.plugins li{list-style-type:none;padding-left:0;}.header p{margin-left:20px;}</style><style type="text/css">#floating-toc{position:fixed;top:10px;right:20px;height:20px;overflow:hidden;text-align:right;}#floating-toc li{list-style-type:none;margin:0;padding:0;}</style><style type="text/css">body{margin:0;padding:0;font-family:'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;;font-size:16px;color:#252519;}h1{font-size:20px;margin-top:0;}a.anchor{text-decoration:none;color:#252519;}a.anchor:hover{color:#5050A6;}table{border-spacing:0;border-bottom:solid #ddd 1px;;margin-bottom:10px;}code{display:inline;}p{margin-top:8px;}tr{margin:0px;padding:0px;}td.docs{width:410px;max-width:410px;vertical-align:top;margin:0px;padding-left:55px;padding-right:20px;border:none;}td.docs pre{font-size:12px;overflow:hidden;}td.codes{border:none;margin:0px;padding-left:20px;width:55%;border-left:solid #E5E5EE 1px;font-size:10pt;vertical-align:top;overflow:hidden;background-color:#F5F5FF;}td.spacer{padding-bottom:40px;}pre code{display:block;padding:4px;}code{background-color:ghostWhite;border:solid #DEDEDE 1px;padding-left:3px;padding-right:3px;font-size:14px;}.syntaxhighlighter code{font-size:13px;}.footer{text-align:center;}</style><title>pallet crates -- Marginalia</title></head><body><table><tr><td class="docs"><div class="header"><h1 class="project-name">pallet crates</h1><h2 class="project-version">0.4.0-SNAPSHOT</h2><br /><p>Pallet Crates</p>
</div><div class="dependencies"><h3>dependencies</h3><table><tr><td class="dep-name">marginalia/marginalia</td><td class="dotted"><hr /></td><td class="dep-version">0.5.0-alpha</td></tr></table></div><div class="dependencies"><h3>dev dependencies</h3><table></table></div></td><td class="codes" style="text-align: center; vertical-align: middle;color: #666;padding-right:20px"><br /><br /><br />(this space intentionally left blank)</td></tr><tr><td class="docs"><div class="toc"><a name="toc"><h3>namespaces</h3></a><ul><li><a href="#pallet.crate.automated-admin-user">pallet.crate.automated-admin-user</a></li><li><a href="#pallet.crate.bzr">pallet.crate.bzr</a></li><li><a href="#pallet.crate.cassandra">pallet.crate.cassandra</a></li><li><a href="#pallet.crate.chef">pallet.crate.chef</a></li><li><a href="#pallet.crate.cloudkick">pallet.crate.cloudkick</a></li><li><a href="#pallet.crate.couchdb">pallet.crate.couchdb</a></li><li><a href="#pallet.crate.crontab">pallet.crate.crontab</a></li><li><a href="#pallet.crate.cruise-control-rb">pallet.crate.cruise-control-rb</a></li><li><a href="#pallet.crate.etc-default">pallet.crate.etc-default</a></li><li><a href="#pallet.crate.etc-hosts">pallet.crate.etc-hosts</a></li><li><a href="#pallet.crate.ganglia">pallet.crate.ganglia</a></li><li><a href="#pallet.crate.git">pallet.crate.git</a></li><li><a href="#"></a></li><li><a href="#pallet.crate.github">pallet.crate.github</a></li><li><a href="#pallet.crate.gpg">pallet.crate.gpg</a></li><li><a href="#pallet.crate.haproxy">pallet.crate.haproxy</a></li><li><a href="#pallet.crate.hudson">pallet.crate.hudson</a></li><li><a href="#pallet.crate.iozone">pallet.crate.iozone</a></li><li><a href="#pallet.crate.iptables">pallet.crate.iptables</a></li><li><a href="#pallet.crate.java">pallet.crate.java</a></li><li><a href="#pallet.crate.jetty">pallet.crate.jetty</a></li><li><a href="#pallet.crate.maven">pallet.crate.maven</a></li><li><a href="#pallet.crate.monit">pallet.crate.monit</a></li><li><a href="#pallet.crate.mysql">pallet.crate.mysql</a></li><li><a href="#pallet.crate.nagios">pallet.crate.nagios</a></li><li><a href="#pallet.crate.nagios-config">pallet.crate.nagios-config</a></li><li><a href="#pallet.crate.nginx">pallet.crate.nginx</a></li><li><a href="#pallet.crate.node-js">pallet.crate.node-js</a></li><li><a href="#pallet.crate.package-builder">pallet.crate.package-builder</a></li><li><a href="#pallet.crate.php">pallet.crate.php</a></li><li><a href="#pallet.crate.postfix">pallet.crate.postfix</a></li><li><a href="#pallet.crate.postgres">pallet.crate.postgres</a></li><li><a href="#pallet.crate.public-dns-if-no-nameserver">pallet.crate.public-dns-if-no-nameserver</a></li><li><a href="#pallet.crate.rabbitmq">pallet.crate.rabbitmq</a></li><li><a href="#pallet.crate.resolv">pallet.crate.resolv</a></li><li><a href="#pallet.crate.ruby">pallet.crate.ruby</a></li><li><a href="#pallet.crate.rubygems">pallet.crate.rubygems</a></li><li><a href="#pallet.crate.sphinx">pallet.crate.sphinx</a></li><li><a href="#pallet.crate.splunk">pallet.crate.splunk</a></li><li><a href="#pallet.crate.squeak">pallet.crate.squeak</a></li><li><a href="#pallet.crate.ssh">pallet.crate.ssh</a></li><li><a href="#pallet.crate.ssh-key">pallet.crate.ssh-key</a></li><li><a href="#pallet.crate.sudoers">pallet.crate.sudoers</a></li><li><a href="#pallet.crate.syslog-ng">pallet.crate.syslog-ng</a></li><li><a href="#pallet.crate.tmux">pallet.crate.tmux</a></li><li><a href="#pallet.crate.tomcat">pallet.crate.tomcat</a></li><li><a href="#pallet.crate.upstart">pallet.crate.upstart</a></li><li><a href="#pallet.crate.vpnc">pallet.crate.vpnc</a></li><li><a href="#pallet.crate.wordpress">pallet.crate.wordpress</a></li><li><a href="#pallet.crate.zeromq">pallet.crate.zeromq</a></li><li><a href="#pallet.crate.zookeeper">pallet.crate.zookeeper</a></li></ul></div></td><td class="codes">&nbsp;</td></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.automated-admin-user" name="pallet.crate.automated-admin-user"><h1 class="project-name">pallet.crate.automated-admin-user</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.automated-admin-user
  (:use [pallet.resource.user :only [user]]
        [pallet.crate.sudoers]
        [pallet.crate.ssh-key :only [authorize-key]]
        [pallet.utils :only [default-public-key-path *admin-user*]]
        pallet.thread-expr)
  (:require
   [pallet.resource :as resource]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn automated-admin-user
  "Builds a user for use in remote-admin automation. The user is given
  permission to sudo without password, so that passwords don't have to appear
  in scripts, etc."
  ([request]
     (automated-admin-user
      request (:username *admin-user*) (default-public-key-path)))
  ([request username]
     (automated-admin-user request username (default-public-key-path)))
  ([request username & public-key-paths]
     (->
      request
      (user username :create-home true :shell :bash)
      (for-> [path-or-bytes public-key-paths]
             (if-> (string? path-or-bytes)
                   (authorize-key username (slurp path-or-bytes))
                   (authorize-key username (String. path-or-bytes))))
      (sudoers {} {} {username {:ALL {:run-as-user :ALL :tags :NOPASSWD}}}))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.bzr" name="pallet.crate.bzr"><h1 class="project-name">pallet.crate.bzr</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.bzr
  (:require
   [pallet.resource.package :as package]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn bzr
  "Install bzr"
  [request]
  (-> request
      (package/package "bzr")
      (package/package "bzrtools")))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.cassandra" name="pallet.crate.cassandra"><h1 class="project-name">pallet.crate.cassandra</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.cassandra
  (:require
   [pallet.argument :as argument]
   [pallet.parameter :as pallet.parameter]
   [pallet.resource :as resource]
   [pallet.resource.package :as package]
   [pallet.parameter :as parameter]
   [pallet.resource.remote-directory :as remote-directory]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.directory :as directory]
   [pallet.resource.file :as file]
   [pallet.resource.service :as service]
   [pallet.stevedore :as stevedore]
   [clojure.string :as string]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def install-path "/usr/local/cassandra")
(def log-path "/var/log/cassandra")
(def config-path "/etc/cassandra")
(def data-path "/var/cassandra")
(def cassandra-home install-path)
(def cassandra-user "cassandra")
(def cassandra-group "cassandra")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn from-package
  [request]
  (-> request
   (package/package-source
    "cassandra"
    :aptitude {:url "ppa:cassandra-ubuntu/stable"})
   (package/package-manager :update)
   (package/package "cassandra")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn url "Download url"
  [version]
  (format
   "http://www.apache.org/dist/cassandra/%s/apache-cassandra-%s-bin.tar.gz"
   version version))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install
  "Install Cassandra"
  [request & {:keys [version user group]
              :or {version "0.6.3"}
              :as options}]
  (let [url (url version)
        owner (or user cassandra-user)
        group (or group cassandra-group)
        home (format "%s-%s" install-path version)]
    (->
     request
     (parameter/parameters
      [:cassandra :home] home
      [:cassandra :owner] owner
      [:cassandra :group] group)
     (remote-directory/remote-directory
      home
      :url url :md5-url (str url ".md5")
      :unpack :tar :tar-options "xz" :owner owner :group group)
     (directory/directory
      log-path :owner owner :group group :mode "0755")
     (directory/directory
      config-path :owner owner :group group :mode "0755")
     (directory/directory
      data-path :owner owner :group group :mode "0755")
     (remote-file/remote-file
      (format "%s/log4j.properties" config-path)
      :remote-file (format "%s/conf/log4j.properties" home)
      :owner owner :group group :mode "0644")
     (remote-file/remote-file
      (format "%s/storage-conf.xml" config-path)
      :remote-file (format "%s/conf/storage-conf.xml" home)
      :owner owner :group group :mode "0644")
     (remote-file/remote-file
      (format "%s/storage-conf.xml" config-path)
      :remote-file (format "%s/cassandra.in.sh" home)
      :owner owner :group group :mode "0644")
     (file/sed
      (format "%s/log4j.properties" config-path)
      {"log4j.rootLogger=INFO, CONSOLE"
       "log4j.rootLogger=INFO, ROLLINGFILE"
       "log4j.appender.ROLLINGFILE.File=cassandra.log"
       (format "log4j.appender.ROLLINGFILE.File=%s/cassandra.log" log-path)}
      :seperator "|"))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.chef" name="pallet.crate.chef"><h1 class="project-name">pallet.crate.chef</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Installation of chef</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.chef
  (:use
   [pallet.resource.package :only [package package-manager]]
   [pallet.resource.directory :only [directory]]
   [pallet.stevedore :only [script]]
   [pallet.utils :only [*admin-user*]]
   [pallet.crate.rubygems :only [gem gem-source rubygems]])
  (:require
   [pallet.resource.exec-script :as exec-script]
   [pallet.parameter :as parameter]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn chef
  "Install chef"
  ([request] (chef request "/var/lib/chef"))
  ([request cookbook-dir]
     (->
      request
      (package "rsync")
      (rubygems)
      (gem-source "http://rubygems.org/")
      (gem "chef")
      (directory cookbook-dir :owner (:username *admin-user*))
      (parameter/assoc-for-target [:chef :cookbook-dir] cookbook-dir))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn solo
  "Run chef solo"
  [request command]
  (let [cookbook-dir (parameter/get-for-target request [:chef :cookbook-dir])]
    (->
     request
     (exec-script/exec-checked-script
      "Chef solo"
      (chef-solo
       -c ~(str cookbook-dir "/config/solo.rb")
       -j ~(str cookbook-dir "/config/" command ".json"))))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.cloudkick" name="pallet.crate.cloudkick"><h1 class="project-name">pallet.crate.cloudkick</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Agent install for cloudkick</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.cloudkick
  (:require
   pallet.resource.remote-file)
  (:require
   [pallet.resource.package :as package]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.hostinfo :as hostinfo]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def cloudkick-conf-template "crate/cloudkick/cloudkick.conf")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn cloudkick
  "Install cloudkick agent.  Options are:
     :name string     - name to identify node in cloudkick
     :tags seq        - tags for grouping nodes in cloudkick
     :resources       - proxy to port 80 on agent-resources.cloudkick.com
     :endpoint        - proxy to port 4166 on agent-endpoint.cloudkick.com"
  [request nodename oauth-key oauth-secret
   & {:keys [name tags resources endpoint] :as options}]
  (-> request
      (remote-file/remote-file
       "/etc/cloudkick.conf"
       :template cloudkick-conf-template
       :values (merge {:oauth-key oauth-key :oauth-secret oauth-secret
                       :name nodename :tags ["any"] :resources nil
                       :endpoint nil}
                      options))
      (package/package-source
       "cloudkick"
       :aptitude {:url "http://packages.cloudkick.com/ubuntu"
                  :key-url "http://packages.cloudkick.com/cloudkick.packages.key"}
       :yum { :url (str "http://packages.cloudkick.com/redhat/"
                        (hostinfo/architecture))})
      (package/package-manager :update)
      (package/package "cloudkick-agent")))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.couchdb" name="pallet.crate.couchdb"><h1 class="project-name">pallet.crate.couchdb</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.couchdb
  (:use
   [pallet.stevedore :only [script]]
   pallet.thread-expr)
  (:require
   [pallet.target :as target]
   [pallet.argument :as argument]
   [pallet.resource :as resource]
   [pallet.resource.package :as package]
   [pallet.resource.exec-script :as exec-script]
   [pallet.stevedore :as script]
   [pallet.resource.service :as service]
   [pallet.resource.directory :as directory]
   [clojure.contrib.json :as json]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def install-dirs
  {:aptitude ["/var/log/couchdb" "/var/run/couchdb" "/var/lib/couchdb"
              "/etc/couchdb"]
   :yum ["/usr/local/var/log/couchdb" "/usr/local/var/run/couchdb"
         "/usr/local/var/lib/couchdb" "/usr/local/etc/couchdb"]})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install
  "Installs couchdb, leaving all default configuration as-is.  Use of the
   `couchdb function is preferred, as it contains a workaround that makes
   it install cleanly in ubuntu."
  [request]
  ;; this fixes this problem
  ;; https://bugs.launchpad.net/ubuntu/karmic/+source/couchdb/+bug/448682
  ;; apparently impacts centos, too.  The fix implemented here pulled from
  ;; http://www.mail-archive.com/user@couchdb.apache.org/msg05488.html
  ;; I added the /var/run/couchdb dirs, which seemed to be tripping up service
  ;; stops and restarts.  The specified paths *should* cover the
  ;; common/reasonable locations....
  (->
   request
   (directory/directories
    (install-dirs (:target-packager request))
    :mode "0770" :owner "couchdb" :group "couchdb")
   (package/package "couchdb")
   ;; the package seems to start couch in some way that the init script
   ;; can't terminate it, so we kill it.
   (exec-script/exec-checked-script
    "Kill and re-start couchdb"
    (pkill couchdb)
    (pkill beam))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn configure
  "Configure couchdb using a key->value map.
   Note that the configuration options mirror the couchdb ini file hierarchy
   documented here: http://wiki.apache.org/couchdb/Configurationfile_couch.ini"
  [request {:as option-keyvals}]
  (->
   request
   (for-> [[k v] option-keyvals
           :let [config-path (->> k (map #(name %)) (interpose "/"))
                 url (apply
                      str "http://localhost:5984/_config/" config-path)
                 v-json (str \' (json/json-str v) \')]]
          (exec-script/exec-script
           (curl -X PUT -d ~v-json ~url)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn couchdb
  "Ensures couchdb is installed (along with curl, as a basis for convenient
   configuration) optionally configuring it as specified.
   e.g. (couchdb
          [:query_server_config :reduce_limit] \"false\"
          [:couchdb :database_dir] \"/var/some/other/path\")
   If any options are provided, then the couch server will be restarted after
   the configuraiton is modified."
  [request & {:as option-keyvals}]
  (let [request (install request)]
    (-> request
        (package/package "curl")
        (service/service "couchdb" :action :restart)
        ;; the sleeps are here because couchdb doesn't actually start taking
        ;; requests for a little bit -- it appears that the real process that's
        ;; forked off is beam which ramps up couchdb *after* it's forked.
        (exec-script/exec-script (sleep 2))
        (configure option-keyvals)
        (service/service "couchdb" :action :restart)
        (exec-script/exec-script
         (sleep 2)
         (echo "Checking that couchdb is alive...")
         (curl "http://localhost:5984")))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.crontab" name="pallet.crate.crontab"><h1 class="project-name">pallet.crate.crontab</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>crontab management</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.crontab
  (:refer-clojure :exclude [alias])
  (:require
   [pallet.stevedore :as stevedore]
   [pallet.utils :as utils]
   [pallet.resource :as resource]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.file :as file]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.user :as user])
  (:use pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def system-cron-dir "/etc/cron.d")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn crontab
  "Manage a user's crontab file. Valid actions are :create or :remove.
   Options are as for remote-file."
  [request user & {:keys [action] :or {action :create} :as options}]
  (let [in-file (str (stevedore/script (user/user-home user)) "/crontab.in")]
    (case action
      :create (->
               request
               (apply->
                remote-file/remote-file
                in-file :owner user :mode "0600"
                (apply
                 concat
                 (select-keys options remote-file/content-options)))
               (exec-script/exec-checked-script
                "Load crontab"
                ("crontab" -u ~user ~in-file)))
      :remove (->
               request
               (file/file in-file :action :delete)
               (exec-script/exec-checked-script
                "Remove crontab"
                ("crontab" -u ~user -r))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn system-crontab
  "Manage a system crontab file. Valid actions are :create or :remove.
Options are as for remote-file."
  [request name & options]
  (let [options (apply hash-map options)
        cron-file (str system-cron-dir "/" name)]
    (condp = (get options :action :create)
        :create (apply
                 remote-file/remote-file request cron-file
                 :owner "root" :group "root" :mode "0644"
                 (apply
                  concat
                  (select-keys options remote-file/content-options)))
        :remove (file/file request cron-file :action :delete))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.cruise-control-rb" name="pallet.crate.cruise-control-rb"><h1 class="project-name">pallet.crate.cruise-control-rb</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Installation cruise-control.rb</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.cruise-control-rb
 (:require
  [pallet.argument :as argument]
  [pallet.stevedore :as stevedore]
  [pallet.resource :as resource]
  [pallet.template :as template]
  [pallet.utils :as utils]
  [pallet.resource.file :as file]
  [pallet.resource.exec-script :as exec-script]
  [pallet.resource.remote-file :as remote-file]
  [pallet.resource.service :as service]
  [pallet.resource.user :as user]
  [pallet.resource.directory :as directory]
  [pallet.resource.exec-script :as exec-script]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def cruise-control-rb-downloads
     {"1.4.0" [ "http://rubyforge.org/frs/download.php/59598/cruisecontrol-1.4.0.tgz"
                "772d8300cc61a581f55e9f1e33eacb6b"]})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def cruise-control-rb-install "/opt/cruisecontrolrb")
(def cruise-control-rb-data "/var/lib/cruisecontrolrb")
(def cruise-control-rb-user "ccrb")
(def cruise-control-rb-owenr cruise-control-rb-user)
(def cruise-control-rb-group "root")
(def cruise-control-rb-init-script "crate/cruise-control-rb/cruisecontrol.rb")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn determine-scm-type
  "determine the scm type"
  [scm-path]
  (cond
   (.contains scm-path "git") :git
   (.contains scm-path "svn") :svn
   (or (.contains scm-path "cvs")
       (.contains scm-path "pserver")) :cvs
   (.contains scm-path "bk") :bitkeeper
   :else nil))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn cruise-control-rb
  "Downloads and installs the specified version of cruisecontrol.rb.  Creates a
cruiscontrol.rb init script."
  ([request] (cruise-control-rb request "1.4.0"))
  ([request version]
     (let [info (cruise-control-rb-downloads version)
           basename (str "cruisecontrol-" version)
           tarfile (str basename ".tgz")
           tarpath (str (stevedore/script (tmp-dir)) "/" tarfile)]
       (-> request
           (remote-file/remote-file
            tarpath :url (first info) :md5 (second info))
           (user/user
            cruise-control-rb-user :home cruise-control-rb-data :shell :false)
           (directory/directory cruise-control-rb-install)
           (directory/directory
            cruise-control-rb-data :owner cruise-control-rb-user)
           (exec-script/exec-script
            (cd ~cruise-control-rb-install)
            (tar xz --strip-components=1 -f ~tarpath))
           (file/file
            (str cruise-control-rb-install "/public/stylesheets/site.css")
            :owner cruise-control-rb-user)
           (file/file
            (str cruise-control-rb-install "/log/production.log")
            :owner cruise-control-rb-user
            :mod "0664")
           (file/file
            (str cruise-control-rb-install "/log/add_project.log")
            :owner cruise-control-rb-user
            :mod "0664")
           (directory/directory
            (str cruise-control-rb-install "/tmp")
            :owner cruise-control-rb-user)
           (directory/directory
            (str cruise-control-rb-install "/tmp")
            :owner cruise-control-rb-user)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn cruise-control-rb-init
  "Creates a cruiscontrol.rb init script."
  [request]
  (service/init-script
   request
   "cruisecontrol.rb"
   :content (utils/load-resource-url
             (template/find-template
              cruise-control-rb-init-script
              (:node-type request)))
   :literal true))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- project-path [project]
  (str cruise-control-rb-data "/projects/" project))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn cruise-control-rb-job
  "Add a cruise control.rb job.
Options include:
  :branch name   -- specify the branch"
  [request name repository-url
   & {:keys [action branch] :or {action :create} :as options}]
  (case action
    :create (exec-script/exec-checked-script
             request
             "cruise-control-rb"
             (export ~(format "CRUISE_DATA_ROOT=%s" cruise-control-rb-data))
             (if-not (file-exists? ~(project-path name))
               (sudo
                -u ~cruise-control-rb-user
                ~(format "CRUISE_DATA_ROOT=%s" cruise-control-rb-data)
                ~(str cruise-control-rb-install "/cruise")
                add ~name
                --repository ~repository-url
                --source-control ~(determine-scm-type repository-url)
                ~(stevedore/option-args
                  (apply concat (dissoc options :action))))))
    :remove (directory/directory
             request
             (project-path name)
             :action :remove :recursive true :force true)))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.etc-default" name="pallet.crate.etc-default"><h1 class="project-name">pallet.crate.etc-default</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Generation and installation of /etc/default-style files.</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.etc-default
 (:require
   [pallet.stevedore :as stevedore]
   [pallet.resource.file :as file]
   [pallet.resource.filesystem-layout :as filesystem-layout]
   [pallet.resource.remote-file :as remote-file]
   [clojure.string :as string]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn write
  "Writes a KEY=value file to /etc/default/~{filename}, or ~{filename} if
   filename starts with a /.  Note that all values are quoted, and quotes in
   values are escaped, but otherwise, values are written literally.
   e.g. (write \"tomcat6\"
          :JAVA_OPTS \"-Xmx1024m\"
          \"JSP_COMPILER\" \"javac\")"
  [request filename & key-value-pairs]
  (let [file (if (= \/ (first filename))
               filename
               (str (stevedore/script (etc-default)) "/" filename))]
    (-> request
        (remote-file/remote-file
         file
         :owner "root:root"
         :mode 644
         :content (string/join
                   \newline
                   (for [[k v] (partition 2 key-value-pairs)]
                     (str (name k) "=" (pr-str v))))))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.etc-hosts" name="pallet.crate.etc-hosts"><h1 class="project-name">pallet.crate.etc-hosts</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>/etc/hosts file.</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.etc-hosts
 (:require
   [pallet.argument :as argument]
   [pallet.compute :as compute]
   [pallet.parameter :as parameter]
   [pallet.stevedore :as stevedore]
   [pallet.request-map :as request-map]
   [pallet.resource.file :as file]
   [pallet.resource.filesystem-layout :as filesystem-layout]
   [pallet.resource.remote-file :as remote-file]
   [clojure.string :as string]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- format-entry
  [entry]
  (format "%s %s"  (key entry) (name (val entry))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn host
  "Declare a host entry"
  [request address names]
  (->
   request
   (parameter/update-for-target [:hosts] merge {address names})))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn hosts-for-tag
  "Declare host entries for all nodes of a tag"
  [request tag & {:keys [private-ip]}]
  (let [ip (if private-ip compute/private-ip compute/primary-ip)]
    (->
     request
     (parameter/update-for-target
      [:hosts]
      merge
      (into
       {}
       (map #(vector (ip %) (compute/hostname %))
            (request-map/nodes-in-tag request tag)))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def ^{:private true} localhost
  {"127.0.0.1" "localhost localhost.localdomain"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- format-hosts*
  [entries]
  (string/join "\n" (map format-entry entries)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- format-hosts
  [request]
  (format-hosts*
   (conj localhost (parameter/get-for-target request [:hosts] nil))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn hosts
  "Writes the hosts files"
  [request]
  (-> request
      (remote-file/remote-file
       (stevedore/script (etc-hosts))
       :owner "root:root"
       :mode 644
       :content (argument/delayed [request] (format-hosts request)))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.ganglia" name="pallet.crate.ganglia"><h1 class="project-name">pallet.crate.ganglia</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Install and configure ganglia.</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.ganglia
  (:require
   [pallet.argument :as argument]
   [pallet.compute :as compute]
   [pallet.target :as target]
   [pallet.request-map :as request-map]
   [pallet.resource :as resource]
   [pallet.stevedore :as stevedore]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.file :as file]
   [pallet.resource.package :as package]
   [pallet.crate.nagios-config :as nagios-config]
   [clojure.string :as string]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install
  [request]
  (-> request
      (package/packages
       :aptitude ["rrdtool" "librrds-perl" "librrd2-dev" "php5-gd"
                  "ganglia-monitor" "ganglia-webfrontend" "gmetad"])
      (file/symbolic-link
       "/usr/share/ganglia-webfrontend" "/var/www/ganglia")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn monitor
  [request]
  (package/packages request :aptitude ["ganglia-monitor"]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn data-source
  [request [id {:keys [interval hosts] :or {interval 15}}]]
  (format
   "data_source \"%s\" %d %s\n"
   id interval
   (string/join " " (if (or (seq? hosts) (vector? hosts))
                      hosts
                      (map
                       compute/primary-ip
                       (request-map/nodes-in-tag request hosts))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn configure*
  [request {:keys [data_sources rras trusted_hosts]
            :as options}]
  (str
   (reduce #(str %1 (data-source request %2))  data_sources)
   (when rras
     (reduce #(str %1 (format " \"%s\ %2)) "RRAs" rras))
   (when trusted_hosts
     (reduce #(str %1 (format " %s" %2)) "trusted_hosts" trusted_hosts))
   (reduce
    #(str %1 (format "%s %s" (name (first %2)) (second %2)))
    (select-keys
     options
     [:scalable :gridname :authority :all_trusted
      :setuid :setuid_username :xml_port :interactive_port
      :server_threads :rrd_rootdir]))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn configure
  "Each data source is a map, keyed by data source name.
     :interval   (15s)
     :hosts      list of hosts, or tag name"
  [request & {:keys [data_sources] :as options}]
  (remote-file/remote-file
   request
   "/etc/ganglia/gmetad.conf"
   :content (argument/delayed [request]
             (configure* request options))
   :mode 644))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(declare format-value)</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn format-map
  [[key value]]
  (cond
   (map? value) (format
                 "%s {\n%s}\n" (name key) (format-value value))
   (or (seq? value)
       (vector? value)) (string/join
                         (map #(format-value {key %}) value))
   (= :include key) (format "%s (%s)\n" (name key) (format-value value))
   :else (format "%s = %s\n" (name key) (format-value value))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn format-value
  [value]
  (cond
   (map? value) (string/join
                 (map format-map value))
   (string? value) (format "\"%s\ value)
   :else (format "%s" value)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn metrics
  "Configure metrics"
  [request {:as options}]
  (remote-file/remote-file
   request
   "/etc/ganglia/gmond.conf"
   :content (format-value options)
   :mode 644))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def default-metrics
  {:globals {:daemonize :yes
             :setuid :yes
             :user :ganglia
             :debug_level 0
             :max_udp_msg_len  1472
             :mute :no
             :deaf :no
             :host_dmax  0              ; secs
             :cleanup_threshold  300    ; secs
             :gexec :no
             :send_metadata_interval  0}
   ;; If a cluster attribute is specified, then all gmond hosts are wrapped
   ;; inside of a <CLUSTER> tag.  If you do not specify a cluster tag, then all
   ;; <HOSTS> will NOT be wrapped inside of a <CLUSTER> tag.
   :cluster {:name "unspecified"
             :owner "unspecified"
             :latlong "unspecified"
             :url "unspecified"}
   ;;  The host section describes attributes of the host, like the location
   :host {:location  "unspecified"}
   ;; Feel free to specify as many udp_send_channels as you like.  Gmond used
   ;; to only support having a single channel
   :udp_send_channel {:mcast_join  :239.2.11.71
                      :port  8649
                      :ttl  1}
   ;; You can specify as many udp_recv_channels as you like as well.
   :udp_recv_channel {:mcast_join  :239.2.11.71
                      :port  8649
                      :bind  :239.2.11.71}
   ;; You can specify as many tcp_accept_channels as you like to share
   ;; an xml description of the state of the cluster
   :tcp_accept_channel { :port  8649 }
   ;; Each metrics module that is referenced by gmond must be specified and
   ;; loaded. If the module has been statically linked with gmond, it does not
   ;; require a load path. However all dynamically loadable modules must include
   ;; a load path.
   :modules {:module [{:name  "core_metrics"}
                      {:name  "cpu_module"
                       :path  "/usr/lib/ganglia/modcpu.so"}
                      {:name  "disk_module"
                       :path  "/usr/lib/ganglia/moddisk.so"}
                      {:name  "load_module"
                       :path  "/usr/lib/ganglia/modload.so"}
                      {:name  "mem_module"
                       :path  "/usr/lib/ganglia/modmem.so"}
                      {:name  "net_module"
                       :path  "/usr/lib/ganglia/modnet.so"}
                      {:name  "proc_module"
                       :path  "/usr/lib/ganglia/modproc.so"}
                      {:name  "sys_module"
                       :path  "/usr/lib/ganglia/modsys.so"}]}
   :include "/etc/ganglia/conf.d/*.conf"
   ;; The old internal 2.5.x metric array has been replaced by the following
   ;; collection_group directives.  What follows is the default behavior for
   ;; collecting and sending metrics that is as close to 2.5.x behavior as
   ;; possible.
   ;; This collection group will cause a heartbeat (or beacon) to be sent every
   ;; 20 seconds.  In the heartbeat is the GMOND_STARTED data which expresses
   ;; the age of the running gmond. */
   :collection_group
   [{:collect_once  :yes
     :time_threshold  20
     :metric {:name  "heartbeat"}}
    ;; This collection group will send general info about this host every 1200
    ;; secs. This information doesn't change between reboots and is only
    ;; collected once.
    {:collect_once  :yes
     :time_threshold  1200
     :metric [{:name  "cpu_num"
               :title  "CPU Count"}
              {:name  "cpu_speed"
               :title  "CPU Speed"}
              {:name  "mem_total"
               :title  "Memory Total"}
              ;; Should this be here? Swap can be added/removed
              ;; between reboots.
              {:name  "swap_total"
               :title  "Swap Space Total"}
              {:name  "boottime"
               :title  "Last Boot Time"}
              {:name  "machine_type"
               :title  "Machine Type"}
              {:name  "os_name"
               :title  "Operating System"}
              {:name  "os_release"
               :title  "Operating System Release"}
              {:name  "location"
               :title  "Location"}]}
    ;; This collection group will send the status of gexecd for this host every
    ;; 300 secs. Unlike 2.5.x the default behavior is to report gexecd OFF.
    {:collect_once  :yes
     :time_threshold  300
     :metric {:name  "gexec"
              :title  "Gexec Status"}}
    ;; This collection group will collect the CPU status info every 20 secs.  The
    ;; time threshold is set to 90 seconds.  In honesty, this time_threshold
    ;; could be set significantly higher to reduce unneccessary network
    ;; chatter.
    {
     :collect_every  20
     :time_threshold  90
     ;;  CPU status
     :metric [{:name  "cpu_user"
               :value_threshold  "1.0"
               :title  "CPU User"}
              {:name  "cpu_system"
               :value_threshold  "1.0"
               :title  "CPU System"}
              {:name  "cpu_idle"
               :value_threshold  "5.0"
               :title  "CPU Idle"}
              {:name  "cpu_nice"
               :value_threshold  "1.0"
               :title  "CPU Nice"}
              {:name  "cpu_aidle"
               :value_threshold  "5.0"
               :title  "CPU aidle"}
              {:name  "cpu_wio"
               :value_threshold  "1.0"
               :title  "CPU wio"}
              ;; The next two metrics are optional if you want
              ;; more detail, since they are accounted
              ;; for in cpu_system.
              ;; {:name  "cpu_intr"
              ;;  :value_threshold  "1.0"
              ;;  :title  "CPU intr"}
              ;; {:name  "cpu_sintr"
              ;;  :value_threshold  "1.0"
              ;;  :title  "CPU sintr"}
              ]}
    {:collect_every  20
     :time_threshold  90
     ;; Load Averages
     :metric [{:name  "load_one"
               :value_threshold  "1.0"
               :title  "One Minute Load Average"}
              {:name  "load_five"
               :value_threshold  "1.0"
               :title  "Five Minute Load Average"}
              {:name  "load_fifteen"
               :value_threshold  "1.0"
               :title  "Fifteen Minute Load Average"}]}
    ;; This group collects the number of running and total processes
    {:collect_every  80
     :time_threshold  950
     :metric [{:name  "proc_run"
               :value_threshold  "1.0"
               :title  "Total Running Processes"}
              {:name  "proc_total"
               :value_threshold  "1.0"
               :title  "Total Processes"}]}
    ;; This collection group grabs the volatile memory metrics every 40 secs and
    ;; sends them at least every 180 secs.  This time_threshold can be increased
    ;; significantly to reduce unneeded network traffic.
    {
     :collect_every  40
     :time_threshold  180
     :metric [{:name  "mem_free"
               :value_threshold  "1024.0"
               :title  "Free Memory"}
              {:name  "mem_shared"
               :value_threshold  "1024.0"
               :title  "Shared Memory"}
              {:name  "mem_buffers"
               :value_threshold  "1024.0"
               :title  "Memory Buffers"}
              {:name  "mem_cached"
               :value_threshold  "1024.0"
               :title  "Cached Memory"}
              {:name  "swap_free"
               :value_threshold  "1024.0"
               :title  "Free Swap Space"}]}
    {:collect_every  40
     :time_threshold  300
     :metric [{:name  "bytes_out"
               :value_threshold  4096
               :title  "Bytes Sent"}
              {:name  "bytes_in"
               :value_threshold  4096
               :title  "Bytes Received"}
              {:name  "pkts_in"
               :value_threshold  256
               :title  "Packets Received"}
              {:name  "pkts_out"
               :value_threshold  256
               :title  "Packets Sent"}]}
    ;; Different than 2.5.x default since the old config made no sense
    {:collect_every  1800
     :time_threshold  3600
     :metric {:name  "disk_total"
              :value_threshold  1.0
              :title  "Total Disk Space"}}
    {:collect_every  40
     :time_threshold  180
     :metric [{:name  "disk_free"
               :value_threshold  1.0
               :title  "Disk Space Available"}
              {:name  "part_max_used"
               :value_threshold  1.0
               :title  "Maximum Disk Space Used"}]}]})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nagios-monitor
  "Monitor ganglia web frontent using nagios."
  [request & {:keys [url service_description]
      :or {service_description "Ganglia Web Frontend"}
      :as options}]
  (nagios-config/monitor-http
   request
   :url "/ganglia"
   :service_description service_description))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn check-ganglia-script
  [request]
  (-> request
      (remote-file/remote-file
       "/usr/lib/nagios/plugins/check_ganglia.py"
       :template "crate/ganglia/check_ganglia.py"
       :mode "0755")
      (nagios-config/command
       :command_name "check_ganglia"
       :command_line
       "$USER1$/check_ganglia.py -h $HOSTNAME$ -m $ARG1$ -w $ARG2$ -c $ARG3$")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nagios-monitor-metric
  [request metric warn critical
   & {:keys [service_description servicegroups]
      :or {servicegroups [:ganglia-metrics]}}]
  (nagios-config/service
   request
   {:service_description (or service_description (format "%s" metric))
    :servicegroups servicegroups
    :check_command (format "check_ganglia!%s!%s!%s" metric warn critical)}))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.git" name="pallet.crate.git"><h1 class="project-name">pallet.crate.git</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.git
  (:use
   [pallet.resource.package :only [packages]]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn git
  "Install git"
  [request]
  (packages request
            :yum ["git" "git-email"]
            :aptitude ["git-core" "git-email"]))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#" name=""><h1 class="project-name"></h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn do-deploy-key [req]
  (let [key (lookup-for-target :zkim :id_rsa.pub)]
    (deploy-key req
                "project"
                "key-title"
                key
                :username "<github user>"
                :apikey "<github-api>")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defnode elnode {:image-id "us-east-1/ami-08728661" :min-ram 512}
  :bootstrap (phase (automated-admin-user))
  :configure (phase (java :openjdk)
                    (git)
                    (generate-key "zkim")
                    (record-public-key req "zkim")
                    do-deploy-key))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.github" name="pallet.crate.github"><h1 class="project-name">pallet.crate.github</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Crate for github api</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.github
  (:require
   [pallet.parameter :as parameter]
   [pallet.resource :as resource]
   [clj-http.client :as client]
   [clojure.string :as string]
   [clojure.contrib.json :as json]
   [clojure.contrib.logging :as logging]
   [clojure.contrib.condition :as condition]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def endpoint "https://github.com/api/v2/json")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn api
  "Call the github api using json"
  [username apikey method [& path] & [opts]]
  (update-in
   (client/request
    (update-in
     (merge
      {:method method
       :url (str endpoint (string/join "/" path))
       :basic-auth [username apikey]
       :content-type :json
       :accept :json}
      opts)
     [:body]
     (fn body-to-json [b] (when b (json/json-str b)))))
   [:body]
   (fn body-from-json [b] (when b (json/read-json b)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- set-deploy-key
  "Set a deploy key for the specified project."
  [project title key [username apikey]]
  (let [response (api username apikey :get ["/repos/keys" project])]
    (when-not (some #(= key (:key %)) (:public_keys response))
      (logging/info
       (format "Installing key %s to github project %s" title project))
      (let [response (api username apikey :post ["/repos/keys" project]
                          {:body {:title title :key key}})]
        (when-not (some #(= key (:key %)) (:public_keys response))
          (logging/error
           (format
            "Failed to install key %s to github project %s (response %s)"
            title project response))
          (condition/raise
           :type :github-deploy-key-failed-to-install
           :message (format
                     "Github deploy key '%s' for project '%s'"
                     " failed to install."
                     title project)))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- credentials
  "Extract credentials from request or arguments, and normalise username
   to the required form, depending on whether apikey or password supplied."
  [request options]
  (let [{:keys [username password apikey]} (merge
                                            (parameter/get-for
                                             request [:github] nil)
                                            options)]
    (when-not (and username (or password apikey))
      (condition/raise
       :type :no-github-credentials
       :message "No github credentials supplied in request or invocation."))
    (if apikey
      [(str username "/token") apikey]
      [username password])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(resource/deflocal deploy-key
  "Set a deploy key"
  (deploy-key*
   [request project title key & {:keys [username password apikey] :as options}]
   (set-deploy-key project title key (credentials request options))
   request))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.gpg" name="pallet.crate.gpg"><h1 class="project-name">pallet.crate.gpg</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Install gpg</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.gpg
  (:require
   [pallet.stevedore :as stevedore]
   [pallet.resource.directory :as directory]
   [pallet.resource.user :as user]
   [pallet.resource.package :as package]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.exec-script :as exec-script])
  (:use
   pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn gpg
  "Install from packages"
  [request]
  (package/package request "pgpgpg"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn import-key
  "Import key. Content options are as for remote-file."
  [request & {:keys [user] :as options}]
  (let [path "gpg-key-import"
        user (or user (-> request :user :username))
        home (stevedore/script (user-home ~user))
        dir (str home "/.gnupg")]
    (->
     request
     (directory/directory dir :mode "0700" :owner user)
     (apply->
      remote-file/remote-file
      path (apply concat (merge {:mode "0600" :owner user} options)))
     (exec-script/exec-checked-script
      "Import gpg key"
      (sudo -u ~user gpg -v -v "--homedir" ~dir "--import" ~path))
     (remote-file/remote-file path :action :delete :force true))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.haproxy" name="pallet.crate.haproxy"><h1 class="project-name">pallet.crate.haproxy</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>HA Proxy installation and configuration</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.haproxy
  (:require
   [pallet.argument :as argument]
   [pallet.compute :as compute]
   [pallet.parameter :as parameter]
   [pallet.request-map :as request-map]
   [pallet.resource :as resource]
   [pallet.resource.package :as package]
   [pallet.resource.remote-file :as remote-file]
   [pallet.crate.etc-default :as etc-default]
   [pallet.target :as target]
   [clojure.string :as string]
   [clojure.contrib.logging :as logging]
   clojure.set)
  (:use
   [clojure.contrib.core :only [-?>]]
   pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def conf-path "/etc/haproxy/haproxy.cfg")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def haproxy-user "haproxy")
(def haproxy-group "haproxy")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def default-global
  {:log ["127.0.0.1 local0" "127.0.0.1 local1 notice"]
   :maxconn 4096
   :user "haproxy"
   :group "haproxy"
   :daemon true})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def default-defaults
  {:log "global"
   :mode "http"
   :option ["httplog" "dontlognull" "redispatch"]
   :retries 3
   :maxconn 2000
   :contimeout 5000
   :clitimeout 50000
   :srvtimeout 50000})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install-package
  "Install HAProxy from packages"
  [request]
  (logging/info (format "INSTALL-HAPROXY %s" (request-map/os-family request)))
  (-> request
      (when->
       (= :amzn-linux (request-map/os-family request))
       (resource/execute-pre-phase
        (package/add-epel :version "5-4")))
      (package/package "haproxy")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmulti format-kv (fn format-kv-dispatch [k v & _] (class v)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod format-kv :default
  [k v sep]
  (format "%s %s%s" (name k) v sep))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod format-kv clojure.lang.IPersistentVector
  [k v sep]
  (reduce (fn format-kv-vector [s value] (str s (format-kv k value sep)))  v))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod format-kv clojure.lang.Sequential
  [k v sep]
  (reduce (fn format-kv-vector [s value] (str s (format-kv k value sep)))  v))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod format-kv Boolean
  [k v sep]
  (when v (format "%s%s" (name k) sep)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- config-values
  "Format a map as key value pairs"
  [m]
  (apply str (for [[k v] m] (format-kv k v \newline))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- config-section
  [[key values]]
  (if (= :listen key)
    (reduce
     #(str
       %1
       (format
        "%s %s %s\n%s"
        (name key) (name (first %2)) (:server-address (second %2))
        (config-values (dissoc (second %2) :server-address))))
     ""
     values)
    (format "%s\n%s" (name key) (config-values values))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- config-server
  "Format a server configuration line"
  [m]
  {:pre [(:name m) (:ip m)]}
  (format
   "%s %s%s %s"
   (name (:name m))
   (:ip m)
   (if-let [p (:server-port m)] (str ":" p) "")
   (apply
    str
    (for [[k v] (dissoc m :server-port :ip :name)]
      (format-kv k v " ")))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn merge-servers
  [request options]
  (let [options (update-in
                 options [:listen]
                 (fn [m]
                   (zipmap (map keyword (keys m)) (vals m))))
        apps (map keyword (keys (:listen options)))
        tag (keyword (request-map/tag request))
        srv-apps (-?> request :parameters :haproxy tag)
        app-keys (keys srv-apps)
        unconfigured (clojure.set/difference (set app-keys) (set apps))
        no-nodes (clojure.set/difference (set app-keys) (set apps))]
    (when (seq unconfigured)
      (doseq [app unconfigured]
        (logging/warn
         (format
          "Unconfigured proxy %s %s"
          tag app))))
    (when (seq no-nodes)
      (doseq [app no-nodes]
        (logging/warn
         (format
          "Configured proxy %s %s with no servers"
          tag app))))
    (reduce
     #(update-in %1 [:listen (keyword (first %2)) :server]
                 (fn [servers]
                   (concat
                    (or servers [])
                    (map config-server (second %2)))))
     options
     srv-apps)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn configure
  "Configure HAProxy.
   :global and :defaults both take maps of keyword value pairs. :listen takes a
   map where the keys are of the form \"name\" and contain an :server-address
   key with a string containing ip:port, and other keyword/value. Servers for
   each listen section can be declared with the proxied-by function."
  [request
   & {:keys [global defaults listen frontend backend]
              :as options}]
  (->
   request
   (remote-file/remote-file
    conf-path
    :content (argument/delayed
              [request]
              (let [combined (merge
                              {:global default-global
                               :defaults default-defaults}
                              (merge-servers request options))]
                (string/join
                 (map
                  config-section
                  (map
                   (juxt identity combined)
                   (filter
                    combined
                    [:global :defaults :listen :frontend :backend]))))))
    :literal true)
   (etc-default/write "haproxy" :ENABLED 1)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn proxied-by
  "Declare that a node is proxied by the given haproxy server.
   (proxied-by request :haproxy :app1 :check true)."
  [request proxy-tag proxy-group
   & {:keys [server-port addr backup check cookie disabled fall id
             inter fastinter downinter maxqueue minconn port redir
             rise slowstart source track weight]
      :as options}]
  (->
   request
   (parameter/update-for
    [:haproxy (keyword proxy-tag) (keyword proxy-group)]
    (fn [v]
      (conj
       (or v [])
       (merge
        options
        {:ip (request-map/target-ip request)
         :name (request-map/safe-name request)}))))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.hudson" name="pallet.crate.hudson"><h1 class="project-name">pallet.crate.hudson</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Installation of hudson</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.hudson
  (:use
   [pallet.resource.service :only [service]]
   [pallet.resource.directory :only [directory*]]
   [pallet.resource.remote-file :only [remote-file remote-file*]]
   [clojure.contrib.prxml :only [prxml]]
   [clojure.contrib.logging]
   [clojure.contrib.def]
   pallet.thread-expr)
  (:require
   [net.cgrand.enlive-html :as xml]
   [pallet.crate.maven :as maven]
   [pallet.crate.tomcat :as tomcat]
   [pallet.enlive :as enlive]
   [pallet.parameter :as parameter]
   [pallet.resource :as resource]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.directory :as directory]
   [pallet.resource.user :as user]
   [pallet.stevedore :as stevedore]
   [pallet.utils :as utils]
   [clojure.string :as string]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def hudson-data-path "/var/lib/hudson")
(def hudson-owner "root")
(def hudson-user  "hudson")
(def hudson-group  "hudson")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defvar- *config-file* "config.xml")
(defvar- *user-config-file* "users/config.xml")
(defvar- *maven-file* "hudson.tasks.Maven.xml")
(defvar- *maven2-job-config-file* "job/maven2_config.xml")
(defvar- *git-file* "scm/git.xml")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn path-for
  "Get the actual filename corresponding to a template."
  [base] (str "crate/hudson/" base))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def hudson-download-base-url
  "http://mirrors.hudson-labs.org/war/")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn hudson-url
  "Calculate the url for the specified version"
  [version]
  (if (= version :latest)
    (str hudson-download-base-url "latest/hudson.war")
    (str "http://hudson-ci.org/download/war/" version "/hudson.war")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def hudson-md5
     {"1.377" "81b602c754fdd28cc4d57a9b82a7c1f0"
      "1.355" "5d616c367d7a7888100ae6e98a5f2bd7"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn tomcat-deploy
  "Install hudson on tomcat.
     :version version-string   - specify version, eg 1.355, or :latest"
  [request & {:keys [version] :or {version :latest} :as options}]
  (trace (str "Hudson - install on tomcat"))
  (let [user (parameter/get-for-target request [:tomcat :owner])
        group (parameter/get-for-target request [:tomcat :group])
        file (str hudson-data-path "/hudson.war")]
    (->
     request
     (parameter/assoc-for-target
      [:hudson :data-path] hudson-data-path
      [:hudson :owner] hudson-owner
      [:hudson :user] user
      [:hudson :group] group)
     (directory/directory
      hudson-data-path :owner hudson-owner :group group :mode "0775")
     (remote-file file :url (hudson-url version) :md5 (hudson-md5 version))
     (tomcat/policy
      99 "hudson"
      {(str "file:${catalina.base}/webapps/hudson/-")
       ["permission java.security.AllPermission"]
       (str "file:" hudson-data-path "/-")
       ["permission java.security.AllPermission"]})
     (tomcat/application-conf
      "hudson"
      (format "<?xml version=\"1.0\" encoding=\"utf-8\"?>
 <Context
 privileged=\"true\"
 path=\"/hudson\"
 allowLinking=\"true\"
 swallowOutput=\"true\"
 >
 <Environment
 name=\"HUDSON_HOME\"
 value=\"%s\"
 type=\"java.lang.String\"
 override=\"false\"/>
 </Context>"
              hudson-data-path))
     (tomcat/deploy "hudson" :remote-file file))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn tomcat-undeploy
  "Remove hudson on tomcat"
  [request]
  (trace (str "Hudson - uninistall from tomcat"))
  (let [hudson-data-path (parameter/get-for-target
                           request [:hudson :data-path])
        file (str hudson-data-path "/hudson.war")]
    (->
     request
     (parameter/assoc-for-target [:hudson] nil)
     (tomcat/undeploy "hudson")
     (tomcat/policy 99 "hudson" nil :action :remove)
     (tomcat/application-conf "hudson" nil :action :remove)
     (directory/directory
      hudson-data-path :action :delete :force true :recursive true))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn download-cli [request]
  (let [user (parameter/get-for-target request [:hudson :admin-user])
        pwd (parameter/get-for-target request [:hudson :admin-password])]
    (remote-file/remote-file
     request
     "hudson-cli.jar"
     :url (if user
            (format
             "http://%s:%s@localhost:8080/hudson/jnlpJars/hudson-cli.jar"
             user pwd)
            "http://localhost:8080/hudson/jnlpJars/hudson-cli.jar"))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn cli [request command]
  (let [user (parameter/get-for-target request [:hudson :admin-user])
        pwd (parameter/get-for-target request [:hudson :admin-password])]
    (format
     "java -jar ~/hudson-cli.jar -s http://localhost:8080/hudson %s %s"
     command
     (if user (format "--username %s --password %s" user pwd) ))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn hudson-cli
  "Install a hudson cli."
  [request]
  (download-cli request))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def hudson-plugin-urls
  {:git "http://hudson-ci.org/latest/git.hpi"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install-plugin [request url]
  (str (cli request (str "install-plugin " (utils/quoted url)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn plugin-via-cli
  "Install a hudson plugin.  The plugin should be a keyword.
  :url can be used to specify a string containing the download url"
  [request plugin & {:keys [url] :as options}]
  {:pre [(keyword? plugin)]}
  (info (str "Hudson - add plugin " plugin))
  (let [src (or url (plugin hudson-plugin-urls))]
    (-> request
        (hudson-cli)
        (exec-script/exec-checked-script
         (format "installing %s plugin" plugin)
         ~(install-plugin src)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn cli-command
  "Execute a maven cli command"
  [request message command]
  (-> request
      (hudson-cli)
      (exec-script/exec-checked-script
       message
       ~(str (cli request command)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn version
  "Show running version"
  [request]
  (cli-command request "Hudson Version: " "version"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn reload-configuration
  "Show running version"
  [request]
  (cli-command request "Hudson reload-configuration: " "reload-configuration"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn build
  "Build a job"
  [request job]
  (cli-command request (format "build %s: " job) (format "build %s" job)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmulti plugin-config
  "Plugin configuration"
  (fn [request plugin options] plugin))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod plugin-config :git
  [request plugin _]
  (user/user
   request
   (parameter/get-for-target request [:hudson :user])
   :action :manage :comment "hudson"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn truefalse [value]
  (if value "true" "false"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod plugin-config :ircbot
  [request plugin options]
  (let [hudson-data-path (parameter/get-for-target
                          request [:hudson :data-path])
        hudson-owner (parameter/get-for-target
                      request [:hudson :owner])
        hudson-group (parameter/get-for-target
                      request [:hudson :group])]
    (remote-file/remote-file
     request
     (format "%s/hudson.plugins.ircbot.IrcPublisher.xml" hudson-data-path)
     :content (with-out-str
                (prxml
                 [:decl! {:version "1.0"}]
                 [:hudson.plugins.ircbot.IrcPublisher_-DescriptorImpl {}
                  [:enabled {} (truefalse (:enabled options))]
                  [:hostname {} (:hostname options)]
                  [:port {} (:port options 6674)]
                  [:password {} (:password options)]
                  [:nick {} (:nick options)]
                  [:nickServPassword {} (:nick-serv-password options)]
                  [:defaultTargets (if (seq (:default-targets options))
                                     {}
                                     {:class "java.util.Collections$EmptyList"})
                   (map #(prxml [:hudson.plugins.im.GroupChatIMMessageTarget {}
                                 [:name {} (:name %)]
                                 [:password {} (:password %)]])
                        (:default-targets options))]
                  [:commandPrefix {}  (:command-prefix options)]
                  [:hudsonLogin {}  (:hudson-login options)]
                  [:hudsonPassword {}  (:hudson-password options)]
                  [:useNotice {}  (truefalse (:use-notice options))]]))
     :literal true
     :owner hudson-owner :group hudson-group :mode "664")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod plugin-config :default [request plugin options]
  request)</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def hudson-plugins
  {:git {:url "http://hudson-ci.org/latest/git.hpi"
         :md5 "423afd697acdb2b7728f80573131c15f"}
   :github {:url "http://hudson-ci.org/latest/github.hpi"}
   :instant-messaging {:url
                       "http://hudson-ci.org/latest/instant-messaging.hpi"}
   :ircbot {:url "http://hudson-ci.org/latest/ircbot.hpi"}
   :greenballs {:url "http://hudson-ci.org/latest/greenballs.hpi"}})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure"> (defn plugin
   "Install a hudson plugin.  The plugin should be a keyword.
   :url can be used to specify a string containing the download url"
  [request plugin & {:keys [url md5] :as options}]
  {:pre [(keyword? plugin)]}
  (info (str "Hudson - add plugin " plugin))
  (let [src (merge (plugin hudson-plugins)
                   (select-keys options [:url :md5]))
        hudson-data-path (parameter/get-for-target
                          request [:hudson :data-path])
        hudson-group (parameter/get-for-target
                      request [:hudson :group])]
    (-> request
     (directory/directory (str hudson-data-path "/plugins"))
     (apply->
      remote-file
      (str hudson-data-path "/plugins/" (name plugin) ".hpi")
      :group hudson-group :mode "0664"
      (apply concat src))
     (plugin-config plugin options))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn determine-scm-type
  "determine the scm type"
  [scm-spec]
  (let [scm-path (first scm-spec)]
    (cond
     (.contains scm-path "git") :git
     (.contains scm-path "svn") :svn
     (or (.contains scm-path "cvs")
         (.contains scm-path "pserver")) :cvs
     (.contains scm-path "bk") :bitkeeper
     :else nil)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmulti output-scm-for
  "Output the scm definition for specified type"
  (fn [scm-type node-type scm-path options] scm-type))</pre></tr><tr><td class="docs"><p>"Generate git scm configuration for job content"</p>
</td><td class="codes" /><pre class="brush: clojure">(enlive/defsnippet git-job-xml
  (path-for *git-file*) node-type
  [node-type scm-path options]
  [:#url]
  (xml/do->
   (xml/content scm-path)
   (xml/remove-attr :id))
  [:#refspec]
  (xml/do->
   (xml/remove-attr :id)
   (enlive/transform-if-let [refspec (options :refspec)]
                            (xml/content refspec)))
  [:#receivepack]
  (xml/do->
   (xml/remove-attr :id)
   (enlive/transform-if-let [receivepack (options :receivepack)]
                            (xml/content receivepack)))
  [:#uploadpack]
  (xml/do->
   (xml/remove-attr :id)
   (enlive/transform-if-let [upload-pack (options :uploadpack)]
                            (xml/content upload-pack)))
  [:#tagopt]
  (xml/do->
   (xml/remove-attr :id)
   (enlive/transform-if-let [tagopt (options :tagopt)]
                            (xml/content tagopt))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod output-scm-for :git
  [scm-type node-type scm-path options]
  (git-job-xml node-type scm-path options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn normalise-scms [scms]
  (map #(if (string? %) [%] %) scms))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def class-for-scm
  {:git "hudson.plugins.git.GitSCM"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def class-for-scm-remote
  {:git "org.spearce.jgit.transport.RemoteConfig"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(enlive/deffragment branch-transform
  [branch]
  [:name]
  (xml/content branch))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmulti publisher-config
  "Publisher configuration"
  (fn [[publisher options]] publisher))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def imstrategy {:all "ALL"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod publisher-config :ircbot
  [[_ options]]
  (with-out-str
    (prxml [:hudson.plugins.ircbot.IrcPublisher {}
            [:targets {}
             [:hudson.plugins.im.GroupChatIMMessageTarget {}
              (map #(prxml
                     [:name {} (:name %)]
                     [:password {} (:password %)])
                   (:targets options))]]
            [:strategy {:class "hudson.plugins.im.NotificationStrategy"}
             (imstrategy (:strategy options :all))]
            [:notifyOnBuildStart {}
             (if (:notify-on-build-start options) "true" false)]
            [:notifySuspects {}
             (if (:notify-suspects options) "true" false)]
            [:notifyCulprits {}
             (if (:notify-culprits options) "true" false)]
            [:notifyFixers {}
             (if (:notify-fixers options) "true" false)]
            [:notifyUpstreamCommitters {}
             (if (:notify-upstream-committers options) "true" false)]
            [:channels {}]])))</pre></tr><tr><td class="docs"><p>todo
-    <authorOrCommitter>false</authorOrCommitter>
-    <clean>false</clean>
-    <wipeOutWorkspace>false</wipeOutWorkspace>
-    <buildChooser class="hudson.plugins.git.util.DefaultBuildChooser"/>
-    <gitTool>Default</gitTool>
-    <submoduleCfg class="list"/>
-    <relativeTargetDir></relativeTargetDir>
-    <excludedRegions></excludedRegions>
-    <excludedUsers></excludedUsers></p>
</td><td class="codes" /><pre class="brush: clojure">(defn maven2-job-xml
  "Generate maven2 job/config.xml content"
  [node-type scm-type scms options]
  (enlive/xml-emit
   (enlive/xml-template
    (path-for *maven2-job-config-file*) node-type [scm-type scms options]
    [:scm] (xml/set-attr :class (class-for-scm scm-type))
    [:remoteRepositories :> :*] nil
    [:remoteRepositories]
    (apply
     xml/prepend
     (mapcat #(output-scm-for
               scm-type
               node-type
               (first %)
               (if (seq (next %)) (apply hash-map %) {}))
             scms))
    [:branches :> :*]
    (xml/clone-for [branch (:branches options ["*"])]
                   (branch-transform branch))
    [:mavenName]
    (enlive/transform-if-let [maven-name (:maven-name options)]
                             (xml/content maven-name))
    [:mavenOpts]
    (enlive/transform-if-let [maven-opts (:maven-opts options)]
                             (xml/content
                              maven-opts))
    [:goals]
    (enlive/transform-if-let [goals (:goals options)]
                             (xml/content goals))
    [:groupId]
    (enlive/transform-if-let [group-id (:group-id options)]
                             (xml/content group-id))
    [:artifactId]
    (enlive/transform-if-let [artifact-id (:artifact-id options)]
                             (xml/content artifact-id))
    [:properties :* :projectUrl]
    (enlive/transform-if-let [github-url (-> options :github :projectUrl)]
                             (xml/content github-url))
    [:mergeOptions]
    (let [target (:merge-target options)]
      (if target
        (xml/transformation
         [:mergeTarget] (xml/content target)
         [:mergeRemote] (xml/set-attr
                         :reference (format
                                     "../../remoteRepositories/%s"
                                     (class-for-scm-remote scm-type))))
        (xml/content )))
    [:authToken] (if-let [token (:auth-token options)]
                   (xml/content token))
    [:publishers]
    (xml/html-content
     (string/join (map publisher-config (:publishers options))))
    [:aggregatorStyleBuild] (xml/content
                             (truefalse
                              (:aggregator-style-build options true))))
   scm-type scms options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmulti output-build-for
  "Output the build definition for specified type"
  (fn [build-type node-type scm-type scms options] build-type))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod output-build-for :maven2
  [build-type node-type scm-type scms options]
  (let [scm-type (or scm-type (some determine-scm-type scms))]
    (maven2-job-xml node-type scm-type scms options)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn job
  "Configure a hudson job.
build-type - :maven2
name - name to be used in links
options are:
:scm-type  determine scm type, eg. :git
:scm a sequence of scm repositories, each a string or a sequence.
     If a sequence, options are
        :name, :refspec, :receivepack, :uploadpack and :tagopt
:description \"a descriptive string\"
:branches [\"branch1\" \"branch2\"]"
  [request build-type job-name & {:keys [refspec receivepack uploadpack
                                         tagopt description branches scm
                                         scm-type merge-target]
                                  :as options}]
  (let [hudson-owner (parameter/get-for-target request [:hudson :owner])
        hudson-group (parameter/get-for-target request [:hudson :group])
        hudson-data-path (parameter/get-for-target
                          request [:hudson :data-path])]
    (trace (str "Hudson - configure job " job-name))
    (->
     request
     (directory/directory (str hudson-data-path "/jobs/" job-name) :p true
                :owner hudson-owner :group hudson-group :mode  "0775")
     (remote-file
      (str hudson-data-path "/jobs/" job-name "/config.xml")
      :content
      (output-build-for
       build-type
       (:node-type request)
       (:scm-type options)
       (normalise-scms (:scm options))
       (dissoc options :scm :scm-type))
      :owner hudson-owner :group hudson-group :mode "0664")
     (directory/directory
      hudson-data-path
      :owner hudson-owner :group hudson-group
      :mode "g+w"
      :recursive true))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(enlive/deffragment hudson-task-transform
  [name version]
  [:name]
  (xml/content name)
  [:id]
  (xml/content version))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- hudson-tool-path
  [hudson-data-path name]
  (str hudson-data-path "/tools/" (string/replace name #" " "_")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn hudson-maven-xml
  "Generate hudson.task.Maven.xml content"
  [node-type hudson-data-path maven-tasks]
  (enlive/xml-emit
   (enlive/xml-template
    (path-for *maven-file*) node-type
    [tasks]
    [:installations xml/first-child]
    (xml/clone-for [task tasks]
                   [:name] (xml/content (first task))
                   [:home] (xml/content
                            (hudson-tool-path hudson-data-path (first task)))
                   [:properties] nil))
   maven-tasks))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(resource/defcollect maven-config
  "Configure a maven instance for hudson."
  {:use-arglist [request name version]}
  (hudson-maven*
   [request args]
   (let [group (parameter/get-for-target request [:hudson :group])
         hudson-owner (parameter/get-for-target request [:hudson :owner])
         hudson-data-path (parameter/get-for-target
                           request [:hudson :data-path])]
     (stevedore/do-script
      (directory* request "/usr/share/tomcat6/.m2" :group group :mode "g+w")
      (directory*
       request hudson-data-path :owner hudson-owner :group group :mode "775")
      (remote-file*
       request
       (str hudson-data-path "/" *maven-file*)
       :content (apply
                 str (hudson-maven-xml
                      (:node-type request) hudson-data-path args))
       :owner hudson-owner :group group)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn maven
  [request name version]
  (let [group (parameter/get-for-target request [:hudson :group])
        hudson-owner (parameter/get-for-target request [:hudson :owner])
        hudson-data-path (parameter/get-for-target
                          request [:hudson :data-path])]
    (->
     request
     (maven/download
      :maven-home (hudson-tool-path hudson-data-path name)
      :version version :owner hudson-owner :group group)
     (maven-config name version))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn hudson-user-xml
  "Generate user config.xml content"
  [node-type user]
  (enlive/xml-emit
   (enlive/xml-template
    (path-for *user-config-file*) node-type
    [user]
    [:fullName] (xml/content (:full-name user))
    [(xml/tag= "hudson.security.HudsonPrivateSecurityRealm_-Details")
     :passwordHash]
    (:password-hash user)
    [(xml/tag= "hudson.tasks.Mailer_-UserProperty") :emailAddress]
    (:email user))
   user))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn user
  "Add a hudson user, using hudson's user database."
  [request username {:keys [full-name password-hash email] :as user}]
  (let [group (parameter/get-for-target request [:hudson :group])
        hudson-owner (parameter/get-for-target request [:hudson :owner])
        hudson-data-path (parameter/get-for-target
                          request [:hudson :data-path])]
    (-> request
        (directory/directory
         (format "%s/users/%s" hudson-data-path username)
         :owner hudson-owner :group group :mode "0775")
        (remote-file/remote-file
         (format "%s/users/%s/config.xml" hudson-data-path username)
         :content (hudson-user-xml (:node-type request) user)
         :owner hudson-owner :group group :mode "0664"))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def security-realm-class
  {:hudson "hudson.security.HudsonPrivateSecurityRealm"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def authorization-strategy-class
  {:global-matrix "hudson.security.GlobalMatrixAuthorizationStrategy"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def permission-class
  {:computer-configure "hudson.model.Computer.Configure"
   :computer-delete "hudson.model.Computer.Delete"
   :hudson-administer "hudson.model.Hudson.Administer"
   :hudson-read "hudson.model.Hudson.Read"
   :item-build "hudson.model.Item.Build"
   :item-configure "hudson.model.Item.Configure"
   :item-create "hudson.model.Item.Create"
   :item-delete "hudson.model.Item.Delete"
   :item-read "hudson.model.Item.Read"
   :item-workspace "hudson.model.Item.Workspace"
   :run-delete "hudson.model.Run.Delete"
   :run-update "hudson.model.Run.Update"
   :scm-tag "hudson.scm.SCM.Tag"
   :view-configure "hudson.model.View.Configure"
   :view-create "hudson.model.View.Create"
   :view-delete "hudson.model.View.Delete"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def all-permissions
  [:computer-configure :computer-delete :hudson-administer :hudson-read
   :item-build :item-configure :item-create :item-delete :item-read
   :item-workspace :run-delete :run-update :scm-tag :view-configure
   :view-create :view-delete])</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn config-xml
  "Generate config.xml content"
  [node-type options]
  (enlive/xml-emit
   (enlive/xml-template
    (path-for *config-file*) node-type
    [options]
    [:useSecurity] (xml/content (if (:use-security options) "true" "false"))
    [:securityRealm] (when-let [realm (:security-realm options)]
                       (xml/set-attr :class (security-realm-class realm)))
    [:disableSignup] (xml/content
                      (if (:disable-signup options) "true" "false"))
    [:authorizationStrategy] (when-let [strategy (:authorization-strategy
                                                  options)]
                               (xml/set-attr
                                :class (authorization-strategy-class strategy)))
    [:permission] (xml/clone-for
                   [permission (apply
                                concat
                                (map
                                 (fn user-perm [user-permissions]
                                   (map
                                    #(hash-map
                                      :user (:user user-permissions)
                                      :permission (permission-class % %))
                                    (:permissions user-permissions)))
                                 (:permissions options)))]
                   (xml/content
                    (format "%s:%s"
                            (:permission permission) (:user permission)))))
   options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn config
  "hudson config."
  [request & {:keys [use-security security-realm disable-signup
                     admin-user admin-password] :as options}]
  (let [group (parameter/get-for-target request [:hudson :group])
        hudson-owner (parameter/get-for-target request [:hudson :owner])
        hudson-data-path (parameter/get-for-target
                          request [:hudson :data-path])]
    (-> request
        (parameter/assoc-for-target
         [:hudson :admin-user] admin-user
         [:hudson :admin-password] admin-password)
        (remote-file
         (format "%s/config.xml" hudson-data-path)
         :content (config-xml (:node-type request) options)
         :owner hudson-owner :group group :mode "0664"))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.iozone" name="pallet.crate.iozone"><h1 class="project-name">pallet.crate.iozone</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Crate for iozone disk benchmark</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.iozone
  (:require
   [pallet.target :as target]
   [pallet.resource :as resource]
   [pallet.stevedore :as stevedore]
   [pallet.utils :as utils]
   [pallet.template :as template]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.package :as package]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.file :as file]
   [pallet.resource.directory :as directory])
  (:use
   pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def src-packages
     ["gcc"])</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def iozone-md5s
     {"3_347" "db136f775b19e6d9c00714bd2399785f"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn ftp-path [version]
  (format "http://iozone.org/src/current/iozone%s.tar" version))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def iozone-conf-dir "/etc/iozone")
(def iozone-install-dir "/opt/iozone")
(def iozone-log-dir "/var/log/iozone")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn iozone
  "Install iozone from source. Options:
     :version version-string   -- specify the version (default \"3_347\")"
  [request & {:keys [version] :or {version "3_347"} :as options}]
  (let [basename (str "iozone-" version)
        tarfile (str basename ".tar")
        tarpath (str (stevedore/script (tmp-dir)) "/" tarfile)]
    (->
     request
     (for-> [p src-packages]
       (package/package p))
     (remote-file/remote-file
      tarpath :url (ftp-path version) :md5 (get iozone-md5s version "x"))
     (directory/directory iozone-install-dir :owner "root")
     (exec-script/exec-checked-script
      "Build iozone"
      (cd ~iozone-install-dir)
      (tar x --strip-components=1 -f ~tarpath)
      (cd ~(str iozone-install-dir "/src/current"))
      (make "linux"))                   ; cludge
     (remote-file/remote-file
      "/usr/local/bin/iozone"
      :remote-file (str iozone-install-dir "/src/current/iozone")
      :owner "root" :group "root" :mode "0755"))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.iptables" name="pallet.crate.iptables"><h1 class="project-name">pallet.crate.iptables</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Crate for managing iptables</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.iptables
  (:require
   pallet.target
   [pallet.argument :as argument]
   [pallet.stevedore :as stevedore]
   pallet.resource
   pallet.resource.remote-file
   pallet.resource.file
   [pallet.target :as target]
   [clojure.contrib.string :as string]
   [clojure.contrib.logging :as logging]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def prefix
     {"filter" ":INPUT ACCEPT
:FORWARD ACCEPT
:OUTPUT ACCEPT
:FWR -
-A INPUT -j FWR
-A FWR -i lo -j ACCEPT"})
(def suffix
     {"filter" "# Rejects all remaining connections with port-unreachable errors.
-A FWR -p tcp -m tcp --tcp-flags SYN,RST,ACK SYN -j REJECT --reject-with icmp-port-unreachable
-A FWR -p udp -j REJECT --reject-with icmp-port-unreachable
COMMIT
"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn restore-iptables
  [request [table rules]]
  (pallet.stevedore/script
   (var tmp @(mktemp iptablesXXXX))
   ~(pallet.resource.remote-file/remote-file*
     request
     "$tmp" :content rules)
   ~(pallet.stevedore/checked-script
     "Restore IPtables"
     ("/sbin/iptables-restore" < @tmp))
   (rm @tmp)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn format-iptables
  [tables]
  (string/join \newline (map second tables)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(pallet.resource/defaggregate iptables-rule
  "Define a rule for the iptables. The argument should be a string containing an
iptables configuration line (cf. arguments to an iptables invocation)"
  {:use-arglist [request table config-line]}
  (iptables*
   [request args]
   (let [args (group-by first args)
         tables (into
                 {}
                 (map
                  #(vector
                    (first %)
                    (str
                     "*" (first %) \newline
                     (string/join
                      \newline (filter
                                identity
                                [(prefix (first %))
                                 (string/join
                                  \newline
                                  (map second (second %)))
                                 (suffix (first %) "COMMIT\n")])))) args))
         packager (:target-packager request)]
     (case packager
       :aptitude (stevedore/do-script*
                  (map #(restore-iptables request %) tables))
       :yum (stevedore/do-script
             (pallet.resource.remote-file/remote-file*
              request
              "/etc/sysconfig/iptables"
              :mode "0755"
              :content (format-iptables tables))
             (stevedore/script
              ("/sbin/iptables-restore" < "/etc/sysconfig/iptables")))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn iptables-accept-established
  "Accept established connections"
  [request]
  (iptables-rule
   request "filter" "-A FWR -m state --state RELATED,ESTABLISHED -j ACCEPT"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn iptables-accept-icmp
  "Accept ICMP"
  [request]
  (iptables-rule request "filter" "-A FWR -p icmp -j ACCEPT"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defonce accept-option-strings
  {:source " -s %s" :source-range " -src-range %s"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn iptables-accept-port
  "Accept specific port, by default for tcp."
  ([request port] (iptables-accept-port request port "tcp"))
  ([request port protocol & {:keys [source source-range] :as options}]
     (iptables-rule
      request "filter"
      (format
       "-A FWR -p %s%s --dport %s -j ACCEPT"
       protocol
       (reduce
        #(str %1 (format
                  ((first %2) accept-option-strings)
                  (second %2)))
         options)
       port))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn iptables-redirect-port
  "Redirect a specific port, by default for tcp."
  ([request from-port to-port]
     (iptables-redirect-port request from-port to-port "tcp"))
  ([request from-port to-port protocol]
     (iptables-rule
      request "nat"
      (format "-I PREROUTING -p %s --dport %s -j REDIRECT --to-port %s"
              protocol from-port to-port))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn iptables-throttle
  "Throttle repeated connection attempts.
   http://hostingfu.com/article/ssh-dictionary-attack-prevention-with-iptables"
  ([request name port] (iptables-throttle request name port "tcp" 60 4))
  ([request name port protocol time-period hitcount]
     (iptables-rule
      request "filter"
      (format
       "-N %s
-A FWR -p %s --dport %s -m state --state NEW -j %s
-A %s -m recent --set --name %s
-A %s -m recent --update --seconds %s --hitcount %s --name %s -j DROP"
       name protocol port name name name name time-period hitcount name))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.java" name="pallet.crate.java"><h1 class="project-name">pallet.crate.java</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Crates for java installation and configuration</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.java
  (:require
   [pallet.request-map :as request-map]
   [pallet.resource :as resource]
   [pallet.resource.package :as package]
   [pallet.resource.remote-file :as remote-file]
   [pallet.script :as script]
   [pallet.stevedore :as stevedore]
   [pallet.target :as target])
  (:use pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def vendor-keywords #{:openjdk :sun})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def deb-package-names
     {:openjdk "openjdk-6-"
      :sun "sun-java6-"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def yum-package-names
     {:openjdk "java"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def pacman-package-names
  {:openjdk "openjdk6"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmulti java-package-name "lookup package name"
  (fn [mgr vendor component] mgr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod java-package-name :aptitude [mgr vendor component]
  (if (= vendor :sun)
    [(str (deb-package-names vendor) "bin")
     (str (deb-package-names vendor) (name component))]
    [(str (deb-package-names vendor) (name component))]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod java-package-name :yum [mgr vendor component]
  [(yum-package-names vendor)])</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod java-package-name :pacman [mgr vendor component]
  (if (= :sun vendor)
    [component]
    [(pacman-package-names vendor)]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def sun-rpm-path "http://cds.sun.com/is-bin/INTERSHOP.enfinity/WFS/CDS-CDS_Developer-Site/en_US/-/USD/VerifyItem-Start/jdk-6u18-linux-i586-rpm.bin?BundledLineItemUUID=wb5IBe.lDHsAAAEn5u8ZJpvu&OrderID=yJxIBe.lc7wAAAEn2.8ZJpvu&ProductID=6XdIBe.pudAAAAElYStRSbJV&FileName=/jdk-6u18-linux-i586-rpm.bin")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def ubuntu-partner-url "http://archive.canonical.com/ubuntu")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn java
  "Install java. Options can be :sun, :openjdk, :jdk, :jre.
   By default openjdk will be installed."
  [request & options]
  (let [vendors (or (seq (filter vendor-keywords options))
                    [:sun])
        components (or (seq (filter #{:jdk :jre} options))
                       [:jdk])
        packager (:target-packager request)
        os-family (request-map/os-family request)]
    (let [vc (fn [request vendor component]
               (let [pkgs (java-package-name packager vendor component)]
                 (->
                  request
                  (for->
                   [p pkgs]
                   (when-> (and (= packager :aptitude) (= vendor :sun))
                           (package/package-manager
                            :debconf
                            (str
                             p " shared/present-sun-dlj-v1-1 note")
                            (str
                             p " shared/accepted-sun-dlj-v1-1 boolean true")))
                   (package/package p)))))]
      (->
       request
       (when-> (some #(= :sun %) vendors)
               (when-> (= packager :aptitude)
                       (when-> (= os-family :ubuntu)
                               (package/package-source
                                "Partner"
                                :aptitude {:url ubuntu-partner-url
                                           :scopes ["partner"]}))
                       (package/package-manager :universe)
                       (package/package-manager :multiverse)
                       (package/package-manager :update))
               (when-> (= packager :yum)
                       (package/package "jpackage-utils")))
       (for-> [vendor vendors]
              (for-> [component components]
                     (vc vendor component)))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(script/defscript jre-lib-security [])
(stevedore/defimpl jre-lib-security :default []
  (str @(update-java-alternatives -l "|" cut "-d ' '" -f 3 "|" head -1)
       "/jre/lib/security/"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn jce-policy-file
  "Installs a local JCE policy jar at the given path in the remote JAVA_HOME's
   lib/security directory, enabling the use of \"unlimited strength\" crypto
   implementations. Options are as for remote-file.
   e.g. (jce-policy-file
          \"local_policy.jar\" :local-file \"path/to/local_policy.jar\")
   Note this only intended to work for ubuntu/aptitude-managed systems and Sun
   JDKs right now."
  [request filename & {:as options}]
  (apply remote-file/remote-file request
    (stevedore/script (str (jre-lib-security) ~filename))
    (apply
     concat (merge {:owner "root" :group "root" :mode 644} options))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.jetty" name="pallet.crate.jetty"><h1 class="project-name">pallet.crate.jetty</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Installation of jetty.</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.jetty
  (:require
   [pallet.parameter :as parameter]
   [pallet.resource.directory :as directory]
   [pallet.resource.remote-directory :as remote-directory]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.file :as file]
   [pallet.resource.user :as user]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.service :as service]
   [pallet.resource :as resource]
   [pallet.stevedore :as stevedore]
   [pallet.crate.java :as java]
   [pallet.crate.etc-default :as etc-default]
   [clojure.string :as string])
  (:use pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def install-path "/usr/share/jetty7")
(def log-path "/var/log/jetty7")
(def jetty-user "jetty")
(def jetty-group "jetty")</pre></tr><tr><td class="docs"><p>7.1.4.v20100610
7.0.2.v20100331</p>
</td><td class="codes" /><pre class="brush: clojure">(def default-version "7.0.2.v20100331")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn download-path [version]
  (format
   "http://download.eclipse.org/jetty/%s/dist/jetty-distribution-%s.tar.gz"
   version version))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn jetty
  "Install jetty via download"
  [request & {:as options}]
  (let [path (download-path (:version options default-version))]
    (->
     request
     (parameter/assoc-for
      [:jetty :base] install-path
      [:jetty :owner] jetty-user
      [:jetty :group] jetty-group)
     (java/java :openjdk)
     (user/group jetty-group :system true)
     (user/user jetty-user :system true :shell "/bin/false")
     (remote-directory/remote-directory
      install-path
      :url path :unpack :tar :tar-options "xz"
      :owner jetty-user :group jetty-group)
     (directory/directory
      (str install-path "/webapps") :owner jetty-user :group jetty-group)
     (directory/directory
      (str install-path "/logs") :owner jetty-user :group jetty-group)
     (directory/directory
      log-path :owner jetty-user :group jetty-group)
     (etc-default/write
      "jetty7"
      "JETTY_USER" jetty-user
      "JETTY_LOGS" log-path
      "JETTY_HOME" install-path
      "JAVA_HOME" "/usr/lib/jvm/java-6-openjdk")
     (service/init-script
      "jetty"
      :remote-file (str install-path "/bin/jetty.sh"))
     (when-not-> (:no-enable options)
       (service/service "jetty" :action :enable))
     ;; Remove the default webapps
     (file/file
      (str install-path "/contexts/test.xml") :action :delete :force true)
     (file/file
      (str install-path "/contexts/demo.xml") :action :delete :force true)
     (file/file
      (str install-path "/contexts/javadoc.xml") :action :delete :force true)
     (file/file
      (str install-path "/webapps/test.war") :action :delete :force true)
     (directory/directory
      (str install-path "/contexts/test.d")
      :action :delete :recursive true :force true)
     (service/service "jetty" :action :enable))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(resource/defcollect configure
  "Configure jetty options for jetty.conf.  Each argument will be added to
   the server configuration file."
  {:use-arglist [request option-string]}
  (configure*
   [request options]
   (stevedore/chain-commands
    (directory/directory*
     request
     (str install-path "/etc") :owner jetty-user :group jetty-group)
    (remote-file/remote-file*
     request
     (str install-path "/etc/jetty.conf")
     :content (string/join \newline (map first options))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn server
  "Configure the jetty server (jetty.xml)."
  [request content]
  (remote-file/remote-file
   request
   (str install-path "/etc/jetty.xml")
   :content content)) ;; (configure "etc/jetty.xml") ; read by start.jar</pre></tr><tr><td class="docs"><p>(configure "etc/jetty.xml") ; read by start.jar</p>
</td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn ssl
  "Configure an ssl connector (jetty-ssl.xml)."
  [request content]
  (->
   request
   (remote-file/remote-file
    (str install-path "/etc/jetty-ssl.xml")
    :content content)
   (configure "etc/jetty-ssl.xml")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn context
  "Configure an application context"
  [request name content]
  (remote-file/remote-file
   request
   (str install-path "/contexts/" name ".xml")
   :content content))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn deploy
  "Copies a .war file to the jetty server under webapps/${app-name}.war.  An
   app-name of \"ROOT\" or nil will deploy the source war file as the / webapp.
   Accepts options as for remote-file in order to specify the source.
   Other Options:
     :clear-existing true -- removes an existing exploded ${app-name} directory"
  [request app-name & {:as opts}]
  (let [exploded-app-dir (str install-path "/webapps/" (or app-name "ROOT"))
        deployed-warfile (str exploded-app-dir ".war")
        options (merge
                 {:owner jetty-user :group jetty-group :mode 600}
                 (select-keys opts remote-file/content-options))]
    (->
     request
     (when-not->
      (:clear-existing opts)
       ;; if we're not removing an existing, try at least to make sure
       ;; that jetty has the permissions to explode the war
      (apply->
        directory/directory
        exploded-app-dir
        (apply concat
               (merge {:owner jetty-user :group jetty-group :recursive true}
                      (select-keys options [:owner :group :recursive])))))
     (apply->
      remote-file/remote-file
      deployed-warfile
      (apply concat options))
     (when-> (:clear-existing opts)
       (exec-script/exec-script
        (rm ~exploded-app-dir ~{:r true :f true}))))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.maven" name="pallet.crate.maven"><h1 class="project-name">pallet.crate.maven</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.maven
  (:require
   [pallet.request-map :as request-map]
   [pallet.resource :as resource]
   [pallet.resource.package :as package]
   [pallet.resource.remote-directory :as remote-directory])
  (:use
   pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def maven-parameters
 {:maven-home "/opt/maven2"
  :version "2.2.2"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn maven-download-md5
  [version]
  {"2.2.1" "c581a15cb0001d9b771ad6df7c8156f8"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn maven-download-url
  [version]
  (str "http://mirrors.ibiblio.org/pub/mirrors/apache/maven/binaries/apache-maven-"
       version "-bin.tar.bz2"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn download
  [request & {:keys [maven-home version]
              :or {maven-home "/opt/maven2" version "2.2.2"}
              :as options}]
  (remote-directory/remote-directory
   request
   maven-home
   :url (maven-download-url version)
   :md5 (maven-download-md5 version)
   :unpack :tar :tar-options "xj"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn package
  [request]
  (->
   request
   (when->
    (= :amzn-linux (request-map/os-family request))
    (package/add-jpackage :releasever "5.0"))
   (package/package "maven2")))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.monit" name="pallet.crate.monit"><h1 class="project-name">pallet.crate.monit</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Install monit</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.monit
  (:require
   [pallet.resource.package :as package]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn package
  "Install monit from system package"
  [request]
  (->
   request
   (package/packages
    :yum ["monit"]
    :aptitude ["monit"])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn monitor
  "Monitor something with monit"
  [request & {:as options}])</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.mysql" name="pallet.crate.mysql"><h1 class="project-name">pallet.crate.mysql</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.mysql
  (:require
   [pallet.request-map :as request-map]
   [pallet.resource :as resource]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.package :as package]
   [pallet.resource.service :as service]
   [pallet.parameter :as parameter]
   [pallet.stevedore :as stevedore]
   [clojure.string :as string])
  (:use
   [pallet.resource :only [defresource]]
   [pallet.stevedore :only [script]]
   [pallet.template :only [deftemplate apply-templates]]
   pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def mysql-my-cnf
     {:yum "/etc/my.cnf"
      :aptitude "/etc/mysql/my.cnf"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn mysql-client
  [request]
  (package/packages
   request
   :yum [ "mysql-devel"]
   :aptitude [ "libmysqlclient15-dev" ]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- mysql-script*
  "MYSQL script invocation"
  [username password sql-script]
  (stevedore/script
   ("{\n" mysql "-u" ~username ~(str "--password=" password)
    ~(str "<<EOF\n" (string/replace sql-script "`" "\\`") "\nEOF\n}"))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def ^{:private true}
  sql-create-user "GRANT USAGE ON *.* TO %s IDENTIFIED BY '%s'")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn mysql-server
  "Install mysql server from packages"
  [request root-password & {:keys [start-on-boot] :or {start-on-boot true}}]
  (->
   request
   (package/package-manager
    :debconf
    (str "mysql-server-5.1 mysql-server/root_password password " root-password)
    (str "mysql-server-5.1 mysql-server/root_password_again password " root-password)
    (str "mysql-server-5.1 mysql-server/start_on_boot boolean " start-on-boot)
    (str "mysql-server-5.1 mysql-server-5.1/root_password password " root-password)
    (str "mysql-server-5.1 mysql-server-5.1/root_password_again password " root-password)
    (str "mysql-server-5.1 mysql-server/start_on_boot boolean " start-on-boot))
   (package/package "mysql-server")
   (when->
    (= :yum (request-map/packager request))
    (when->
     start-on-boot
     (service/service "mysqld" :action :enable))
    (service/service "mysqld" :action :start)
    (exec-script/exec-checked-script
     "Set Root Password"
     (chain-or
      ("/usr/bin/mysqladmin" -u root password (quoted ~root-password))
      (echo "Root password already set"))))
   (assoc-in [:parameters :mysql :root-password] root-password)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(deftemplate my-cnf-template
  [request string]
  {{:path (mysql-my-cnf (:target-packager request))
    :owner "root" :mode "0440"}
   string})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defresource mysql-conf
  "my.cnf configuration file for mysql"
  (mysql-conf*
   [request config]
   (apply-templates #(my-cnf-template request %) [config])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn mysql-script
  "Execute a mysql script"
  [request username password sql-script]
  (exec-script/exec-checked-script
   request
   "MYSQL command"
   ~(mysql-script* username password sql-script)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn create-database
  ([request name]
     (create-database
      request name "root"
      (parameter/get-for request [:mysql :root-password])))
  ([request name username root-password]
     (mysql-script
      request
      username root-password
      (format "CREATE DATABASE IF NOT EXISTS `%s`" name))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn create-user
  ([request user password]
     (create-user
      request user password "root"
      (parameter/get-for request [:mysql :root-password])))
  ([request user password username root-password]
     (mysql-script
      request
      username root-password
      (format sql-create-user user password))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn grant
  ([request privileges level user]
     (grant
      request privileges level user "root"
      (parameter/get-for request [:mysql :root-password])))
  ([request privileges level user username root-password]
     (mysql-script
      request
      username root-password
      (format "GRANT %s ON %s TO %s" privileges level user))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.nagios" name="pallet.crate.nagios"><h1 class="project-name">pallet.crate.nagios</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.nagios
  (:require
   [pallet.compute :as compute]
   [pallet.resource :as resource]
   [pallet.request-map :as request-map]
   [pallet.argument :as argument]
   [pallet.parameter :as parameter]
   [pallet.resource.package :as package]
   [pallet.resource.user :as user]
   [pallet.resource.remote-file :as remote-file]
   [clojure.string :as string]
   [clojure.contrib.condition :as condition]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nagios-hostname
  "Return the nagios hostname for a node"
  [node]
  ;; this should match (request-map/safe-name request)
  ;; for things to work well
  (format "%s%s" (compute/tag node) (request-map/safe-id (compute/id node))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def hostgroup-fmt "
define hostgroup {
  hostgroup_name %s
  alias %s
  members %s
  }
")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def host-fmt "
define host {
 use %s
 host_name %s
 alias %s
 address %s
}
")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def service-fmt "
define service {
 use %s
 hostgroup_name %s
 service_description %s
 check_command %s
 notification_interval %s
}
")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def servicegroup-fmt "
define servicegroup {
 servicegroup_name %s
}
")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def host-service-fmt "
define service {
 use %s
 host_name %s
 service_description %s
 check_command %s
 notification_interval %s
 servicegroups %s
}
")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def command-fmt "
define command {
 command_name %s
 command_line %s
}
")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmulti property-fmt
  (fn [value]
    (cond
     (string? value) :default
     (seq? value) :seq
     (vector? value) :seq
     :else :default)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod property-fmt :seq
  [value]
  (string/join "," (map name value)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod property-fmt :default
  [value]
  (str value))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn define
  "Define a nagios object"
  [object-type properties]
  (format
   "define %s{\n%s\n}\n"
   object-type
   (string/join
    \newline
    (map
     #(format " %s %s" (name (first %)) (property-fmt (second %)))
     properties))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn define-contact [properties]
  (define "contact"
    (select-keys
     properties
     [:contact_name :alias :service_notification_period
      :host_notification_period :service_notification_options
      :host_notification_options :service_notification_commands
      :host_notification_commands :email :contactgroups])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn define-contactgroup [properties]
  (define "contactgroup"
    (select-keys
     properties
     [:contactgroup_name :alias :members :contactgroup_members])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(resource/defcollect contact
  "Define a contact for nagios"
  (contact*
   [request options]
   (str
    (remote-file/remote-file*
     request
     "/etc/nagios3/conf.d/pallet-contacts.cfg" :action :delete :force true)
    (remote-file/remote-file*
     request
     "/etc/nagios3/conf.d/pallet-contacts.cfg"
     :owner "root"
     :content (string/join
               \newline
               (concat
                (map (comp define-contact first) options)
                (map (comp
                      define-contactgroup
                      #(hash-map :contactgroup_name %))
                     (distinct
                      (map
                       name
                       (apply
                        concat
                        (map (comp :contactgroups first) options)))))))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn hostgroup
  [name alias members]
  (format hostgroup-fmt name alias (string/join "," members)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn host
  ([ip hostname] (host ip hostname "generic-host"))
  ([ip hostname template]
     (format host-fmt template hostname hostname ip)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn define-servicegroup
  "Define a nagios servicegroup"
  [properties]
  (when-not
      (every? properties #{:servicegroup_name})
    (condition/raise
     :type :invalid-servicegroup-definiton
     :message (format "Invalid servicegroup definition : %s" properties)))
  (define "servicegroup"
    (select-keys
     properties
     [:servicegroup_name :alias :members :servicegroup_members :notes
      :notes_url :action_url])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn define-service
  "Define a nagios service"
  [properties]
  (when-not
      (every? properties #{:service_description :host_name :check_command})
    (condition/raise
     :type :invalid-service-definiton
     :message (format "Invalid service definition : %s" properties)))
  (define "service"
    (select-keys
     properties
     [:use :host_name :hostgroup_name :service_description :display_name
      :servicegroups :is_volatile :check_command :initial_state
      :max_check_attempts :check_interval :retry_interval :active_checks_enabled
      :passive_checks_enabled :check_period :obsess_over_service
      :check_freshness :freshness_threshold :event_handler
      :event_handler_enabled :low_flap_threshold :high_flap_threshold
      :flap_detection_enabled :flap_detection_options :process_perf_data
      :retain_status_information :retain_nonstatus_information
      :notification_interval :first_notification_delay :notification_period
      :notification_options :notifications_enabled :contacts :contact_groups
      :stalking_options :notes :notes_url :action_url :icon_image
      :icon_image_alt])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn host-service
  [hostname {:keys [template check_command service_description
                    notification_interval service_group]
             :as options}]
  (define-service
    (-> (merge
         {:use "generic-service"
          :notification_interval 0}
         options)
        (assoc :host_name hostname))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn config-for-node
  [request node]
  (parameter/get-for request
   [:nagios :host-services (keyword (nagios-hostname node))] nil))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn config-for-unmanaged-node
  [request unmanaged-node]
  (parameter/get-for request
   [:nagios :host-services (keyword (:name unmanaged-node))] nil))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn unmanaged-host
  "Add an unmanaged host to a nagios server. Beware name conflicts between
   managed and unmanged servers are not detected."
  [request ip name]
  (parameter/update-for
   request [:nagios :hosts]
   (fn [m]
     (distinct (conj (or m []) {:ip ip :name name})))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(resource/defresource hosts
  "Define nagios hosts"
  (hosts*
   [request]
   ;(swank.core/break)
   (str
    (remote-file/remote-file*
     request
     "/etc/nagios3/conf.d/pallet-host-*.cfg" :action :delete :force true)
    (string/join
     \newline
     (for [node (filter #(config-for-node request %) (:all-nodes request))
           :let [hostname (nagios-hostname node)]]
       (remote-file/remote-file*
        request
        (format "/etc/nagios3/conf.d/pallet-host-%s.cfg" hostname)
        :owner "root"
        :content (str
                  (host
                   (compute/primary-ip node) hostname)
                  (string/join
                   \newline
                   (map
                    (partial host-service hostname)
                    (config-for-node request node)))))))
    (string/join
     \newline
     (for [node (filter
                 #(config-for-unmanaged-node request %)
                 (parameter/get-for request [:nagios :hosts] nil))
           :let [hostname (:name node)]]
       (remote-file/remote-file*
        request
        (format "/etc/nagios3/conf.d/pallet-host-%s.cfg" hostname)
        :owner "root"
        :content (str
                  (host (:ip node) hostname)
                  (string/join
                   \newline
                   (map
                    (partial host-service hostname)
                    (config-for-unmanaged-node request node))))))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn servicegroup
  "Configure nagios servicegroup monitoring.
    :servicegroup_name    servicegroup name
    :alias                alias
    :members              services
    :servicegroup_members servicegroups
    :notes                note string
    :notes_url            url
    :action_url           url"
  [request options]
  (parameter/update-for
   request [:nagios :servicegroups (keyword (:servicegroup_name options))]
   (fn [x]
     (merge-with
      conj
      (merge (or x {}) (dissoc options :members :servicegroup_members))
      (select-keys options [:members :servicegroup_members])))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(resource/defresource servicegroups
  (servicegroups*
   [request]
   (str
    (remote-file/remote-file*
     request
     "/etc/nagios3/conf.d/pallet-servicegroups.cfg"
     :owner "root"
     :content
     (string/join
      \newline
      (map
       (comp
        define-servicegroup
        #(parameter/get-for
          request
          [:nagios :servicegroups %]
          {:servicegroup_name (name %)}))
       (distinct
        (map
         keyword
         (filter
          identity
          (apply
           concat
           (apply
            concat
            (map
             #(map :servicegroups %)
             (concat
              (map #(config-for-node request %) (:all-nodes request))
              (map #(config-for-unmanaged-node request %)
                   (parameter/get-for
                    request [:nagios :hosts] nil)))))))))))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn command*
  [request [command-name command-line]]
  (remote-file/remote-file*
   request
   (format "/etc/nagios3/conf.d/pallet-command-%s.cfg" (name command-name))
   :owner "root"
   :content (format command-fmt (name command-name) command-line)
   :literal true))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn command
  "Define nagios command"
  [request command-name command-line]
  (remote-file/remote-file
   request
   (format "/etc/nagios3/conf.d/pallet-command-%s.cfg" (name command-name))
   :owner "root"
   :content (format command-fmt (name command-name) command-line)
   :literal true))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(resource/defresource commands
  "Define nagios commands"
  (commands*
   [request]
   (string/join
    "\n"
    (map
     #(command* request %)
     (parameter/get-for request [:nagios :commands] nil)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nrpe-command
  "Define an nrpe command"
  [request]
  (command
   request
   "check_nrpe"
   "$USER1$/check_nrpe -H $HOSTADDRESS$ -c $ARG1$"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn record-nagios-server
  "Record nagios server details"
  [request]
  (parameter/update-for
   request [:nagios :server :ip]
   (fn [x]
     (compute/primary-ip (:target-node request)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn hostgroups
  "Create host groups for each tag, and one for all managed machines."
  [request]
  (let [nodes (filter #(config-for-node request %) (:all-nodes request))]
    (str
     (hostgroup "all-managed" "Managed Servers" (map nagios-hostname nodes))
     (when-let  [unmanaged (parameter/get-for
                            request [:nagios :hosts] nil)]
       (hostgroup
        "all-unmanaged" "Unmanaged Servers"
        (map :name unmanaged)))
     (reduce
      #(str
        %1 " "
        (hostgroup
         (first %2) (first %2)
         (map (fn [n] (nagios-hostname n)) (second %2))))
      (group-by (fn [n] (compute/tag n)) nodes)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nagios
  "Install nagios. Depends on a MTA and a webserver.  Note that you will
   need all target node groups in the lift/converge command."
  [request admin-password]
  (->
   request
   (package/package-manager
    :debconf
    (str "nagios3-cgi nagios3/adminpassword password " admin-password)
    (str "nagios3-cgi nagios3/adminpassword-repeat password " admin-password)
    (str "nagios3-cgi nagios3/httpd multiselect " "apache2"))
   (package/packages
    :yum ["httpd" "gcc" "glib" "glibc-common" "gd" "gd-devel" "nagios"]
    :aptitude ["build-essential" "libgd2-xpm-dev" "apache2"
               "php5-common" "php5" "libapache2-mod-php5"
               "nagios3" "nagios-plugins-extra nagios-nrpe-plugin"])
   ;; remove any botched configuration files
   (remote-file/remote-file
    "/etc/nagios3/conf.d/pallet-hostgroups.cfg" :action :delete :force true)
   (remote-file/remote-file
    "/etc/nagios3/conf.d/pallet-servicegroups.cfg" :action :delete :force true)
   (resource/execute-pre-phase
    (record-nagios-server))
   ;; Generate hostgroups defintion for each tag
   (resource/execute-after-phase
    (commands)
    (remote-file/remote-file
     "/etc/nagios3/conf.d/pallet-hostgroups.cfg"
     :owner "root"
     :content (argument/delayed-fn hostgroups))
    ;; generate host configurations for each node
    (hosts)
    (servicegroups))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.nagios-config" name="pallet.crate.nagios-config"><h1 class="project-name">pallet.crate.nagios-config</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.nagios-config
  (:require
   [pallet.resource :as resource]
   [pallet.argument :as argument]
   [pallet.resource.file :as file]
   [pallet.resource.package :as package]
   [pallet.crate.iptables :as iptables]
   [pallet.crate.nagios :as nagios]
   [pallet.target :as target]
   [pallet.parameter :as parameter]
   [clojure.string :as string])
  (:use
   pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn service
  "Configure nagios service monitoring.
     :servicegroups        name for service group(s) service should be part of
     :check_command        command for service
     :service_description  description for the service"
  [request {:keys [host_name] :as options}]
  (parameter/update-for request
   [:nagios :host-services
    (keyword (or host_name (nagios/nagios-hostname (:target-node request))))]
   (fn [x]
     (distinct
      (conj
       (or x [])
       options)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn command
  "Configure nagios command monitoring.
     :command_name name
     :command_line command line"
  [request & {:keys [command_name command_line] :as options}]
  (parameter/update-for
   request [:nagios :commands (keyword command_name)]
   (fn [_] command_line)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nrpe-client
  "Configure nrpe on machine to be monitored"
  [request]
  (-> request
      (package/package "nagios-nrpe-server")
      (when-let-> [server (parameter/get-for request [:nagios :server :ip] nil)]
                  (file/sed
                   "/etc/nagios/nrpe.cfg"
                   {"allowed_hosts=127.0.0.1"
                    (format "allowed_hosts=%s" server)}))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nrpe-client-port
  "Open the nrpe client port to the nagios server ip"
  [request]
  (-> request
      (when-let-> [server (parameter/get-for request [:nagios :server :ip] nil)]
        (iptables/iptables-accept-port 5666 "tcp" :source server))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nrpe-check-load
  [request]
  (service
   request
   {:servicegroups [:machine]
    :check_command "check_nrpe_1arg!check_load"
    :service_description  "Current Load"}))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nrpe-check-users
  [request]
  (service
   request
   {:servicegroups [:machine]
    :check_command "check_nrpe_1arg!check_users"
    :service_description  "Current Users"}))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nrpe-check-disk
  [request]
  (service
   request
   {:servicegroups [:machine]
    :check_command "check_nrpe_1arg!check_hda1"
    :service_description  "Root Disk"}))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nrpe-check-total-procs
  [request]
  (service
   request
   {:servicegroups [:machine]
    :check_command "check_nrpe_1arg!check_total_procs"
    :service_description  "Total Processes"}))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nrpe-check-zombie-procs
  [request]
  (service
   request
   {:servicegroups [:machine]
    :check_command "check_nrpe_1arg!check_zombie_procs"
    :service_description  "Zombie Processes"}))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def check-http-options
  #{:port :ssl :use-ipv4 :use-ipv6 :timeout :no-body :url
    :expect :string :method :certificate})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn dissoc-keys
  [m keys]
  (apply dissoc m keys))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn monitor-http
  "Configure nagios monitoring of https certificate"
  [request
   & {:keys [port ssl use-ipv4 use-ipv6 timeout no-body url expect string
             method]
      :or {timeout 10}
      :as options}]
  (let [cmd (str
             "check_http_"
             (string/join
              (map name (filter check-http-options (keys options)))))]
    (-> request
        (command
         :command_name cmd
         :command_line
         (format
          "/usr/lib/nagios/plugins/check_http -I '$HOSTADDRESS$' %s --timeout=%s"
          (str
           (when port (format " --port=%d" port))
           (when ssl " --ssl")
           (when no-body " --no-body")
           (when use-ipv4 " --use-ipv4")
           (when use-ipv6 " --use-ipv6")
           (when url (format " --url=%s" url))
           (when expect (format " --expect=%s" expect))
           (when string (format " --string=%s" string))
           (when method (format " --method=%s" method)))
          timeout))
        (service
         (merge
          {:servicegroups [:http-services]
           :service_description (if ssl "HTTPS" "HTTP")}
          (->
           options
           (dissoc-keys check-http-options)
           (assoc :check_command cmd)))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn monitor-https-certificate
  "Configure nagios monitoring of https certificate"
  [request & {:keys [port ssl use-ipv4 use-ipv6 timeout certificate]
              :or {timeout 10 certificate 14}
              :as options}]
  (let [cmd (str
             "check_https_certificate"
             (string/join
              (map name (filter check-http-options (keys options)))))]
    (-> request
        (command
         :command_name cmd
         :command_line
         (format
          "/usr/lib/nagios/plugins/check_http -I '$HOSTADDRESS$' %s --timeout=%s"
          (str
           (when port (format " --port=%d" port))
           (when ssl " --ssl")
           (when use-ipv4 " --use-ipv4")
           (when use-ipv6 " --use-ipv6")
           (format " --certificate=%d" certificate))
          timeout))
        (service
         (merge
          {:servicegroups [:http-services]
           :service_description "HTTPS Certificate"}
          (->
           options
           (dissoc-keys check-http-options)
           (assoc :check_command cmd)))))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.nginx" name="pallet.crate.nginx"><h1 class="project-name">pallet.crate.nginx</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Crate for nginx management functions</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.nginx
  (:require
   [pallet.crate.rubygems :as rubygems]
   [pallet.parameter :as parameter]
   [pallet.argument :as argument]
   [pallet.resource :as resource]
   [pallet.resource.directory :as directory]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.file :as file]
   [pallet.resource.package :as package]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.service :as service]
   [pallet.resource.user :as user]
   [pallet.stevedore :as stevedore]
   [pallet.strint :as strint]
   [pallet.target :as target]
   [pallet.template :as template]
   [pallet.utils :as utils]
   [clojure.contrib.string :as string])
  (:use pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def src-packages
     ["libpcre3" "libpcre3-dev" "libssl" "libssl-dev"])</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def nginx-md5s
     {"0.7.65" "abc4f76af450eedeb063158bd963feaa"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn ftp-path [version]
  (format "http://sysoev.ru/nginx/nginx-%s.tar.gz" version))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def nginx-conf-dir "/etc/nginx")
(def nginx-install-dir "/opt/nginx")
(def nginx-log-dir "/var/log/nginx")
(def nginx-pid-dir "/var/run/nginx")
(def nginx-lock-dir "/var/lock")
(def nginx-user "www-data")
(def nginx-group "www-data")
(def nginx-binary "/usr/local/sbin/nginx")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def nginx-init-script "crate/nginx/nginx")
(def nginx-conf "crate/nginx/nginx.conf")
(def nginx-site "crate/nginx/site")
(def nginx-location "crate/nginx/location")
(def nginx-passenger-conf "crate/nginx/passenger.conf")
(def nginx-mime-conf "crate/nginx/mime.types")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def nginx-defaults
     {:version "0.7.65"
      :modules [:http_ssl_module :http_gzip_static_module]})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def nginx-default-conf
     {:gzip "on"
      :gzip_http_version "1.0"
      :gzip_comp_level "2"
      :gzip_proxied "any"
      :gzip_types ["text/plain"
                   "text/html"
                   "text/css"
                   "application/x-javascript"
                   "text/xml"
                   "application/xml"
                   "application/xml+rss"
                   "text/javascript"]
      :client_max_body_size "10M"
      :sendfile "on"
      :tcp_nopush "off"
      :tcp_nodelay "off"
      :keepalive "on"
      :keepalive_timeout 65
      :worker_processes "total"
      :worker_connections 2048
      :server_names_hash_bucket_size 64})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def nginx-default-site
     {:listen "80"
      :server_name "localhost"
      :access_log (str nginx-log-dir "/access.log")})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def nginx-default-location
     {:location "/"
      :root nil
      :index ["index.html" "index.htm"]
      :proxy_pass nil
      :rails-env nil
      :passenger-enabled nil})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nginx
  "Install nginx from source. Options:
     :version version-string   -- specify the version (default \"0.7.65\")
     :configuration map        -- map of values for nginx.conf"
  [request & options]
  (let [options (merge nginx-defaults (apply hash-map options))
        version (options :version)
        modules (options :version)
        basename (str "nginx-" version)
        tarfile (str basename ".tar.gz")
        tarpath (str (stevedore/script (tmp-dir)) "/" tarfile)
        options (if (:passenger options)
                  (update-in
                   options [:add-modules]
                   (fn [m]
                     (conj (or m [])
                           (stevedore/script
                            (str @("/usr/local/bin/passenger-config --root")
                                 "/ext/nginx")))))
                  options)]
    (-> request
        (for-> [p src-packages]
          (package/package p))
        (remote-file/remote-file
         tarpath :url (ftp-path version) :md5 (get nginx-md5s version "x"))
        (user/user
         nginx-user
         :home nginx-install-dir :shell :false :create-home true :system true)
        (directory/directory nginx-install-dir :owner "root")
        (when-> (:passenger options)
          (package/package "build-essential")
          (package/package "g++")
          (package/package "libxslt1.1")
          (package/package "libssl-dev")
          (package/package "zlib1g-dev")
          (rubygems/require-rubygems)
          (rubygems/gem "passenger" :no-ri true :no-rdoc true))
        (exec-script/exec-checked-script
         "Build nginx"
         (if-not (and @(pipe (~nginx-binary -v) (grep ~version))
                      @(pipe (~nginx-binary -V)
                             (grep ~(if (:passenger options)  "-v") "passenger")))
           (do
             (cd ~nginx-install-dir)
             (tar xz --strip-components=1 -f ~tarpath)
             ("./configure"
              ~(format "--conf-path=%s/nginx.conf" nginx-conf-dir)
              ~(format "--prefix=%s" nginx-install-dir)
              ~(format "--pid-path=%s/nginx.pid" nginx-pid-dir)
              ~(format "--error-log-path=%s/error.log" nginx-log-dir)
              ~(format "--http-log-path=%s/access.log" nginx-log-dir)
              ~(format "--lock-path=%s/nginx" nginx-lock-dir)
              ~(format "--sbin-path=%s" nginx-binary)
              ~(apply
                str
                (map #(format "--with-%s " (utils/as-string %)) (options :modules)))
              ~(apply
                str
                (map #(format "--add-module=%s " (utils/as-string %)) (options :add-modules))))
             (make)
             (make install))))
        (remote-file/remote-file
         (format "%s/nginx.conf" nginx-conf-dir)
         :template nginx-conf
         :values (reduce
                  merge {}
                  [nginx-default-conf
                   (options :configuration)
                   (strint/capture-values nginx-user nginx-group)])
         :owner "root" :group nginx-group :mode "0644")
        (directory/directory
         (format "%s/conf.d" nginx-conf-dir)
         :owner nginx-user :group nginx-group :mode "0755")
        (when-> (:passenger options)
          (remote-file/remote-file
           (format "%s/conf.d/passenger.conf" nginx-conf-dir)
           :template nginx-passenger-conf
           :values (merge
                    {:passenger-root
                     (stevedore/script
                      @("/usr/local/bin/passenger-config --root"))
                     :passenger-ruby
                     (stevedore/script
                      @("which ruby"))}
                    (:configuration options))
           :owner "root" :group nginx-group :mode "0644"))
        (directory/directory
         nginx-pid-dir
         :owner nginx-user :group nginx-group :mode "0755")
        (when-> (= :install (get options :action :install))
          (parameter/parameters
           [:nginx :owner] nginx-user
           [:nginx :group] nginx-group)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn mime
  [request]
  (->
   request
   (remote-file/remote-file
    (format "%s/mime.types" nginx-conf-dir)
    :owner "root"
    :group nginx-group
    :mode "0644"
    :template nginx-mime-conf)
   (file/file
    (format "%s/mime.types.default" nginx-conf-dir)
    :action :delete)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn init
  "Creates a nginx init script."
  [request & {:as options}]
  (->
   request
   (service/init-script
    "nginx"
    :content (utils/load-resource-url
              (template/find-template
               nginx-init-script
               (:node-type request)))
    :literal true)
   (if-not-> (:no-enable options)
     (service/service "nginx" :action :enable))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn site
  "Enable or disable a site.  Options:
:listen        -- address to listen on
:server_name   -- name
:locations     -- locations (a seq of maps, with keys :location, :root
                  :index, :proxy_pass :passenger-enabled :rails-env)"
  [request name & {:keys [locations action] :or {action :enable} :as options}]
  (let [available (format "%s/sites-available/%s" nginx-conf-dir name)
        enabled (format "%s/sites-enabled/%s" nginx-conf-dir name)
        site (fn [request filename]
               (let [locations (string/join
                                \newline
                                (map
                                 #(template/interpolate-template
                                   nginx-location
                                   (merge nginx-default-location %)
                                   (:node-type request))
                                 locations))]
                 (remote-file/remote-file
                  request
                  filename
                  :template nginx-site
                  :values (utils/map-with-keys-as-symbols
                            (reduce
                             merge {:locations locations}
                             [nginx-default-site
                              (dissoc options :locations)])))))]
    (->
     request
     (directory/directory (format "%s/sites-available" nginx-conf-dir))
     (directory/directory (format "%s/sites-enabled" nginx-conf-dir))
     (when-> (= action :enable)
             (site enabled)
             (file/file available :action :delete :force true))
     (when-> (= action :disable)
             (site available)
             (file/file enabled :action :delete :force true))
     (when-> (= action :remove)
             (file/file available :action :delete :force true)
             (file/file enabled :action :delete :force true)))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.node-js" name="pallet.crate.node-js"><h1 class="project-name">pallet.crate.node-js</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Install and configure node.js</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.node-js
  (:require
   [pallet.resource.package :as package]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.remote-directory :as remote-directory]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def src-dir "/opt/local/node-js")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def md5s {"0.2.1" nil})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn tarfile
  [version]
  (format "node-v%s.tar.gz" version))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn download-path [version]
  (format "http://nodejs.org/dist/%s" (tarfile version)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install
  [request & {:keys [version] :or {version "0.2.1"}}]
  (->
   request
   (package/packages
    :yum ["gcc" "glib" "glibc-common" "python"]
    :aptitude ["build-essential" "python" "libssl-dev"])
   (remote-directory/remote-directory
    src-dir :url (download-path version) :md5 (md5s version) :unpack :tar)
   (exec-script/exec-checked-script
    "Build node-js"
    (cd ~src-dir)
    ("./configure")
    (make)
    (make install))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.package-builder" name="pallet.crate.package-builder"><h1 class="project-name">pallet.crate.package-builder</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Build packages.</p>

<p>   For yum, this sets up an environment and provides methods for building
   rpms using mock and rpmbuild. First build a source rpm using
   <code>rpm-build-source-package</code>, the use <code>rpm-rebuild</code> to build for a specific
   target.</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.package-builder
  "Build packages.
   For yum, this sets up an environment and provides methods for building
   rpms using mock and rpmbuild. First build a source rpm using
   `rpm-build-source-package`, the use `rpm-rebuild` to build for a specific
   target."
  (:require
   [pallet.parameter :as parameter]
   [pallet.resource.directory :as directory]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.file :as file]
   [pallet.resource.package :as package]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.user :as user]
   [pallet.stevedore :as stevedore]
   [clojure.string :as string]))</pre></tr><tr><td class="docs"><p>http://fedoraproject.org/wiki/PackageMaintainers/CreatingPackageHowTo
http://wiki.centos.org/HowTos/SetupRpmBuildEnvironment</p>
</td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- rpmbuild-dirs
  "A list of directories to create for building rpms with rpmbuild"
  [base]
  (concat
   [base]
   (map
    #(str base "/" %)
    ["BUILD" "BUILDROOT" "RPMS" "SPECS" "SOURCES" "SRPMS"])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn yum-package-setup
  "Setup an environment for building yum packages with mock.
   Configuration of mock is required using yum-mock-config
   (or use one of the distribution supplied configuration files).
   You could link a configuration file as the default:
     (file/symbolic-link
       \"/etc/mock/epel-5-$(uname -i).cfg\" \"/etc/mock/default.cfg\")
"
  [request & {:keys [base-dir build-dir build-user packager-name packager-email]
              :or {build-user "build"
                   packager-name "Pallet package builder"
                   packager-email "none@nowhere.com"}}]
  (let [home (stevedore/script (user-home ~build-user))
        base-dir (or base-dir (str home "/rpmbuild"))]
    (->
     request
     (package/add-epel)
     (package/package-manager :update)
     (package/package "rpm-build")
     (package/package "redhat-rpm-config")
     (package/package "mock")
     (user/user build-user :create-home true :groups "mock" )
     (directory/directories
      (rpmbuild-dirs base-dir)
      :owner build-user)
     (remote-file/remote-file
      (str "$HOME/.rpmmacros") ;; looked up by real user id
      :content (format
                "%%_topdir %s\n%%packager %s <%s>"
                base-dir packager-name packager-email)
      :owner build-user)
     (parameter/assoc-for-target ; record setup
      [:package-builder :base-dir] base-dir
      [:package-builder :build-user] build-user))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- format-mock-config
  "Format a configuration option in a mock configuration file"
  [[key value]]
  (format
   (if (and (string? value) (.contains value "\n"))
     "config_opts['%s'] = \"\"\"\n%s\n\"\"\"\n"
     "config_opts['%s'] = '%s'\n")
   (name key)
   value))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn yum-mock-config-content
  "Format a mock configuration file for the specified options.
   The config options include:
     :root              path element for the chroot directory
     :target_arch       target architecture (e.g. i386)
     :chroot_setup_cmd  command to setup chroot, e.g. \"install buildsys-build\"
     :dist              a distribution string, e.g. el5
     :yum.conf          string specifying yu,.conf for the chroot environment
"
  [request name {:as config}]
  (string/join (map format-mock-config config)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn yum-mock-config-path
  "Path for a mock configuration file."
  [request name]
  (str "/etc/mock/" name ".cfg"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn yum-mock-config
  "Write a mock configuration file with the given name and configuration
  options."
  [request name {:as config}]
  (remote-file/remote-file
   request
   (yum-mock-config-path request name)
   :content (yum-mock-config-content request name config)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn source-path
  "Helper to return source path for a package."
  [request]
  (str
   (parameter/get-for-target request [:package-builder :base-dir]) "/SOURCES/"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn srpm-path
  "Helper to return source path for a package."
  [request]
  (str
   (parameter/get-for-target request [:package-builder :base-dir]) "/SRPMS/"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn spec-path
  "Helper to return rpm path for a package."
  [request]
  (str
   (parameter/get-for-target request [:package-builder :base-dir]) "/SPECS/"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn rpm-path
  "Helper to return rpm path for a package."
  [request]
  (str
   (parameter/get-for-target request [:package-builder :base-dir]) "/RPMS/"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn build-user
  "Helper to return the user for building packages."
  [request]
  (parameter/get-for-target request [:package-builder :build-user]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn mock-init
  "Initialise a mock environment for a target architecture."
  [request & {:keys [target] :or {target "default"}}]
  (let [user (parameter/get-for-target request [:package-builder :build-user])]
    (exec-script/exec-checked-script    ; set up the mock chroot
     request
     "init mock chroot"
     (sudo -u ~user "/usr/bin/mock" -r ~target init))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn rpm-build-source-package
  "Build a rpm source package."
  [request path]
  (let [user (parameter/get-for-target request [:package-builder :build-user])]
    (exec-script/exec-checked-script request
     (format "rpmbuild source package %s" path)
     (cd @(dirname ~path))
     (rpmbuild -bs --nodeps @(basename ~path)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn rpm-rebuild
  "Rebuild an rpm package based on a source package."
  [request src-rpm & {:keys [target resultdir] :or {target "default"}}]
  (let [user (parameter/get-for-target request [:package-builder :build-user])]
    (->
     request
     (exec-script/exec-checked-script
      (format "rpm rebuild %s" src-rpm)
      (sudo -u ~user "/usr/bin/mock"
            -r ~target
            --resultdir ~(or resultdir (rpm-path request))
            --rebuild ~src-rpm)))))</pre></tr><tr><td class="docs"><p>TODO - improve or remove this</p>
</td><td class="codes" /><pre class="brush: clojure">(defn specfile
  "Trivial helper for specfiles."
  [& lines]
  (string/join "\n" lines))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.php" name="pallet.crate.php"><h1 class="project-name">pallet.crate.php</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.php
  (:require
   [pallet.resource.package :as package])
  (:use pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn php
  "Install php"
  [request & extensions]
  (->
   request
   (package/packages :yum ["php5"] :aptitude ["php5"])
   (for-> [extension extensions]
     (package/package (format "php-%s" (name extension))))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.postfix" name="pallet.crate.postfix"><h1 class="project-name">pallet.crate.postfix</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Install postfix.
   To reconfigure: sudo dpkg-reconfigure postfix</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.postfix
  (:use
   [pallet.resource.package :as package]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def mailer-types
     {:internet-site "Internet Site"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn postfix
  [request mailname mailer-type]
  (->
   request
   (package/package-manager
    :debconf
    (str "postfix postfix/mailname string " mailname)
    (str "postfix postfix/main_mailer_type select "
         (mailer-type mailer-types (name mailer-type))))
   (package/packages
    :yum ["postfix"]
    :aptitude ["postfix"])))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.postgres" name="pallet.crate.postgres"><h1 class="project-name">pallet.crate.postgres</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Install and configure PostgreSQL.</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.postgres
  (:require
   [pallet.resource.package :as package]
   [pallet.request-map :as request-map]
   [pallet.resource :as resource]
   [pallet.resource.file :as file]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.resource-when :as resource-when]
   [pallet.stevedore :as stevedore]
   [pallet.parameter :as parameter]
   [clojure.contrib.condition :as condition]
   [clojure.contrib.logging :as logging]
   [clojure.string :as str])
  (:use
   pallet.thread-expr
   [pallet.script :only [defscript]]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn postgres
  "version should be a string identifying the major.minor version number desired
   (e.g. \"9.0\")."
  [request version]
  (let [os-family (request-map/os-family request)]
    (-> request
        (when-> (= os-family :ubuntu)
                (when-> (= version "9.0")
                        (package/package-source
                         "Martin Pitt backports"
                         :aptitude {:url "ppa:pitti/postgresql"}))
                (package/package-manager :update))
        (package/packages :aptitude [(str "postgresql-" version)])
        (assoc-in [:parameters :postgresql :version] version))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def ^{:private true} pallet-cfg-preamble
"# This file was auto-generated by Pallet. Do not edit it manually unless you
# know what you are doing. If you are still using Pallet, you probably want to
# edit your Pallet scripts and rerun them.\n")</pre></tr><tr><td class="docs"><p>pg_hba.conf</p>
</td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def ^{:private true}
  auth-methods #{"trust" "reject" "md5" "password" "gss" "sspi" "krb5"
                                     "ident" "ldap" "radius" "cert" "pam"})
(def ^{:private true}
  ip-addr-regex #"[0-9]{1,3}.[0-9]{1,3}+.[0-9]{1,3}+.[0-9]{1,3}+")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- valid-hba-record?
  "Takes an hba-record as input and minimally checks that it could be a valid
   record."
  [{:keys [connection-type database user auth-method address ip-mask]
    :as record-map}]
  (and (#{"local" "host" "hostssl" "hostnossl"} (name connection-type))
       (every? #(not (nil? %)) [database user auth-method])
       (auth-methods (name auth-method))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- record-to-map
  "Takes a record given as a map or vector, and turns it into the map version."
  [record]
  (cond
   (map? record) record
   (vector? record) (case (name (first record))
                      "local" (apply
                               hash-map
                               (interleave
                                [:connection-type :database :user :auth-method
                                 :auth-options]
                                record))
                      ("host"
                       "hostssl"
                       "hostnossl") (let [[connection-type database user address
                                           & remainder] record]
                                      (if (re-matches
                                           ip-addr-regex (first remainder))
                                        ;; Not nil so must be an IP mask.
                                        (apply
                                         hash-map
                                         (interleave
                                          [:connection-type :database :user
                                           :address :ip-mask :auth-method
                                           :auth-options]
                                          record))
                                        ;; Otherwise, it may be an auth-method.
                                        (if (auth-methods
                                             (name (first remainder)))
                                          (apply
                                           hash-map
                                           (interleave
                                            [:connection-type :database :user
                                             :address :auth-method
                                             :auth-options]
                                            record))
                                          (condition/raise
                                           :type :postgres-invalid-hba-record
                                           :message
                                           (format
                                            "The fifth item in %s does not appear to be an IP mask or auth method."
                                            (name record))))))
                       (condition/raise
                        :type :postgres-invalid-hba-record
                        :message (format
                                  "The first item in %s is not a valid connection type."
                                  (name record))))
   :else
   (condition/raise :type :postgres-invalid-hba-record
                    :message (format "The record %s must be a vector or map."
                                     (name record)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- format-auth-options
  "Given the auth-options map, returns a string suitable for inserting into the
   file."
  [auth-options]
  (str/join "," (map #(str (first %) "=" (second %)) auth-options)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- format-hba-record
  [record]
  (let [record-map (record-to-map record)
        record-map (assoc record-map :auth-options
                          (format-auth-options (:auth-options record-map)))
        ordered-fields (map record-map
                            [:connection-type :database :user :address :ip-mask
                             :auth-method :auth-options])
        ordered-fields (map name ordered-fields)]
    (if (valid-hba-record? record-map)
      (str (str/join "\t" ordered-fields) "\n"))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn hba-conf
  "Generates a pg_hba.conf file from the arguments. Each record is either a
   vector or map of keywords/args.
   Note that pg_hba.conf is case-sensitive: all means all databases, ALL is a
   database named ALL.
   Also note that if you intend to execute subsequent commands, you'd do best to
   include entries in here that allow the admin user you are using easy access
   to the database. For example, allow the postgres user to have ident access
   over local.
   Options:
   :records     - A sequence of records (either vectors or maps of
                  keywords/strings).
   :conf-path   - A string suitable for passing to format before a string of the
                  version."
  [request & {:keys [records conf-path]
              :or {records []
                   conf-path "/etc/postgresql/%s/main/pg_hba.conf"}}]
  (let [hba-contents (apply str pallet-cfg-preamble
                            (map format-hba-record records))
        version (parameter/get-for request [:postgresql :version])]
    (-> request
        (remote-file/remote-file (format conf-path version)
         :content hba-contents
         :literal true))))</pre></tr><tr><td class="docs"><p>postgresql.conf</p>
</td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- parameter-escape-string
  "Given a string, escapes any single-quotes."
  [string]
  (apply str (replace {\' "''"} string)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- format-parameter-value
  [value]
  (cond (number? value)
        (str value)
        (string? value)
        (str "'" value "'")
        (vector? value)
        (str "'" (str/join "," (map name value)) "'")
        :else
        (condition/raise
         :type :postgres-invalid-parameter
         :message "Parameters must be numbers, strings, or vectors of such.")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- format-parameter
  "Given a key/value pair in a vector, formats it suitably for the
   postgresql.conf file.
   The value should be either a number, a string, or a vector of such."
  [[key value]]
  (let [key-str (name key)
        parameter-str (format-parameter-value value)]
    (str key-str " = " parameter-str "\n")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn postgresql-conf
  "Generates a postgresql.conf file from the arguments.
   Example: (postgresql-conf
              :options {:listen_address [\"10.0.1.1\",\"localhost\"]})
         => listen_address = '10.0.1.1,localhost'
   Options:
   :options     - A map of parameters (string(able)s, numbers, or vectors of
                  such).
   :conf-path   - A string suitable for passing to format before a string of
                  the version."
  [request & {:keys [options conf-path]
              :or {options {}
                   conf-path "/etc/postgresql/%s/main/postgresql.conf"}}]
  (let [contents (apply str pallet-cfg-preamble
                        (map format-parameter options))
        version (parameter/get-for request [:postgresql :version])]
    (-> request
        (remote-file/remote-file (format conf-path version)
                                 :content contents
                                 :literal true))))</pre></tr><tr><td class="docs"><p>Scripts</p>
</td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn postgresql-script
  "Execute a postgresql script.
   Options for how this script should be run:
     :as-user username       - Run this script having sudoed to this (system)
                               user. Default: postgres
     :ignore-result          - Ignore any error return value out of psql."
  [request sql-script & {:keys [as-user ignore-result]
                         :as options
                         :or {as-user "postgres"}}]
  (-> request
      (exec-script/exec-checked-script
       "PostgreSQL temp command file"
       (var psql_commands (file/make-temp-file "postgresql")))
      (remote-file/remote-file
       (stevedore/script @psql_commands)
       :no-versioning true
       :literal true
       :content sql-script)
      (exec-script/exec-script
       ;; Note that we stuff all output. This is because certain commands in
       ;; PostgreSQL are idempotent but spit out an error and an error exit
       ;; anyways (eg, create database on a database that already exists does
       ;; nothing, but is counted as an error).
       ("{\n" sudo "-u" ~as-user psql "-f" @psql_commands > "/dev/null" "2>&1"
        ~(when ignore-result "|| 0") "\n}"))
      (remote-file/remote-file
       (stevedore/script @psql_commands)
       :action :delete)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn create-database
  "Create a database if it does not exist.
   You can specify database parameters by including a keyed parameter called
   :db-parameters, which indicates a vector of strings or keywords that will get
   translated in order to the options to the create database command. Passes on
   key/value arguments it does not understand to postgresql-script.
   Example: (create-database
              \"my-database\" :db-parameters [:encoding \"'LATIN1'\"])"
  [request db-name & rest]
  (let [{:keys [db-parameters] :as options} rest
        db-parameters-str (str/join " " (map name db-parameters))]
    ;; Postgres simply has no way to check if a database exists and issue a
    ;; "CREATE DATABASE" only in the case that it doesn't. That would require a
    ;; function, but create database can't be done within a transaction, so
    ;; you're screwed. Instead, we just use the fact that trying to create an
    ;; existing database does nothing and stuff the output/error return.
    (apply postgresql-script
           request
           (format "CREATE DATABASE %s %s;" db-name db-parameters-str)
           (conj (vec rest) :ignore-result true))))</pre></tr><tr><td class="docs"><p>This is a format string that generates a temporary PL/pgsql function to
check if a given role exists, and if not create it. The first argument
should be the role name, the second should be any user-parameters.</p>
</td><td class="codes" /><pre class="brush: clojure">(def ^{:private true} create-role-pgsql
"create or replace function pg_temp.createuser() returns void as $$
 declare user_rec record;
 begin
 select into user_rec * from pg_user where usename='%1$s';
 if user_rec.usename is null then
     create role %1$s %2$s;
 end if;
 end;
 $$ language plpgsql;
 select pg_temp.createuser();")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn create-role
  "Create a postgres role if it does not exist.
   You can specify user parameters by including a keyed parameter called
   :user-parameters, which indicates a vector of strings or keywords that will
   get translated in order to the options to the create user command. Passes on
   key/value arguments to postgresql-script.
   Example (create-role
             \"myuser\" :user-parameters [:encrypted :password \"'mypasswd'\"])"
  [request username & rest]
  (let [{:keys [user-parameters] :as options} rest
        user-parameters-str (str/join " " (map name user-parameters))]
    (apply postgresql-script
           request
           (format create-role-pgsql username user-parameters-str)
           rest)))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.public-dns-if-no-nameserver" name="pallet.crate.public-dns-if-no-nameserver"><h1 class="project-name">pallet.crate.public-dns-if-no-nameserver</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.public-dns-if-no-nameserver
  (:require
   pallet.resource.hostinfo
   [pallet.resource.resource-when :as resource-when]
   [pallet.crate.resolv :as resolv]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defonce google-dns ["8.8.8.8" "8.8.4.4"])
(defonce opendns-nameservers ["208.67.222.222" "208.67.220.220"])</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn public-dns-if-no-nameserver
  "Install a public nameserver if none configured"
  [request & nameservers]
  (let [nameservers (if (seq nameservers)
                      nameservers
                      (conj google-dns (first opendns-nameservers))) ]
    (-> request
        (resource-when/resource-when-not
         (nameservers)
         (resolv/resolv nil nameservers :rotate true)))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.rabbitmq" name="pallet.crate.rabbitmq"><h1 class="project-name">pallet.crate.rabbitmq</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.rabbitmq
  (:require
   [pallet.resource.package :as package]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.directory :as directory]
   [pallet.resource.remote-file :as remote-file]
   [pallet.crate.etc-default :as etc-default]
   [pallet.crate.etc-hosts :as etc-hosts]
   [pallet.crate.iptables :as iptables]
   [pallet.parameter :as parameter]
   [pallet.compute :as compute]
   [pallet.request-map :as request-map]
   [clojure.string :as string])
  (:use
   pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def ^{:doc "Settings for the daemon"}
  etc-default-keys
  {:node-count :NODE_COUNT
   :rotate-suffix :ROTATE_SUFFIX
   :user :USER
   :name :NAME
   :desc :DESC
   :init-log-dir :INIT_LOG_DIR
   :daemon :DAEMON})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def ^{:doc "RabbitMQ conf settings"} conf-keys
  {:mnesia-base :MNESIA_BASE
   :log-base :LOG_BASE
   :nodename :NODENAME
   :node-ip-addres :NODE_IP_ADDRESS
   :node-port :NODE_PORT
   :config-file :CONFIG_FILE
   :server-start-args :SERVER_START_ARGS
   :multi-start-args :MULTI_START_ARGS
   :ctl-erl-args :CTL_ERL_ARGS})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmulti erlang-config-format class)
(defmethod erlang-config-format :default
  [x]
  (str x))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod erlang-config-format clojure.lang.Named
  [x]
  (name x))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod erlang-config-format java.lang.String
  [x]
  (str "'" x "'"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod erlang-config-format java.util.Map$Entry
  [x]
  (str
   "{" (erlang-config-format (key x)) ", " (erlang-config-format (val x)) "}"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod erlang-config-format clojure.lang.ISeq
  [x]
  (str "[" (string/join "," (map erlang-config-format x)) "]"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod erlang-config-format clojure.lang.IPersistentMap
  [x]
  (str "[" (string/join "," (map erlang-config-format x)) "]"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn erlang-config [m]
  (str (erlang-config-format m) "."))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- cluster-nodes
  "Create a node list for the specified nodes"
  [node-name nodes]
  (map
   (fn cluster-node-name [node]
     (str node-name "@" (compute/hostname node)))
   nodes))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- cluster-nodes-for-tag
  "Create a node list for the specified tag"
  [request tag]
  (let [nodes (request-map/nodes-in-tag request tag)]
    (assert (seq nodes))
    (cluster-nodes
     (parameter/get-for
      request
      [:host (keyword (compute/id (first nodes))) :rabbitmq :options :node-name]
      "rabbit")
     nodes)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- default-cluster-nodes
  [request options]
  (cluster-nodes
   (:node-name options "rabbit")
   (request-map/nodes-in-tag request)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- configure
  "Write the configuration file, based on a hash map m, that is serialised as
   erlang config.  By specifying :cluster tag, the current tag's rabbitmq
   instances will be added as ram nodes to that cluster."
  [request cluster config]
  (let [options (parameter/get-for-target request [:rabbitmq :options] nil)
        cluster-nodes (when cluster (cluster-nodes-for-tag request cluster))
        cluster-nodes (or cluster-nodes
                          (if-let [node-count (:node-count options)]
                            (when (> node-count 1)
                              (default-cluster-nodes request options))))]
    (->
     request
     (etc-hosts/hosts-for-tag (request-map/tag request))
     (when->
      (or cluster-nodes config)
      (remote-file/remote-file
       (parameter/get-for-target request [:rabbitmq :config-file])
       :content (erlang-config
                 (if cluster-nodes
                   (assoc-in config [:rabbit :cluster_nodes] cluster-nodes)
                   config))
       :literal true))
     (when->
      cluster
      (etc-hosts/hosts-for-tag cluster)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn rabbitmq
  "Install rabbitmq from packages.
    :config map   - erlang configuration, specified as a map
                    from application to attribute value map.
    :cluster tag  - If specified, then this tag will be ram nodes for the
                    given tag's disk cluster."
  [request & {:keys [node node-count mnesia-base log-base node-ip-address
                     node-port config-file config cluster]
              :as options}]
  (->
   request
   (parameter/assoc-for-target
    [:rabbitmq :options] options
    [:rabbitmq :default-file] (or config-file "/etc/default/rabbitmq")
    [:rabbitmq :conf-file] (or config-file "/etc/rabbitmq/rabbitmq.conf")
    [:rabbitmq :config-file] (or config-file "/etc/rabbitmq/rabbitmq.config"))
   (directory/directory
    "/etc/rabbitmq")
   (apply-map->
    etc-default/write "rabbitmq"
    (map #(vector (etc-default-keys (first %)) (second %))
         (select-keys options (keys etc-default-keys))))
   (apply-map->
    etc-default/write "/etc/rabbitmq/rabbitmq.conf"
    (map #(vector (conf-keys (first %)) (second %))
         (select-keys options (keys conf-keys))))
   (package/package "rabbitmq-server")
   (configure cluster config)
   (etc-hosts/hosts)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn iptables-accept
  "Accept rabbitmq connectios, by default on port 5672"
  ([request] (iptables-accept request 5672))
  ([request port]
     (iptables/iptables-accept-port request port)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn iptables-accept-status
  "Accept rabbitmq status connections, by default on port 55672"
  ([request] (iptables-accept request 55672))
  ([request port]
     (iptables/iptables-accept-port request port)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn password
  "Change rabbitmq password."
  [request user password]
  (->
   request
   (exec-script/exec-checked-script
    "Change RabbitMQ password"
    (rabbitmqctl change_password ~user ~password))))</pre></tr><tr><td class="docs"><p>rabbitmq without iptablse</p>
</td><td class="codes" /></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.resolv" name="pallet.crate.resolv"><h1 class="project-name">pallet.crate.resolv</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.resolv
 (:use
   [pallet.target :only [admin-group]]
   [pallet.stevedore :only [script]]
   [pallet.template]
   [pallet.resource :only [defaggregate]]
   [pallet.resource.hostinfo :only [dnsdomainname]])
 (:require
  [pallet.utils :as utils]
  [clojure.contrib.string :as string]
  [clojure.contrib.logging :as logging]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- write-key-value [key value]
  (str (name key) " " (utils/as-string value) \newline))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- write-option [[key value]]
  (str (name key)
       (if (and value (not (instance? Boolean value)))
         (str ":" (utils/as-string value)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- write-options [options]
  (write-key-value "options" (string/join " " (map write-option options))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn write [domainname nameservers searches sortlist options]
  (str (write-key-value "domain" (or domainname (str (script (dnsdomainname)))))
       (string/map-str (partial write-key-value "nameserver") nameservers)
       (when (first searches)
         (write-key-value "search" (string/join " " searches)))
       (when (first sortlist)
         (write-key-value "sortlist" (string/join " " sortlist)))
       (when (first options)
         (write-options options))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(deftemplate resolv-templates
  [domainname nameservers searches sortlist options]
  {{:path "/etc/resolv.conf" :owner "root" :mode "0644"}
   (write domainname nameservers searches sortlist options)})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- ensure-vector [arg]
  (if (vector? arg)
    arg
    (if arg [arg] [])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- merge-resolve-spec [m1 m2]
  (let [[d1 n1 s1 r1 opt1] m1
        [d2 n2] m2
        opt2 (apply hash-map (drop 2 m2))
        r [(or d1 d2)
           (concat (ensure-vector n1) (ensure-vector n2))
           (concat s1 (ensure-vector (:search opt2)))
           (concat r1 (ensure-vector (:sortlist opt2)))
           (merge opt1 (dissoc (dissoc opt2 :search) :sortlist))]]
    (if-not (or (nil? d1) (nil? d2) (= d1 d2))
      (logging/warn (str "Trying to set domain name to two distinct values")))
    r))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defaggregate resolv
  "Resolv configuration. Generates a resolv.conf file.
options are:

:search    search order
:sortlist  sortlist

or one of the resolv.conf options"
  {:use-arglist [request domainname nameservers & {:keys [search sortlist]}]}
  (apply-resolv
   [request args]
   (logging/trace "apply-resolv")
   (apply-templates
    resolv-templates
    (reduce merge-resolve-spec [nil [] [] [] {}] args))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.ruby" name="pallet.crate.ruby"><h1 class="project-name">pallet.crate.ruby</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Installation of ruby from source</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.ruby
  (:require
   [pallet.resource :as resource]
   [pallet.request-map :as request-map]
   [pallet.stevedore :as stevedore]
   [pallet.resource.package :as package]
   [clojure.string :as string])
  (:use
   [pallet.resource.package :only [package package* package-manager]]
   [pallet.resource.exec-script :only [exec-script]]
   [pallet.resource.remote-file :only [remote-file]]
   [pallet.resource.file]
   [pallet.script :only [defscript]]
   pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defscript ruby-version [])
(stevedore/defimpl ruby-version :default []
  (ruby "--version" "|" cut "-f2" "-d' '"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def src-packages
  {:aptitude ["zlib-devel"  "gcc" "gcc-c++" "make"
              "curl-devel" "expat-devel" "gettext-devel"
              "libncurses5-dev" "libreadline-dev"
              ;; ubuntu 10.04
              "zlib1g" "zlib1g-dev" "zlibc"
              "libssl-dev"]
   :yum ["openssl-devel" "zlib-devel" "gcc" "make"
         "curl-devel" "expat-devel" "gettext-devel" "readline-devel"
         "ncurses-devel"]})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def version-regex
     {"1.8.7-p72" #"1.8.7.*patchlevel 72"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def version-md5
     {"1.8.7-p72" "5e5b7189674b3a7f69401284f6a7a36d"
      "1.8.7-p299" "43533980ee0ea57381040d4135cf9677"
      "1.8.7-p330" "50a49edb787211598d08e756e733e42e"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn ftp-path [tarfile]
  (cond
   (.contains tarfile "1.8") (str "ftp://ftp.ruby-lang.org/pub/ruby/1.8/" tarfile)
   (.contains tarfile "stable") (str "ftp://ftp.ruby-lang.org/pub/ruby/" tarfile)
   :else (str "ftp://ftp.ruby-lang.org/pub/ruby/1.9/" tarfile)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn ruby
  "Install ruby from source"
  ([request] (ruby request "1.8.7-p72"))
  ([request version]
     (let [basename (str "ruby-" version)
           tarfile (str basename ".tar.gz")
           tarpath (str (stevedore/script (tmp-dir)) "/" tarfile)]
       (->
        request
        (for-> [p (src-packages (request-map/packager request))]
          (package p))
        (remote-file
         tarpath :url (ftp-path tarfile) :md5 (version-md5 version))
        (exec-script
         (if-not (pipe ("ruby" "--version")
                       (grep (quoted ~(string/replace version "-p" ".*"))))
           (do
             ~(stevedore/checked-script
               "Building ruby"
               (cd (tmp-dir))
               (tar xfz ~tarfile)
               (cd ~basename)
               ("./configure" "--enable-shared" "--enable-pthread")
               (make)
               (make install)
               (if-not (|| (file-exists? "/usr/bin/ruby")
                           (file-exists? "/usr/local/bin/ruby"))
                 (do (println "Could not find ruby executable")
                     (exit 1)))
               (cd "ext/zlib")
               (ruby "extconf.rb" "--with-zlib")
               (make)
               (make install)
               (cd "../../")
               (cd "ext/openssl")
               (ruby "extconf.rb")
               (make)
               (make install)
               (cd "../../")
               (cd "ext/readline")
               (ruby "extconf.rb")
               (make)
               (make install)
               (cd "../../")
               (make)
               (make install)))))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn ruby-packages
  "Install ruby from packages"
  [request]
  (package/packages
   request
   :aptitude
   ["ruby" "ruby-dev" "rdoc" "ri" "irb" "libopenssl-ruby" "libzlib-ruby"]
   :yum
   ["ruby" "ruby-devel" "ruby-docs" "ruby-ri" "ruby-rdoc" "ruby-irb"]))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.rubygems" name="pallet.crate.rubygems"><h1 class="project-name">pallet.crate.rubygems</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Installation of rubygems from source</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.rubygems
  (:use
   [pallet.resource.package :only [package package-manager]]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.remote-file :only [remote-file remote-file*]]
   [pallet.resource.resource-when :only [resource-when resource-when-not]]
   [pallet.resource :only [defresource]]
   [pallet.crate.ruby :only [ruby ruby-packages ruby-version]]
   [pallet.resource.user :only [user-home]]
   [pallet.stevedore :as stevedore]
   [pallet.script :only [defscript]]
   [pallet.utils :only [*admin-user*]]
   [clojure.contrib.json :as json])
  (:require
   [pallet.resource.file]
   [pallet.stevedore :as stevedore]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defscript gem [action package & options])
(defimpl gem :default [action package & options]
  ("gem" ~action ~(map-to-arg-string (first options)) ~package))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def rubygems-downloads
     {"1.4.1" ["http://rubyforge.org/frs/download.php/73779/rubygems-1.4.1.tgz"
               "e915dbf79e22249d10c0fcf503a5adda"]
      "1.4.0" ["http://rubyforge.org/frs/download.php/73763/rubygems-1.4.0.tgz"]
      "1.3.7" ["http://rubyforge.org/frs/download.php/70696/rubygems-1.3.7.tgz"]
      "1.3.6"  ["http://rubyforge.org/frs/download.php/69365/rubygems-1.3.6.tgz"
                "789ca8e9ad1d4d3fe5f0534fcc038a0d"]
      "1.3.5" ["http://rubyforge.org/frs/download.php/60718/rubygems-1.3.5.tgz"
                "6e317335898e73beab15623cdd5f8cff"]})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn rubygems
  "Install rubygems from source"
  ([request] (rubygems request "1.3.6"))
  ([request version]
     (let [info (rubygems-downloads version)
           basename (str "rubygems-" version)
           tarfile (str basename ".tgz")
           tarpath (str (stevedore/script (tmp-dir)) "/" tarfile)]
       (->
        request
        (ruby-packages)
        (resource-when (< @(ruby-version) "1.8.6")
                       (ruby))
        (remote-file
         tarpath
         :url (first info)
         :md5 (second info))
        (exec-script/exec-script
         (if-not (pipe ("gem" "--version") (grep (quoted ~version)))
           (do
             ~(stevedore/checked-script
               "Building rubygems"
               (cd (tmp-dir))
               (tar xfz ~tarfile)
               (cd ~basename)
               (ruby setup.rb)
               (if-not (|| (file-exists? "/usr/bin/gem1.8")
                           (file-exists? "/usr/local/bin/gem"))
                 (do (println "Could not find rubygem executable")
                     (exit 1)))
               ;; Create a symlink if we only have one ruby version installed
               (if-not (&& (file-exists? "/usr/bin/gem1.8")
                           (file-exists? "/usr/bin/gem1.9"))
                 (if (file-exists? "/usr/bin/gem1.8")
                   (ln "-sfv" "/usr/bin/gem1.8" "/usr/bin/gem")))
               (if-not (&& (file-exists? "/usr/local/bin/gem1.8")
                           (file-exists? "/usr/local/bin/gem1.9"))
                 (if (file-exists? "/usr/local/bin/gem1.8")
                   (ln "-sfv" "/usr/locl/bin/gem1.8" "/usr/local/bin/gem")))))))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn rubygems-update
  [request]
  (exec-script/exec-script
   request
   ("gem" "update" "--system")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defresource gem "Gem management."
  (gem*
   [request name & {:keys [action version no-ri no-rdoc]
                    :or {action :install}
                    :as options}]
   (case action
     :install (stevedore/checked-script
               (format "Install gem %s" name)
               (gem
                "install" ~name
                ~(select-keys options [:version :no-ri :no-rdoc])))
     :delete (stevedore/checked-script
              (format "Uninstall gem %s" name)
              (gem
               "uninstall" ~name
               ~(select-keys options [:version :no-ri :no-rdoc]))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defresource gem-source "Gem source management."
  (gem-source*
   [request source & {:keys [action] :or {action :create} :as options}]
   (case action
     :create (stevedore/script
              (if-not ("gem" "sources" "--list" "|" "grep" ~source)
                (gem "sources" ~source ~{:add true})))
     :delete (stevedore/script (gem "sources" ~source ~{:remove true})))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defresource gemrc "rubygems configuration"
  (gemrc*
   [request m & user?]
   (let [user (or (first user?) (*admin-user* :username))]
     (remote-file*
      request
      (str (stevedore/script (user-home ~user)) "/.gemrc")
      :content (.replaceAll (json/json-str m) "[{}]" "")
      :owner user))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn require-rubygems
  "Ensure that a version of rubygems is installed"
   [request]
   (exec-script/exec-checked-script
    request
    "Checking for rubygems"
    ("gem" "--version")))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.sphinx" name="pallet.crate.sphinx"><h1 class="project-name">pallet.crate.sphinx</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.sphinx
  (:require
   [pallet.stevedore :as stevedore]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.exec-script :as exec-script]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def sphinx-downloads
  {"0.9.9" ["http://sphinxsearch.com/downloads/sphinx-0.9.9.tar.gz" "x"]})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn sphinx
  "Install sphinx from source"
  ([request] (sphinx request "0.9.9"))
  ([request version]
     (let [info (sphinx-downloads version)
           basename (str "sphinx-" version)
           tarfile (str basename ".tar.gz")
           tarpath (str (stevedore/script (tmp-dir)) "/" tarfile)]
       (->
        request
        (remote-file/remote-file tarpath :url (first info) :md5 (second info))
        (exec-script/exec-checked-script
         "Sphinx"
         (cd (tmp-dir))
         (tar xfz ~tarfile)
         (cd ~basename)
         ("(" "./configure" "&&" "make" "&&" "make install" ")"
          "||" exit 1) )))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.splunk" name="pallet.crate.splunk"><h1 class="project-name">pallet.crate.splunk</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Install and configure splunk</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.splunk
  (:require
   [pallet.argument :as argument]
   [pallet.compute :as compute]
   [pallet.target :as target]
   [pallet.request-map :as request-map]
   [pallet.resource :as resource]
   [pallet.stevedore :as stevedore]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.package :as package]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def build
  {"4.1.4" 82143
   "4.1.3" 80534
   "4.1.2" 79191
   "4.1.1" 78281
   "4.1" 77833
   "4.0.11" 79031
   "4.0.10" 77146
   "4.0.9" 74233
   "4.0.8" 73243
   "4.0.7" 72459
   "4.0.6" 70313
   "4.0.5" 69401
   "4.0.4" 67724
   "4.0.3" 65638
   "4.0.2" 64889
   "4.0.1" 64658
   "3.4.14" 79166
   "3.4.13" 75215
   "3.4.12" 69236
   "3.4.11" 65313
   "3.4.10" 60883
   "3.4.9" 57762
   "3.4.8" 54309
   "3.4.6" 51113
   "3.4.5" 47883
   "3.4.3" 46779
   "3.4.2" 46047
   "3.4.1" 45588
   "3.4" 44873
   "3.3.4" 43000
   "3.3.3" 42717
   "3.3.2" 41320
   "3.3.1" 39933
   "3.3" 38914
   "3.2.6" 38259
   "3.2.5" 38160
   "3.2.4" 37025
   "3.2.3" 35555
   "3.2.2" 34603
   "3.2.1" 34291
   "3.2" 33572
   "3.1.5" 31521
   "3.1.4" 30364
   "3.1.3" 28524
   "3.1.2" 28096
   "3.1.1" 27147
   "3.1" 26228
   "3.0.2" 24828
   "3.0.1" 24078
   "3.0" 23043
   "2.2.6" 21120
   "2.2.3" 18173
   "2.2.1" 17100
   "2.2" 15292
   "2.1.3" 14652
   "2.1.2" 14524})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn debfile [request version]
  (if (compute/is-64bit? (:target-node request))
    (format "splunk-%s-%d-linux-2.6-amd64.deb" version (build version))
    (format "splunk-%s-%d-linux-2.6-intel.deb" version (build version))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn rpmfile [request version]
  (if (compute/is-64bit? (:target-node request))
    (format "splunk-%s-%d-linux-2.6-x86_64.rpm" version (build version))
    (format "splunk-%s-%d-i386.rpm" version (build version))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn url [version file]
  (format
   "http://www.splunk.com/index.php/download_track?file=%s/linux/%s&ac=&wget=true&name=wget&typed=releases"
   version file))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn md5-url
  "Unfortunately the md5 file returned is not usable with md5sum --check"
  [version file]
  (format
   "http://www.splunk.com/index.php/download_track?file=%s/linux/%s.md5&ac=&wget=true&name=wget&typed=releases"
   version file))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(resource/defresource install
  (install*
   [request & {:keys [version]}]
   (case (request-map/packager request)
     :aptitude
     (let [f (debfile request version)
           deb (str (stevedore/script (tmp-dir)) "/" f)]
       (stevedore/checked-commands
        "Install splunk"
        (remote-file/remote-file* request deb :url (url version f))
        (stevedore/script
         (if-not (file-exists? "/opt/splunk/bin/splunk")
           (do
             (dpkg -i (quoted ~deb))
             ("/opt/splunk/bin/splunk" start "--accept-license")
             ("/opt/splunk/bin/splunk" enable boot-start))))))
     :yum
     (let [f (rpmfile request version)
           rpm (str (stevedore/script (tmp-dir)) "/" f)]
       (stevedore/checked-commands
        "Install splunk"
        (remote-file/remote-file* request rpm :url (url version f))
        (stevedore/script
         (rpm -i (quoted ~rpm))
         ("/opt/splunk/bin/splunk" start "--accept-license")
         ("/opt/splunk/bin/splunk" enable boot-start)))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn splunk
  [request & {:keys [version ] :or {version "4.1.4"}}]
  (install request :version version))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn format-section
  [m]
  (reduce #(str %1 (format "%s = %s\n" (name (first %2)) (second %2)))  m))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn format-conf
  [maps]
  (reduce
   #(str %1 (format
             "[%s]\n%s\n"
             (name (first %2)) (format-section (second %2))))
   maps))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn fifo-input
  [path & {:keys [host index sourcetype source queue] :as options}]
  {(format "fifo://%s" path) options})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn configure
  [request & {:keys [inputs host] :or {inputs {}}}]
  (remote-file/remote-file
   request
   "/opt/splunk/etc/system/local/inputs.conf"
   :content (format-conf
             (merge
              inputs
              {:default {:host (or host
                                   (compute/hostname
                                    (:target-node request)))}}))
   :owner "splunk" :group "splunk"))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.squeak" name="pallet.crate.squeak"><h1 class="project-name">pallet.crate.squeak</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Crate for working with squeak, pharo and seaside.
   This is by not finished as yet.</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.squeak
  (:require
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.package :as package]
   [pallet.resource.directory :as directory]
   [pallet.resource.file :as file]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.remote-directory :as remote-directory]
   [pallet.crate.upstart :as upstart]
   [pallet.parameter :as parameter]
   [pallet.stevedore :as stevedore]
   [clojure.string :as string])
  (:use
   pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn squeak-vm
  "Install squeak VM package.
   The :smalltalk :vm keys are used to hold a function which will generate
   script to launch squeak-vm with the arguments it is passed."
  [request]
  ;; the package on debian sucks.  no simple squeakvm wrapper.
  ;; no way of overwridding options without setting the vm.
  (->
   request
   (package/package "squeak-vm")
   (parameter/assoc-for-target
    [:smalltalk :vm] (fn [& args]
                       (stevedore/script
                        (export (str VM_VERSION=
                                     @(pipe
                                       (find "/usr/lib/squeak/" -name "squeakvm"
                                             -type f)
                                       (cut -f5 "-d\"/\))))
                        (export SQ_DIR=/usr/lib/squeak/$VM_VERSION)
                        ((str @SQ_DIR "/squeakvm")
                         -vm-sound-null -vm-display-null ~@args))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def ^{:doc "Default install location"} pharo-dir
  "/opt/local/pharo")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def ^{:doc "Download url"} pharo-url
  {:stable "http://www.pharo-project.org/pharo-download/stable"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn pharo-md5s
  [version]
  {:stable nil})</pre></tr><tr><td class="docs"><p>build smalltalk statements</p>
</td><td class="codes" /><pre class="brush: clojure">(defmulti smalltalk-message class)
(defmethod smalltalk-message clojure.lang.Symbol
  [s]
  (name s))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod smalltalk-message clojure.lang.Keyword
  [s]
  (name s))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod smalltalk-message clojure.lang.IPersistentMap
  [m]
  (string/join " " (map #(format "%s: %s" (name (key %)) (val %)) m)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn smalltalk-statement
  [object msgs]
  (str object " "
       (string/join ";\n" (map smalltalk-message (filter identity msgs))) "."))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn smalltalk-call
  "Convert a map to smalltalk"
  [object & {:as message}]
  (str "(" object (smalltalk-message message) ")"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn smalltalk
  "Convert a map to smalltalk"
  [object & messages]
  (str (smalltalk-statement object messages) "\n"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn smalltalk-str [arg]
  (str "'" arg "'"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn smalltalk-comment [arg]
  (str "\ arg "\"\n"))</pre></tr><tr><td class="docs"><p>Pharo</p>
</td><td class="codes" /><pre class="brush: clojure">(defn pharo
  "Install pharo smalltalk."
  [request & {:keys [version name enable-preferences disable-preferences
                     install-dir new-image-name]
              :or {version :stable
                   name "noname"
                   install-dir pharo-dir
                   }}]
  (let [image (str install-dir "/Pharo-*.image")]
    (->
     request
     (package/package "unzip")
     (remote-directory/remote-directory
      install-dir :url (pharo-url version) :md5 (pharo-md5s version)
      :unpack :unzip :unzip-options "-j -o")
     (parameter/assoc-for-target
      [:pharo :install-dir] install-dir
      [:pharo :image] image))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn pharo-preferences
  "Generate smalltalk for setting the given preferences."
  [& {:keys [enable disable]}]
  (str
   (smalltalk-comment "Set Preferences")
   (string/join
    (map #(format "Preferences enable: %s.\n" %) enable))
   (string/join
    (map #(format "Preferences disable: %s.\n" %) disable))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn pharo-author
  [your-name]
  (str
   (smalltalk-comment "Your name")
   (smalltalk "Author" {:fullName (smalltalk-str your-name)})))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn pharo-installer
  []
  (str "\"Install Installer\"\n"
       (smalltalk "ScriptLoader"
                  {:loadLatestPackage "'Installer-Core'"
                   :fromSqueaksource "'Installer'"})))
(defn pharo-update
  "Update from pharo update stream"
  []
  "[Utilities updateFromServer] valueSuppressingAllMessages."
  ;; (str (smalltalk-comment "Update from pharo update stream")
  ;;      (smalltalk "Utilities" :updateFromServer)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn pharo-save-and-snapshot-image
  [image-name & {:keys [snapshot quit] :or {snapshot true quit true}}]
  (str
   (smalltalk-comment (format "Save image %s" image-name))
   (smalltalk "SmalltalkImage current" {:saveAs (smalltalk-str image-name)})
   (smalltalk "SmalltalkImage current" {:snapshot snapshot :andQuit quit})))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn pharo-script
  "Run a script with the given content. Content options are as for remote-file."
  [request {:keys [image] :as options}]
  (let [vm (parameter/get-for-target request [:smalltalk :vm])
        image (parameter/get-for-target request [:pharo :image])
        install-dir (parameter/get-for-target request [:pharo :install-dir])]
    (->
     request
     (exec-script/exec-script
      (cd ~install-dir)
      (var pharo_script (str ~install-dir "/" (make-temp-file "pharo"))))
     (apply->
      remote-file/remote-file
      (stevedore/script @pharo_script)
      :no-versioning true
      (apply
       concat
       (merge {:literal true} options)))
     (exec-script/exec-checked-script
      "Pharo script"
      ~(vm (str install-dir "/" image) (stevedore/script @pharo_script)))
     (remote-file/remote-file
      (stevedore/script @pharo_script)
      :action :delete))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn clean-up-for-production []
  (smalltalk "ScriptLoader new" :cleanUpForProduction))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn gofer-magma
  [load]
  (str
   (smalltalk "Gofer new"
              {:squeaksource "'MetaRepoForPharo11'"}
              {:package "'ConfigurationOfMagma'"}
              :load)
   (case load
     :client (smalltalk
              "ConfigurationOfMagma project latestVersion"
              {:load "'Client'"})
     :server (smalltalk
              "ConfigurationOfMagma project latestVersion"
              {:load "'Server'"})
     :tester (smalltalk
              "ConfigurationOfMagma project latestVersion"
              {:load "'Tester'"}))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn gofer-rfb
  []
  (smalltalk "Gofer new"
             {:renggli "'unsorted'"}
             {:package "'RFB'"}
             :load))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn gofer-seaside
  []
  (str
   (smalltalk "Gofer new"
              {:squeaksource (smalltalk-str "MetacelloRepository")}
              {:package (smalltalk-str "ConfigurationOfSeaside30")}
              :load)
   "((Smalltalk at: #ConfigurationOfSeaside30 ) project latestVersion)
     load: #('Base' 'Seaside-Adaptors-Comanche' 'JQuery-UI' 'Seaside-Examples')."
   "(WAComancheAdaptor port: 8080) start."))</pre></tr><tr><td class="docs"><p>It seems Installer is deprecated
scripts adapted from
http://miguel.leugim.com.mx/index.php/2009/09/22/deploying-seaside-prepare-the-images/</p>
</td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn pharo-package
  "Create smalltalk to install a package on pharo"
  [installer project & packages]
  (apply
   smalltalk (format "Installer %s" installer)
   {:project (smalltalk-str project)}
   (map #(array-map :install (smalltalk-str %)) packages)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install-magma
  "Install magma server."
  []
  (pharo-package "ss" "Magma" "1.0r42 (server)"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install-rfb
  "Install rfb"
  [& {:keys [allow-empty-passwords allow-local-connections
             allow-remote-connections
             allow-interactive-connections
             connection-type-disconnect
             configure-for-memory-conservation
             set-full-password]
      :or {allow-empty-passwords false
           allow-local-connections true
           allow-remote-connections false
           allow-interactive-connections true
           connection-type-disconnect true
           configure-for-memory-conservation true}}]
  (str
   (pharo-package "lukas" "unsorted" "RFB")
   (smalltalk-comment "Configure RFB")
   (smalltalk
    "RFBServer current"
    :initializePreferences
    {:allowEmptyPasswords allow-empty-passwords}
    {:allowLocalConnections allow-local-connections}
    {:allowRemoteConnections allow-remote-connections}
    {:allowInteractiveConnections true}
    (when connection-type-disconnect
      :connectionTypeDisconnect)
    (when configure-for-memory-conservation
      :configureForMemoryConservation)
    (when set-full-password
      {:setFullPassword (smalltalk-str set-full-password)}))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install-comanche
  [& {:keys [port unregister] :or {port 9001}}]
  (str
   (smalltalk-comment "Install Commanche")
   (pharo-package
    "ss" "KomHttpServer" "DynamicBindings" "KomServices" "KomHttpServer")
   (smalltalk "WAKom" {:startOn port})
   (when unregister
     (str
      (smalltalk "WADispatcher default" :trimForDeployment)
      (smalltalk "WADispatcher default"
                 {:unregister
                  (smalltalk-call "WADispatcher default"
                                  :entryPointAt (smalltalk-str "/browse"))}
                 {:unregister
                  (smalltalk-call "WADispatcher default"
                                  :entryPointAt (smalltalk-str "/config"))})))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install-seaside
  [username password & {:keys [version] :or {version "Seaside2.8a1"}}]
  (str
   (smalltalk-comment "Install Seaside")
   (smalltalk
    "Installer ss"
    {:project "Seaside"}
    {:answer (smalltalk-str ".*username.*") :with (smalltalk-str username)}
    {:answer (smalltalk-str ".*password.*") :with (smalltalk-str password)}
    {:install (smalltalk-str version)}
    (:install (smalltalk-str "Scriptaculous")))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install-seaside-jetsam
  [& {:keys [version] :or {version "Seaside28Jetsam-kph.67"}}]
  (str
   (smalltalk-comment "Install Seaside")
   (pharo-package "ss" "Jetsam" version)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install-magma-seaside-helper
  [username password]
  (str
   (smalltalk-comment "Install Magma Seaside Helper")
   (smalltalk
    "Installer ss"
    {:project "MagmaTester"}
    {:answer (smalltalk-str ".*username.*") :with (smalltalk-str username)}
    {:answer (smalltalk-str ".*password.*") :with (smalltalk-str password)}
    (:install (smalltalk-str "Magma seasideHelper")))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install-seaside-proxy-tester
  []
  (str
   (smalltalk-comment "Install SeasideProxyTester")
   (pharo-package "ss" "SeasideExamples" "SeasideProxyTester")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn magma-server-image
  "Build image for magma."
  [request]
  (let [magma (str
               (pharo-preferences
                :enable ["#fastDragWindowForMorphic" "#updateSavesFile."]
                :disable ["#windowAnimation"])
               (pharo-update)
               (pharo-author "MyName")
               (pharo-installer)
               (gofer-rfb)
               (gofer-magma :server)
               (pharo-save-and-snapshot-image "magma"))]
    (->
     request
     (pharo-script {:content magma}))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn seaside-server-image
  "Build image for seaside"
  [request]
  (let [seaside (str
                 (pharo-preferences
                  :enable ["#fastDragWindowForMorphic" "#updateSavesFile."]
                  :disable ["#windowAnimation"])
                 ;(pharo-update)
                 (pharo-author "MyName")
                 (pharo-installer)
                 (gofer-seaside)
                 ;(install-comanche)
                 ;(install-seaside "admin" "password")
                 ;(install-seaside-jetsam)
                 ;(install-magma-seaside-helper "admin" "password")
                 ;(install-seaside-proxy-tester)
                 (pharo-save-and-snapshot-image "seaside"))]
    (->
     request
     (pharo-script {:content seaside}))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def magma-st
  "[
[
[ 60 seconds asDelay wait.
(FileDirectory default fileOrDirectoryExists: 'magma.shutdown')
ifTrue: [ SmalltalkImage current snapshot: false andQuit: true ].
(FileDirectory default fileOrDirectoryExists: 'magma.startvnc')
ifTrue: [ Project uiProcess resume.  RFBServer start:0 ].
(FileDirectory default fileOrDirectoryExists: 'magma.stopvnc')
ifTrue: [ RFBServer stop. Project uiProcess suspend ].
] on: Error do: [ :error | error asDebugEmail ]
] repeat
] forkAt: Processor systemBackgroundPriority.
\"To save CPU cycles\"
Project uiProcess suspend.")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn magma-service
  [request & {:keys [image log-dir]
              :or {image "magma.image"
                   log-dir "/var/log/magma"}}]
  (let [vm (parameter/get-for-target request [:smalltalk :vm])
        install-dir (parameter/get-for-target request [:pharo :install-dir])
        image (str install-dir "/" image)
        script (str install-dir "/magma.st")
        files (map #(str install-dir "/" %)
                   ["magma.shutdown" "magma.startvnc" "magma.stopvnc"])]
    (->
     request
     (remote-file/remote-file script :content magma-st :literal true)
     (directory/directory log-dir)
     (pallet.crate.upstart/job
      "magma"
      :pre-start-script (stevedore/chain-commands*
                         (map
                          #(stevedore/script (if (file-exists? %) ("rm" -f %)))
                          files))
      :script (stevedore/script
               ~(vm image  ">>" (str log-dir "/magma.out")))
      :pre-stop-script (stevedore/script
                        (touch ~(first files)))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def seaside-st
  "[
[
[ 60 seconds asDelay wait.
(FileDirectory default fileOrDirectoryExists: 'seaside.shutdown')
ifTrue: [ SmalltalkImage current snapshot: false andQuit: true ]
] on: Error do: [ :error | error asDebugEmail ]
] repeat
] forkAt: Processor systemBackgroundPriority.
To save CPU cycles
Project uiProcess suspend.")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn seaside-service
  [request & {:keys [image log-dir from-port to-port]
              :or {image "seaside.image"
                   log-dir "/var/log/seaside"
                   from-port 9001
                   to-port 9004}}]
  (let [vm (parameter/get-for-target request [:smalltalk :vm])
        install-dir (parameter/get-for-target request [:pharo :install-dir])
        image (str install-dir "/" image)
        script (str install-dir "/seaside.st")
        files (map #(str install-dir "/" %) ["seaside.shutdown"])]
    (->
     request
     (remote-file/remote-file script :content seaside-st :literal true)
     (directory/directory log-dir)
     (pallet.crate.upstart/job
      "seaside"
      :pre-start-script (stevedore/chain-commands*
                         (map
                          #(stevedore/script (if (file-exists? %) ("rm" -f %)))
                          files))
      :script (stevedore/chain-commands*
               (map #(stevedore/script
                      ~(vm image "port" %
                           ">>" (str log-dir "/seaside.out")))
                    (range from-port to-port)))
      :pre-stop-script (stevedore/script
                        (touch ~(first files)))))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.ssh" name="pallet.crate.ssh"><h1 class="project-name">pallet.crate.ssh</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Crate for managing ssh</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.ssh
  (:require
   [pallet.target :as target]
   [pallet.argument :as argument]
   [pallet.request-map :as request-map]
   pallet.crate.iptables
   pallet.resource.package
   pallet.resource.service
   [pallet.crate.nagios-config :as nagios-config]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn openssh
  "Install OpenSSH"
  [request]
  (pallet.resource.package/packages
   request
   :yum ["openssh-clients" "openssh"]
   :aptitude ["openssh-client" "openssh-server"]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn service-name
  "SSH service name"
  [packager]
  (condp = packager
      :aptitude "ssh"
      :yum "sshd"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn sshd-config
  "Take an sshd config string, and write to sshd_conf."
  [request config]
  (->
   request
   (pallet.resource.remote-file/remote-file
    "/etc/ssh/sshd_config"
    :mode "0644"
    :owner "root"
    :content config)
   (pallet.resource.service/service
    (service-name (request-map/packager request))
    :action :reload)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn iptables-accept
  "Accept ssh, by default on port 22"
  ([request] (iptables-accept request 22))
  ([request port]
     (pallet.crate.iptables/iptables-accept-port request port)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn iptables-throttle
  "Throttle ssh connection attempts, by default on port 22"
  ([request] (iptables-throttle request 22))
  ([request port] (iptables-throttle request port 60 6))
  ([request port time-period hitcount]
     (pallet.crate.iptables/iptables-throttle
      request
      "SSH_CHECK" port "tcp" time-period hitcount)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn nagios-monitor
  "Configure nagios monitoring for ssh"
  [request & {:keys [command] :as options}]
  (nagios-config/service
   request
   (merge
    {:servicegroups [:ssh-services]
     :service_description "SSH"
     :check_command "check_ssh"}
    options)))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.ssh-key" name="pallet.crate.ssh-key"><h1 class="project-name">pallet.crate.ssh-key</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.ssh-key
  (:require
   [pallet.stevedore :as stevedore]
   [pallet.utils :as utils]
   [pallet.parameter :as parameter]
   [pallet.resource :as resource]
   [pallet.resource.directory :as directory]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.file :as file]
   [clojure.string :as string])
  (:use
   [pallet.target :only [admin-group]]
   [pallet.resource.user :only [user-home]]
   [pallet.resource.file :only [chmod chown]]
   pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn user-ssh-dir [user]
  (str (stevedore/script (user-home ~user)) "/.ssh/"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn authorize-key
  "Authorize a public key on the specified user."
  [request user public-key-string & {:keys [authorize-for-user] :as options}]
  (let [target-user (or authorize-for-user user)
        dir (user-ssh-dir target-user)
        auth-file (str dir "authorized_keys")]
    (->
     request
     (directory/directory dir :owner target-user :mode "755")
     (file/file auth-file :owner target-user :mode "644")
     (exec-script/exec-checked-script
      "authorize-key"
      (var auth_file ~auth-file)
      (if-not (fgrep (quoted ~(string/trim public-key-string)) @auth_file)
        (echo (quoted ~public-key-string) ">>" @auth_file))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn authorize-key-for-localhost
  "Authorize a user's public key on the specified user, for ssh access to
  localhost.  The :authorize-for-user option can be used to specify the
  user to who's authorized_keys file is modified."
  [request user public-key-filename & {:keys [authorize-for-user] :as options}]
  (let [target-user (or authorize-for-user user)
        key-file (str (user-ssh-dir user) public-key-filename)
        auth-file (str (user-ssh-dir target-user) "authorized_keys")]
    (->
     request
     (directory/directory
      (user-ssh-dir target-user) :owner target-user :mode "755")
     (file/file auth-file :owner target-user :mode "644")
     (exec-script/exec-checked-script
      "authorize-key"
      (var key_file ~key-file)
      (var auth_file ~auth-file)
      (if-not (grep (quoted @(cat @key_file)) @auth_file)
        (do
          (echo -n (quoted "from=\\\"localhost\\\" ") ">>" @auth_file)
          (cat @key_file ">>" @auth_file)))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install-key
  "Install a ssh private key."
  [request user key-name private-key-string public-key-string]
  (let [ssh-dir (user-ssh-dir user)]
    (->
     request
     (directory/directory ssh-dir :owner user :mode "755")
     (remote-file/remote-file
      (str ssh-dir key-name)
      :owner user :mode "600"
      :content private-key-string)
     (remote-file/remote-file
      (str ssh-dir key-name ".pub")
      :owner user :mode "644"
      :content public-key-string))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def ssh-default-filenames
     {"rsa1" "identity"
      "rsa" "id_rsa"
      "dsa" "id_dsa"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn generate-key
  "Generate an ssh key pair for the given user, unless one already
   exists. Options are:
     :file path     -- output file name (within ~user/.ssh directory)
     :type key-type -- key type selection
     :no-dir true   -- do note ensure directory exists
     :passphrase    -- new passphrase for encrypring the private key
     :comment       -- comment for new key"
  [request user & {:keys [type file passphrase no-dir comment]
                   :or {type "rsa" passphrase }
                   :as  options}]
  (let [key-type type
        path (stevedore/script
              ~(str (user-ssh-dir user)
                    (or file (ssh-default-filenames key-type))))
        ssh-dir (.getParent (java.io.File. path))]
    (->
     request
     (when-not-> (or (:no-dir options))
                 (directory/directory ssh-dir :owner user :mode "755"))
     (exec-script/exec-checked-script
      "ssh-keygen"
      (var key_path ~path)
      (if-not (file-exists? @key_path)
        (ssh-keygen ~(stevedore/map-to-arg-string
                      {:f (stevedore/script @key_path)
                       :t key-type
                       :N (str \" passphrase \")
                       :C (str
                           \"
                           (or (:comment options "generated by pallet"))
                           \")}))))
     (file/file path :owner user :mode "0600")
     (file/file (str path ".pub") :owner user :mode "0644"))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn record-public-key
  [request user & {:keys [filename type]
                   :or {type "rsa"} :as options}]
  (let [filename (or filename (ssh-default-filenames type))
        path (str (user-ssh-dir user) filename ".pub")]
    (->
     request
     (remote-file/with-remote-file
       (fn [request local-path]
         (resource/as-local-resource
          request
          (fn [request]
            (parameter/assoc-for-target
             request [:user (keyword user) (keyword filename)]
             (slurp local-path)))))
       path))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.sudoers" name="pallet.crate.sudoers"><h1 class="project-name">pallet.crate.sudoers</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.sudoers
  (:require
   [clojure.contrib.string :as string])
  (:use
   [pallet.utils :only [underscore as-string]]
   [pallet.target :only [admin-group]]
   [pallet.template]
   [pallet.resource :only [defaggregate]]
   [clojure.contrib.logging]))</pre></tr><tr><td class="docs"><p>TODO - add recogintion of +key or key+
TODO - add escaping according to man page
TODO - dsl for sudoers, eg. (alias "user1" "user2" :as :ADMINS)</p>
</td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- default-specs [request]
  (array-map
   "root" {:ALL {:run-as-user :ALL}}
   (str "%" (admin-group (:image (:node-type request))))
   {:ALL {:run-as-user :ALL}}))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- param-string [[key value]]
  (cond
   (instance? Boolean value) (str (if-not value "!") (underscore (name key)))
   (instance? String value) (str (underscore (name key)) \= value)
   (keyword? value) (str (underscore (name key)) \= (underscore (name value)))
   :else (str (underscore (name key)) \= value)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- write-defaults [type name defaults]
  (str "Defaults" type name " "
       (string/join  "," (map param-string defaults))
       "\n"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- defaults-for [defaults key type]
  (apply
   str
   (map
    #(write-defaults type (as-string (first %)) (second %))
    (defaults key))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- defaults [defaults]
  (str
   (when-let [default (:default defaults)]
     (write-defaults "" "" default))
   (apply str
          (map (partial defaults-for defaults)
               [:run-as-user :user :host] [ \> \: \@]))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- write-aliases [type name aliased]
  (str type " " (string/upper-case name) " = "
       (apply str (interpose "," (map str aliased)))
       "\n"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- aliases-for [aliases key type]
  (apply str (map #(write-aliases type (name (first %)) (second %)) (aliases key))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- aliases [aliases]
  (apply str
          (map (partial aliases-for aliases)
               [:user :run-as-user :host :cmnd]
               ["User_Alias" "Runas_Alias" "Host_Alias" "Cmnd_Alias"])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- as-tag [item]
  (str (as-string item) ":"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- tag-or-vector [item]
  (if (vector? item)
    (string/join " " (map as-tag item))
    (as-tag item)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- item-or-vector [item]
  (if (vector? item)
    (string/join "," (map as-string item))
    (as-string item)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- write-cmd-spec [[cmds options]]
  (str (if (:run-as-user options) (str "(" (item-or-vector (:run-as-user options))  ") "))
       (if (:tags options) (str (tag-or-vector (:tags options)) " "))
       (item-or-vector cmds)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- write-host-spec [host-spec]
  (trace (str "write-host-spec" host-spec))
  (str
   (item-or-vector (or (:host host-spec) :ALL)) " = "
   (string/join "," (map write-cmd-spec (dissoc host-spec :host)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- write-spec [[user-spec host-spec]]
  (str (item-or-vector user-spec) " "
       (if (vector? host-spec)
         (string/join " : " (map write-host-spec host-spec))
         (write-host-spec host-spec))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- specs [spec-map]
  (string/join "\n" (map write-spec spec-map)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(deftemplate sudoer-templates
  [aliases-map default-map spec-map]
  {{:path "/etc/sudoers" :owner "root" :mode "0440"}
   (str
    (aliases aliases-map)
    (defaults default-map)
    (specs spec-map))})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- merge-user-spec [m1 m2]
  (cond
   (and (map? m1) (map? m2) (and (= (:host m1) (:host m2))))
   (merge m2 m1)
   (and (vector? m1) (vector? m2))
   (apply vector (concat m1 m2))
   :else
   (throw (IllegalArgumentException. "do not know how to merge mixed style user specs"))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- sudoer-merge [initial args]
  (letfn [(merge-fn [m initial-keys args-keys]
                    (let [additional-keys
                          (filter #(not-any? (fn [x] (= x %)) initial-keys) args-keys)]
                      (apply array-map
                       (apply concat (map #(vector % (m %))
                                          (concat initial-keys additional-keys))))))]
    (reduce (fn [v1 v2]
              (map #(merge-fn
                     (merge-with merge-user-spec %1 %2) (keys %1) (keys %2))
                   v1 v2))
            initial args)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defaggregate sudoers
  "Sudo configuration. Generates a sudoers file.
By default, root and an admin group are already present.

Examples of the arguments are:

aliases { :user { :ADMINS [ \"user1\" \"user2\" ] }
          :host { :TRUSTED [ \"host1\" ] }
          :run-as-user { :OP [ \"root\" \"sysop\" ] }
          :cmnd { :KILL [ \"kill\" ]
                  :SHELLS [ \"/usr/bin/sh\" \"/usr/bin/csh\" \"/usr/bin/ksh\"]}}
default-map { :default { :fqdn true }
              :host { \"host\" { :lecture false } }
              :user { \"user\" { :lecture false } }
              :run-as-user { \"sysop\" { :lecture false } } }
specs [ { [\"user1\" \"user2\"]
          { :host :TRUSTED
            :KILL { :run-as-user \"operator\" :tags :NOPASSWORD }
            [\"/usr/bin/*\" \"/usr/local/bin/*\"]
            { :run-as-user \"root\" :tags [:NOEXEC :NOPASSWORD} }"
  {:use-arglist [aliases defaults specs]}
  (apply-sudoers
   [request args]
   (trace "apply-sudoers")
   (apply-templates
    sudoer-templates
    (sudoer-merge
     [(array-map) (array-map) (default-specs (:image (:node-type request)))]
     args))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.syslog-ng" name="pallet.crate.syslog-ng"><h1 class="project-name">pallet.crate.syslog-ng</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Install and configure syslog-ng</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.syslog-ng
  (:require
   [pallet.compute :as compute]
   [pallet.parameter :as parameter]
   [pallet.resource :as resource]
   [pallet.target :as target]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.package :as package]
   [pallet.resource.user :as user]
   [pallet.crate.iptables :as iptables]
   [clojure.string :as string])
  (:use pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn default-group "adm")
(defn default-mode "0640")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def default-options
  {:chain_hostnames 0
   :time_reopen 10
   :time_reap 360
   :sync 0
   :log_fifo_size 2048
   :create_dirs "yes"
   :group "adm"
   :dir_group "adm"
   :perm "0640"
   :dir_perm "0750"
   :use_dns "no"
   :stats_freq 0
   :bad_hostname "^gconfd$"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def default-sources
  {:s_all {:internal true
           :unix-stream "/dev/log"
           :file {:value "/proc/kmsg" :log_prefix "kernel: "}}})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn receive-from
  "Create a configuration for receiving from remote syslog-ng client. The return
   value is suitable for specifying a source."
  ([protocol] (receive-from protocol 514))
  ([protocol port]  { protocol {:port port}}))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def default-destinations
  {:df_auth { :file "/var/log/auth.log" }
   :df_syslog { :file "/var/log/syslog" }
   :df_cron { :file "/var/log/cron.log" }
   :df_daemon { :file "/var/log/daemon.log" }
   :df_kern { :file "/var/log/kern.log" }
   :df_lpr { :file "/var/log/lpr.log" }
   :df_mail { :file "/var/log/mail.log" }
   :df_user { :file "/var/log/user.log" }
   :df_uucp { :file "/var/log/uucp.log" }
   :df_facility_dot_info { :file "/var/log/$FACILITY.info" }
   :df_facility_dot_notice { :file "/var/log/$FACILITY.notice" }
   :df_facility_dot_warn { :file "/var/log/$FACILITY.warn" }
   :df_facility_dot_err { :file "/var/log/$FACILITY.err" }
   :df_facility_dot_crit { :file "/var/log/$FACILITY.crit" }
   :df_news_dot_notice { :file {:value "/var/log/news/news.notice"
                                :owner "news"} }
   :df_news_dot_err { :file {:value "/var/log/news/news.err" :owner "news"} }
   :df_news_dot_crit { :file {:value "/var/log/news/news.crit" :owner "news"} }
   :df_debug { :file "/var/log/debug" }
   :df_messages { :file "/var/log/messages" }
   :dp_xconsole { :pipe "/dev/xconsole" }
   :du_all { :usertty "*" }})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn send-to
  "Create a configuration for sending to a remote syslog-ng server. The return
   value is suitable for specifying a destination."
  ([destination] (send-to destination "tcp" 514))
  ([destination protocol] (send-to destination protocol 514))
  ([destination protocol port]
     {:tcp {:value destination :port port}}))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def default-filters
  {:f_auth { :facility "auth, authpriv" }
   :f_syslog { :not { :facility "auth, authpriv" } }
   :f_cron { :facility "cron" }
   :f_daemon { :facility "daemon" }
   :f_kern { :facility "kern" }
   :f_lpr { :facility "lpr" }
   :f_mail { :facility "mail" }
   :f_news { :facility "news" }
   :f_user { :facility "user" }
   :f_uucp { :facility "uucp" }
   :f_at_least_info { :level "info..emerg" }
   :f_at_least_notice { :level "notice..emerg" }
   :f_at_least_warn { :level "warn..emerg" }
   :f_at_least_err { :level "err..emerg" }
   :f_at_least_crit { :level "crit..emerg" }
   :f_debug {:and {:level "debug"
                   :not {:facility "auth, authpriv, news, mail"}}}
   :f_messages {:and {:level "info,notice,warn"
                      :not {:facility "auth,authpriv,cron,daemon,mail,news"}}}
   :f_emerg { :level "emerg" }
   :f_xconsole {:or {:facility "daemon,mail"
                     :level "debug,info,notice,warn"
                     :and {:facility "news"
                           :level "crit,err,notice"}}}})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def default-logs
  [{:source :s_all
    :filter :f_auth
    :destination :df_auth}
   {:source :s_all
    :filter :f_syslog
    :destination :df_syslog}
   {:source :s_all
    :filter :f_daemon
    :destination :df_daemon}
   {:source :s_all
    :filter :f_kern
    :destination :df_kern}
   {:source :s_all
    :filter :f_lpr
    :destination :df_lpr}
   {:source :s_all
    :filter :f_mail
    :destination :df_mail}
   {:source :s_all
    :filter :f_user
    :destination :df_user}
   {:source :s_all
    :filter :f_uucp
    :destination :df_uucp}
   {:source :s_all
    :filter [:f_mail :f_at_least_info]
    :destination :df_facility_dot_info}
   {:source :s_all
    :filter [:f_mail :f_at_least_warn]
    :destination :df_facility_dot_warn}
   {:source :s_all
    :filter [:f_mail :f_at_least_err]
    :destination :df_facility_dot_err}
   {:source :s_all
    :filter [:f_news :f_at_least_crit]
    :destination :df_news_dot_crit}
   {:source :s_all
    :filter [:f_news :f_at_least_err]
    :destination :df_news_dot_err}
   {:source :s_all
    :filter [:f_news :f_at_least_notice]
    :destination :df_news_dot_notice}
   {:source :s_all
    :filter :f_debug
    :destination :df_debug}
   {:source :s_all
    :filter :f_messages
    :destination :df_messages}
   {:source :s_all
    :filter :f_emerg
    :destination :du_all}
   {:source :s_all
    :filter :f_xconsole
    :destination :dp_xconsole}])</pre></tr><tr><td class="docs"><p>:key value -> key(value)
:key { :p1 v1 :p2 v2 } -> key(p1(v1) p2(v2))
:key { :value v :p1 v1 :p2 v2 } -> key(v p1(v1) p2(v2))</p>
</td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmulti property-fmt
  (fn [& [value & options]]
    (cond
     (map? value) :map
     :else :default)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmulti value-fmt
  (fn [value key]
    (cond
     (map? value) :map
     (and (instance? Boolean value) value) :true
     (instance? clojure.lang.Named value) :named
     :else :default)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod property-fmt :map
  ([value] (property-fmt value ";\n"))
  ([value seperator]
     (string/join
      (map
       #(cond
         (#{:not} (first %)) (str (name (first %)) " "
                                  (property-fmt (second %) seperator))
         (#{:and :or} (first %)) (str "("
                                      (string/trim
                                       (string/join
                                        (str " " (name (first %)) " ")
                                        (map (fn [x]
                                               (property-fmt
                                                (apply hash-map x) " "))
                                             (second %))))
                                      ")" seperator)
         (vector? (second %)) (string/join
                               (map (fn [x]
                                      (property-fmt { (first %) x} seperator))
                                    (second %)))
         :else (str (name (first %)) "("
                    (string/trim
                     (str
                      (value-fmt (second %) (first %))
                      " "
                      (property-fmt (second %) " ")))
                    ")" seperator))
       (dissoc value :value)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod property-fmt :default
  [value & _]
  nil)</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def quoted-keys
  #{:file :pipe :unix-stream :bad_hostname :template :log_prefix})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn format-value [value key]
  (if (quoted-keys key)
    (pr-str value)
    (str value)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod value-fmt :default
  [value key]
  (format-value value key))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod value-fmt :true
  [value key]
  nil)</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod value-fmt :named
  [value key]
  (format-value (name value) key))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod value-fmt :map
  [value key]
  (format-value (:value value) key))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn configure-block
  "Define a syslog-ng configuration block"
  [block-type properties]
  (format
   "%s {\n%s\n};\n"
   block-type
   (string/trim (property-fmt properties))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn config
  [request & {:keys [options sources destinations filters logs]
              :or {options default-options
                   sources default-sources
                   destinations default-destinations
                   filters default-filters
                   logs default-logs}
              :as args}]
  (remote-file/remote-file
   request
   "/etc/syslog-ng/syslog-ng.conf"
   :content (str
             (configure-block "options" options)
             (string/join
              \newline
              (map #(configure-block
                     (str "source " (name (first %))) (second %))
                   sources))
             (string/join
              \newline
              (map #(configure-block
                     (str "destination " (name (first %))) (second %))
                   destinations))
             (string/join
              \newline
              (map #(configure-block
                     (str "filter " (name (first %))) (second %))
                   filters))
             (string/join
              \newline
              (map #(configure-block "log" %) logs)))
   :literal true))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install
  "Install from package. keys correspond to sections of the syslog-ng.conf file"
  [request & {:keys [options sources destinations filters logs]
              :as args}]
  (->
   request
   (package/package "syslog-ng")
   (when-let-> [group (:group options)]
     (user/group group :system true))
   (when-let-> [dir_group (:dir_group options)]
     (when-> (not (= dir_group (:group options)))
       (user/group dir_group :system true)))
   (apply->
    config
    (apply concat
           (select-keys args [:options :sources :destinations :filters :logs])))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn set-server-ip
  "Set the syslog-ng server ip, so that it may be picked up by clients. This
   should probably be run in the pre-configure phase."
  [request]
  (parameter/update-for
   request
   [:syslog-ng :server :ip]
   (fn [_] (compute/primary-ip (:target-node request)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn iptables-accept
  "Accept connections, by default on port 514, with tcp."
  ([request] (iptables-accept request 514 "tcp"))
  ([request port] (iptables-accept request port "tcp"))
  ([request port protocol]
     (pallet.crate.iptables/iptables-accept-port request port protocol)))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.tmux" name="pallet.crate.tmux"><h1 class="project-name">pallet.crate.tmux</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.tmux
  (:use
   [pallet.resource.package :only [packages]]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn tmux
  "Install tmux"
  [request]
  (packages request
            :yum ["tmux"]
            :aptitude ["tmux"]))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.tomcat" name="pallet.crate.tomcat"><h1 class="project-name">pallet.crate.tomcat</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Crate to install and configure tomcat.</p>

<p>   Installation sets the following host paramters:
     - [:tomcat :base] base of the tomcat installation
     - [:tomcat :config-path] path to the configuration files
     - [:tomcat :owner] user that owns and runs tomcat
     - [:tomcat :group] group for tomcat files
     - [:tomcat :service] the name of the package installed</p>

<p>   Configuration is via <code>server-configuration</code>, passing a server configuration
   generated with a call to <code>server</code>.</p>

<p>   The tomcat service may be controlled via <code>init-service</code>.</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.tomcat
  "Crate to install and configure tomcat.
   Installation sets the following host paramters:
     - [:tomcat :base] base of the tomcat installation
     - [:tomcat :config-path] path to the configuration files
     - [:tomcat :owner] user that owns and runs tomcat
     - [:tomcat :group] group for tomcat files
     - [:tomcat :service] the name of the package installed
   Configuration is via `server-configuration`, passing a server configuration
   generated with a call to `server`.
   The tomcat service may be controlled via `init-service`."
  (:refer-clojure :exclude [alias])
  (:use
   [pallet.stevedore :only [script]]
   [pallet.resource.file :only [heredoc file rm]]
   [pallet.template :only [find-template]]
   [pallet.enlive :only [xml-template xml-emit transform-if deffragment elt]]
   [clojure.contrib.prxml :only [prxml]]
   pallet.thread-expr)
  (:require
   [pallet.resource :as resource]
   [pallet.core :as core]
   [pallet.parameter :as parameter]
   [pallet.resource.package :as package]
   [pallet.resource.file :as file]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.directory :as directory]
   [pallet.resource.service :as service]
   [pallet.resource.exec-script :as exec-script]
   [pallet.request-map :as request-map]
   [pallet.target :as target]
   [net.cgrand.enlive-html :as enlive]
   [clojure.contrib.string :as string]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def dummy-for-marginalia)</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def
  ^{:doc "Baseline configuration file path" :private true}
  tomcat-config-root "/etc/")
(def
  ^{:doc "Baseline install path" :private true}
  tomcat-base "/var/lib/")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def
  ^{:doc "package names for specific versions" :private true}
  version-package
  {6 "tomcat6"
   5 "tomcat5"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def
  ^{:doc "default package name for each packager" :private true}
  package-name
  {:aptitude "tomcat6"
   :pacman "tomcat"
   :yum "tomcat5"
   :amzn-linux "tomcat6"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def
 ^{:doc "default user and group name for each packager" :private true}
  tomcat-user-group-name
  {:aptitude "tomcat6"
   :pacman "tomcat"
   :yum "tomcat"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn tomcat
  "Install tomcat from the standard package sources.
   Options:
    - :user     override the tomcat user
    - :group    override the tomcat group
    - :version  specify the tomcat version (5, 6, or arbitrary string)"
  [request & {:keys [user group version] :as options}]
  (let [package (or
                 (version-package version version)
                 (package-name (request-map/os-family request))
                 (package-name (:target-packager request)))
        tomcat-user (tomcat-user-group-name (:target-packager request))]
    (-> request
        (when->
         (and (= :centos (request-map/os-family request))
              (= "5.3" (request-map/os-version request)))
         (package/add-jpackage :releasever "5.0"))
        (when-> (= :install (:action options :install))
                (parameter/assoc-for-target
                 [:tomcat :base] (str tomcat-base package "/")
                 [:tomcat :config-path] (str tomcat-config-root package "/")
                 [:tomcat :owner] (or user tomcat-user)
                 [:tomcat :group] (or group tomcat-user)
                 [:tomcat :service] package))
        (apply->
         package/package package
         (apply concat options))
        (when-> (:purge options)
                (directory/directory
                 tomcat-base :action :delete :recursive true :force true)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn init-service
  "Control the tomcat service.
   Arguments are as for `pallet.resource.service/service`, except the service
   name is looked up in the request parameters."
  [request & args]
  (->
   request
   (apply->
    service/service
    (parameter/get-for-target request [:tomcat :service])
    args)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn undeploy
  "Removes the named webapp directories, and any war files with the same base
   names."
  [request & app-names]
  (let [tomcat-base (parameter/get-for-target request [:tomcat :base])]
    (-> request
        (for-> [app-name app-names
                :let [app-name (or app-name "ROOT")
                      app-name (if (string? app-name) app-name (name app-name))
                      exploded-app-dir (str tomcat-base "webapps/" app-name)]]
               (directory/directory exploded-app-dir :action :delete)
               (file/file (str exploded-app-dir ".war") :action :delete)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn undeploy-all
  "Removes all deployed war file and exploded webapp directories."
  [request]
  (let [tomcat-base (parameter/get-for-target request [:tomcat :base])]
    (exec-script/exec-script
     request
     (rm ~(str tomcat-base "webapps/*") ~{:r true :f true}))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn deploy
  "Copies a .war file to the tomcat server under webapps/${app-name}.war.  An
   app-name of \"ROOT\" or nil will deploy the source war file as the / webapp.
   Accepts options as for remote-file in order to specify the source.
   Other Options:
     :clear-existing true -- removes the existing exploded ${app-name} directory"
  [request app-name & {:as opts}]
  (let [tomcat-base (parameter/get-for-target request [:tomcat :base])
        tomcat-user (parameter/get-for-target request [:tomcat :owner])
        tomcat-group (parameter/get-for-target request [:tomcat :group])
        exploded-app-dir (str tomcat-base "webapps/" (or app-name "ROOT"))
        deployed-warfile (str exploded-app-dir ".war")
        options (merge
                 {:owner tomcat-user :group tomcat-group :mode 600}
                 (select-keys opts remote-file/all-options))]
    (->
     request
     (apply->
      remote-file/remote-file
      deployed-warfile
      (apply concat options))
     ;; (when-not-> (:clear-existing opts)
     ;;  ;; if we're not removing an existing, try at least to make sure
     ;;  ;; that tomcat has the permissions to explode the war
     ;;  (apply->
     ;;   directory/directory
     ;;   exploded-app-dir
     ;;   (apply concat
     ;;          (merge {:owner tomcat-user :group tomcat-group :recursive true}
     ;;                 (select-keys options [:owner :group :recursive])))))
     (when-> (:clear-existing opts)
             (directory/directory exploded-app-dir :action :delete)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- output-grants
  "Return a string containing `grant` statements for a tomcat policy file."
  [[code-base permissions]]
  (let [code-base (when code-base
                    (format "codeBase \"%s\"" code-base))]
  (format
    "grant %s {\n  %s;\n};"
    (or code-base "")
    (string/join ";\n  " permissions))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn policy
  "Configure tomcat policies.
     number - determines sequence i which policies are applied
     name - a name for the policy
     grants - a map from codebase to sequence of permissions"
  [request number name grants
   & {:keys [action] :or {action :create} :as options}]
  (let [tomcat-config-root (parameter/get-for-target
                            request [:tomcat :config-path])
        policy-file (str tomcat-config-root "policy.d/" number name ".policy")]
    (case action
      :create (->
               request
               (directory/directory
                (str tomcat-config-root "policy.d"))
               (remote-file/remote-file
                policy-file
                :content (string/join \newline (map output-grants grants))
                :literal true))
      :remove (file/file request policy-file :action :delete))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn application-conf
  "Configure tomcat applications.
   name - a name for the policy
   content - an xml application context"
  [request name content & {:keys [action] :or {action :create} :as options}]
  (let [tomcat-config-root (parameter/get-for-target
                            request [:tomcat :config-path])
        app-file (str tomcat-config-root "Catalina/localhost/" name ".xml")]
    (case action
      :create (remote-file/remote-file
               request app-file :content content :literal true)
      :remove (file/file request app-file :action :delete))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn users*
  [roles users]
  (with-out-str
    (prxml
     [:decl {:version "1.1"}]
     [:tomcat-users
      (map #(vector :role {:rolename %}) roles)
      (map #(vector :user {:username (first %)
                           :password ((second %) :password)
                           :roles (string/join "," ((second %) :roles))})
           users)])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn merge-tomcat-users [args]
  (loop [args args
         users {}
         roles []]
    (if (seq args)
      (if (= :role (first args))
        (recur (nnext args) users (conj roles (fnext args)))
        (recur (nnext args) (merge users {(first args) (fnext args)}) roles))
      [roles users])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(resource/defcollect user
  "Configure tomcat users. Options are:
     :role rolename
     username {:password \"pw\" :roles [\"role1\" \"role 2\"]}"
  {:use-arglist [request & {:keys [role] :as options}]}
  (apply-tomcat-user
   [request args]
   (let [[roles users] (merge-tomcat-users (apply concat args))]
     (users* roles users))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def listener-classnames
     {:apr-lifecycle
      "org.apache.catalina.core.AprLifecycleListener"
      :jasper
      "org.apache.catalina.core.JasperListener"
      ::server-lifecycle
      "org.apache.catalina.mbeans.ServerLifecycleListener"
      ::global-resources-lifecycle
      "org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"
     :jmx-remote-lifecycle
      "org.apache.catalina.mbeans.JmxRemoteLifecycleListener"
     :jre-memory-leak-prevention
      "org.apache.catalina.mbeans.JmxRemoteLifecycleListener"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def connector-classnames
     {})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def resource-classnames
     {:sql-data-source "javax.sql.DataSource"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def valve-classnames
     {:access-log "org.apache.catalina.valves.AccessLogValve"
      :remote-addr "org.apache.catalina.valves.RemoteAddrValve"
      :remote-host "org.apache.catalina.valves.RemoteHostValve"
      :request-dumper "org.apache.catalina.valves.RequestDumperValve"
      :single-sign-on "org.apache.catalina.authenticator.SingleSignOn"
      :basic-authenticator "org.apache.catalina.authenticator.BasicAuthenticator"
      :digest-authenticator "org.apache.catalina.authenticator.DigestAuthenticator"
      :form-authenticator "org.apache.catalina.authenticator.FormAuthenticator"
      :ssl-authenticator "org.apache.catalina.authenticator.SSLAuthenticator"
      :webdav-fix "org.apache.catalina.valves.WebdavFixValve"
      :remote-ip "org.apache.catalina.valves.RemoteIpValve"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def realm-classnames
     {:jdbc "org.apache.catalina.realm.JDBCRealm"
      :data-source "org.apache.catalina.realm.DataSourceRealm"
      :jndi "org.apache.catalina.realm.JNDIRealm"
      :user-database "org.apache.catalina.realm.UserDatabaseRealm"
      :memory "org.apache.catalina.realm.MemoryRealm"
      :jaas "org.apache.catalina.realm.JAASRealm"
      :combined "org.apache.catalina.realm.CombinedRealm"
      :lock-out "org.apache.catalina.realm.LockOutRealm"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def *server-file* "server.xml")
(def *context-file* "context.xml")
(def *web-file* "web.xml")</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn path-for
  "Get the actual filename corresponding to a template."
  [base] (str "crate/tomcat/" base))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn flatten-map
  "Flatten a map, removing all namespaced keywords and specified keys"
  [m & dissoc-keys]
  (apply concat (remove (fn [[k v]]
                          (and (keyword? k) (namespace k)))
                  (apply dissoc m dissoc-keys))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(deffragment server-resources-transform
  [global-resources]
  [:Environment] (transform-if (global-resources ::environment) nil)
  [:Resource] (transform-if (global-resources ::resource) nil)
  [:Transaction] (transform-if (global-resources ::transaction) nil)
  [:GlobalNamingResources]
  (enlive/do-> ; ensure we have elements to configure
   (transform-if (global-resources ::environment)
                 (enlive/prepend (elt :Environment)))
   (transform-if (global-resources ::resource)
                 (enlive/prepend (elt ::resource)))
   (transform-if (global-resources ::transaction)
                 (enlive/prepend (elt :Transaction))))
  [:Environment]
  (transform-if (global-resources ::environment)
   (enlive/clone-for [environment (global-resources ::environment)]
                     (apply enlive/set-attr (flatten-map environment))))
  [:Resource]
  (transform-if (global-resources ::resource)
   (enlive/clone-for [resource (global-resources ::resource)]
                     (apply enlive/set-attr (flatten-map resource))))
  [:Transaction]
  (transform-if (global-resources ::transaction)
   (enlive/clone-for [transaction (global-resources ::transaction)]
                     (apply enlive/set-attr (flatten-map transaction)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(deffragment engine-transform
  [engine]
  [:Host] (transform-if (engine ::host) nil)
  [:Valve] (transform-if (engine ::valve) nil)
  [:Realm] (transform-if (engine ::realm) nil)
  [:Engine]
  (enlive/do-> ; ensure we have elements to configure
   (transform-if (engine ::host)
                 (enlive/prepend (elt :Host)))
   (transform-if (engine ::valve)
                 (enlive/prepend (elt :Valve)))
   (transform-if (engine ::realm)
                 (enlive/prepend (elt :Realm))))
  [:Host]
  (transform-if (engine ::host)
                (enlive/clone-for
                 [host (engine ::host)]
                 (enlive/do->
                  (apply enlive/set-attr (flatten-map host))
                  (engine-transform (engine ::host)))))
  [:Valve]
  (transform-if (engine ::valve)
                (enlive/clone-for
                 [valve (engine ::valve)]
                 (apply enlive/set-attr (flatten-map valve))))
  [:Realm]
  (transform-if (engine ::realm)
                (enlive/set-attr (flatten-map (engine ::realm)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(deffragment service-transform
  [service]
  [:Connector]
  (enlive/clone-for [connector (service ::connector)]
                    (apply enlive/set-attr (flatten-map connector)))
  [:Engine]
  (transform-if (service ::engine)
                (enlive/do->
                 (apply enlive/set-attr (flatten-map (service ::engine)))
                 (engine-transform (service ::engine)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn tomcat-server-xml
  "Generate server.xml content"
  [node-type server]
  {:pre [node-type]}
  (xml-emit
   (xml-template
    (path-for *server-file*) node-type [server]
    [:Listener]
    (transform-if (server ::listener) nil)
    [:GlobalNamingResources]
    (transform-if (server ::global-resources) nil)
    [:Service] (transform-if (server ::service)
                 (enlive/clone-for [service (server ::service)]
                   (service-transform service)))
    [:Server]
    (enlive/do->
     (transform-if (seq (apply concat (select-keys server [:port :shutdown])))
                   (apply enlive/set-attr
                          (apply concat (select-keys server [:port :shutdown]))))
     (transform-if (server ::listener)
                   (enlive/prepend (elt :Listener)))
     (transform-if (server ::global-resources)
                   (enlive/prepend
                    (elt :GlobalNamingResources))))
    [:Listener]
    (transform-if (server ::listener)
      (enlive/clone-for
       [listener (server ::listener)]
       (apply enlive/set-attr (flatten-map listener))))
    [:GlobalNamingResources]
    (transform-if (server ::global-resources)
      (server-resources-transform (server ::global-resources))))
   server))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn classname-for
  "Lookup value in the given map if it is a keyword, else return the value."
  [value classname-map]
  (if (keyword? value)
    (classname-map value)
    value))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn extract-member-keys [options]
  (loop [options (seq options)
         output []
         members #{}
         collections #{}]
    (if options
      (condp = (first options)
        :members (recur (nnext options) output (set (fnext options)) collections)
        :collections (recur (nnext options) output members (set (fnext collections)))
        (recur (next options) (conj output (first options)) members collections))
      [members collections output])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn extract-nested-maps
  [[members collections options]]
  (let [pallet-type (fn [object]
                      (and (map? object) (object ::pallet-type)))
        add-member (fn [result object]
                     (if-let [pt (pallet-type object)]
                       (assoc result pt
                              (if (members pt)
                                object
                                (conj (or (result pt) []) object)))
                       result))
        members (reduce add-member {} options)
        options (filter (complement pallet-type) options)]
    (merge members (into {} (map vec (partition 2 options))))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn extract-options [& options]
  (extract-nested-maps (extract-member-keys options)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmacro pallet-type
  "Create a pallet type-map"
  [type-tag & options]
  `(assoc (apply extract-options ~@options) ::pallet-type ~type-tag))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn listener
  "Define a tomcat listener. listener-type is a classname or a key from
   `listener-classnames`.
   Options are listener-type specific, and match the attributes in the tomcat
   docs.
   For example, to configure the APR SSL support:
       (listener :apr-lifecycle :SSLEngine \"on\" :SSLRandomSeed \"builtin\")"
  [listener-type & options]
  (pallet-type ::listener
               :className (classname-for listener-type listener-classnames)
               options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn global-resources
  "Define tomcat resources.
   Options include:
     resources, transactions, environments"
  [& options]
  (pallet-type ::global-resources
               :collections [::resource ::transaction ::environment]
               options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn environment
  "Define tomcat environment variable.
   http://tomcat.apache.org/tomcat-6.0-doc/config/context.html#Environment_Entries"
  ([name value type]
     (pallet-type ::environment
                  [:name name :value value :type (.getName type)]))
  ([name value type override]
     (pallet-type ::environment
                  [:name name :value value :type (.getName type)
                   :override override])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn resource
  "Define tomcat JNDI resource.
   resource-type is a classname, or on of :sql-datasource.
   Options include:
   http://tomcat.apache.org/tomcat-6.0-doc/config/resources.html
   "
  [name resource-type & options]
  (pallet-type ::resource
               :name name
               :type (classname-for resource-type resource-classnames)
               options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn transaction
  "Define tomcat transaction factory."
  [factory-classname]
  (pallet-type ::transaction [:factory factory-classname]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn service
  "Define a tomcat service.
   Requires an engine and connectors.
       (service (engine ) (connector)
   Options are implementation specific, and includes:
    - :className
   http://tomcat.apache.org/tomcat-6.0-doc/config/service.html"
  [& options]
  (pallet-type ::service :members [::engine] :collections [::connector] options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn connector
  "Define a tomcat connector."
  [& options]
  (pallet-type ::connector options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn ssl-jsse-connector
  "Define a SSL connector using JSEE.  This connector can be specified for a
   service.
   This connector has defaults equivalant to:
     (tomcat/connector :port 8443 :protocol \"HTTP/1.1\" :SSLEnabled \"true\"
       :maxThreads 150 :scheme \"https\" :secure \"true\"
       :clientAuth \"false\" :sslProtocol \"TLS\"
       :keystoreFile \"${user.home}/.keystore\" :keystorePass \"changeit\")"
  [& options]
  (pallet-type
   ::connector
   (concat [:port 8443 :protocol "HTTP/1.1" :SSLEnabled "true"
            :maxThreads 150 :scheme "https" :secure "true"
            :clientAuth "false" :sslProtocol "TLS"
            :keystoreFile "${user.home}/.keystore" :keystorePass "changeit"]
           options)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn ssl-apr-connector
  "Define a SSL connector using APR.  This connector can be specified for a
   service.  You can use the :SSLEngine and :SSLRandomSeed options on the
   server's APR lifecycle listener to configure which engine is used.
   This connector has defaults equivalant to:
     (tomcat/connector :port 8443 :protocol \"HTTP/1.1\" :SSLEnabled \"true\"
       :maxThreads 150 :scheme \"https\" :secure \"true\"
       :clientAuth \"optional\" :sslProtocol \"TLSv1\"
       :SSLCertificateFile \"/usr/local/ssl/server.crt\"
       :SSLCertificateKeyFile=\"/usr/local/ssl/server.pem\")"
  [& options]
  (pallet-type
   ::connector
   (concat [:port 8443 :protocol "HTTP/1.1" :SSLEnabled "true"
            :maxThreads 150 :scheme "https" :secure "true"
            :clientAuth "optional" :sslProtocol "TLSv1"
            :SSLCertificateFile "/usr/local/ssl/server.crt"
            :SSLCertificateKeyFile="/usr/local/ssl/server.pem"]
           options)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn engine
  "Define a tomcat engine.
   Accepts a realm, valves, and hosts.
   Options are specified in the tomcat docs, and include:
    - :className
    - :backgroundProcessorDelay
    - :jvmRoute
   http://tomcat.apache.org/tomcat-6.0-doc/config/engine.html"
  [name default-host & options]
  (pallet-type
   ::engine :members [::realm] :collections [::valve ::host]
   :name name :defaultHost default-host options))</pre></tr><tr><td class="docs"><p>TODO : Create specialised constructors for each realm</p>
</td><td class="codes" /><pre class="brush: clojure">(defn realm
  "Define a tomcat realm.
   Options are specified in the tomcat docs, and realm-type specific.
   http://tomcat.apache.org/tomcat-6.0-doc/config/realm.html"
  [realm-type & options]
  (pallet-type
   ::realm :className (classname-for realm-type realm-classnames) options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn valve
  "Define a tomcat valve.
   Options are specified in the tomcat docs, and valve-type specific.
   http://tomcat.apache.org/tomcat-6.0-doc/config/valve.html"
  [valve-type & options]
  (pallet-type
   ::valve :className (classname-for valve-type valve-classnames) options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn host
  "Define a tomcat host.
   Accepts valves, contexts, aliases and listeners.
   Options are implementation specific, and include:
    - :autoDeploy
    - :backgroundProcessorDelay
    - :className
    - :deployOnStartup
   http://tomcat.apache.org/tomcat-6.0-doc/config/host.html"
  [name app-base & options]
  (pallet-type
   ::host :collections [::valve ::context ::alias ::listener]
   :name name :appBase app-base options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn alias
  "Define a tomcat alias."
  [name]
  (pallet-type ::alias [:name name]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn context
  "Define a tomcat context.
   Accepts: loader, manager realm, valves, listeners, resources, resource-links,
   parameters, environments, transactions and watched-resources
   Options are implemenation specific, and include:
    - :backgroundProcessorDelay
    - :className
    - :cookies
    - :crossContext
    - :docBase
    - :override
    - :privileged
    - :path
    - :reloadable
    - :sessionCookieDomain
    - :sessionCookieName
    - :sessionCookiePath
    - :wrapperClass
    - :useHttpOnly
   http://tomcat.apache.org/tomcat-6.0-doc/config/context.html"
  [name & options]
  (pallet-type
   ::context
   :members [::loader :manager ::realm]
   :collections [::valve ::listener ::resource ::resource-link :parameter
                 ::environment ::transaction :watched-resource]
   options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn loader
  "Define a tomcat class loader.
   Options are implementation specific, and include:
    - :className
    - :delegate
    - :reloadable
   http://tomcat.apache.org/tomcat-6.0-doc/config/loader.html"
  [classname options]
  (pallet-type ::loader :className classname options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn parameter
  "Define a tomcat parameter.
   Options are:
     - :description
     - :override
   http://tomcat.apache.org/tomcat-6.0-doc/config/context.html#Context_Parameters"
  [name value & options]
  (pallet-type ::parameters :name name :value value options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn watched-resource
  "Define a tomcat watched resource. Used in a tomcat context."
  [name]
  (pallet-type ::watched-resources [:name name]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn server
  "Define a tomcat server. Accepts server, listener and a global-resources
   form.
     - ::services         vector of services
     - ::global-resources vector of resources.
   Options include:
     - :class-name       imlementation class name - org.apache.catalina.Server
     - :port             shutdown listen port - 8005
     - :shutdown         shutdown command string - SHUTDOWN
       (server :port \"123\" :shutdown \"SHUTDOWNx\"
         (global-resources)
         (service
           (engine \"catalina\" \"host\"
             (valve :request-dumper))
             (connector :port \"8080\" :protocol \"HTTP/1.1\"
                :connectionTimeout \"20000\" :redirectPort \"8443\")))"
  [& options]
  (pallet-type
   ::server
   :members [::global-resources]
   :collections [::listener ::service]
   options))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn server-configuration
  "Define a tomcat server.  When a key is not specified, the relevant section
   of the template is output, unmodified."
  [request server]
  (let [base (parameter/get-for-target request [:tomcat :base])]
    (->
     request
     (directory/directory
      (str base "conf"))
     (remote-file/remote-file
      (str base "conf/server.xml")
      :content (apply
                str (tomcat-server-xml (:node-type request) server))))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.upstart" name="pallet.crate.upstart"><h1 class="project-name">pallet.crate.upstart</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Create upstart daemon scripts</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.upstart
  (:require
   [pallet.parameter :as parameter]
   [pallet.resource.package :as package]
   [pallet.resource.remote-file :as remote-file]
   [clojure.string :as string]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn package
  "Install upstart from system package"
  [request]
  (->
   request
   (package/packages
    :yum ["upstart"]
    :aptitude ["upstart"])))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn names {:pre-start-exec "pre-start exec"
             :post-start-exec "post-start exec"
             :pre-stop-exec "pre-stop exec"
             :post-stop-exec "post-stop exec"
             :pre-start-script "pre-start script"
             :post-start-script "post-start script"
             :pre-stop-script "pre-stop script"
             :post-stop-script "post-stop script"})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- name-for [k]
  (k names (string/replace (name k) "-" " ")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmulti format-stanza
  "Format an upstart stanza"
  (fn [[k v]]
    (cond
     (#{:exec
        :pre-start-exec :post-start-exec :pre-stop-exec :post-stop-exec
        :start-on :stop-on
        :respawn-limit :normal-exit
        :instance
        :description :author :version :emits
        :console :umask :nice :oom :chroot :chdir
        :kill-timeout
        } k) :simple
     (#{:respawn} k) :boolean
     (#{:script :pre-start-script :post-start-script :pre-stop-script
        :post-stop-script} k) :block
     (#{:env :export :kill-timeout :expect} k) :multi
     (#{:limit} k) :map)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod format-stanza :simple
  [[k v]]
  (format "%s %s" (name-for k) v))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod format-stanza :multi
  [[k v]]
  (if (sequential? v)
    (string/join "\n" (map #(format "%s %s" (name-for k) %) v))
    (format "%s %s" (name-for k) v)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod format-stanza :map
  [[k v]]
  (string/join
   "\n"
   (map #(format "%s %s %s" (name-for k) (first %) (second %)) v)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod format-stanza :boolean
  [[k v]]
  (if v
    (format "%s" (name-for k))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defmethod format-stanza :block
  [[k v]]
  (if v
    (format
     "%s\n%s\nend %s"
     (name-for k)
     v
     (last (string/split (name-for k) #" ")))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- job-format [options]
  (string/join \newline (concat (map format-stanza options))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn job
  "Define an upstart job.
    :start-on, :stop-on, :env, :export takes a sequency of strings.
    :limit takes a map of limit-resource and soft hard limit pairs as a string"
  [request name &
   {:keys [script exec
           pre-start-script post-start-script pre-stop-script post-stop-script
           pre-start-exec post-start-exec pre-stop-exec post-stop-exec
           start-on stop-on
           env export respawn respawn-limit normal-exit
           instance
           description author version emits
           console umask nice oom chroot chdir limit
           kill-timeout expect] :as options}]
  (->
   request
   (remote-file/remote-file
    (format "/etc/init/%s.conf" name)
    :content (job-format options)
    :literal true)
   (parameter/assoc-for-target [:upstart (keyword name)] options)))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.vpnc" name="pallet.crate.vpnc"><h1 class="project-name">pallet.crate.vpnc</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Crate for vpnc installation and configuration.</p>

<p>   <code>package</code> installs from package.  For centos this enables rpmforge.
   <code>configure-vpn</code> writes a configuration to a named configuraiton file.
   <code>vpn-up</code> to bring up a vpn
   <code>vpn-down</code> to bring down a vpn</p>

<p>   ** Links
    - http://www.gentoo.org/doc/en/vpnc-howto.xml
    - http://www.debuntu.org/how-to-connect-to-a-cisco-vpn-using-vpnc</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.vpnc
  "Crate for vpnc installation and configuration.
   `package` installs from package.  For centos this enables rpmforge.
   `configure-vpn` writes a configuration to a named configuraiton file.
   `vpn-up` to bring up a vpn
   `vpn-down` to bring down a vpn
   ** Links
    - http://www.gentoo.org/doc/en/vpnc-howto.xml
    - http://www.debuntu.org/how-to-connect-to-a-cisco-vpn-using-vpnc"
  (:require
   [pallet.parameter :as parameter]
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.file :as file]
   [pallet.resource.filesystem-layout :as filesystem-layout]
   [pallet.resource.package :as package]
   [pallet.resource.remote-file :as remote-file]
   [pallet.request-map :as request-map]
   [pallet.stevedore :as stevedore]
   [pallet.thread-expr :as thread-expr]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- default-config-home
  "Default configuration home for vpnc conf files"
  []
  (stevedore/script (str (pkg-config-root) "/vpnc")))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- default-sbin
  "Default sbin location"
  []
  (stevedore/script (pkg-sbin)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn package
 "Install vpnc client from packages"
 [request & {:keys [config-home sbin]}]
 (let [config-home (or config-home (default-config-home))
       sbin (or sbin (default-sbin))]
   (->
    request
    (thread-expr/when-> (= :centos (request-map/os-family request))
                        (package/add-rpmforge)
                        (package/package-manager :update))
    (package/package "vpnc")
    (file/file (str config-home "/vpnc-script") :mode "0755")
    (parameter/assoc-for-target
     [:vpnc :config-home] config-home
     [:vpnc :sbin] sbin))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn- config-for-name
  "Path for given vpn-name config"
  [request vpn-name]
  (str
   (parameter/get-for-target request [:vpnc :config-home] (default-config-home))
   "/" vpn-name ".conf"))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn configure-vpn
  "Configure a vpn. Options as for `remote-file/remote-file`.
   `pallet.resource.format/name-values` could be used to generate the
   configuration based on a map, and passed to this function via :content.
       (configure-vpn request \"myvpn\"
         :content (name-values { \"IPSec gateway\" \"<gateway>\"
                                 \"IPSec ID\" \"<group-id>\"
                                 \"IPSec secret\" \"<group-psk>\"
                                 \"IKE Authmode\" \"hybrid\"
                                 \"Xauth username\" \"<username>\"
                                 \"Xauth password\" \"<password>\"}))"
  [request name & {:as options}]
  (->
   request
   (thread-expr/apply-map->
    remote-file/remote-file
    (config-for-name request name)
    :mode "0600" options)))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn vpn-up
  "Bring the vpn up"
  [request name]
  (let [sbin (parameter/get-for-target request [:vpnc :sbin] (default-sbin))]
    (->
     request
     (exec-script/exec-checked-script
      (format "Bring VPN %s up" name)
      (~(str sbin "/vpnc") ~name)))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn vpn-down
  "Bring the vpn down"
  [request]
  (let [sbin (parameter/get-for-target request [:vpnc :sbin] (default-sbin))]
    (->
     request
     (exec-script/exec-checked-script
      "Bring VPN down"
      (~(str sbin "/vpnc-disconnect"))
      ("killall vpnc")))))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.wordpress" name="pallet.crate.wordpress"><h1 class="project-name">pallet.crate.wordpress</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs"><p>Install wordpress</p>
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.wordpress
  (:require
   [pallet.resource.package :as package]
   [pallet.crate.php :as php]
   [pallet.crate.mysql :as mysql]
   [pallet.resource.file :as file]
   [pallet.resource.remote-file :as remote-file])
  (:use
   pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn wordpress
  "Install wordpress - no configuration yet!"
  [request
   mysql-wp-username
   mysql-wp-password
   mysql-wp-database
   & extensions]
  (->
   request
   (package/package "wordpress")
   (for-> [extension extensions]
     (package/package (format "wordpress-%s" (name extension))))
   (mysql/create-database mysql-wp-database)
   (mysql/create-user mysql-wp-username mysql-wp-password)
   (mysql/grant "ALL" (format "`%s`.*" mysql-wp-database) mysql-wp-username)))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.zeromq" name="pallet.crate.zeromq"><h1 class="project-name">pallet.crate.zeromq</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.zeromq
  (:require
   [pallet.resource.exec-script :as exec-script]
   [pallet.resource.package :as package]
   [pallet.resource.remote-directory :as remote-directory]
   [pallet.crate.iptables :as iptables]))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def src-path "/opt/local/zeromq")
(def md5s {})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn download-url
  "The url for downloading zeromq"
  [version]
  (format
   "http://www.zeromq.org/local--files/area:download/zeromq-%s.tar.gz"
   version))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install
  "Install zeromq from source."
  [request & {:keys [version] :or {version "2.0.9"}}]
  (->
   request
   (package/packages
    :yum ["gcc" "glib" "glibc-common" "uuid-dev"]
    :aptitude ["build-essential" "uuid-dev"])
   (remote-directory/remote-directory
    src-path
    :url (download-url version) :md5 (md5s version) :unpack :tar)
   (exec-script/exec-checked-script
    "Build zeromq"
    (cd ~src-path)
    ("./configure")
    (make)
    (make install)
    (ldconfig))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn iptables-accept
  "Accept zeromq connections, by default on port 5672"
  ([request] (iptables-accept request 5672))
  ([request port]
     (iptables/iptables-accept-port request port)))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr><tr><td class="docs"><div class="docs-header"><a class="anchor" href="#pallet.crate.zookeeper" name="pallet.crate.zookeeper"><h1 class="project-name">pallet.crate.zookeeper</h1><a class="toc-link" href="#toc">toc</a></a></div></td><td class="codes" /></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(ns pallet.crate.zookeeper
  (:require
   [pallet.argument :as argument]
   [pallet.compute :as compute]
   [pallet.request-map :as request-map]
   [pallet.parameter :as parameter]
   [pallet.target :as target]
   [pallet.resource.remote-directory :as remote-directory]
   [pallet.resource.remote-file :as remote-file]
   [pallet.resource.directory :as directory]
   [pallet.resource.file :as file]
   [pallet.resource.service :as service]
   [pallet.resource.user :as user]
   [pallet.stevedore :as stevedore]
   [clojure.string :as string])
  (:use
   pallet.thread-expr))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(def install-path "/usr/local/zookeeper")
(def log-path "/var/log/zookeeper")
(def tx-log-path (format "%s/txlog" log-path))
(def config-path "/etc/zookeeper")
(def data-path "/var/zookeeper")
(def zookeeper-home install-path)
(def zookeeper-user "zookeeper")
(def zookeeper-group "zookeeper")
(def default-config
  {:dataDir data-path
   :tickTime 2000
   :clientPort 2181
   :initLimit 10
   :syncLimit 5
   :dataLogDir tx-log-path})</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn url "Download url"
  [version]
  (format
   "http://www.apache.org/dist/hadoop/zookeeper/zookeeper-%s/zookeeper-%s.tar.gz"
   version version))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn install
  "Install Zookeeper"
  [request & {:keys [user group version home]
              :or {user zookeeper-user
                   group zookeeper-group
                   version "3.3.1"}
              :as options}]
  (let [url (url version)
        home (or home (format "%s-%s" install-path version))]
    (->
     request
     (parameter/assoc-for
      [:zookeeper :home] home
      [:zookeeper :owner] user
      [:zookeeper :group] group)
     (user/user user :system true)
     (user/group group :system true)
     (remote-directory/remote-directory
      home
      :url url :md5-url (str url ".md5")
      :unpack :tar :tar-options "xz"
      :owner user :group group)
     (directory/directory log-path :owner user :group group :mode "0755")
     (directory/directory tx-log-path :owner user :group group :mode "0755")
     (directory/directory config-path :owner user :group group :mode "0755")
     (directory/directory data-path :owner user :group group :mode "0755")
     (remote-file/remote-file
      (format "%s/log4j.properties" config-path)
      :remote-file (format "%s/conf/log4j.properties" home)
      :owner user :group group :mode "0644")
     (file/sed
      (format "%s/log4j.properties" config-path)
      {"log4j.rootLogger=INFO, CONSOLE"
       "log4j.rootLogger=INFO, ROLLINGFILE"
       "log4j.appender.ROLLINGFILE.File=zookeeper.log"
       (format "log4j.appender.ROLLINGFILE.File=%s/zookeeper.log" log-path)}
      :seperator "|"))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn init
  [request & {:as options}]
  (->
   request
   (service/init-script
    "zookeeper"
    :link (format
           "%s/bin/zkServer.sh"
           (parameter/get-for request [:zookeeper :home])))
   (file/sed
    (format
     "%s/bin/zkServer.sh"
     (parameter/get-for request [:zookeeper :home]))
    {"# chkconfig:.*" 
     "# description:.*" 
     "# by default we allow local JMX connections"
     "# by default we allow local JMX connections\\n# chkconfig: 2345 20 80\\n# description: zookeeper"})
   (if-not-> (:no-enable options)
             (service/service
              "zookeeper" :action :start-stop
              :sequence-start "20 2 3 4 5"
              :sequence-stop "20 0 1 6"))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn config-files
  "Create a zookeeper configuration file.  We sort by name to preserve sequence
   across invocations."
  [request]
  (let [target-name (request-map/target-name request)
        target-ip (request-map/target-ip request)
        nodes (sort-by compute/hostname (request-map/nodes-in-tag request))
        configs (parameter/get-for
                 request
                 [:zookeper (keyword (request-map/tag request))])
        config (configs (keyword target-name))
        owner (parameter/get-for request [:zookeeper :owner])
        group (parameter/get-for request [:zookeeper :group])]
    (->
     request
     (remote-file/remote-file
      (format "%s/zoo.cfg" config-path)
      :content (str (string/join
                     \newline
                     (map #(format "%s=%s" (name (first %)) (second %))
                          (merge
                           default-config
                           (dissoc config :electionPort :quorumPort))))
                    \newline
                    (when (> (count nodes) 1)
                      (string/join
                       \newline
                       (map #(let [config (configs
                                           (keyword (compute/hostname %1)))]
                               (format "server.%s=%s:%s:%s"
                                       %2
                                       (compute/private-ip %1)
                                       (:quorumPort config 2888)
                                       (:electionPort config 3888)))
                            nodes
                            (range 1 (inc (count nodes)))))))
      :owner owner :group group :mode "0644")
     (remote-file/remote-file
      (format "%s/myid" data-path)
      :content (str (some #(and (= target-ip (second %)) (first %))
                          (map #(vector %1 (compute/primary-ip %2))
                               (range 1 (inc (count nodes)))
                               nodes)))
      :owner owner :group group :mode "0644"))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn store-configuration
  "Capture zookeeper configuration"
  [request options]
  (parameter/update-for
   request
   [:zookeper (keyword (request-map/tag request))]
   (fn [m]
     (assoc m (request-map/target-name request) options))))</pre></tr><tr><td class="docs">
</td><td class="codes" /><pre class="brush: clojure">(defn configure
  "Configure zookeeper instance"
  [request & {:keys [dataDir tickTime clientPort initLimit syncLimit dataLogDir
                     electionPort quorumPort]
              :or {quorumPort 2888 electionPort 3888}
              :as options}]
  (->
   request
   (store-configuration
    (assoc options :quorumPort quorumPort :electionPort electionPort))
   (config-files)))</pre></tr><tr><td class="spacer docs">&nbsp;</td><td class="codes" /></tr></table><div class="footer">Generated by <a href="https://github.com/fogus/marginalia">Marginalia</a>.&nbsp;&nbsp;Syntax highlighting provided by Alex Gorbatchev's <a href="http://alexgorbatchev.com/SyntaxHighlighter/">SyntaxHighlighter</a><div id="floating-toc"><ul><li class="floating-toc-li" id="floating-toc_pallet.crate.automated-admin-user">pallet.crate.automated-admin-user</li><li class="floating-toc-li" id="floating-toc_pallet.crate.bzr">pallet.crate.bzr</li><li class="floating-toc-li" id="floating-toc_pallet.crate.cassandra">pallet.crate.cassandra</li><li class="floating-toc-li" id="floating-toc_pallet.crate.chef">pallet.crate.chef</li><li class="floating-toc-li" id="floating-toc_pallet.crate.cloudkick">pallet.crate.cloudkick</li><li class="floating-toc-li" id="floating-toc_pallet.crate.couchdb">pallet.crate.couchdb</li><li class="floating-toc-li" id="floating-toc_pallet.crate.crontab">pallet.crate.crontab</li><li class="floating-toc-li" id="floating-toc_pallet.crate.cruise-control-rb">pallet.crate.cruise-control-rb</li><li class="floating-toc-li" id="floating-toc_pallet.crate.etc-default">pallet.crate.etc-default</li><li class="floating-toc-li" id="floating-toc_pallet.crate.etc-hosts">pallet.crate.etc-hosts</li><li class="floating-toc-li" id="floating-toc_pallet.crate.ganglia">pallet.crate.ganglia</li><li class="floating-toc-li" id="floating-toc_pallet.crate.git">pallet.crate.git</li><li class="floating-toc-li" id="floating-toc_"></li><li class="floating-toc-li" id="floating-toc_pallet.crate.github">pallet.crate.github</li><li class="floating-toc-li" id="floating-toc_pallet.crate.gpg">pallet.crate.gpg</li><li class="floating-toc-li" id="floating-toc_pallet.crate.haproxy">pallet.crate.haproxy</li><li class="floating-toc-li" id="floating-toc_pallet.crate.hudson">pallet.crate.hudson</li><li class="floating-toc-li" id="floating-toc_pallet.crate.iozone">pallet.crate.iozone</li><li class="floating-toc-li" id="floating-toc_pallet.crate.iptables">pallet.crate.iptables</li><li class="floating-toc-li" id="floating-toc_pallet.crate.java">pallet.crate.java</li><li class="floating-toc-li" id="floating-toc_pallet.crate.jetty">pallet.crate.jetty</li><li class="floating-toc-li" id="floating-toc_pallet.crate.maven">pallet.crate.maven</li><li class="floating-toc-li" id="floating-toc_pallet.crate.monit">pallet.crate.monit</li><li class="floating-toc-li" id="floating-toc_pallet.crate.mysql">pallet.crate.mysql</li><li class="floating-toc-li" id="floating-toc_pallet.crate.nagios">pallet.crate.nagios</li><li class="floating-toc-li" id="floating-toc_pallet.crate.nagios-config">pallet.crate.nagios-config</li><li class="floating-toc-li" id="floating-toc_pallet.crate.nginx">pallet.crate.nginx</li><li class="floating-toc-li" id="floating-toc_pallet.crate.node-js">pallet.crate.node-js</li><li class="floating-toc-li" id="floating-toc_pallet.crate.package-builder">pallet.crate.package-builder</li><li class="floating-toc-li" id="floating-toc_pallet.crate.php">pallet.crate.php</li><li class="floating-toc-li" id="floating-toc_pallet.crate.postfix">pallet.crate.postfix</li><li class="floating-toc-li" id="floating-toc_pallet.crate.postgres">pallet.crate.postgres</li><li class="floating-toc-li" id="floating-toc_pallet.crate.public-dns-if-no-nameserver">pallet.crate.public-dns-if-no-nameserver</li><li class="floating-toc-li" id="floating-toc_pallet.crate.rabbitmq">pallet.crate.rabbitmq</li><li class="floating-toc-li" id="floating-toc_pallet.crate.resolv">pallet.crate.resolv</li><li class="floating-toc-li" id="floating-toc_pallet.crate.ruby">pallet.crate.ruby</li><li class="floating-toc-li" id="floating-toc_pallet.crate.rubygems">pallet.crate.rubygems</li><li class="floating-toc-li" id="floating-toc_pallet.crate.sphinx">pallet.crate.sphinx</li><li class="floating-toc-li" id="floating-toc_pallet.crate.splunk">pallet.crate.splunk</li><li class="floating-toc-li" id="floating-toc_pallet.crate.squeak">pallet.crate.squeak</li><li class="floating-toc-li" id="floating-toc_pallet.crate.ssh">pallet.crate.ssh</li><li class="floating-toc-li" id="floating-toc_pallet.crate.ssh-key">pallet.crate.ssh-key</li><li class="floating-toc-li" id="floating-toc_pallet.crate.sudoers">pallet.crate.sudoers</li><li class="floating-toc-li" id="floating-toc_pallet.crate.syslog-ng">pallet.crate.syslog-ng</li><li class="floating-toc-li" id="floating-toc_pallet.crate.tmux">pallet.crate.tmux</li><li class="floating-toc-li" id="floating-toc_pallet.crate.tomcat">pallet.crate.tomcat</li><li class="floating-toc-li" id="floating-toc_pallet.crate.upstart">pallet.crate.upstart</li><li class="floating-toc-li" id="floating-toc_pallet.crate.vpnc">pallet.crate.vpnc</li><li class="floating-toc-li" id="floating-toc_pallet.crate.wordpress">pallet.crate.wordpress</li><li class="floating-toc-li" id="floating-toc_pallet.crate.zeromq">pallet.crate.zeromq</li><li class="floating-toc-li" id="floating-toc_pallet.crate.zookeeper">pallet.crate.zookeeper</li></ul></div></div><script type="text/javascript">SyntaxHighlighter.defaults['gutter'] = false;
       SyntaxHighlighter.all()</script></body></html>